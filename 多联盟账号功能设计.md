# 多联盟账号功能设计文档

## 一、需求概述

### 1.1 业务背景
- 每个员工至少拥有3个广告联盟平台账号
- 后续会拥有更多账号（可扩展）
- 经理需要查看：
  - 每个员工不同联盟账号的数据
  - 整个工作室每个联盟平台的数据

### 1.2 功能目标
- 支持员工管理多个联盟账号
- 数据上传时关联到具体联盟账号
- 支持多维度数据查看和统计
- 支持按联盟平台汇总整个工作室数据

## 二、数据库设计

### 2.1 联盟平台表 (affiliate_platforms)
存储所有可用的联盟平台信息。

```sql
CREATE TABLE affiliate_platforms (
    id SERIAL PRIMARY KEY,
    platform_name VARCHAR(100) NOT NULL UNIQUE,  -- 平台名称（如：Amazon、CJ、ShareASale等）
    platform_code VARCHAR(50) NOT NULL UNIQUE,    -- 平台代码（用于标识）
    description TEXT,                              -- 平台描述
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

**初始数据示例：**
```sql
INSERT INTO affiliate_platforms (platform_name, platform_code) VALUES
('Amazon Associates', 'amazon'),
('Commission Junction', 'cj'),
('ShareASale', 'shareasale'),
('Rakuten', 'rakuten');
```

### 2.2 联盟账号表 (affiliate_accounts)
存储每个员工的联盟账号信息。

```sql
CREATE TABLE affiliate_accounts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,  -- 所属员工
    platform_id INTEGER REFERENCES affiliate_platforms(id),  -- 所属联盟平台
    account_name VARCHAR(100) NOT NULL,  -- 账号名称/标识（如：账号1、主账号等）
    account_code VARCHAR(50),  -- 账号代码（可选，用于系统识别）
    is_active BOOLEAN DEFAULT TRUE,  -- 是否激活
    notes TEXT,  -- 备注信息
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, platform_id, account_name)  -- 同一员工在同一平台不能有重复账号名
);
```

**索引：**
```sql
CREATE INDEX idx_affiliate_accounts_user ON affiliate_accounts(user_id);
CREATE INDEX idx_affiliate_accounts_platform ON affiliate_accounts(platform_id);
```

### 2.3 更新数据上传表
添加联盟账号关联字段。

```sql
ALTER TABLE data_uploads 
ADD COLUMN affiliate_account_id INTEGER REFERENCES affiliate_accounts(id);

-- 创建索引
CREATE INDEX idx_data_uploads_account ON data_uploads(affiliate_account_id);
```

### 2.4 更新分析结果表
添加联盟账号关联字段。

```sql
ALTER TABLE analysis_results 
ADD COLUMN affiliate_account_id INTEGER REFERENCES affiliate_accounts(id);

-- 创建索引
CREATE INDEX idx_analysis_results_account ON analysis_results(affiliate_account_id);
```

## 三、功能模块设计

### 3.1 联盟账号管理模块

#### 3.1.1 员工功能
- **查看自己的联盟账号列表**
  - 显示账号名称、所属平台、激活状态
  - 支持按平台筛选
  - 支持搜索

- **添加新联盟账号**
  - 选择联盟平台（下拉选择）
  - 输入账号名称
  - 可选：输入账号代码、备注
  - 默认激活状态为TRUE

- **编辑联盟账号**
  - 修改账号名称
  - 修改激活状态
  - 修改备注

- **删除联盟账号**
  - 检查是否有关联的数据上传记录
  - 如果有数据，提示不能删除或标记为停用

#### 3.1.2 经理功能
- **查看所有员工的联盟账号**
  - 按员工分组显示
  - 显示每个员工拥有的账号数量和平台分布
  - 支持按员工、平台筛选

### 3.2 数据上传模块更新

#### 3.2.1 上传联盟数据
- **必须选择联盟账号**
  - 下拉选择框显示：平台名称 - 账号名称
  - 只显示当前用户的激活账号
  - 如果用户没有账号，提示先创建账号

- **上传记录关联**
  - 保存上传记录时，记录关联的联盟账号ID
  - 上传历史中显示账号信息

### 3.3 数据分析模块更新

#### 3.3.1 分析结果关联
- 分析结果自动关联到对应的联盟账号
- 支持按联盟账号查询分析结果
- 支持按联盟平台查询分析结果

### 3.4 数据总览模块（经理）

#### 3.4.1 按员工查看
- 显示每个员工的所有联盟账号
- 每个账号的数据统计
- 员工所有账号的汇总数据

#### 3.4.2 按联盟平台查看
- 显示整个工作室在每个平台的数据
- 汇总所有员工在该平台的所有账号数据
- 平台数据对比图表

#### 3.4.3 按员工+联盟账号查看
- 选择特定员工
- 选择该员工的特定账号
- 查看该账号的详细数据

#### 3.4.4 多维度统计
- 按平台统计：各平台的总点击、总订单、总佣金、平均EPC、平均ROI
- 按员工统计：各员工的总数据
- 按员工+平台统计：各员工在各平台的数据
- 按账号统计：各账号的详细数据

### 3.5 个人数据模块（员工）

#### 3.5.1 按联盟账号查看
- 显示自己所有联盟账号的列表
- 每个账号的数据统计卡片
- 点击账号查看详细数据

#### 3.5.2 按联盟平台查看
- 按平台分组显示数据
- 同一平台下所有账号的汇总

#### 3.5.3 账号对比
- 多账号数据对比图表
- 账号表现排名

## 四、API接口设计

### 4.1 联盟平台接口
```python
GET /api/affiliate-platforms
# 获取所有联盟平台列表
# 返回：平台ID、名称、代码

GET /api/affiliate-platforms/{id}
# 获取平台详情
```

### 4.2 联盟账号接口
```python
GET /api/affiliate-accounts
# 获取联盟账号列表
# 参数：
#   - user_id: 可选，经理可指定员工ID
#   - platform_id: 可选，按平台筛选
#   - is_active: 可选，按激活状态筛选
# 权限：员工只能看自己的，经理可看所有

POST /api/affiliate-accounts
# 创建联盟账号
# 请求体：
# {
#   "platform_id": 1,
#   "account_name": "主账号",
#   "account_code": "ACC001",
#   "notes": "备注"
# }

PUT /api/affiliate-accounts/{id}
# 更新联盟账号
# 权限：只能更新自己的账号

DELETE /api/affiliate-accounts/{id}
# 删除联盟账号
# 权限：只能删除自己的账号
# 检查：如果有关联数据，不允许删除
```

### 4.3 数据上传接口更新
```python
POST /api/upload/affiliate
# 上传联盟数据
# 请求体（multipart/form-data）：
#   - file: 文件
#   - affiliate_account_id: 联盟账号ID（必填）⭐
#   - data_date: 数据日期
```

### 4.4 数据分析接口更新
```python
POST /api/analysis/process
# 触发数据分析
# 请求体：
# {
#   "google_ads_upload_id": 1,
#   "affiliate_upload_id": 2,
#   "affiliate_account_id": 1  # 自动从上传记录获取，也可手动指定
# }
```

### 4.5 数据总览接口（经理）
```python
GET /api/dashboard/platform-summary
# 获取各联盟平台的数据汇总
# 返回：各平台的总点击、总订单、总佣金、平均EPC、平均ROI等

GET /api/dashboard/employee-accounts
# 获取员工及其联盟账号列表
# 返回：员工列表，每个员工包含其所有账号

GET /api/dashboard/account-details
# 获取指定联盟账号的详细数据
# 参数：
#   - account_id: 联盟账号ID
#   - start_date: 开始日期
#   - end_date: 结束日期

GET /api/dashboard/statistics
# 获取统计数据
# 参数：
#   - group_by: 'platform' | 'employee' | 'account' | 'employee_platform'
#   - employee_id: 可选，指定员工
#   - platform_id: 可选，指定平台
#   - account_id: 可选，指定账号
```

### 4.6 个人数据接口（员工）
```python
GET /api/user/account-summary
# 获取个人各联盟账号的数据汇总
# 返回：各账号的统计数据

GET /api/user/analysis-results
# 获取个人分析结果
# 参数：
#   - account_id: 可选，按账号筛选
#   - platform_id: 可选，按平台筛选
```

## 五、前端页面设计

### 5.1 联盟账号管理页面
```
┌─────────────────────────────────────┐
│  联盟账号管理                        │
├─────────────────────────────────────┤
│  [+ 添加新账号]  [筛选: 全部平台 ▼]  │
├─────────────────────────────────────┤
│  账号名称     平台        状态   操作 │
│  ───────────────────────────────────│
│  主账号      Amazon      ✓激活  [编辑]│
│  账号2       CJ          ✓激活  [编辑]│
│  账号3       ShareASale  ✓激活  [编辑]│
└─────────────────────────────────────┘
```

### 5.2 数据上传页面更新
```
┌─────────────────────────────────────┐
│  上传联盟数据                        │
├─────────────────────────────────────┤
│  选择联盟账号: [Amazon - 主账号 ▼]  │ ⭐
│  选择文件: [选择文件]                │
│  数据日期: [2026-01-20]             │
│  [上传]                              │
└─────────────────────────────────────┘
```

### 5.3 经理数据总览页面
```
┌─────────────────────────────────────┐
│  数据总览                            │
├─────────────────────────────────────┤
│  [按员工] [按平台] [按账号]          │ ⭐
├─────────────────────────────────────┤
│  筛选: [员工 ▼] [平台 ▼] [日期范围]  │
├─────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐          │
│  │ Amazon   │  │   CJ    │          │
│  │ 总点击:  │  │ 总点击: │          │
│  │ 5000     │  │ 3000    │          │
│  │ 总订单:  │  │ 总订单: │          │
│  │ 100      │  │ 60      │          │
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘
```

### 5.4 员工个人数据页面
```
┌─────────────────────────────────────┐
│  我的数据                            │
├─────────────────────────────────────┤
│  [全部账号] [按平台] [账号对比]      │ ⭐
├─────────────────────────────────────┤
│  ┌─────────┐  ┌─────────┐          │
│  │ 主账号   │  │ 账号2    │          │
│  │ Amazon  │  │   CJ    │          │
│  │ EPC: 2.0│  │ EPC: 1.8│          │
│  │ ROI: 33%│  │ ROI: 20%│          │
│  └─────────┘  └─────────┘          │
└─────────────────────────────────────┘
```

## 六、数据统计维度

### 6.1 按联盟平台统计（整个工作室）
- 总点击数（所有员工在该平台所有账号的总和）
- 总订单数
- 总保守佣金
- 平均保守EPC
- 平均保守ROI
- 活跃账号数（该平台下激活的账号数量）
- 活跃员工数（该平台下有账号的员工数量）

### 6.2 按员工统计
- 该员工所有账号的总数据
- 该员工各平台的数据分布
- 该员工各账号的数据对比

### 6.3 按员工+平台统计
- 该员工在特定平台的所有账号数据
- 该员工在特定平台的汇总数据

### 6.4 按联盟账号统计
- 该账号的详细数据
- 该账号的历史趋势
- 该账号的表现指标

## 七、实现注意事项

### 7.1 数据完整性
- 上传联盟数据时，必须选择联盟账号
- 删除账号前，检查是否有关联数据
- 如果有关联数据，不允许删除，只能停用

### 7.2 权限控制
- 员工只能管理自己的账号
- 员工只能查看自己的数据
- 经理可以查看所有数据
- API接口需要验证权限

### 7.3 性能优化
- 多维度统计使用数据库聚合查询
- 大数据量时使用分页
- 使用缓存优化常用查询

### 7.4 扩展性
- 支持动态添加新的联盟平台
- 支持员工拥有任意数量的账号
- 数据结构设计考虑未来扩展

## 八、开发优先级

### 阶段1：基础功能
1. 联盟平台表和数据初始化
2. 联盟账号管理（CRUD）
3. 数据上传时关联账号

### 阶段2：数据关联
1. 分析结果关联账号
2. 数据查询支持按账号筛选
3. 个人数据按账号展示

### 阶段3：多维度统计
1. 按平台统计（整个工作室）
2. 按员工+账号统计
3. 多维度数据总览页面

### 阶段4：高级功能
1. 账号对比功能
2. 平台对比功能
3. 数据可视化优化


















