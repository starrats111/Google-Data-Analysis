# 导出功能设计文档

## 一、需求概述

### 1.1 功能要求
- 导出分析结果为Excel格式（.xlsx）
- 导出模板使用表6的格式
- 导出文件存储路径：`excel/` 目录

### 1.2 导出场景
- 员工导出自己的分析结果
- 经理导出所有员工的分析结果
- 支持按联盟账号、平台、日期范围筛选后导出

## 二、表6模板结构分析

需要先分析表6的实际结构，确定：
- 表头字段
- 数据格式
- 样式要求（如果有）

## 三、功能设计

### 3.1 导出接口设计

#### 3.1.1 个人数据导出（员工）
```python
GET /api/analysis/export
# 导出个人分析结果
# 参数：
#   - account_id: 可选，按联盟账号筛选
#   - platform_id: 可选，按平台筛选
#   - start_date: 可选，开始日期
#   - end_date: 可选，结束日期
# 返回：Excel文件下载
```

#### 3.1.2 批量数据导出（经理）
```python
GET /api/dashboard/export
# 导出所有员工的分析结果
# 参数：
#   - employee_id: 可选，按员工筛选
#   - platform_id: 可选，按平台筛选
#   - account_id: 可选，按账号筛选
#   - start_date: 可选，开始日期
#   - end_date: 可选，结束日期
#   - group_by: 可选，分组方式（'employee', 'platform', 'account'）
# 返回：Excel文件下载
```

### 3.2 导出文件命名规则

```
个人导出：
{用户名}_分析结果_{日期范围}.xlsx
例如：employee1_分析结果_2026-01-20至2026-01-26.xlsx

经理导出：
工作室_分析结果_{日期范围}_{筛选条件}.xlsx
例如：工作室_分析结果_2026-01-20至2026-01-26_Amazon平台.xlsx
```

### 3.3 导出文件存储

- **存储路径**: `excel/` 目录
- **文件格式**: .xlsx
- **文件管理**: 
  - 可以保留历史导出文件
  - 或者定期清理旧文件
  - 或者覆盖同名文件

## 四、实现方案

### 4.1 后端实现

使用 `openpyxl` 或 `pandas` + `openpyxl` 生成Excel文件：

```python
# 使用pandas生成Excel
df.to_excel('excel/导出文件.xlsx', index=False, engine='openpyxl')

# 或者使用openpyxl进行更精细的控制
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, PatternFill
```

### 4.2 数据映射

将分析结果数据映射到表6的格式：
- 确定表6的列结构
- 将分析结果字段映射到表6列
- 处理数据格式（日期、数字、百分比等）

### 4.3 样式设置（如果需要）

- 表头样式（加粗、背景色等）
- 数据格式（数字格式、日期格式等）
- 列宽自动调整

## 五、前端实现

### 5.1 导出按钮

在以下页面添加导出按钮：
- 分析结果页面
- 数据总览页面（经理）
- 个人数据页面（员工）

### 5.2 导出选项

- 选择导出范围（全部/筛选后的数据）
- 选择导出字段（如果需要）
- 选择日期范围

### 5.3 导出进度

- 显示导出进度（大文件）
- 导出完成后自动下载

## 六、注意事项

1. **文件大小**: 大文件导出可能需要异步处理
2. **内存管理**: 大数据量时使用流式写入
3. **文件权限**: 确保有写入excel目录的权限
4. **并发控制**: 多个用户同时导出时的文件命名冲突处理
5. **错误处理**: 导出失败时的错误提示


















