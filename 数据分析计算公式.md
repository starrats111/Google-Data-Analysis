# 数据分析计算公式文档

## 一、核心计算公式

### 1.1 保守EPC（Earnings Per Click）
**公式：**
```
保守EPC = 保守佣金 / 点击
```

**说明：**
- EPC表示每次点击的平均收益
- 保守佣金：来自联盟平台的数据（表2）
- 点击：来自谷歌广告中心的数据（表1）⭐ **从表1提取**

**单位：** 货币单位（如：元、美元）

### 1.2 保守ROI（Return on Investment）
**公式：**
```
保守ROI = (保守EPC - CPC) / CPC × 100%
```

**说明：**
- ROI表示投资回报率
- 保守EPC：通过公式1.1计算得出
- CPC：每次点击成本（Cost Per Click），来自谷歌广告中心数据（表1）

**单位：** 百分比（%）

**示例：**
- 如果保守EPC = 2元，CPC = 1元
- 保守ROI = (2 - 1) / 1 × 100% = 100%

## 二、数据来源

### 2.1 表1（谷歌广告中心数据）字段
需要包含以下字段：
- **点击（Clicks）**: 广告点击次数 ⭐ **从表1提取**
- **CPC**: 每次点击成本（Cost Per Click）
- 其他相关字段（日期、广告ID、关键词等）

### 2.2 表2（联盟平台数据）字段
需要包含以下字段：
- **订单数**: 订单数量 ⭐ **从表2提取**
- **保守佣金**: 联盟平台产生的佣金收入
- 其他相关字段（日期、广告ID、订单ID等）

### 2.3 数据匹配规则
- 按**日期**匹配
- 按**广告ID**或**关键词**匹配（根据实际业务需求）
- 确保表1和表2的数据能够正确关联

## 三、计算流程

```
步骤1: 读取表1数据（谷歌广告）
    ├─ 提取：点击 ⭐
    └─ 提取：CPC
    ↓
步骤2: 读取表2数据（联盟平台）
    ├─ 提取：订单数 ⭐
    └─ 提取：保守佣金
    ↓
步骤3: 数据匹配（按日期、广告ID等）
    ↓
步骤4: 计算保守EPC
    保守EPC = 保守佣金 / 点击
    （点击来自表1，保守佣金来自表2）
    ↓
步骤5: 计算保守ROI
    保守ROI = (保守EPC - CPC) / CPC × 100%
    ↓
步骤6: 生成表3（分析结果）
    包含：点击（表1）+ 订单数（表2）+ 保守佣金 + 保守EPC + 保守ROI
```

## 四、异常情况处理

### 4.1 除零错误
- **点击数为0**: 保守EPC无法计算，应标记为"N/A"或0
- **CPC为0**: 保守ROI无法计算，应标记为"N/A"或特殊值

### 4.2 数据缺失
- **表1或表2数据缺失**: 无法匹配的数据应单独标记
- **部分字段缺失**: 使用默认值或标记为缺失

### 4.3 数据异常
- **负数检查**: EPC和ROI不应为负数（除非特殊情况）
- **异常值检查**: 超出合理范围的数值应标记

## 五、计算结果字段

### 5.1 表3（分析结果）应包含的字段

**原始数据字段：**
- 日期
- 广告ID / 关键词
- 点击（来自表1）
- CPC（来自表1）
- 保守佣金（来自表2）

**计算字段：**
- **保守EPC**: 计算得出
- **保守ROI**: 计算得出（百分比格式）

**其他字段：**
- 数据来源标识
- 匹配状态（成功/失败）
- 异常标记

## 六、代码实现示例

### 6.1 Python计算函数

```python
def calculate_conservative_epc(commission, clicks):
    """
    计算保守EPC
    
    参数:
        commission: 保守佣金
        clicks: 点击次数
    
    返回:
        保守EPC值，如果点击为0则返回None
    """
    if clicks == 0 or clicks is None:
        return None
    return commission / clicks

def calculate_conservative_roi(epc, cpc):
    """
    计算保守ROI
    
    参数:
        epc: 保守EPC
        cpc: 每次点击成本
    
    返回:
        保守ROI（百分比），如果CPC为0则返回None
    """
    if cpc == 0 or cpc is None or epc is None:
        return None
    return ((epc - cpc) / cpc) * 100
```

### 6.2 Pandas数据处理示例

```python
import pandas as pd
import numpy as np

def process_analysis(df_google, df_affiliate):
    """
    处理数据分析并计算EPC和ROI
    """
    # 数据匹配（假设按日期和广告ID匹配）
    merged_df = pd.merge(
        df_google,
        df_affiliate,
        on=['date', 'ad_id'],
        how='outer',
        suffixes=('_google', '_affiliate')
    )
    
    # 计算保守EPC
    merged_df['保守EPC'] = merged_df.apply(
        lambda row: calculate_conservative_epc(
            row.get('保守佣金', 0),
            row.get('点击', 0)
        ),
        axis=1
    )
    
    # 计算保守ROI
    merged_df['保守ROI'] = merged_df.apply(
        lambda row: calculate_conservative_roi(
            row.get('保守EPC'),
            row.get('CPC', 0)
        ),
        axis=1
    )
    
    # 处理异常值
    merged_df['保守EPC'] = merged_df['保守EPC'].replace([np.inf, -np.inf], None)
    merged_df['保守ROI'] = merged_df['保守ROI'].replace([np.inf, -np.inf], None)
    
    return merged_df
```

## 七、数据验证规则

### 7.1 输入数据验证
- 点击数必须 >= 0
- CPC必须 >= 0
- 保守佣金必须 >= 0

### 7.2 计算结果验证
- 保守EPC应该 >= 0（除非有特殊业务逻辑）
- 保守ROI可以是负数（表示亏损）
- 计算结果应该在合理范围内

## 八、性能优化建议

### 8.1 大数据量处理
- 使用向量化计算（Pandas）
- 避免循环计算
- 使用批量处理

### 8.2 内存优化
- 分块读取大文件
- 及时释放不需要的数据
- 使用适当的数据类型

## 九、测试用例

### 9.1 正常情况
- 输入：保守佣金=100，点击=50，CPC=1
- 预期：保守EPC=2，保守ROI=100%

### 9.2 边界情况
- 输入：点击=0 → 保守EPC=None
- 输入：CPC=0 → 保守ROI=None
- 输入：保守EPC < CPC → 保守ROI为负数

### 9.3 异常情况
- 输入：负数 → 应标记为异常
- 输入：空值 → 应处理为None

