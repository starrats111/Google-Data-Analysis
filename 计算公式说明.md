# 数据分析计算公式说明

## 一、核心公式

### 公式1：保守EPC（Earnings Per Click）
```
保守EPC = 保守佣金 / 点击
```

**含义：**
- 计算每次点击的平均收益
- 用于衡量广告点击的盈利能力

**数据来源：**
- 保守佣金：来自表2（联盟平台数据）
- 点击：来自表1（谷歌广告中心数据）⭐ **从表1提取**

**示例：**
- 如果保守佣金 = 1000元，点击 = 500次（从表1提取）
- 则保守EPC = 1000 / 500 = 2.0元

### 公式2：保守ROI（Return on Investment）
```
保守ROI = (保守EPC - CPC) / CPC × 100%
```

**含义：**
- 计算投资回报率
- 正值表示盈利，负值表示亏损
- 用于评估广告投放的盈利能力

**数据来源：**
- 保守EPC：通过公式1计算得出
- CPC：每次点击成本，来自表1（谷歌广告中心数据）

**示例：**
- 如果保守EPC = 2.0元，CPC = 1.0元
- 则保守ROI = (2.0 - 1.0) / 1.0 × 100% = 100%
- 表示每投入1元，可以获得2元收益，回报率为100%

## 二、计算流程

```
步骤1: 读取表1（谷歌广告数据）
    ├─ 提取：点击（Clicks）⭐ 从表1提取
    └─ 提取：CPC（每次点击成本）
    ↓
步骤2: 读取表2（联盟数据）
    ├─ 提取：订单数 ⭐ 从表2提取
    └─ 提取：保守佣金
    ↓
步骤3: 数据匹配
    ├─ 按日期匹配
    └─ 按广告ID匹配
    ↓
步骤4: 计算保守EPC
    保守EPC = 保守佣金 / 点击
    （点击来自表1，保守佣金来自表2）
    ↓
步骤5: 计算保守ROI
    保守ROI = (保守EPC - CPC) / CPC × 100%
    ↓
步骤6: 生成表3（分析结果）
    包含：点击（表1）+ 订单数（表2）+ 保守佣金 + 保守EPC + 保守ROI
```

## 三、计算示例

### 示例1：盈利情况
```
输入数据：
- 保守佣金：1000元（来自表2）
- 点击：500次（来自表1）⭐ 从表1提取
- 订单数：10（来自表2）⭐ 从表2提取
- CPC：1.5元（来自表1）

计算过程：
1. 保守EPC = 1000 / 500 = 2.0元
2. 保守ROI = (2.0 - 1.5) / 1.5 × 100% = 33.33%

结果：
- 点击：500次（从表1提取）
- 订单数：10（从表2提取）
- 每次点击平均收益：2.0元
- 投资回报率：33.33%（盈利）
```

### 示例2：亏损情况
```
输入数据：
- 保守佣金：500元（来自表2）
- 点击：1000次（来自表1）⭐ 从表1提取
- 订单数：5（来自表2）⭐ 从表2提取
- CPC：1.0元（来自表1）

计算过程：
1. 保守EPC = 500 / 1000 = 0.5元
2. 保守ROI = (0.5 - 1.0) / 1.0 × 100% = -50%

结果：
- 点击：1000次（从表1提取）
- 订单数：5（从表2提取）
- 每次点击平均收益：0.5元
- 投资回报率：-50%（亏损）
```

### 示例3：盈亏平衡
```
输入数据：
- 保守佣金：1000元
- 点击：1000次
- CPC：1.0元

计算过程：
1. 保守EPC = 1000 / 1000 = 1.0元
2. 保守ROI = (1.0 - 1.0) / 1.0 × 100% = 0%

结果：
- 每次点击平均收益：1.0元
- 投资回报率：0%（盈亏平衡）
```

## 四、异常情况处理

### 4.1 点击数为0
```
情况：点击 = 0
处理：保守EPC = None（无法计算）
原因：不能除以0
```

### 4.2 CPC为0
```
情况：CPC = 0
处理：保守ROI = None（无法计算）
原因：不能除以0
```

### 4.3 数据缺失
```
情况：保守佣金、点击或CPC为None或缺失
处理：对应的计算结果为None
标记：在结果中标记为"数据缺失"
```

### 4.4 异常值
```
情况：计算结果为无穷大或NaN
处理：替换为None
原因：数据异常或计算错误
```

## 五、数据验证规则

### 5.1 输入验证
- ✅ 保守佣金 >= 0
- ✅ 点击 >= 0
- ✅ CPC >= 0

### 5.2 结果验证
- ✅ 保守EPC >= 0（正常情况下）
- ✅ 保守ROI可以是负数（表示亏损）
- ✅ 计算结果在合理范围内

## 六、在代码中的使用

### 6.1 Python函数调用
```python
from app.utils.data_processor import (
    calculate_conservative_epc,
    calculate_conservative_roi
)

# 计算EPC
epc = calculate_conservative_epc(commission=1000, clicks=500)
# 结果：2.0

# 计算ROI
roi = calculate_conservative_roi(epc=2.0, cpc=1.5)
# 结果：33.33
```

### 6.2 Pandas批量计算
```python
import pandas as pd

# 假设df是合并后的数据框
df['保守EPC'] = df.apply(
    lambda row: calculate_conservative_epc(
        row['保守佣金'], 
        row['点击']
    ),
    axis=1
)

df['保守ROI'] = df.apply(
    lambda row: calculate_conservative_roi(
        row['保守EPC'], 
        row['CPC']
    ),
    axis=1
)
```

## 七、注意事项

1. **数据匹配准确性**：确保表1和表2的数据能够正确匹配（按日期和广告ID）
2. **单位一致性**：确保所有货币单位一致（如都是"元"或都是"美元"）
3. **精度处理**：EPC保留4位小数，ROI保留2位小数
4. **异常处理**：必须处理除零错误和异常值
5. **数据验证**：在计算前验证输入数据的有效性

## 八、常见问题

**Q: 为什么保守EPC可能小于CPC？**
A: 这表示每次点击的收益小于成本，会导致负ROI，即亏损。

**Q: ROI为负数意味着什么？**
A: ROI为负数表示亏损，即投入的成本大于获得的收益。

**Q: 如何判断广告是否值得投放？**
A: 如果保守ROI > 0，表示盈利，可以考虑继续投放；如果保守ROI < 0，表示亏损，需要优化或停止投放。

**Q: 点击数为0时如何处理？**
A: 点击数为0时无法计算EPC，应标记为None或"N/A"，并在结果中说明原因。

