# 🔧 问题修复手册

> 最后更新：2026-02-12
> 维护人：07

---

## 目录

1. [CORS 跨域错误](#一cors-跨域错误)
2. [API 请求超时](#二api-请求超时)
3. [数据不一致问题](#三数据不一致问题)
4. [权限角色检查错误](#四权限角色检查错误)
5. [前端缓存问题](#五前端缓存问题)
6. [数据库枚举值不匹配](#六数据库枚举值不匹配)
7. [Decimal 与 Float 类型错误](#七decimal-与-float-类型错误)
8. [服务器部署问题](#八服务器部署问题)

---

## 一、CORS 跨域错误

### 症状
```
Access to XMLHttpRequest at 'https://api.xxx.top/api/xxx' from origin 'https://xxx.top' 
has been blocked by CORS policy: No 'Access-Control-Allow-Origin' header is present
```

### 原因
1. 后端未配置 CORS 中间件
2. 请求超时导致浏览器报 CORS 错误（实际是超时）
3. 后端服务未启动或崩溃

### 解决方案

**检查后端 CORS 配置** (`app/main.py`)：
```python
from fastapi.middleware.cors import CORSMiddleware

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 生产环境建议指定具体域名
    allow_credentials=False,  # 如果 allow_origins=["*"]，必须为 False
    allow_methods=["*"],
    allow_headers=["*"],
)
```

**验证后端是否运行**：
```bash
curl http://localhost:8000/
# 应返回: {"message":"Google Analysis backend is running","docs":"/docs"}
```

**查看后端日志**：
```bash
tail -100 ~/Google-Data-Analysis/backend/nohup.out | grep -i error
```

---

## 二、API 请求超时

### 症状
- 前端显示"网络错误"或"同步失败"
- 请求长时间无响应后失败
- `net::ERR_FAILED`

### 原因
1. 同步 API 执行时间过长（>60秒）
2. 外部平台 API 响应慢
3. 数据量过大

### 解决方案

**使用后台任务模式**：
```python
import threading

def _do_sync_background(user_id: int, params: dict):
    """后台执行同步"""
    from app.database import SessionLocal
    db = SessionLocal()
    try:
        # 执行同步逻辑
        pass
    finally:
        db.close()

@router.post("/sync-realtime")
async def sync_realtime(current_user: User = Depends(get_current_user)):
    # 启动后台线程
    sync_thread = threading.Thread(
        target=_do_sync_background,
        args=(current_user.id, {})
    )
    sync_thread.daemon = True
    sync_thread.start()
    
    # 立即返回
    return {
        "success": True,
        "message": "同步已在后台开始，请稍后刷新页面",
        "background": True
    }
```

**前端处理后台任务**：
```javascript
const response = await api.post('/api/xxx/sync-realtime')
if (response.data.background) {
  message.success('同步已在后台开始，请稍后刷新页面')
  setTimeout(() => loadData(), 3000)  // 延迟刷新
}
```

---

## 三、数据不一致问题

### 症状
- 组长页面和员工页面数据对不上
- 不同页面显示的佣金/费用不一致

### 常见原因

| 原因 | 说明 | 解决方案 |
|------|------|----------|
| **日期范围不同** | 页面A默认"本月"，页面B默认"过去7天" | 统一默认日期范围 |
| **佣金计算方式不同** | 一个显示总佣金，另一个显示净佣金 | 明确字段含义，同时显示 |
| **数据同步时间不同** | 数据未及时同步 | 点击同步按钮更新数据 |
| **缓存问题** | 浏览器缓存旧版本前端 | 清除浏览器缓存 |

### 解决方案

**统一日期范围（默认本月）**：
```javascript
const [dateRange, setDateRange] = useState([
  dayjs().startOf('month'),
  dayjs().endOf('month')
])
```

**同时显示总佣金、拒付佣金、净佣金**：
```python
# 后端
total_commission = float(total_query.scalar() or 0)  # 所有状态
rejected_commission = float(rejected_query.scalar() or 0)  # status='rejected'
net_commission = total_commission - rejected_commission
```

---

## 四、权限角色检查错误

### 症状
- 登录后看不到应该看到的数据
- API 返回 403 Forbidden
- 数据过滤不正确

### 原因
代码中使用了错误的角色名称：
```python
# ❌ 错误：使用字符串 "employee"
if current_user.role == "employee":

# ❌ 错误：使用旧的枚举值
if current_user.role == UserRole.EMPLOYEE:
```

### 解决方案

**使用正确的枚举值**：
```python
from app.models.user import UserRole

# ✅ 正确：使用 UserRole 枚举
if current_user.role == UserRole.MEMBER:
    # 组员逻辑

if current_user.role == UserRole.LEADER:
    # 组长逻辑

if current_user.role == UserRole.MANAGER:
    # 经理逻辑

# ✅ 推荐：按权限判断
if current_user.role != UserRole.MANAGER:
    # 非经理，需要过滤数据
    query = query.filter(Model.user_id == current_user.id)
```

**批量检查和修复**：
```bash
# 查找所有使用错误角色名的文件
grep -r "employee" backend/app/api/*.py
grep -r "UserRole.EMPLOYEE" backend/app/
```

---

## 五、前端缓存问题

### 症状
- 代码已推送但页面没有变化
- 日期范围显示旧的默认值
- 新功能/按钮不显示

### 解决方案

**用户端清除缓存**：
- **强制刷新**：`Ctrl + Shift + R` (Windows) / `Cmd + Shift + R` (Mac)
- **开发者工具**：F12 → 右键刷新按钮 → "清空缓存并硬性重新加载"

**Cloudflare 清除缓存**：
1. 登录 Cloudflare Dashboard
2. 选择域名 → Caching → Configuration
3. 点击 "Purge Everything"

**添加版本号强制刷新**（可选）：
```html
<script src="/main.js?v=20260212"></script>
```

---

## 六、数据库枚举值不匹配

### 症状
```
sqlalchemy.exc.StatementError: 'manager' is not among the defined enum values
```

### 原因
SQLAlchemy Enum 定义与数据库存储值不匹配。

### 解决方案

**修改 Enum 列定义**：
```python
from sqlalchemy import Enum

class UserRole(str, enum.Enum):
    MANAGER = "manager"
    LEADER = "leader"
    MEMBER = "member"

# ✅ 使用 values_callable 存储枚举的 value 而不是 name
role = Column(
    Enum(UserRole, values_callable=lambda obj: [e.value for e in obj]),
    nullable=False,
    default=UserRole.MEMBER
)
```

---

## 七、Decimal 与 Float 类型错误

### 症状
```
TypeError: unsupported operand type(s) for -: 'decimal.Decimal' and 'float'
```

### 原因
SQLAlchemy 查询返回 `Decimal` 类型，与 Python `float` 运算不兼容。

### 解决方案

**显式转换为 float**：
```python
# ❌ 错误
total_cost = cost_query.scalar() or 0
total_profit = total_commission - total_cost  # TypeError!

# ✅ 正确
total_cost = float(cost_query.scalar() or 0)
total_commission = float(commission_query.scalar() or 0)
total_profit = total_commission - total_cost
```

---

## 八、服务器部署问题

### 8.1 端口被占用

**症状**：
```
ERROR: [Errno 98] error while attempting to bind on address ('0.0.0.0', 8000): address already in use
```

**解决方案**：
```bash
# 强制杀死进程
pkill -9 -f uvicorn
sleep 2

# 确认端口释放
lsof -i :8000  # 应该无输出

# 重新启动
cd ~/Google-Data-Analysis/backend
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 &
```

### 8.2 服务启动失败

**检查日志**：
```bash
tail -100 ~/Google-Data-Analysis/backend/nohup.out
```

**常见问题**：
- 缺少依赖：`pip install -r requirements.txt`
- 数据库文件权限：`chmod 644 google_analysis.db`
- 虚拟环境未激活：`source venv/bin/activate`

### 8.3 标准重启流程

```bash
cd ~/Google-Data-Analysis
git pull origin main
pkill -9 -f uvicorn
sleep 2
cd backend
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 &
sleep 3
curl http://localhost:8000/
```

---

## 九、常用诊断命令

### 后端诊断

```bash
# 查看服务状态
curl http://localhost:8000/

# 查看错误日志
tail -100 nohup.out | grep -i "error\|exception\|traceback"

# 查看最近请求
tail -50 nohup.out | grep "HTTP"

# 检查数据库
python -c "
from sqlalchemy import create_engine, text
engine = create_engine('sqlite:///google_analysis.db')
with engine.connect() as conn:
    result = conn.execute(text('SELECT COUNT(*) FROM users'))
    print(f'用户数: {result.scalar()}')
"
```

### 前端诊断

```javascript
// 浏览器控制台检查 API 响应
fetch('/api/xxx').then(r => r.json()).then(console.log)

// 查看 localStorage
console.log(localStorage.getItem('token'))

// 清除所有缓存
localStorage.clear()
sessionStorage.clear()
location.reload(true)
```

---

## 十、问题排查流程图

```
问题出现
    │
    ├─→ 前端报错？
    │       │
    │       ├─→ 网络错误/CORS → 检查后端是否运行 → 检查 CORS 配置
    │       │
    │       ├─→ 数据不显示 → 检查日期范围 → 检查权限 → 清除缓存
    │       │
    │       └─→ 功能不生效 → 清除浏览器缓存 → 清除 Cloudflare 缓存
    │
    └─→ 后端报错？
            │
            ├─→ 500 Error → 查看 nohup.out 日志 → 定位具体错误
            │
            ├─→ 403 Forbidden → 检查角色权限代码
            │
            └─→ 服务无响应 → 检查进程 → 重启服务
```

---

## 更新日志

| 日期 | 更新内容 |
|------|----------|
| 2026-02-12 | 初始版本创建 |


