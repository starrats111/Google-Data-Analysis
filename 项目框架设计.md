# 谷歌广告数据分析平台 - 项目框架设计

## 一、项目概述

### 1.1 项目背景
为广告工作室开发一个数据分析平台，自动化处理谷歌广告中心和联盟平台的数据分析工作，减少日常重复性数据搬运工作。

### 1.2 核心功能
- 用户登录认证（1个经理 + 10个员工）
- 数据表格导入（Excel/CSV格式）
- 自动数据分析（表1 + 表2 → 表3）
- 数据可视化展示
- 经理数据总览（查看所有员工数据）
- 员工个人数据查看

## 二、技术栈选择

### 2.1 后端技术
- **框架**: Flask / FastAPI（推荐FastAPI，性能更好，API文档自动生成）
- **数据库**: PostgreSQL / MySQL（存储用户信息、数据记录）
- **ORM**: SQLAlchemy
- **数据处理**: Pandas（Excel/CSV处理）
- **认证**: JWT Token
- **文件存储**: 本地文件系统 / 云存储（OSS）

### 2.2 前端技术
- **框架**: React / Vue.js（推荐React，生态更丰富）
- **UI组件库**: Ant Design / Element Plus
- **图表库**: ECharts / Chart.js
- **HTTP客户端**: Axios
- **状态管理**: Redux / Vuex

### 2.3 部署方案
- **容器化**: Docker + Docker Compose
- **Web服务器**: Nginx（反向代理）
- **进程管理**: Gunicorn / uWSGI（Python后端）

## 三、项目结构

```
google-analysis-platform/
├── backend/                    # 后端服务
│   ├── app/
│   │   ├── __init__.py
│   │   ├── main.py            # FastAPI应用入口
│   │   ├── config.py          # 配置文件
│   │   ├── database.py        # 数据库连接
│   │   ├── models/            # 数据模型
│   │   │   ├── user.py        # 用户模型
│   │   │   ├── data_upload.py # 数据上传记录
│   │   │   └── analysis.py    # 分析结果
│   │   ├── schemas/           # Pydantic模型（API请求/响应）
│   │   │   ├── user.py
│   │   │   ├── upload.py
│   │   │   └── analysis.py
│   │   ├── api/               # API路由
│   │   │   ├── auth.py        # 认证相关
│   │   │   ├── upload.py      # 文件上传
│   │   │   ├── analysis.py     # 数据分析
│   │   │   └── dashboard.py   # 数据总览
│   │   ├── services/          # 业务逻辑层
│   │   │   ├── auth_service.py
│   │   │   ├── file_service.py
│   │   │   ├── analysis_service.py
│   │   │   └── data_service.py
│   │   ├── utils/             # 工具函数
│   │   │   ├── excel_parser.py
│   │   │   ├── csv_parser.py
│   │   │   ├── data_processor.py
│   │   │   └── validators.py
│   │   └── middleware/        # 中间件
│   │       └── auth.py        # JWT认证中间件
│   ├── requirements.txt       # Python依赖
│   ├── Dockerfile
│   └── .env                   # 环境变量
│
├── frontend/                  # 前端应用
│   ├── public/
│   ├── src/
│   │   ├── components/        # 组件
│   │   │   ├── Layout/
│   │   │   │   ├── Header.jsx
│   │   │   │   ├── Sidebar.jsx
│   │   │   │   └── Layout.jsx
│   │   │   ├── Upload/
│   │   │   │   ├── FileUpload.jsx
│   │   │   │   └── UploadHistory.jsx
│   │   │   ├── Analysis/
│   │   │   │   ├── AnalysisResult.jsx
│   │   │   │   └── DataTable.jsx
│   │   │   └── Dashboard/
│   │   │       ├── ManagerDashboard.jsx
│   │   │       └── EmployeeDashboard.jsx
│   │   ├── pages/             # 页面
│   │   │   ├── Login.jsx
│   │   │   ├── Upload.jsx
│   │   │   ├── Analysis.jsx
│   │   │   └── Dashboard.jsx
│   │   ├── services/          # API服务
│   │   │   ├── api.js
│   │   │   └── auth.js
│   │   ├── store/             # 状态管理
│   │   │   ├── authSlice.js
│   │   │   └── dataSlice.js
│   │   ├── utils/             # 工具函数
│   │   │   └── request.js
│   │   ├── App.jsx
│   │   └── index.js
│   ├── package.json
│   ├── Dockerfile
│   └── .env
│
├── excel/                     # 参考数据表格（已存在）
│   ├── 表1.xlsx
│   ├── 表2.csv
│   ├── 表3.csv
│   ├── 表4.xlsx
│   └── 表5.xlsx
│
├── docker-compose.yml         # Docker编排
├── nginx.conf                 # Nginx配置
└── README.md                  # 项目说明
```

## 四、数据库设计

### 4.1 用户表 (users)
```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    role VARCHAR(20) NOT NULL,  -- 'manager' 或 'employee'
    employee_id INTEGER,         -- 员工编号（1-10），经理为NULL
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.2 联盟平台表 (affiliate_platforms)
```sql
CREATE TABLE affiliate_platforms (
    id SERIAL PRIMARY KEY,
    platform_name VARCHAR(100) NOT NULL UNIQUE,  -- 联盟平台名称（如：Amazon、CJ等）
    platform_code VARCHAR(50) NOT NULL UNIQUE,  -- 平台代码
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.3 联盟账号表 (affiliate_accounts)
```sql
CREATE TABLE affiliate_accounts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,  -- 所属员工
    platform_id INTEGER REFERENCES affiliate_platforms(id),  -- 所属联盟平台
    account_name VARCHAR(100) NOT NULL,  -- 账号名称/标识
    account_code VARCHAR(50),  -- 账号代码（可选）
    is_active BOOLEAN DEFAULT TRUE,  -- 是否激活
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, platform_id, account_name)  -- 同一员工在同一平台不能有重复账号名
);
```

### 4.4 数据上传记录表 (data_uploads)
```sql
CREATE TABLE data_uploads (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    affiliate_account_id INTEGER REFERENCES affiliate_accounts(id),  -- 联盟账号ID（仅affiliate类型需要）
    upload_type VARCHAR(20) NOT NULL,  -- 'google_ads' 或 'affiliate'
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    upload_date DATE NOT NULL,         -- 数据日期（前7天中的某一天）
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    status VARCHAR(20) DEFAULT 'pending'  -- 'pending', 'processing', 'completed', 'failed'
);
```

### 4.5 分析结果表 (analysis_results)
```sql
CREATE TABLE analysis_results (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    affiliate_account_id INTEGER REFERENCES affiliate_accounts(id),  -- 关联的联盟账号
    upload_id_google INTEGER REFERENCES data_uploads(id),  -- 表1的上传ID
    upload_id_affiliate INTEGER REFERENCES data_uploads(id), -- 表2的上传ID
    analysis_date DATE NOT NULL,
    result_data JSONB,  -- 存储分析结果（表3的数据）
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 4.4 数据字典表 (data_dictionary)
```sql
CREATE TABLE data_dictionary (
    id SERIAL PRIMARY KEY,
    field_name VARCHAR(100) NOT NULL,
    field_description TEXT,  -- 字段含义（来自表4、表5）
    category VARCHAR(50),    -- 所属类别
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 五、核心功能模块设计

### 5.1 用户认证模块
**功能点：**
- 用户登录（用户名+密码）
- JWT Token生成和验证
- 角色权限控制（经理/员工）
- 密码加密存储（bcrypt）

**API接口：**
- `POST /api/auth/login` - 用户登录
- `POST /api/auth/logout` - 用户登出
- `GET /api/auth/me` - 获取当前用户信息

### 5.2 联盟账号管理模块
**功能点：**
- 员工管理自己的联盟账号（至少3个，可扩展）
- 为每个账号指定所属的联盟平台
- 账号的激活/停用管理
- 账号列表查看和搜索

**API接口：**
- `GET /api/affiliate-accounts` - 获取联盟账号列表（员工只能看自己的，经理可看所有）
- `POST /api/affiliate-accounts` - 创建联盟账号
- `PUT /api/affiliate-accounts/{id}` - 更新联盟账号
- `DELETE /api/affiliate-accounts/{id}` - 删除联盟账号
- `GET /api/affiliate-platforms` - 获取联盟平台列表

### 5.3 文件上传模块
**功能点：**
- 支持Excel (.xlsx, .xls) 和 CSV 格式
- 文件类型验证（表1：谷歌广告数据，表2：联盟数据）
- **上传联盟数据时必须选择对应的联盟账号**
- 文件大小限制（如：10MB）
- 文件存储和路径记录
- 上传历史记录（按联盟账号筛选）

**API接口：**
- `POST /api/upload/google-ads` - 上传谷歌广告数据（表1）
- `POST /api/upload/affiliate` - 上传联盟数据（表2，需指定联盟账号ID）
- `GET /api/upload/history` - 获取上传历史（支持按联盟账号筛选）
- `GET /api/upload/{id}` - 获取上传记录详情

### 5.4 数据分析模块
**功能点：**
- 读取表1和表2的数据
- 根据业务规则进行数据匹配和分析
- 生成表3格式的分析结果
- **分析结果关联到对应的联盟账号**
- 数据验证和错误处理
- 异步处理（大文件分析）

**API接口：**
- `POST /api/analysis/process` - 触发数据分析（需指定联盟账号）
- `GET /api/analysis/result/{id}` - 获取分析结果
- `GET /api/analysis/list` - 获取分析结果列表（支持按联盟账号、平台筛选）
- `GET /api/export/analysis` - 导出分析结果（Excel格式，使用表6模板）⭐
- `GET /api/export/dashboard` - 导出数据总览（经理专用，Excel格式）⭐

### 5.5 数据总览模块（经理专用）
**功能点：**
- 查看所有员工的数据上传情况
- 查看所有员工的分析结果
- **按员工查看不同联盟账号的数据** ⭐
- **按联盟平台查看整个工作室的数据** ⭐
- **按员工+联盟账号组合查看数据** ⭐
- 数据汇总统计（支持多维度）
- 图表可视化
- 按日期、员工、联盟账号、联盟平台筛选

**API接口：**
- `GET /api/dashboard/overview` - 获取总览数据
- `GET /api/dashboard/employees` - 获取所有员工数据
- `GET /api/dashboard/employee-accounts` - 获取员工及其联盟账号列表
- `GET /api/dashboard/platform-summary` - 获取各联盟平台的数据汇总 ⭐
- `GET /api/dashboard/account-details` - 获取指定联盟账号的详细数据 ⭐
- `GET /api/dashboard/statistics` - 获取统计数据（支持多维度筛选）
- `GET /api/dashboard/charts` - 获取图表数据（支持按平台、账号分组）

### 5.6 个人数据模块（员工）
**功能点：**
- 查看自己的数据上传记录
- 查看自己的分析结果
- **按联盟账号查看自己的数据** ⭐
- **按联盟平台查看自己的数据** ⭐
- 数据可视化
- 历史数据查询

**API接口：**
- `GET /api/user/upload-history` - 获取个人上传历史（支持按联盟账号筛选）
- `GET /api/user/analysis-results` - 获取个人分析结果（支持按联盟账号、平台筛选）
- `GET /api/user/statistics` - 获取个人统计数据（支持按账号、平台分组）
- `GET /api/user/account-summary` - 获取个人各联盟账号的数据汇总 ⭐

## 六、前端页面设计

### 6.1 登录页面
- 用户名/密码输入
- 登录按钮
- 错误提示

### 6.2 主页面布局
- 顶部导航栏（用户信息、退出）
- 侧边栏菜单（根据角色显示不同菜单）
- 主内容区

### 6.3 联盟账号管理页面（员工）
- 联盟账号列表展示
- 添加新账号（选择联盟平台、输入账号名称）
- 编辑/删除账号
- 账号激活/停用切换
- 账号搜索和筛选

### 6.4 数据上传页面
- 文件选择器
- 上传类型选择（谷歌广告/联盟数据）
- **上传联盟数据时需选择联盟账号** ⭐
- 数据日期选择（前7天）
- 上传进度显示
- 上传历史列表（支持按联盟账号筛选）

### 6.4 联盟账号管理页面（员工）
- 联盟账号列表展示
- 添加新账号（选择联盟平台、输入账号名称）
- 编辑/删除账号
- 账号激活/停用切换
- 账号搜索和筛选

### 6.5 数据上传页面
- 文件选择器
- 上传类型选择（谷歌广告/联盟数据）
- **上传联盟数据时需选择联盟账号** ⭐
- 数据日期选择（前7天）
- 上传进度显示
- 上传历史列表（支持按联盟账号筛选）

### 6.6 分析结果页面
- 数据表格展示（表3格式）
- 数据筛选和搜索（支持按联盟账号、平台筛选）
- 导出功能
- 数据字典说明（表4、表5内容）

### 6.7 数据总览页面（经理）
- **多维度数据查看** ⭐
  - 按员工查看
  - 按联盟平台查看（整个工作室）
  - 按员工+联盟账号查看
- 数据汇总卡片（支持多维度统计）
- 图表展示（折线图、柱状图等，支持按平台、账号分组）
- 筛选器（日期范围、员工、联盟账号、联盟平台）
- **联盟平台数据对比** ⭐
- **员工账号数据对比** ⭐

### 6.8 个人数据页面（员工）
- 个人数据统计
- **按联盟账号分组展示** ⭐
- **按联盟平台分组展示** ⭐
- 上传记录（支持按账号筛选）
- 分析结果列表（支持按账号、平台筛选）
- 简单图表（支持多账号对比）

## 七、数据分析逻辑设计

### 7.1 核心计算公式

**1. 保守EPC（Earnings Per Click）**
```
保守EPC = 保守佣金 / 点击
```
- **数据来源**: 
  - 保守佣金：来自表2（联盟数据）
  - 点击：来自表1（谷歌广告数据）⭐ **从表1提取**
- **单位**: 货币单位（如：元、美元）
- **说明**: 表示每次点击的平均收益

**2. 保守ROI（Return on Investment）**
```
保守ROI = (保守EPC - CPC) / CPC × 100%
```
- **数据来源**: 保守EPC通过公式1计算得出，CPC来自表1（谷歌广告数据）
- **单位**: 百分比（%）
- **说明**: 表示投资回报率，正值表示盈利，负值表示亏损

### 7.2 数据字段来源
- **表1（谷歌广告数据）包含**:
  - 点击 ⭐ **从表1提取**
  - CPC（每次点击成本）
  - 其他字段（日期、广告ID、关键词等）

- **表2（联盟数据）包含**:
  - 订单数 ⭐ **从表2提取**
  - 保守佣金
  - 其他字段（日期、广告ID、订单ID等）

### 7.3 数据匹配规则
需要根据表1和表2的实际字段进行设计，一般包括：
- **按日期匹配**: 确保是同一天的数据
- **按广告ID/关键词匹配**: 确保是同一个广告的数据
- **数据聚合计算**: 如果有多条记录，需要先聚合
- **效果指标计算**: 使用上述公式计算EPC和ROI

### 7.4 分析流程
1. 验证上传的文件格式和内容
2. 解析Excel/CSV文件（表1和表2）
3. 数据清洗和标准化
4. **从表1提取点击数据**
5. **从表2提取订单数数据**
6. 按日期和广告ID匹配表1和表2的数据
7. 计算保守EPC = 保守佣金 / 点击（点击来自表1，保守佣金来自表2）
8. 计算保守ROI = (保守EPC - CPC) / CPC × 100%
9. 生成表3格式的结果（包含：点击、订单数、保守佣金、保守EPC、保守ROI等）
10. 保存到数据库
11. 返回结果给前端

### 7.4 异常情况处理
- **点击数为0**: 保守EPC无法计算，标记为None或"N/A"
- **CPC为0**: 保守ROI无法计算，标记为None或"N/A"
- **数据缺失**: 无法匹配的数据单独标记
- **异常值**: 处理无穷大和NaN值

## 八、安全设计

### 8.1 认证安全
- JWT Token过期时间设置
- 密码加密存储
- 登录失败次数限制

### 8.2 数据安全
- 文件上传类型验证
- 文件大小限制
- SQL注入防护（使用ORM）
- XSS防护（前端转义）

### 8.3 权限控制
- 经理可以查看所有数据
- 员工只能查看自己的数据
- API接口权限验证

## 九、开发计划

### 阶段一：基础框架搭建（1-2周）
- 项目初始化
- 数据库设计
- 用户认证模块
- 基础API框架

### 阶段二：核心功能开发（2-3周）
- 文件上传功能
- 数据分析逻辑
- 数据展示功能

### 阶段三：高级功能（1-2周）
- 数据总览（经理）
- 图表可视化
- 数据导出

### 阶段四：测试和优化（1周）
- 功能测试
- 性能优化
- 用户体验优化

### 阶段五：部署上线（1周）
- Docker容器化
- 服务器部署
- 域名配置

## 十、技术难点和解决方案

### 10.1 Excel文件解析
- 使用pandas + openpyxl处理Excel
- 处理中文编码问题
- 处理大文件（分块读取）

### 10.2 数据分析性能
- 异步任务处理（Celery + Redis）
- 数据缓存
- 数据库索引优化

### 10.3 数据匹配准确性
- 需要仔细分析表1、表2、表3的字段关系
- 建立匹配规则配置表
- 支持规则调整

## 十一、后续扩展功能

- 数据自动导入（API对接）
- 邮件报告自动发送
- 数据对比分析（多日期对比）
- 自定义分析规则
- 移动端适配

---

**注意事项：**
1. 需要先分析表1、表2、表3的实际数据结构，确定匹配规则
2. 表4、表5作为数据字典，需要在系统中展示给用户
3. 考虑数据量增长，设计合理的数据库索引
4. 做好数据备份和恢复机制

