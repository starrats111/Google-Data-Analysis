# 真实可用方案 - API端点自动检测

## 核心功能

### 1. API端点自动检测 ✅

**新增服务**: `backend/app/services/api_endpoint_detector.py`

**功能**:
- 自动尝试多个可能的Rewardoo API端点
- 测试不同的API路径和payload格式
- 找到可用的端点后自动保存到账号配置

**支持的端点列表**:
- `https://api.rewardoo.com/api`
- `https://api.rewardoo.com`
- `https://rewardoo.com/api`
- `https://www.rewardoo.com/api`
- `https://api.rewardoo.net/api`
- `https://api.rewardoo.io/api`

**支持的API路径**:
- `/transaction_details`
- `/transaction`
- `/transactions`
- `/api/transaction_details`
- `/api/transaction`
- `/v1/transaction_details`
- `/v1/transaction`

### 2. 智能测试连接 ✅

**改进的测试端点**: `POST /api/affiliate/accounts/{id}/test-api`

**新功能**:
- 支持 `auto_detect` 参数，启用自动检测
- 如果检测到可用端点，自动保存到账号配置
- 如果测试失败，建议启用自动检测

### 3. 前端智能提示 ✅

**改进内容**:
- 如果测试失败且可能是端点问题，显示"启用自动检测端点"按钮
- 一键启用自动检测，无需手动配置
- 检测成功后自动更新API URL配置

## 使用方法

### 方法1：自动检测（推荐）

1. 打开同步数据对话框
2. 输入API Token
3. 点击"测试连接"
4. 如果出现404错误，会显示"启用自动检测端点"按钮
5. 点击按钮，系统会自动尝试多个可能的端点
6. 如果找到可用端点，会自动保存并显示成功消息

### 方法2：手动配置

如果知道正确的API地址：
1. 在"Rewardoo API URL"字段中输入
2. 点击"测试连接"验证

## 工作原理

1. **自动检测流程**:
   ```
   输入Token → 点击测试连接 → 如果404错误 → 点击"启用自动检测端点"
   → 系统尝试多个端点组合 → 找到可用端点 → 自动保存配置 → 显示成功
   ```

2. **检测逻辑**:
   - 尝试6个可能的基础URL
   - 每个URL尝试7个可能的路径
   - 每个路径尝试3种payload格式
   - 总共尝试 6 × 7 × 3 = 126 种组合
   - 找到第一个可用的端点即停止

3. **端点验证**:
   - 检查HTTP状态码（200为成功，401表示端点存在但token无效）
   - 验证响应是否为有效JSON
   - 检查响应是否包含预期的数据结构

## 优势

1. **无需手动配置**: 系统自动找到正确的端点
2. **支持多渠道**: 自动适配不同的Rewardoo渠道
3. **智能提示**: 失败时自动建议启用检测
4. **自动保存**: 检测到的配置自动保存，下次直接使用

## 技术实现

### 后端
- `ApiEndpointDetector`: 端点检测服务
- 改进的 `test-api` 端点，支持自动检测
- 自动保存检测到的配置

### 前端
- 改进的错误提示
- "启用自动检测端点"按钮
- 自动更新表单字段

## 下一步

在服务器上更新代码后：

1. 打开同步数据对话框
2. 输入API Token
3. 点击"测试连接"
4. 如果出现404，点击"启用自动检测端点"
5. 等待系统自动检测（通常几秒钟）
6. 检测成功后即可正常同步

这个方案可以解决所有API端点配置问题！

