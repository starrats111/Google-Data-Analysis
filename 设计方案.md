# 网站功能优化1.0

> **设计人员：** AI设计师  
> **验收人员：** 07  
> **审核状态：** ✅ OPT-001~005 终审通过 ｜ ⏳ OPT-006 待审核  
> **编写日期：** 2026-02-27  
> **当前迭代：** 1.5  
> **涉及系统：** 谷歌广告数据分析平台

---

## 一、优化项总览

本次优化共 6 项功能，编号 OPT-001 ~ OPT-006：

| 编号 | 功能名称 | 变更类型 | 优先级 | 涉及端 |
|------|----------|----------|--------|--------|
| OPT-001 | 全局消息提醒系统 | 新增功能 | P0 | 前端 + 后端 |
| OPT-002 | 拒付佣金变动检测 | 新增功能 | P0 | 后端 |
| OPT-003 | 已付佣金展示 | 功能优化 | P1 | 前端 |
| OPT-004 | ROI 计算公式修改 | 功能优化 | P1 | 前端 |
| OPT-005 | MCC 数据同步双模式（API/脚本） | 新增功能 | P0 | 前端 + 后端 |
| OPT-006 | 更新日志弹窗 | 新增功能 | P1 | 前端 |

> OPT-001 和 OPT-002 配合使用：OPT-002 负责检测拒付佣金变动并生成通知，OPT-001 负责在页面上展示通知。  
> OPT-005 为 Google Ads API 配额不足时的备用方案：通过 MCC 脚本导出数据到 Google Sheets，后端自动读取，实现零 API 配额消耗的数据同步。

### 实施状态（截至 2026-03-02）

| 编号 | 功能名称 | 状态 | 说明 |
|------|----------|------|------|
| OPT-001 | 全局消息提醒系统 | ✅ 已开发 | Header 铃铛+未读角标+下拉通知列表，后端 /api/notifications 四接口+权限，60s 轮询 |
| OPT-002 | 拒付佣金变动检测 | ✅ 已开发 | 定时任务 06:00、快照与通知写入、补跑策略、_sync_lock 互斥 |
| OPT-003 | 已付佣金展示 | ⏳ 待开发 | 设计已通过 |
| OPT-004 | ROI 计算公式修改 | ⏳ 待开发 | 设计已通过 |
| OPT-005 | MCC 双模式（API/脚本） | ✅ 已开发 | MCC 编辑页同步模式+Sheet URL，后端 sync_mode 等 5 字段+Alembic 004，Sheets 同步服务，04:00 双模式，script-template/sync-sheet/test-sheet 接口 |
| OPT-006 | 更新日志弹窗 | ✅ 已上线 | 已实现：Header「更新日志」按钮 + 登录自动弹窗 + 历史版本 Collapse |

---

## 二、OPT-001 全局消息提醒系统

### 2.1 功能描述

在网站顶部 Header 右侧、用户头像左边，新增铃铛图标消息提醒入口。该组件为**全局组件**，所有页面均可见（不仅限于数据中心页面）。点击铃铛展开下拉通知列表，支持已读/未读标记。

### 2.2 UI 位置示意

```
┌─────────────────────────────────────────────────────────────┐
│  谷歌广告数据分析平台              [🔔 3]  👤 wj07  员工    │
│                                     ↑                       │
│                              铃铛+红点角标                   │
└─────────────────────────────────────────────────────────────┘
```

- 位置：Header 右侧，用户头像 **左边**
- 组件：Ant Design `BellOutlined` 图标 + `Badge` 红色数字角标
- 点击行为：弹出 `Popover` 下拉面板（宽度约 360px）

### 2.3 下拉面板内容

```
┌──────────────────────────────────┐
│  消息通知                 全部已读 │
├──────────────────────────────────┤
│ 🔴 上月拒付佣金变动               │
│    1月拒付佣金从 $100 增至 $115   │
│    2026-02-04 06:00              │
├──────────────────────────────────┤
│ 🔴 本月拒付佣金异常               │
│    本月拒付佣金日增 $120 > $100   │
│    2026-02-27 06:00              │
├──────────────────────────────────┤
│ ⚪ 上月拒付佣金变动（已读）        │
│    1月拒付佣金从 $100 增至 $110   │
│    2026-02-02 06:00              │
├──────────────────────────────────┤
│          查看更多 ↓               │
└──────────────────────────────────┘
```

- 🔴 = 未读，⚪ = 已读
- 点击单条通知 → 标记为已读
- 「全部已读」按钮 → 批量标记
- 下拉面板默认展示最近 20 条，底部「查看更多」支持滚动加载

### 2.4 数据权限

> 🔧 **审核修正（S-04）：** 补充 leader 角色权限，与实际 `user.py` 中的 4 种角色对齐。  
> 🔧 **迭代 1.2 确认：** team_id 不允许为空，系统强制每个用户必须分组。

| 角色 | 枚举值 | 可见范围 |
|------|--------|----------|
| 经理 | manager | 所有用户的通知 |
| 组长 | leader | 本组成员的通知（通过 `team_id` 关联查询） |
| 组员 | member | 仅自己的通知 |
| 员工 | employee（兼容旧数据） | 仅自己的通知 |

**team_id 强制分组约束（迭代 1.2 新增，迭代 1.3 修正）：**

> 🔧 **审核修正（S-05）：** 直接改 `NOT NULL` 会导致 SQLite 迁移失败（SQLite 不支持 `ALTER COLUMN`），且现有数据可能存在 `team_id = NULL` 的用户。改为分两步走方案。

**第一步（应用层强制校验，本次实施）：**

- 后端校验：`team_management.py` 中 `UserCreate.team_id` 从 `Optional[int] = None` 改为 `int`（必填），`UserUpdate.team_id` 保持 `Optional`（允许不修改，但不允许设为 NULL）
- 前端校验：用户管理表单中，「所属分组」为必选下拉框，不可留空
- 数据修复脚本：编写 Alembic 数据迁移，将现有 `team_id = NULL` 的用户分配到默认分组（需先确认或创建默认分组）
- 数据库层面 `team_id` 暂时保持 `nullable=True`，不修改列约束

**第二步（数据库约束，后续迭代）：**

- 确认所有用户均已分配分组后，通过 Alembic 迁移重建 `users` 表，将 `team_id` 改为 `NOT NULL`
- SQLite 重建表步骤：创建新表 → 复制数据 → 删除旧表 → 重命名新表
- 此步骤风险较高，需在维护窗口执行，并提前备份数据库

**回滚方案：** 如果应用层校验导致问题，只需回滚代码即可，数据库无需变更。

**影响范围：**
- leader 角色的通知查询依赖 `team_id`，应用层强制校验后，新用户必定有 `team_id`
- 对于历史 `team_id = NULL` 的用户，通知查询中增加 NULL 保护：`team_id IS NOT NULL` 条件

API 查询逻辑：
- `manager`：不加 `user_id` 过滤，返回全部通知
- `leader`：查询 `user_id IN (SELECT id FROM users WHERE team_id = 当前用户.team_id)`
- `member` / `employee`：`WHERE user_id = 当前用户.id`

### 2.5 数据刷新策略

- 页面首次加载时获取未读数量
- 之后每 60 秒轮询一次 `/api/notifications/unread-count`
- 点击铃铛时实时拉取通知列表

### 2.6 新增数据库表

**表名：`notifications`**

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 主键 |
| user_id | INTEGER FK → users.id | 通知归属用户 |
| type | VARCHAR(50) | 通知类型：`rejected_monthly` / `rejected_daily` / `system_announcement` / `sync_error`（预留扩展） |
| title | VARCHAR(200) | 通知标题 |
| content | TEXT | 通知详细内容 |
| is_read | BOOLEAN DEFAULT FALSE | 是否已读 |
| created_at | DATETIME | 创建时间 |

> 🔧 **审核修正（L-03）：** 补充索引定义。

**索引：**

```python
Index("idx_notification_user_created", "user_id", "created_at")
Index("idx_notification_user_read", "user_id", "is_read")
```

新建文件：`backend/app/models/notification.py`

> 🔧 **审核修正（L-02）：** 增加通知过期清理策略。

**通知清理策略：**
- 在定时任务中增加清理逻辑：每月 1 号自动删除 90 天前的已读通知
- 清理 SQL：`DELETE FROM notifications WHERE is_read = TRUE AND created_at < datetime('now', '-90 days')`
- **未读通知保护：** 超过 180 天的未读通知自动标记为已读（防止长期不登录用户的通知无限累积）
- 清理 SQL：`UPDATE notifications SET is_read = TRUE WHERE is_read = FALSE AND created_at < datetime('now', '-180 days')`
- 可在后续版本实现，不阻塞本次上线

### 2.7 数据库迁移方案

> 🔧 **审核修正（S-02）：** 补充数据库迁移方案，避免部署后 `no such table` 错误。  
> 🔧 **审核修正（S-07）：** 统一使用 Alembic 迁移，不再使用 `create_all()`，避免与 OPT-005 的 Alembic 策略冲突。

**采用 Alembic 统一迁移（迭代 1.3 修正）：**

项目已有 Alembic 基础设施（`backend/alembic/` 目录，含 2 个历史迁移版本 001、002），所有数据库变更统一走 Alembic。

**迁移脚本内容（版本 003）：**

```bash
alembic revision --autogenerate -m "add_notifications_and_commission_snapshots"
```

该迁移将创建 `notifications` 和 `commission_snapshots` 两张新表。

**部署步骤：**

```bash
cd backend
alembic upgrade head
```

**回滚命令：**

```bash
alembic downgrade -1
```

> 不再在 `startup_event()` 中使用 `Base.metadata.create_all()`，避免与 Alembic 的 `autogenerate` 检测冲突。

修改文件：`backend/app/main.py` — 仅注册新路由，不添加 `create_all()` 逻辑。

### 2.8 新增 API 接口

新建文件：`backend/app/api/notifications.py`

> 🔧 **审核修正（M-01）：** 通知列表接口增加分页参数。

| 方法 | 路径 | 参数 | 说明 |
|------|------|------|------|
| GET | `/api/notifications` | `page`（默认1）、`page_size`（默认20） | 获取通知列表（分页，按角色权限过滤） |
| GET | `/api/notifications/unread-count` | - | 获取未读数量（铃铛角标数字） |
| PUT | `/api/notifications/{id}/read` | - | 标记单条为已读 |
| PUT | `/api/notifications/read-all` | - | 全部标记已读 |

**API 权限校验规则（迭代 1.3 新增，修正 M-06）：**

| 接口 | 权限校验 |
|------|----------|
| `GET /api/notifications` | 按角色过滤（2.4 节逻辑），只返回当前用户有权查看的通知 |
| `GET /api/notifications/unread-count` | 同上，只统计当前用户有权查看的未读通知 |
| `PUT /api/notifications/{id}/read` | 校验该通知是否属于当前用户可见范围（防止越权标记他人通知）；不在可见范围内返回 `403 Forbidden` |
| `PUT /api/notifications/read-all` | 只标记当前用户**有权查看**的通知为已读（manager 标记全部，leader 标记本组，member/employee 标记自己的） |

权限过滤统一在 SQL 层实现（通过 `WHERE` 条件），不在应用层做二次过滤，确保性能和一致性。

**分页响应格式：**

```json
{
  "items": [...],
  "total": 120,
  "page": 1,
  "page_size": 20,
  "total_pages": 6
}
```

在 `backend/app/main.py` 中注册新路由。

### 2.9 前端修改

修改文件：`frontend/src/components/Layout/index.jsx`

在 Header 右侧区域，`<Dropdown>` 用户头像下拉菜单组件之前，插入铃铛通知组件。

---

## 三、OPT-002 拒付佣金变动检测

### 3.1 功能描述

通过后端定时任务，每天自动检测每个用户的拒付佣金是否发生变动。有变动时自动生成通知，写入 `notifications` 表，由 OPT-001 的消息提醒系统展示给用户。

### 3.2 检测规则

**规则A — 本月日变动提醒（type: `rejected_daily`）**

| 项目 | 说明 |
|------|------|
| 对比对象 | 本月拒付佣金「昨天累计值」 vs 「今天累计值」 |
| 触发条件 | 差额 > 阈值（默认 100 USD，可配置） |
| 示例 | 昨天本月拒付佣金累计 $500，今天变为 $620，差额 $120 > $100 → 触发提醒 |
| 通知标题 | "本月拒付佣金异常" |
| 通知内容 | "本月拒付佣金日增 $120（从 $500 增至 $620），超过 $100 阈值" |

> 🔧 **审核修正（M-03）：** 阈值配置化，不再硬编码。

**阈值配置：** 在 `backend/app/config.py` 中新增配置项：

```python
# 拒付佣金日变动检测阈值（USD）
REJECTED_COMMISSION_DAILY_THRESHOLD: float = 100.0
```

**规则B — 上月变动提醒（type: `rejected_monthly`）**

| 项目 | 说明 |
|------|------|
| 对比对象 | 上月拒付佣金「当前总额」 vs 「上次快照总额」 |
| 触发条件 | 金额有任何变化（不论增减） |
| 不触发条件 | 金额与上次快照相同 → 不操作 |
| 示例 | 2/1 检测到1月拒付 $100 → 记录快照；2/2 变为 $110 → 提醒+更新快照；2/3 仍为 $110 → 不提醒；2/4 变为 $115 → 提醒+更新快照 |
| 通知标题 | "上月拒付佣金变动" |
| 通知内容 | "1月拒付佣金从 $100 增至 $115（变动 +$15）" |

### 3.3 数据查询定义

> 🔧 **审核修正（S-03）：** 明确数据查询的日期字段、范围、NULL 处理和精度。

| 项目 | 定义 |
|------|------|
| 日期筛选字段 | `transaction_time`（与前端展示一致，非 `created_at`） |
| 本月日期范围 | 本月1号 `00:00:00` 至 昨天 `23:59:59`（06:30 执行时今天数据可能未同步完，排除今天） |
| 上月日期范围 | 上月1号 `00:00:00` 至 上月最后一天 `23:59:59` |
| 状态筛选 | `status = 'rejected'` |
| 聚合维度 | 按 `user_id` 聚合 |
| `user_id` 为 NULL 处理 | 通过 `affiliate_account_id` 关联 `affiliate_accounts` 表反查 `user_id`；若仍无法关联，归入「未分配」汇总，生成一条通知发送给 manager 角色用户 |
| 金额字段 | `commission_amount`（`Numeric(12,2)` 类型） |

### 3.4 快照数据库表

**表名：`commission_snapshots`**

> 🔧 **审核修正（M-04）：** `snapshot_type` 命名改为更精确的 `current_month` / `previous_month`。  
> 🔧 **审核修正（S-03）：** `total_rejected` 类型改为 `Numeric(12,2)`，与交易表精度一致。

| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER PK | 主键 |
| user_id | INTEGER FK → users.id | 用户 |
| snapshot_type | VARCHAR(20) | 类型：`current_month`（本月累计快照）/ `previous_month`（上月总额快照） |
| period | VARCHAR(20) | 期间标识，如 `"2026-01"`（代表1月份） |
| total_rejected | Numeric(12,2) | 该期间拒付佣金总额 |
| checked_at | DATETIME | 检测时间 |
| created_at | DATETIME | 创建时间 |

新建文件：`backend/app/models/commission_snapshot.py`

> 🔧 **审核修正（L-07）：** 补充唯一约束，防止重复快照记录。

**唯一约束：**

```python
UniqueConstraint("user_id", "snapshot_type", "period", name="uq_commission_snapshot_user_type_period")
```

### 3.5 定时任务配置

> 🔧 **审核修正（S-01）：** 执行时间从 06:00 改为 **06:30**，避免与 backfill 任务冲突。  
> 🔧 **审核修正（S-06）：** backfill 实际在 05:00 执行（非设计方案之前声称的 06:00）。拒付佣金检测改为 **06:00**，与 backfill 间距 60 分钟，足够安全。

修改文件：`backend/app/services/scheduler.py`

- 新增函数：`check_rejected_commission_job()`
- 在 `start_scheduler()` 中注册，执行时间：每天北京时间 **06:00**
- 选择 06:00 的原因：backfill 任务在 05:00 执行，通常耗时 10-20 分钟，06:00 已有 60 分钟间距，足够安全
- **前置检查：** 执行前检测 backfill 任务是否仍在运行，若仍在运行则跳过并触发补跑

**补跑策略（迭代 1.2 新增）：**

> 🔧 **迭代 1.2 确认：** 06:00 检测若因 backfill 未完成而跳过，最多补跑 3 次，仍失败则放弃。

- 06:00 首次执行：检测 backfill 是否仍在运行
  - 若 backfill 已完成 → 正常执行检测
  - 若 backfill 仍在运行 → 跳过，记录日志，触发补跑调度
- 补跑时间：**06:30 → 07:00 → 07:30**（间隔 30 分钟，最多 3 次）
- 每次补跑前仍检测 backfill 状态
- 3 次补跑均失败 → 放弃本日检测，记录 `WARNING` 级别日志：`"拒付佣金检测：连续 3 次补跑均因 backfill 未完成而跳过，放弃本日检测"`
- 实现方式：使用 APScheduler `add_job()` 动态添加一次性补跑任务（`trigger='date'`）
- **互斥锁保护：** 拒付佣金检测任务纳入全局 `_sync_lock` 保护范围，避免与 backfill 同时写入 SQLite 导致 `database is locked`

### 3.6 检测流程

> 🔧 **审核修正（M-05）：** 快照更新和通知写入必须在同一个数据库事务中完成。

```
check_rejected_commission_job() 执行流程：

0. 前置检查：若 backfill 任务仍在运行 → 记录日志，跳过本次检测
1. 获取所有活跃用户列表
2. 遍历每个用户：
   │
   ├─ 规则A：本月日变动检测
   │   ├─ 查询本月拒付佣金总额
   │   │   └─ SQL: SELECT SUM(commission_amount) FROM affiliate_transactions
   │   │          WHERE user_id = ? AND status = 'rejected'
   │   │          AND transaction_time BETWEEN 本月1号00:00:00 AND 昨天23:59:59
   │   │   └─ user_id 为 NULL 时：JOIN affiliate_accounts 反查 user_id
   │   ├─ 从 commission_snapshots 取 snapshot_type='current_month'、period=本月 的最近一条
   │   ├─ 计算差额 = 当前总额 - 快照总额
   │   ├─ 差额 > 阈值（config.REJECTED_COMMISSION_DAILY_THRESHOLD）：
   │   │   └─ 在同一事务中：生成通知 + 更新快照
   │   └─ 差额 <= 阈值：仅更新快照（不生成通知）
   │
   └─ 规则B：上月变动检测
       ├─ 查询上月拒付佣金总额
       │   └─ SQL: 同上，日期范围改为上月1号~上月最后一天
       ├─ 从 commission_snapshots 取 snapshot_type='previous_month'、period=上月 的最近一条
       ├─ 当前总额 != 快照总额：
       │   └─ 在同一事务中：生成通知 + 插入新快照
       └─ 当前总额 == 快照总额 → 不操作
```

**事务保护示例：**

```python
with db.begin():
    # 写入通知
    db.add(notification)
    # 更新/插入快照
    db.add(snapshot)
# 事务自动提交，任一失败自动回滚
```

### 3.7 更新后的定时任务时间线

> 🔧 **审核修正（S-01）：** 拒付佣金检测从 06:00 改为 06:30。  
> 🔧 **审核修正（S-06）：** backfill 实际在 05:00 执行，时间线与代码对齐。拒付佣金检测改为 06:00。

| 时间（北京） | 任务 | 状态 |
|-------------|------|------|
| 03:00 | 数据库自动备份 | 已有 |
| 04:00 | 每日同步（Google Ads + 平台数据 + 分析 + L7D） | 已有 |
| 05:00 | Backfill 历史数据补齐 | 已有 |
| **06:00** | **拒付佣金变动检测**（含前置检查 + 补跑策略） | **新增** |
| 16:00 | 平台数据补充同步 | 已有 |
| 每月1/15号 00:00 | 已付佣金同步 | 已有 |

---

## 四、OPT-003 已付佣金展示

### 4.1 功能描述

在数据中心页面的「平台数据」tab 中，新增已付佣金（approved 状态的佣金）的展示。包括统计卡片和表格列，汇总模式和明细模式均展示。

### 4.2 修改文件

`frontend/src/pages/DataCenter.jsx`

### 4.3 统计卡片区域变更

当前卡片顺序（6个）：

```
总佣金 | 拒付佣金 | 净佣金 | 总订单 | ROI | 视图切换
```

修改后卡片顺序（7个）：

```
总佣金 | 已付佣金✨ | 拒付佣金 | 净佣金 | 总订单 | ROI | 视图切换
```

已付佣金卡片样式：
- 标题：`已付佣金`
- 前缀：`$`
- 精度：2位小数
- 颜色：绿色（`#52c41a`）

### 4.4 汇总模式表格变更

在 `platformSummaryColumns` 中，「总佣金($)」列之后添加「已付佣金($)」列：

| 属性 | 值 |
|------|------|
| title | 已付佣金($) |
| dataIndex | approved_commission |
| width | 110 |
| sorter | 支持排序 |
| render | 绿色字体，$前缀，2位小数 |

数据来源：后端 `/api/platform-data/summary` 接口的 `merchant_breakdown` 中已返回 `approved_commission` 字段（经审核验证，`platform_data.py` 第 539 行），**无需后端改动**。

> 🔧 **审核修正（M-08）：** 明确「净佣金」定义不变。

**净佣金定义说明：** 净佣金 = 总佣金 - 拒付佣金（维持现有计算逻辑不变）。已付佣金作为独立展示列，不参与净佣金计算。原因：已付佣金和拒付佣金不一定覆盖全部佣金（可能存在 pending 状态），净佣金的现有定义更准确。

### 4.5 明细模式表格变更

> 🔧 **审核修正（L-04）：** 明确明细模式下「已付佣金」列的 render 逻辑。

在 `platformDetailColumns` 中添加「已付佣金($)」列。

**render 逻辑：**

```javascript
render: (value, record) => record.status === 'approved' 
  ? <span style={{ color: '#52c41a' }}>${record.commission_amount.toFixed(2)}</span>
  : <span style={{ color: '#999' }}>$0.00</span>
```

- `status === 'approved'` → 显示绿色金额
- 其他状态 → 显示灰色 `$0.00`

### 4.6 统计计算变更

在 `platformStats` 计算逻辑中新增 `totalApproved`：

- 汇总模式：`totalApproved = sum(item.approved_commission)`
- 明细模式：`totalApproved = sum(item.commission_amount where status === 'approved')`

---

## 五、OPT-004 ROI 计算公式修改

### 5.1 功能描述

将 ROI 计算公式从「佣金 ÷ 费用」改为「(佣金 - 费用) ÷ 费用」，结果显示为小数。

### 5.2 修改文件

`frontend/src/pages/DataCenter.jsx`（第590~797行）

### 5.3 公式变更

> 🔧 **审核修正（L-01）：** 明确 ROI 保留 2 位小数。

| 项目 | 修改前 | 修改后 |
|------|--------|--------|
| 公式 | 佣金 / 费用 | (佣金 - 费用) / 费用 |
| 示例 | 佣金=$176, 费用=$100 → ROI=1.76 | 佣金=$176, 费用=$100 → ROI=0.76 |
| 显示格式 | 小数（如 1.76） | 小数，保留 2 位（如 0.76） |
| 卡片标题 | "ROI (佣金/费用)" | "ROI" |

**费用为 0 时的处理（迭代 1.2 新增）：**

> 🔧 **迭代 1.2 确认：** 费用为 0 时 ROI 显示「-」，不参与排序。

| 场景 | 处理方式 |
|------|----------|
| 费用 = 0 | ROI 显示 `-`（灰色），排序时视为 `null`，排在最后 |
| 费用 > 0 | 正常计算 `(佣金 - 费用) / 费用`，保留 2 位小数 |

```javascript
// ROI 计算逻辑
const roi = cost === 0 ? null : ((commission - cost) / cost);

// 显示逻辑
render: (value) => value === null 
  ? <span style={{ color: '#999' }}>-</span>
  : <span style={{ color: value >= 0 ? '#3f8600' : '#cf1322' }}>{value.toFixed(2)}</span>

// 排序逻辑
sorter: (a, b) => {
  if (a.roi === null && b.roi === null) return 0;
  if (a.roi === null) return 1;  // null 排最后
  if (b.roi === null) return -1;
  return a.roi - b.roi;
}
```

> 🔧 **审核修正（B-05）：** 在 ROI 卡片增加 Tooltip 说明公式变更。

**ROI 卡片 Tooltip：** 鼠标悬停时显示 `"ROI = (佣金 - 费用) ÷ 费用"`，帮助用户理解新公式。

### 5.4 颜色规则变更

> 🔧 **审核修正（M-09）：** 统一颜色值，沿用现有代码的 `#3f8600`（深绿）和 `#cf1322`（深红），与 OPT-003 的 `#52c41a`（亮绿）区分开，避免视觉混淆。

| 条件 | 修改前 | 修改后 |
|------|--------|--------|
| 盈利 | ROI >= 1 → 绿色（`#3f8600`） | ROI >= 0 → 绿色（`#3f8600`） |
| 亏损 | ROI < 1 → 红色（`#cf1322`） | ROI < 0 → 红色（`#cf1322`） |
| 费用为0 | 无 | 灰色（`#999`） |

**颜色使用规范：**

| 场景 | 颜色 | 色值 |
|------|------|------|
| ROI 盈利 | 深绿 | `#3f8600` |
| ROI 亏损 | 深红 | `#cf1322` |
| 已付佣金 | 亮绿 | `#52c41a` |
| 费用为0/无数据 | 灰色 | `#999999` |

---

## 六、OPT-005 MCC 数据同步双模式（API/脚本）

> 🔧 **迭代 1.2 新增功能**

### 6.1 功能描述

为 Google Ads 数据同步提供双模式支持：当 API 配额（Explorer Access）不足时，可将指定 MCC 切换为「脚本模式」，通过 Google Ads MCC 脚本将数据导出到 Google Sheets，后端定时读取 Sheets 数据入库，实现零 API 配额消耗的数据同步。

### 6.2 核心概念

| 概念 | 说明 |
|------|------|
| API 模式（默认） | 现有方式，后端直接调用 Google Ads API 拉取数据 |
| 脚本模式 | MCC 脚本导出数据到 Google Sheets → 后端读取 Sheets → 数据入库 |
| sync_mode | MCC 级别的同步模式字段，值为 `api`（默认）或 `script` |
| 切换粒度 | 每个 MCC 独立控制，可混合使用两种模式 |

### 6.3 数据库变更

**修改表：`google_mcc_accounts`**

新增 5 个字段：

| 字段 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| sync_mode | VARCHAR(10) | `'api'` | 同步模式：`api` / `script` |
| google_sheet_url | VARCHAR(500) | NULL | Google Sheets URL（脚本模式必填） |
| sheet_sync_hour | INTEGER | 4 | Sheet 读取时间-小时（0-23） |
| sheet_sync_minute | INTEGER | 0 | Sheet 读取时间-分钟（0-59） |
| last_sheet_sync_at | DATETIME | NULL | 最近一次 Sheet 同步完成时间（用于判断首次/日常同步） |

> 🔧 **迭代 1.2 确认：** 使用 Alembic 迁移版本管理新增字段，不使用手动 SQL 脚本。

**数据库迁移方式：Alembic**

- 初始化 Alembic（若项目尚未使用）：`alembic init alembic`
- 生成迁移脚本：`alembic revision --autogenerate -m "add_mcc_sync_mode_fields"`
- 迁移内容：`ALTER TABLE google_mcc_accounts ADD COLUMN sync_mode VARCHAR(10) DEFAULT 'api'` 等 5 条
- 执行迁移：`alembic upgrade head`
- 回滚命令：`alembic downgrade -1`

### 6.4 同步调度方案

> 🔧 **迭代 1.2 确认：** Ads 脚本 02:00 前写完 Sheet，后端 04:00 统一读取（API + Sheet 同一轮）。

**调度流程：**

```
02:00 前  MCC 脚本在 Google Ads 中执行，将数据写入 Google Sheets
          ↓
04:00     daily_auto_sync_and_analysis_job() 启动
          ├─ 遍历所有 MCC
          │   ├─ sync_mode = 'api'  → 调用 Google Ads API 同步（现有逻辑）
          │   └─ sync_mode = 'script' → 调用 GoogleSheetSyncService 读取 Sheets
          ├─ 平台数据同步
          ├─ 数据分析
          └─ L7D 计算
```

- API 模式和脚本模式在 04:00 同一轮内顺序执行
- 脚本模式的 `sheet_sync_hour` / `sheet_sync_minute` 字段保留但不用于独立调度，仅作为配置记录
- **保留原因（L-09）：** 未来若需要支持各 MCC 独立调度读取时间（如某些 MCC 的 Ads 脚本在不同时间完成），可直接启用这两个字段，无需再做数据库迁移
- 若 Sheets 数据为空或读取失败，记录 `ERROR` 日志并跳过该 MCC，不影响其他 MCC

### 6.5 Google Sheets 数据格式

**Sheet 名称：** `DailyData`（固定）

**列定义：**

> 🔧 **审核修正（S-08）：** 增加 `CampaignId` 列，与现有表唯一约束 `(mcc_id, campaign_id, date)` 对齐。

| 列名 | 对应字段 | 说明 |
|------|----------|------|
| Date | date | 日期，格式 YYYY-MM-DD |
| Account | customer_id | 广告账户 ID |
| AccountName | account_name | 账户名称 |
| CampaignId | campaign_id | 广告系列 ID（数字） |
| CampaignName | campaign_name | 广告系列名称 |
| Impressions | impressions | 展示次数 |
| Clicks | clicks | 点击次数 |
| Cost | cost_micros | 费用（微单位，需 ÷ 1000000） |
| Conversions | conversions | 转化次数 |
| ConversionValue | conversions_value | 转化价值 |
| Currency | currency_code | 货币代码 |

### 6.6 GoogleSheetSyncService

**新建文件：** `backend/app/services/google_sheet_sync.py`

**核心方法：**

```python
class GoogleSheetSyncService:
    def __init__(self, db: Session):
        self.db = db
    
    def sync_mcc_from_sheet(self, mcc: GoogleMccAccount, force_refresh: bool = False) -> dict:
        """从 Google Sheets 读取数据并写入 google_ads_api_data 表"""
        # 1. 使用独立服务账号认证 Sheets API
        # 2. 读取 Sheet 'DailyData' 全部数据
        # 3. 判断首次/日常同步，确定日期范围
        # 4. 数据清洗：类型转换、cost_micros 转换、去重
        # 5. 调用 CampaignMatcher 提取 platform_code / account_code
        # 6. UPSERT 到 google_ads_api_data 表（force_refresh 时绕过增量检查）
        # 7. 返回统计：{inserted: N, updated: N, skipped: N}
    
    def test_sheet_connection(self, sheet_url: str) -> dict:
        """测试 Sheet 连接，返回行数、最新日期、列名"""
        # 返回: {row_count, last_date, sample_columns, status}
```

**首次同步策略（迭代 1.3 新增，修正 RS-02）：**

> 🔧 **审核修正（RS-02）：** 补充首次同步与日常同步的区分策略，解决 MCC 切换到脚本模式后本月数据修复问题。

MCC 从 API 模式切换到脚本模式后，首次同步需要覆盖本月全部数据，修复因 API 配额不足导致的数据缺失/不完整。

**首次同步判断条件：**

```python
def _is_first_sheet_sync(self, mcc: GoogleMccAccount) -> bool:
    """判断该 MCC 是否为首次 Sheet 同步"""
    # 检查 google_ads_api_data 表中是否存在该 MCC 的 Sheet 来源记录
    # 方式：检查 last_sheet_sync_at 字段（新增字段，见下方说明）
    return mcc.last_sheet_sync_at is None
```

**新增字段：** `google_mcc_accounts` 表增加 `last_sheet_sync_at`（DATETIME, nullable=True, 默认 NULL），记录最近一次 Sheet 同步完成时间。首次同步完成后写入时间戳，后续同步据此判断。

> 该字段纳入 Alembic 迁移版本 004（与 sync_mode 等 4 字段一起），总计 5 个新增字段。

**首次同步 vs 日常同步对比：**

| 项目 | 首次同步 | 日常同步 |
|------|----------|----------|
| 触发条件 | `last_sheet_sync_at IS NULL` | `last_sheet_sync_at IS NOT NULL` |
| 日期范围 | 本月1号 至 昨天 | 昨天 1 天 |
| force_refresh | `True`（绕过增量检查） | `False`（正常增量检查） |
| 原数据处理 | UPSERT 覆盖更新（不删除、不跳过） | UPSERT 覆盖更新 |
| 数据相同时 | 仍执行更新，刷新 `last_sync_at` | 仍执行更新 |
| 完成后操作 | 更新 `mcc.last_sheet_sync_at = now()` | 更新 `mcc.last_sheet_sync_at = now()` |

**首次同步流程：**

```
sync_mcc_from_sheet(mcc) 执行流程：

1. 判断是否首次同步：mcc.last_sheet_sync_at IS NULL？
   │
   ├─ 首次同步（last_sheet_sync_at = NULL）：
   │   ├─ 日期范围 = 本月1号 ~ 昨天
   │   ├─ force_refresh = True（绕过增量检查）
   │   ├─ 读取 Sheet 全部数据，按日期范围过滤
   │   ├─ UPSERT 到 google_ads_api_data（覆盖更新，不删除、不跳过）
   │   ├─ 更新 mcc.last_sheet_sync_at = now()
   │   └─ 日志：INFO "MCC {name} 首次 Sheet 同步完成，覆盖 {start}~{end}，{N} 条记录"
   │
   └─ 日常同步（last_sheet_sync_at != NULL）：
       ├─ 日期范围 = 昨天 1 天（与 API 模式一致）
       ├─ force_refresh = False（正常增量检查）
       ├─ 读取 Sheet 全部数据，按昨天日期过滤
       ├─ UPSERT 到 google_ads_api_data
       ├─ 更新 mcc.last_sheet_sync_at = now()
       └─ 缺失数据由 05:00 backfill 兜底
```

**蝴蝶效应防护：**

首次同步覆盖本月全部数据后，以下功能的数据准确性得到保障：
- 数据中心页面：费用/ROI 统计基于完整的本月数据
- L7D 分析：最近 7 天分析结果准确
- OPT-002 拒付佣金检测：ROI 计算依赖的 cost 数据完整
- OPT-004 ROI 公式：(佣金 - 费用) / 费用 中的费用数据完整

**Sheets API 限流策略（迭代 1.3 新增，修正 M-11）：**

Google Sheets API 限制：每分钟 60 次读取请求，每次最多 1000 万个单元格。

- 多个 MCC 使用脚本模式时，每个 MCC 读取后等待 **2 秒**，避免触发限流
- 增加 429 Too Many Requests 错误重试机制：指数退避，最多重试 3 次（等待 5s → 10s → 20s）
- 单个 MCC 的 Sheet 读取失败不影响其他 MCC，记录 `ERROR` 日志后继续

```python
import time

SHEET_READ_INTERVAL = 2  # 每个 MCC 读取间隔（秒）
SHEET_MAX_RETRIES = 3    # 最大重试次数

def _read_sheet_with_retry(self, sheet_url: str) -> list:
    for attempt in range(SHEET_MAX_RETRIES):
        try:
            return self._read_sheet(sheet_url)
        except HttpError as e:
            if e.resp.status == 429 and attempt < SHEET_MAX_RETRIES - 1:
                wait = 5 * (2 ** attempt)  # 5s, 10s, 20s
                logger.warning(f"Sheets API 限流，{wait}s 后重试")
                time.sleep(wait)
            else:
                raise
```

**UPSERT 逻辑：**

> 🔧 **审核修正（S-08）：** 唯一键改为与现有表一致的 `(mcc_id, campaign_id, date)`。  
> 🔧 **审核修正（RS-02）：** 明确原数据处理策略。

- 唯一键：`(mcc_id, campaign_id, date)` — 与 `google_ads_api_data` 表的 `UniqueConstraint` 一致
- `mcc_id`：从当前 MCC 记录的 `id` 字段获取
- `campaign_id`：从 Google Sheets 的 `CampaignId` 列读取
- 存在 → 更新数值字段 + 刷新 `last_sync_at`（即使数据相同也执行更新，作为同步记录）
- 不存在 → 插入新记录
- **不删除原数据** — UPSERT 覆盖更新即可，避免删除期间的数据空窗
- **不跳过相同数据** — MCC 数据是确定性数据，首次同步数据量有限，性能不是瓶颈
- 使用事务保护，单个 MCC 的所有数据在同一事务中

### 6.7 Sheet 数据读取方式

> 🔧 **迭代 1.6 修正：** 移除独立服务账号和 Google Sheets API 依赖，改用公开 CSV 导出链接读取。

**读取方式：HTTP GET 公开 CSV 导出链接**

用户需将 Google Sheet 设置为「知道链接的任何人都可以编辑」，后端通过以下 URL 直接读取 CSV 数据：

```
https://docs.google.com/spreadsheets/d/{SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=DailyData
```

- 无需 Google Sheets API，无需任何服务账号
- 无需 GCP 项目配置
- 使用 Python `requests.get()` + `csv.reader()` 解析
- 失败时指数退避重试（最多 3 次，间隔 5s → 10s → 20s）
- 零配置：无需在 `.env` 中添加任何新配置项

**已删除的旧配置项：**
```python
# 以下配置已删除（迭代 1.6）
# google_sheets_service_account_file
# google_sheets_service_account_json_base64
```

### 6.8 MCC 管理界面变更

**修改文件：** `frontend/src/pages/MccManagement.jsx`（或对应组件）

**MCC 编辑表单新增字段：**

| 字段 | 组件 | 说明 |
|------|------|------|
| 同步模式 | `Radio.Group`（API / 脚本） | 默认 API |
| Google Sheet URL | `Input`（脚本模式时显示） | 条件显示 |
| Sheet 读取时间 | `TimePicker`（时:分） | 条件显示，默认 04:00 |

**条件显示逻辑：** 选择「脚本」模式时，展开 Sheet URL 和读取时间字段。

**MCC 列表新增列：**

| 列名 | 说明 |
|------|------|
| 同步模式 | 显示 `API` 或 `脚本`，脚本模式用蓝色标签 |

### 6.9 新增 API 接口

**修改文件：** `backend/app/api/mcc.py`

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/mcc/{id}/script-template` | 获取 MCC 脚本模板（根据 MCC 的 customer_id 生成） |
| POST | `/api/mcc/{id}/sync-sheet` | 手动触发 Sheet 同步（单个 MCC） |

> 🔧 **终审建议（TS-02）：** 手动触发 `sync-sheet` 始终使用 `force_refresh=True`，日期范围遵循首次/日常判断逻辑（`last_sheet_sync_at IS NULL` → 本月全量，否则 → 昨天 1 天）。可选参数 `force_full_sync: bool = false`，允许管理员手动指定全量同步（覆盖本月1号~昨天）。
| POST | `/api/mcc/{id}/test-sheet` | 测试 Sheet 连接（返回 row_count、last_date、sample_columns） |

**MCC 更新接口扩展：**

`MccAccountUpdate` schema 新增字段：`sync_mode`、`google_sheet_url`、`sheet_sync_hour`、`sheet_sync_minute`

> 🔧 **终审建议（TS-01）：** `last_sheet_sync_at` 为系统自动维护字段（同步完成后由后端写入），不纳入 `MccAccountUpdate`，仅在 `MccAccountResponse` 中返回（只读）。

`MccAccountResponse` schema 新增对应返回字段（含 `last_sheet_sync_at`）。

### 6.10 MCC 脚本模板

> 🔧 **审核修正（M-10）：** 修正 API 调用方式，增加 `campaign.id` 导出，改用批量写入，增加错误处理。

**接口 `/api/mcc/{id}/script-template` 返回的脚本内容：**

```javascript
// Google Ads MCC 脚本 - 自动导出到 Google Sheets
// MCC: {mcc_name} ({customer_id})
// 生成时间: {timestamp}

function main() {
  var spreadsheet = SpreadsheetApp.openByUrl('{google_sheet_url}');
  var sheet = spreadsheet.getSheetByName('DailyData') || spreadsheet.insertSheet('DailyData');
  
  // 清空旧数据
  sheet.clear();
  
  // 写入表头
  var headers = ['Date', 'Account', 'AccountName', 'CampaignId', 'CampaignName', 
                 'Impressions', 'Clicks', 'Cost', 'Conversions', 
                 'ConversionValue', 'Currency'];
  sheet.getRange(1, 1, 1, headers.length).setValues([headers]);
  
  // 收集所有数据行（批量写入）
  var allRows = [];
  
  // 查询最近 30 天数据（遍历 MCC 下所有子账号）
  var accountIterator = AdsManagerApp.accounts().get();
  
  while (accountIterator.hasNext()) {
    var account = accountIterator.next();
    AdsManagerApp.select(account);
    
    try {
      var report = AdsApp.report(
        'SELECT segments.date, customer.id, customer.descriptive_name, ' +
        'campaign.id, campaign.name, metrics.impressions, metrics.clicks, ' +
        'metrics.cost_micros, metrics.conversions, ' +
        'metrics.conversions_value, customer.currency_code ' +
        'FROM campaign ' +
        'WHERE segments.date DURING LAST_30_DAYS'
      );
      
      var rows = report.rows();
      while (rows.hasNext()) {
        var row = rows.next();
        allRows.push([
          row['segments.date'],
          row['customer.id'],
          row['customer.descriptive_name'],
          row['campaign.id'],
          row['campaign.name'],
          row['metrics.impressions'],
          row['metrics.clicks'],
          row['metrics.cost_micros'],
          row['metrics.conversions'],
          row['metrics.conversions_value'],
          row['customer.currency_code']
        ]);
      }
    } catch (e) {
      Logger.log('账号 ' + account.getName() + ' 导出失败: ' + e.message);
      // 单个账号失败不中断整个脚本
    }
  }
  
  // 批量写入（性能远优于逐行 appendRow）
  if (allRows.length > 0) {
    sheet.getRange(2, 1, allRows.length, headers.length).setValues(allRows);
  }
  
  Logger.log('导出完成，共 ' + allRows.length + ' 行数据');
}
```

### 6.11 脚本模式新手引导

> 🔧 **迭代 1.6 新增：** 前端完整操作引导，降低使用门槛。

**引导位置 1：MCC 编辑表单（选择脚本模式时自动展开）**

当用户在 MCC 编辑表单中将「同步模式」切换为「脚本」时，在 Sheet URL 输入框上方显示步骤引导 Alert：

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 新建 Google Sheet | 名称随意 |
| 2 | 设置共享权限 | 点击右上角「共享」→「知道链接的任何人 — 编辑者」 |
| 3 | 粘贴共享链接 | 复制链接粘贴到表单输入框，保存 |
| 4 | 获取脚本 | 在 MCC 列表操作栏点击「获取脚本」按钮 |
| 5 | 运行脚本 | 到 Google Ads MCC →「工具与设置 → 批量操作 → 脚本」中新建并运行 |
| 6 | 同步数据 | 脚本运行完毕后，回到本页点击「同步 Sheet 数据」 |

**引导位置 2：获取脚本弹窗**

点击「获取脚本」时弹窗包含：
- 详细步骤说明（复制 → 粘贴到 Google Ads → 运行 → 回来同步）
- 提醒确认 Sheet 已设为公开可编辑
- 告知数据写入 Sheet 底部的 DailyData 标签页

**引导位置 3：Layout 全局新手引导**

首次登录弹窗中的脚本模式描述更新为完整流程概要。

**无需配置项：** 脚本模式不依赖服务账号、不依赖 API 配额、不需要在 `.env` 中添加任何配置。

### 6.12 回滚方案

> 🔧 **迭代 1.2 确认：** 回滚前先停用脚本模式的 MCC。

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 停用脚本模式 MCC | 回滚前执行 SQL：`UPDATE google_mcc_accounts SET is_active = 0 WHERE sync_mode = 'script'` |
| 2 | 代码回滚 | `git revert` 到 OPT-005 之前的版本 |
| 3 | Alembic 回滚 | `alembic downgrade -1` 移除新增字段 |
| 4 | 重启后端 | 重启服务，旧代码不会识别 script 模式 |
| 5 | 恢复 MCC | 需要时手动将停用的 MCC 改回 `is_active = 1`，此时它们默认走 API 模式 |

---

## 七、OPT-006 更新日志弹窗

### 7.1 功能概述

在网站 Header 右侧新增「更新日志」入口，用户登录后若有未读版本更新则自动弹窗展示。弹窗默认展示最新版本内容，底部提供「历史版本」折叠区域可查看更早版本。用户可随时通过 Header 按钮手动打开。

- **优先级：** P1
- **涉及端：** 纯前端
- **依赖：** 无（不依赖后端，不依赖其他 OPT）

### 7.2 数据源

更新日志硬编码在前端配置文件 `frontend/src/config/changelog.js` 中，每次发版时由开发人员维护。

数据结构：

```js
export const changelog = [
  {
    version: "1.1.0",
    date: "2026-02-28",
    title: "网站功能优化1.0",
    sections: [
      {
        type: "feature",    // feature | improve | fix
        label: "新增功能",
        items: ["功能描述1", "功能描述2"]
      }
    ]
  }
];
```

**隐私规范：** 涉及具体用户的问题统一用「个别用户」代替，不出现任何用户名/工号。

### 7.3 弹窗 UI 规格

| 属性 | 值 |
|------|-----|
| 弹窗宽度 | 560px |
| 最大高度 | 70vh（内容可滚动） |
| 标签颜色 | 新增 = 绿色 Tag、优化 = 蓝色 Tag、修复 = 橙色 Tag |
| 历史版本 | 默认折叠，使用 Ant Design `Collapse` 展开 |
| 底部按钮 | 「我知道了」— 关闭弹窗并记录已读 |

### 7.4 触发逻辑

1. **登录后自动弹出：** 在 `Layout/index.jsx` 组件挂载时，检查 `localStorage.getItem('changelog_last_seen')` 与 `changelog[0].version` 是否一致，不一致则自动弹出
2. **关闭时标记已读：** 点击「我知道了」或关闭弹窗时执行 `localStorage.setItem('changelog_last_seen', changelog[0].version)`
3. **手动查看：** Header 右侧用户头像左边放一个 `GiftOutlined` 图标按钮，点击打开弹窗，不受已读状态限制
4. **未读红点：** 当有未读更新时，按钮上显示小红点（Ant Design `Badge dot`）

### 7.5 Header 入口位置

```
Header 右侧布局：
  [平台标题]                    [更新日志按钮] [铃铛通知(OPT-001)] [用户头像]
```

### 7.6 涉及文件

| 操作 | 文件 | 说明 |
|------|------|------|
| 新增 | `frontend/src/config/changelog.js` | 更新日志数据（硬编码 3 个版本） |
| 新增 | `frontend/src/components/ChangelogModal/index.jsx` | 弹窗组件（含已读检测、版本渲染、折叠历史） |
| 修改 | `frontend/src/components/Layout/index.jsx` | Header 加入口按钮 + 挂载时自动弹窗逻辑 |

### 7.7 初始版本内容

`changelog.js` 初始包含 3 个版本记录：

| 版本 | 日期 | 标题 | 内容概要 |
|------|------|------|----------|
| v1.1.0 | 2026-02-28 | 网站功能优化1.0 | OPT-001~006 全部功能 + 修复项 |
| v1.0.1 | 2026-02-15 | 紧急修复 | 登录异常修复 + API 限速修复 |
| v1.0.0 | 2026-01-20 | 系统上线 | 平台初始上线全部功能 |

### 7.8 回滚方案

纯前端改动，回滚方式：

1. 删除 `frontend/src/config/changelog.js`
2. 删除 `frontend/src/components/ChangelogModal/` 目录
3. 还原 `Layout/index.jsx` 中新增的 import、state、useEffect 和 Header 按钮代码
4. 重新构建部署前端

---

## 八、文件变更清单

### 新增文件（8个）

| 文件路径 | 说明 |
|----------|------|
| `backend/app/models/notification.py` | 通知数据模型（含索引定义） |
| `backend/app/models/commission_snapshot.py` | 拒付佣金快照数据模型（含唯一约束） |
| `backend/app/api/notifications.py` | 通知 API 路由（4个接口，含分页+权限校验） |
| `backend/app/services/google_sheet_sync.py` | Google Sheets 同步服务（含限流+重试，OPT-005） |
| `alembic/versions/003_add_notifications_and_snapshots.py` | Alembic 迁移：创建 notifications + commission_snapshots 表 |
| `alembic/versions/004_add_mcc_sync_mode_fields.py` | Alembic 迁移：google_mcc_accounts 新增 5 字段（含 last_sheet_sync_at） |
| `frontend/src/config/changelog.js` | 更新日志数据配置（硬编码 3 个版本，OPT-006） |
| `frontend/src/components/ChangelogModal/index.jsx` | 更新日志弹窗组件（OPT-006） |

### 修改文件（8个）

| 文件路径 | 修改内容 |
|----------|----------|
| `backend/app/main.py` | 注册 notifications 路由（不使用 create_all） |
| `backend/app/config.py` | 新增 `REJECTED_COMMISSION_DAILY_THRESHOLD` 配置项（已删除 `google_sheets_service_account_*`，迭代 1.6） |
| `backend/app/services/scheduler.py` | 新增 `check_rejected_commission_job` 定时任务（06:00 + 补跑策略 + _sync_lock）+ 修改 `sync_google_ads_data_job` 支持双模式 |
| `backend/app/models/google_ads_api_data.py` | `GoogleMccAccount` 新增 5 字段（sync_mode、google_sheet_url、sheet_sync_hour、sheet_sync_minute、last_sheet_sync_at） |
| `backend/app/api/mcc.py` | MCC 接口扩展（schema 新增字段 + 3 个新 API：脚本模板/手动同步/测试连接） |
| `backend/app/api/team_management.py` | `UserCreate.team_id` 改为必填（去掉 Optional） |
| `frontend/src/components/Layout/index.jsx` | Header 右侧添加铃铛通知组件 + 更新日志按钮及自动弹窗逻辑（OPT-006） |
| `frontend/src/pages/DataCenter.jsx` | 已付佣金展示 + ROI 公式修改（含费用为0处理、颜色统一）+ ROI Tooltip |

### 文档更新（1个）

| 文件路径 | 修改内容 |
|----------|----------|
| `设计方案.md` | 替换为本设计方案全文 |

---

## 九、设计方案变更记录

> 🔧 **审核修正（M-02）：** 变更编号从 CR-004 开始，避免与已有 CR-003（API限速修复）冲突。

完成后在变更记录中登记：

| 变更编号 | 功能模块 | 变更类型 | 变更描述 |
|----------|----------|----------|----------|
| CR-004 | 全局Layout | 新增功能 | 全局消息提醒系统（铃铛+角标+下拉通知列表+已读标记+分页+4角色权限+team_id强制分组） |
| CR-005 | 定时任务 | 新增功能 | 拒付佣金变动检测（上月变动+本月日变动>阈值，06:00执行+补跑策略+_sync_lock互斥，事务保护） |
| CR-006 | 数据中心 | 功能优化 | 平台数据tab新增已付佣金卡片和表格列 |
| CR-007 | 数据中心 | 功能优化 | ROI公式改为(佣金-费用)/费用，保留2位小数，费用为0显示「-」，颜色沿用#3f8600/#cf1322，增加Tooltip |
| CR-008 | MCC管理+定时任务 | 新增功能 | MCC数据同步双模式（API/脚本），Google Sheets同步服务（含限流+重试），Alembic迁移，独立服务账号，UPSERT唯一键对齐 |
| CR-009 | 全局Layout | 新增功能 | 更新日志弹窗（OPT-006）：登录后自动弹出未读版本更新，Header右侧入口按钮+Badge红点，硬编码配置文件，Collapse历史版本 |

---

## 十、回滚方案

> 🔧 **审核修正（L-05）：** 补充回滚策略。

如果上线后发现严重问题，按以下步骤快速回退：

**OPT-001～004 回滚：**

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 前端回滚 | Cloudflare Pages 回滚到上一次部署版本 |
| 2 | 后端回滚 | `git revert` 到上一个版本，重启后端服务 |
| 3 | 数据库 | 新增的 `notifications` 和 `commission_snapshots` 表不影响旧功能，可保留不删 |
| 4 | 定时任务 | 回滚后新增的定时任务自动消失，无需额外处理 |

**OPT-005 回滚（迭代 1.2 新增）：**

> 🔧 **迭代 1.2 确认：** 回滚前先停用脚本模式的 MCC，避免旧代码误走 API 同步触发配额错误。

| 步骤 | 操作 | 说明 |
|------|------|------|
| 1 | 停用脚本模式 MCC | `UPDATE google_mcc_accounts SET is_active = 0 WHERE sync_mode = 'script'` |
| 2 | 代码回滚 | `git revert` 到 OPT-005 之前的版本 |
| 3 | Alembic 回滚 | `alembic downgrade -1` 移除 sync_mode 等 5 个新增字段 |
| 4 | 重启后端 | 重启服务 |
| 5 | 恢复 MCC | 需要时手动将停用的 MCC 改回 `is_active = 1`（此时默认走 API 模式） |

---

## 十一、后端部署指令

> **说明：** 后端部署须在**阿里云服务器**上执行。必须先**激活虚拟环境**再启动 `uvicorn`，否则会报 `Exit 127`（找不到 uvicorn 命令）。虚拟环境路径：`~/Google-Data-Analysis/backend/venv`。

**连接信息：** 主机 `47.239.193.33`，端口 `22`，用户 `admin`。

### 一键部署（拉代码 + 重启，不更新依赖）

```bash
cd ~/Google-Data-Analysis && git pull origin main && cd backend && source venv/bin/activate && pkill -f 'uvicorn.*app.main' || true && sleep 2 && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 & sleep 3 && curl -s http://127.0.0.1:8000/health && echo "" && echo "✓ 后端已重启" && tail -n 15 /tmp/backend.log
```

### 一键部署（拉代码 + 更新依赖 + 重启）

```bash
cd ~/Google-Data-Analysis && git pull origin main && cd backend && source venv/bin/activate && pip install -q --upgrade pip && pip install -q -r requirements.txt && pkill -f 'uvicorn.*app.main' && sleep 2 && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 & sleep 3 && curl -s http://127.0.0.1:8000/health && echo "" && echo "✓ 部署完成" && tail -n 5 run.log
```

### 分步执行（便于排查）

```bash
# 1. 进入项目根目录（拉代码必须在仓库根目录）
cd ~/Google-Data-Analysis

# 2. 拉取最新代码
git pull origin main

# 3. 进入后端目录并激活虚拟环境
cd backend
source venv/bin/activate

# 4. 停止现有服务
pkill -f 'uvicorn.*app.main' || true
sleep 2

# 5. 启动服务（必须在前一步 source 之后执行）
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > /tmp/backend.log 2>&1 &

# 6. 验证
sleep 3
curl -s http://127.0.0.1:8000/health
tail -n 20 /tmp/backend.log
```

---

## 十二、审核问题修正对照表

| 问题编号 | 级别 | 问题简述 | 修正位置 | 修正内容 |
|----------|------|----------|----------|----------|
| S-01 | 🔴 严重 | 定时任务时间冲突 | 3.5、3.7 节 | 06:00 → 06:30，增加前置检查 |
| S-02 | 🔴 严重 | 缺数据库迁移方案 | 2.7 节（新增） | `startup_event()` 中 `create_all()` 自动建表 |
| S-03 | 🔴 严重 | 数据查询定义不精确 | 3.3 节（新增）、3.4 节 | 明确日期字段/范围/NULL处理/精度 |
| S-04 | 🔴 严重 | 角色权限不完整 | 2.4 节 | 补充 leader/member/employee 三角色权限 |
| M-01 | 🟡 中等 | 通知列表缺分页 | 2.8 节 | 增加 page/page_size 参数 |
| M-02 | 🟡 中等 | 变更编号冲突 | 第八节 | CR-003~006 → CR-004~008 |
| M-03 | 🟡 中等 | 阈值硬编码 | 3.2 节 | 抽取到 config.py 配置项 |
| M-04 | 🟡 中等 | snapshot_type 命名混淆 | 3.4 节 | daily→current_month, monthly→previous_month |
| M-05 | 🟡 中等 | 缺事务保护 | 3.6 节 | 快照+通知在同一事务中执行 |
| L-01 | 🟢 轻微 | ROI 精度未明确 | 5.3 节 | 明确保留 2 位小数 |
| L-02 | 🟢 轻微 | 通知无清理机制 | 2.6 节 | 增加 90 天已读通知清理策略 |
| L-03 | 🟢 轻微 | 缺索引定义 | 2.6 节 | 补充 2 个复合索引 |
| L-04 | 🟢 轻微 | 明细模式 render 不明确 | 4.5 节 | 明确 approved→绿色金额，其他→灰色$0.00 |
| L-05 | 🟢 轻微 | 缺回滚方案 | 第九节（新增） | 补充前端/后端/数据库/定时任务回滚步骤 |
| S-05 | 🔴 严重 | team_id 强制非空与现有代码冲突 | 2.4 节 | 改为分两步走：先应用层强制校验，后续迭代再改数据库约束 |
| S-06 | 🔴 严重 | backfill 时间与代码不一致 | 3.5、3.7 节 | backfill 实际 05:00，拒付检测改为 06:00，补跑 06:30→07:00→07:30 |
| S-07 | 🔴 严重 | 迁移策略自相矛盾 | 2.7 节 | 统一使用 Alembic，删除 create_all() 方案 |
| S-08 | 🔴 严重 | UPSERT 唯一键冲突 | 6.5、6.6、6.10 节 | 增加 CampaignId 列，唯一键改为 (mcc_id, campaign_id, date) |
| M-06 | 🟡 中等 | 通知 API 缺权限校验 | 2.8 节 | 补充 4 个 API 的权限校验规则 |
| M-07 | 🟡 中等 | user_id NULL 处理不健壮 | 3.3 节 | 孤立记录归入「未分配」汇总，通知 manager |
| M-08 | 🟡 中等 | 净佣金定义需明确 | 4.4 节 | 明确净佣金=总佣金-拒付佣金，不变更 |
| M-09 | 🟡 中等 | ROI 颜色值不一致 | 5.4 节 | 统一沿用 #3f8600/#cf1322，与已付佣金 #52c41a 区分 |
| M-10 | 🟡 中等 | MCC 脚本 API 调用方式有误 | 6.10 节 | 改用 AdsManagerApp，批量写入，增加错误处理 |
| M-11 | 🟡 中等 | 缺 Sheets API 限流策略 | 6.6 节 | 增加 2s 间隔 + 429 指数退避重试 |
| L-06 | 🟢 轻微 | 通知类型扩展性不足 | 2.6 节 | type 字段改为 VARCHAR(50)，预留 system/sync_error |
| L-07 | 🟢 轻微 | 快照表缺唯一约束 | 3.4 节 | 增加 (user_id, snapshot_type, period) 唯一约束 |
| L-08 | 🟢 轻微 | 前端行号定位不精确 | 2.9 节 | 改为描述性定位，不依赖行号 |
| L-09 | 🟢 轻微 | 保留但不使用的字段 | 6.4 节 | 补充保留原因：未来独立调度扩展 |
| L-10 | 🟢 轻微 | 变更记录编号表述有误 | 第十节 | CR-004~007 → CR-004~008 |
| RS-01 | 🟡 中等 | 设计方案与维护方案 backfill 时间冲突 | 3.7 节 | 需维护方案侧确认 backfill 保持 05:00（不阻塞开发） |
| RS-02 | 🔴 严重 | OPT-005 缺少首次同步策略 | 6.6 节 | 补充首次/日常同步区分、首次范围本月1号~昨天、force_refresh、UPSERT 覆盖更新、日常改为1天 |
| TS-01 | 🟢 轻微 | MccAccountUpdate 未说明 last_sheet_sync_at 只读 | 6.9 节 | 补充说明：系统自动维护字段，不纳入 Update，仅在 Response 返回 |
| TS-02 | 🟢 轻微 | sync-sheet 手动触发行为未定义 | 6.9 节 | 补充说明：手动触发始终 force_refresh=True，可选 force_full_sync 参数 |

---

## 十三、审核确认

| 审核项 | 审核人 | 状态 | 意见 |
|--------|--------|------|------|
| 方案设计（OPT-001 全局消息提醒） | AI 审核官 | ✅ 通过 | S-05 分步走方案合理，权限校验完整 |
| 方案设计（OPT-002 拒付佣金检测） | AI 审核官 | ✅ 通过 | 检测规则清晰，事务保护到位，补跑策略合理 |
| 方案设计（OPT-003 已付佣金展示） | AI 审核官 | ✅ 通过 | 前端改动明确，净佣金定义清晰 |
| 方案设计（OPT-004 ROI 公式修改） | AI 审核官 | ✅ 通过 | 公式正确，颜色统一，费用为0处理明确 |
| 方案设计（OPT-005 MCC 双模式） | AI 审核官 | ✅ 通过 | 迭代 1.4 补充 RS-02 首次同步策略，终审通过 |
| 方案设计（OPT-006 更新日志弹窗） | AI 审核官 | ⏳ 待审 | 纯前端改动，已纳入设计方案，待审核 |
| 数据库设计 | AI 审核官 | ✅ 通过 | Alembic 统一迁移，UPSERT 唯一键对齐，快照唯一约束 |
| API 设计 | AI 审核官 | ✅ 通过 | 权限校验完整，NULL 处理健壮 |
| UI 交互设计 | AI 审核官 | ✅ 通过 | 颜色统一，描述性定位 |
| 定时任务设计 | AI 审核官 | ✅ 通过 | 需与维护方案协调 backfill 时间（RS-01） |

---

## 十四、迭代 1.2 验收确认记录

> 以下为验收人员 07 在迭代 1.2 设计沟通中确认的决策，作为开发和验收的对照依据。

### OPT-001～004 确认项

| 确认项 | 确认结果 | 确认时间 |
|--------|----------|----------|
| 组长权限（team_id 为空） | 不允许 team_id 为空，系统强制每个用户必须分组 | 2026-02-27 |
| ROI 费用为 0 | 显示「-」，不参与排序（排在最后） | 2026-02-27 |
| 拒付佣金检测跳过后补跑 | 最多补跑 3 次（06:30、07:00、07:30），仍失败则放弃并记录日志 | 2026-02-27 |

### OPT-005 确认项

| 确认项 | 确认结果 | 确认时间 |
|--------|----------|----------|
| 1. 数据库迁移方式 | B. 使用 Alembic 迁移版本管理 | 2026-02-27 |
| 2. 脚本模式同步时间 | Ads 脚本 02:00 前写完 Sheet，后端 04:00 统一读取（API + Sheet 同一轮） | 2026-02-27 |
| 3. GOOGLE_SHEET_SYNC_ENABLED | 不需要总开关，每个 MCC 由 sync_mode 单独控制 | 2026-02-27 |
| 4. 服务账号 | 使用独立服务账号，新增 `google_sheets_service_account_*` 配置键 | 2026-02-27 |
| 5. 回滚策略 | A. 回滚前先停用脚本模式的 MCC（`is_active = 0`） | 2026-02-27 |

---

> 以上为「网站功能优化1.0」迭代 1.5 完整设计方案，包含 OPT-001～OPT-006 共 6 项功能。OPT-001～OPT-005 经四轮审核累计处理 35 项问题（9 严重 + 12 中等 + 14 轻微），全部修正到位并通过终审。OPT-006（更新日志弹窗）为新增纯前端功能，待审核。
