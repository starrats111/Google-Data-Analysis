# 综合问题修复设计方案

> **设计人员**: AI 开发助手  
> **版本**: v5.4  
> **日期**: 2026-02-24  
> **审核状态**: 待审核  
> **变更说明**: 响应审核报告 v17.0，修正 E2 清理脚本查询写法、采纳 N3 sys.path 建议

---

## 〇、审核报告响应

### 〇-A、v17.0 响应（最新）

#### E2：D1 清理脚本 SQLAlchemy 查询写法错误

**审核结论**：`db.query(GoogleMccAccount.id).filter(...).all()` 仅查询单列，返回 `Row` 或元组列表，迭代时 `m` 无 `.id` 属性，会抛出 `AttributeError`。

**我方回应**：✅ **完全接受**

- 改为与项目惯例一致的完整模型查询：`db.query(GoogleMccAccount).filter(...).all()`，再 `[m.id for m in cny_mccs]`
- 已在本方案 2.4 节修正

---

#### N3：D1 清理脚本建议添加 sys.path 保障

**审核结论**：脚本直接使用 `from app.database`，未添加项目路径，从非 `backend` 目录执行可能失败。

**我方回应**：✅ **采纳**

- 在脚本开头（`from app.database` 之前）增加 `sys.path.insert(0, ...)` 三行
- 确保从任意目录执行 `python -m scripts.clean_cny_google_ads_data` 均可正常运行

---

### 〇-B、v16.0 响应（历史）

#### E1：D1 清理脚本使用错误数据库类型

**审核结论**：方案使用 `psql`（PostgreSQL），项目默认 `sqlite:///./google_analysis.db`，清理步骤无法执行。

**我方回应**：✅ **完全接受**

- 恢复为 **Python + SQLAlchemy** 脚本，兼容 SQLite 与 PostgreSQL
- 作为主方案，若生产环境使用 PostgreSQL 可保留 psql 为可选补充

---

#### N1：D5 formatIsLost 修改范围不明确

**审核结论**：方案仅列 `Analysis.jsx`，实际展示 IS Budget/Rank 的组件在 `DataCenter.jsx`、`GoogleAdsData.jsx`。

**我方回应**：✅ **采纳**

- 明确修改 `DataCenter.jsx` 第 263、269 行
- 明确修改 `GoogleAdsData.jsx` 第 457、465 行（若需统一展示规则）
- 在 `Analysis.jsx` 中定义 `formatIsLost` 并导出，供上述组件复用

---

#### N2：D3 include_empty 参数传递方式未细化

**审核结论**：方案未给出端点参数、调用方式、service 签名的具体实现。

**我方回应**：✅ **采纳**

- 在 4.2 节补充完整参数传递链路（见下文）

---

### 〇-B、v15.0 响应（历史）

### 0.1 对审核人员的回应

#### F1：C1 补丁会导致 AttributeError 崩溃

**审核结论**：v14.0 的 C1 判定错误。`analysis.py` 的 `items` 来自 `AdCampaignDailyMetric`（用户上传），非 `GoogleAdsApiData`；`AdCampaign` 无 `mcc_id` 字段。

**我方回应**：✅ **完全接受**

- 已核实 `AdCampaign` 模型确实无 `mcc_id` 字段
- D1 修复（`google_ads_service_account_sync.py`）仅影响 API 同步路径，与上传路径无关
- **撤销 C1 补丁**：不再在 `analysis.py` 添加 `convert_to_usd`、`mcc_currency_map` 及任何 D1 相关修改

---

#### C1：D6 在 analysis.py 中的补丁同样会崩溃

**审核结论**：D6 补丁同样使用 `mcc_id`，会 AttributeError；上传路径无 MCC 上下文，无法做货币转换。

**我方回应**：✅ **接受**

- **推迟 `analysis.py` 的 D6 补丁**：本次仅修复 `api_analysis_service.py`（L7D API 端点）
- 用户痛点主要来自 L7D 分析（API 数据），上传路径的 Max CPC 修复列入后续迭代
- 若审核/产品确认上传路径也需修复，再单独设计（需解决 campaign_name→MCC 映射问题）

---

#### C2：D2 预设修复未使用 base_query，导致筛选不一致

**审核结论**：独立构建的 `no_mid_rejected` 查询缺少 `platform`、`AffiliateAccount` 等筛选，导致"未归类拒付"行包含所有平台数据，与 breakdown 筛选不一致。

**我方回应**：✅ **完全接受**

- 采用**差值法**：`missing_rejected = total_rejected_commission - sum(breakdown.rejected_commission)`
- 保证 `total = sum(breakdown)`，与任意筛选条件一致
- 不再单独查询无 MID 拒付，避免筛选条件遗漏

---

#### M2：D5 格式函数边界值不精确

**审核结论**：`>= 0.9` 会使 90.0% 显示为 ">90%"，数学上不精确。

**我方回应**：✅ **接受**

- 改为 `value > 0.9`，仅当严格大于 90% 时显示 ">90%"
- 或在注释中说明：若需对齐 Google Ads 显示约定（≥90% 显示 ">90%"），则保留 `>= 0.9`

---

### 0.2 修正汇总

| 审核项 | 采纳 | 修正措施 |
|--------|------|---------|
| F1 | ✅ | 撤销 C1 补丁，`analysis.py` 不做 D1 相关修改 |
| C1 | ✅ | 推迟 `analysis.py` D6 补丁，本次仅修 `api_analysis_service.py` |
| C2 | ✅ | D2 改用差值法 |
| M2 | ✅ | D5 格式函数 `>= 0.9` → `> 0.9` |
| E2 | ✅ | 清理脚本改为 `query(GoogleMccAccount).all()` 后 `[m.id for m in cny_mccs]` |
| N3 | ✅ | 清理脚本开头增加 sys.path.insert，增强鲁棒性 |

---

## 一、问题总览（v5.4）

| 编号 | 问题 | 严重程度 | 处理状态 |
|------|------|---------|---------|
| **D1** | CNY 账号费用双重转换 | 🔴 严重 | 本方案修复（**仅存储端**，无 C1 补丁） |
| **D2** | 拒付佣金汇总与明细不一致 | 🔴 严重 | 本方案修复（**差值法**） |
| **D3** | L7D 广告系列数量不一致 | 🔴 严重 | 本方案修复（方案 B） |
| **D4** | 数据同步延迟 | 🟠 中等 | 说明+优化方向 |
| **D5-原始** | >90% 应存储为字符串 | 🟢 轻微 | 不修复，前端 `> 0.9` 时显示 ">90%" |
| **D6** | 当前 Max CPC 来源错误 | 🔴 严重 | 本方案修复（**仅 api_analysis_service.py**） |
| **P1** | Playwright 超时 | 🟡 中等 | 本方案修复 |
| **P2** | 代理日志 + SVG 缓存 | 🟢 轻微 | 本方案修复 |
| **U1-U4** | UI 优化建议 | 🟢 轻微 | 后续迭代 |

---

## 二、D1：CNY 账号费用双重转换（无 C1 补丁）

### 2.1 问题阐释

**现象**：wj03 的 CZSMCC11261 在 Google Ads 后台显示 ¥2,209.92，网站显示 ¥296.77（偏低 86.6%）

**根因**：存储时 ÷7.2，L7D 分析时再 ÷7.2（双重转换）

### 2.2 修复思路

**原则**：存储原始货币值，读取时统一转换

**数据流说明**（v15.0 勘误后）：
- **API 同步路径**：`GoogleAdsApiData` ← `google_ads_service_account_sync.py` ← 需修复
- **上传路径**：`AdCampaignDailyMetric` ← 用户 Excel ← **不受 D1 影响，无需修改**

### 2.3 修改清单（仅存储端）

| 序号 | 文件 | 位置 | 修改内容 |
|------|------|------|---------|
| 1 | `google_ads_service_account_sync.py` | 第 1175-1177 行 | 移除汇率转换 |

**修改内容**：

```python
# 修改前
converted_cost = raw_cost / currency_rate
converted_budget = raw_budget / currency_rate
converted_cpc = raw_cpc / currency_rate

# 修改后
converted_cost = raw_cost
converted_budget = raw_budget
converted_cpc = raw_cpc
```

### 2.4 清理脚本（E1 修正：Python + SQLAlchemy）

**目的**：删除 D1 修复前已错误存储的 CNY 历史数据，以便重新同步后得到正确值。

**主方案**：Python 脚本，兼容 SQLite 与 PostgreSQL。

**脚本路径**：`backend/scripts/clean_cny_google_ads_data.py`

**脚本结构**（E2 修正：完整模型查询；N3 采纳：sys.path 保障）：

```python
"""
D1 清理脚本：删除 CNY 账号的 Google Ads API 历史数据
执行前请备份数据库。兼容 SQLite / PostgreSQL。
"""
# N3：确保从任意目录执行均可找到 app 模块
import sys
import os
sys.path.insert(0, os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from app.database import SessionLocal
from app.models.google_ads_api_data import GoogleAdsApiData, GoogleMccAccount
import json
from datetime import datetime

def main():
    db = SessionLocal()
    try:
        # 1. 找出 CNY 账号的 mcc_id（E2 修正：完整模型查询，避免 Row 无 .id 属性）
        cny_mccs = db.query(GoogleMccAccount).filter(
            GoogleMccAccount.currency == 'CNY'
        ).all()
        cny_mcc_ids = [m.id for m in cny_mccs]
        if not cny_mcc_ids:
            print("无 CNY 账号，无需清理")
            return

        # 2. 备份摘要到 JSON（行数、示例数据）
        to_delete = db.query(GoogleAdsApiData).filter(
            GoogleAdsApiData.mcc_id.in_(cny_mcc_ids)
        ).all()
        backup_path = f"cny_backup_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
        with open(backup_path, "w", encoding="utf-8") as f:
            json.dump([{"id": r.id, "date": str(r.date), "cost": r.cost} for r in to_delete[:100]], f, indent=2, ensure_ascii=False)
        print(f"备份摘要已写入 {backup_path}，共 {len(to_delete)} 行待删除")

        # 3. 确认后执行
        confirm = input("确认删除？输入 yes 继续: ")
        if confirm.strip().lower() != "yes":
            print("已取消")
            return
        deleted = db.query(GoogleAdsApiData).filter(
            GoogleAdsApiData.mcc_id.in_(cny_mcc_ids)
        ).delete(synchronize_session=False)
        db.commit()
        print(f"已删除 {deleted} 行")

        # 4. 验证
        remaining = db.query(GoogleAdsApiData).filter(
            GoogleAdsApiData.mcc_id.in_(cny_mcc_ids)
        ).count()
        print(f"验证：CNY 数据剩余 {remaining} 行（应为 0）")
    finally:
        db.close()

if __name__ == "__main__":
    main()
```

**执行方式**：

```bash
cd backend
python -m scripts.clean_cny_google_ads_data
```

**可选**：若生产环境使用 PostgreSQL，可保留 psql 命令作为补充，但 Python 脚本为主方案。

### 2.5 验证方法

1. 执行 D1 存储端修改并部署
2. 执行清理脚本删除 CNY 历史数据
3. 等待 Google Ads API 配额重置后，重新同步 CNY 账号
4. 对比数据库 `google_ads_api_data.cost` 与 Google Ads 后台显示值，应一致

---

## 三、D2：拒付佣金汇总与明细不一致（C2 修正：差值法）

### 3.1 问题阐释

**现象**：顶部卡片「拒付佣金」有值，表格明细「拒付佣金($)」列全为 $0.00

### 3.2 根因

部分拒付交易的 `merchant_id` 为空，按商家分组时这些数据被丢失。

### 3.3 修复方案（C2 修正：差值法）

**原则**：不单独查询无 MID 拒付，而是用 `total_rejected_commission - sum(breakdown.rejected_commission)` 计算差额，保证与 `base_query` 筛选条件一致。

**文件**：`backend/app/api/platform_data.py`

**修改位置**：第 538 行附近（`merchant_breakdown` 构建完成后）

```python
# 在 merchant_breakdown 循环结束后、返回前添加

# C2 修正：用差值法追加"未归类拒付"行，保证 total = sum(breakdown)
breakdown_rejected_sum = sum(item.get("rejected_commission", 0) for item in merchant_breakdown)
missing_rejected = round(float(total_rejected_commission) - breakdown_rejected_sum, 2)

if missing_rejected > 0.01:
    merchant_breakdown.append({
        "mid": "N/A",
        "merchant": "(未归类拒付)",
        "platform": "mixed",
        "account_label": "-",
        "orders": 0,
        "gmv": 0,
        "total_commission": 0,
        "approved_commission": 0,
        "pending_commission": 0,
        "rejected_commission": missing_rejected
    })
```

**说明**：
- `total_rejected_commission` 与 `merchant_breakdown` 使用相同的 `base_query` 筛选
- 差值 = 因无 MID 而无法归入任一商家的拒付金额
- 保证 `sum(breakdown.rejected_commission) == total_rejected_commission`

---

## 四、D3：L7D 广告系列数量不一致

### 4.1 问题阐释

**现象**：L7D 分析表格中的广告系列数量少于 Google Ads 后台

**根因**：`api_analysis_service.py` 第 785-787 行过滤了 `clicks==0 and cost==0 and commission==0` 的广告系列

### 4.2 修复方案（方案 B：添加 include_empty 开关，N2 细化）

**原则**：默认保持现有行为（过滤空数据），增加「显示无数据的广告系列」复选框，勾选时不过滤

**参数传递链路**（完整实现方式）：

| 层级 | 文件 | 修改内容 |
|------|------|---------|
| 1. 端点 | `analysis.py` 第 819-846 行 | 增加参数 `include_empty: bool = Query(False, description="是否显示无数据的广告系列")` |
| 2. 调用 | `analysis.py` 第 846 行 | `generate_l7d_analysis(end, user_id, include_empty=include_empty)` |
| 3. Service 签名 | `api_analysis_service.py` 第 633 行 | `def generate_l7d_analysis(self, end_date, user_id=None, include_empty: bool = False)` |
| 4. 过滤逻辑 | `api_analysis_service.py` 第 785-787 行 | `if not include_empty and (clicks==0 and cost==0 and commission==0): continue` |
| 5. 前端 | `Analysis.jsx` L7D 分析区域 | 增加「显示无数据的广告系列」复选框，请求时带上 `include_empty=true` 查询参数 |

**端点修改示例**：

```python
# analysis.py 第 819-846 行
@router.post("/l7d")
async def generate_l7d_analysis_from_api(
    end_date: Optional[str] = Query(None, description="结束日期 YYYY-MM-DD（默认为昨天）"),
    include_empty: bool = Query(False, description="是否显示无数据的广告系列"),
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
):
    ...
    result = api_analysis_service.generate_l7d_analysis(end, user_id, include_empty=include_empty)
```

---

## 五、D5-原始：>90% 显示（M2 修正，N1 明确修改范围）

### 5.1 处置意见

**结论**：不修改存储，前端显示时格式化。

### 5.2 前端格式化函数（M2 修正）

```javascript
// M2 修正：> 0.9 而非 >= 0.9，避免 90.0% 显示为 ">90%"
const formatIsLost = (value) => {
  if (value === null || value === undefined) return '-';
  if (value === 0) return '-';
  if (value > 0.9) return '>90%';  // 严格大于 90% 时显示
  return `${(value * 100).toFixed(1)}%`;
};
```

### 5.3 修改文件清单（N1 明确）

| 文件 | 位置 | 修改内容 |
|------|------|---------|
| `Analysis.jsx` 或公共 utils | - | 定义并导出 `formatIsLost`，供其他组件复用 |
| `DataCenter.jsx` | 第 263、269 行 | 将 IS Budget/Rank 的 render 改为 `render: (val) => formatIsLost(val)`，替换原 `val ? \`${(val*100).toFixed(1)}%\` : '-'` |
| `GoogleAdsData.jsx` | 第 461、469 行（render） | 若需统一展示规则，将 render 改为 `formatIsLost(val)`（第 457、465 为列 title，以 render 为准） |

**说明**：`Analysis.jsx` 第 309-310 行是解析 Excel 输入，非展示逻辑，无需修改。实际展示 IS Budget/Rank 的组件为 DataCenter、GoogleAdsData。

**可选**：若需对齐 Google Ads 约定（≥90% 显示 ">90%"），可改为 `>= 0.9` 并加注释说明。

---

## 六、D6：当前 Max CPC 来源错误（仅 api_analysis_service.py）

### 6.1 问题阐释

**用户要求**：取同一广告系列中所有已启用关键词的「最高每次点击费用」的最大值

### 6.2 修复范围（v15.0 修正）

| 端点 | 数据来源 | 本次是否修复 | 说明 |
|------|---------|-------------|------|
| L7D 分析 `/l7d` | `api_analysis_service.py` ← Google Ads API | ✅ 修复 | 有 MCC 上下文，可做货币转换 |
| 上传分析 `/from-daily`、`/from-daily-with-google` | `analysis.py` ← 用户 Excel | ❌ 推迟 | 无 MCC 上下文，需单独设计 |

### 6.3 修改清单（仅 api_analysis_service.py）

**文件**：`backend/app/services/api_analysis_service.py`

**位置**：第 792-799 行

```python
# 修改前
max_cpc_limit = bid_strategy.max_cpc_limit if bid_strategy and bid_strategy.max_cpc_limit else None
current_max_cpc = max_cpc_limit if max_cpc_limit else cdata["max_cpc"]

# 修改后
# 从 KeywordBid 获取关键字级别最高 CPC（两级回退）
from app.models.keyword_bid import KeywordBid

keyword_max_cpc_raw = self.db.query(func.max(KeywordBid.max_cpc)).filter(
    KeywordBid.user_id == data_user_id,
    KeywordBid.campaign_id == cdata["campaign_id"],
    KeywordBid.status == "ENABLED"
).scalar()

if keyword_max_cpc_raw:
    # KeywordBid 存原始货币，需转换为 USD
    current_max_cpc = convert_to_usd(keyword_max_cpc_raw, cdata["currency"])
else:
    current_max_cpc = cdata["max_cpc"]
```

**说明**：`cdata` 中已有 `currency` 字段（第 698 行），可直接用于 `convert_to_usd`。

### 6.4 analysis.py D6 补丁：推迟

**原因**：
- `AdCampaign` 无 `mcc_id`，无法获取货币类型
- 上传路径的 `m.cpc` 来自用户 Excel，货币由用户约定
- 若从 `KeywordBid` 取 CPC，需解决 campaign_name→campaign_id/MCC 映射

**后续**：若产品确认上传路径也需修复，再单独设计方案。

### 6.5 字段定义更新

**文件**：`网站字段定义参考手册.md` 第 142 行

```markdown
| 当前Max CPC | 当前最高CPC | 取同一广告系列中所有已启用关键词的「最高每次点击费用」的最大值；如无关键词数据则回退到广告系列级别 CPC 最大值（仅 L7D 分析） | Google Ads 关键字级别 |
```

---

## 七、P1：Playwright 超时

### 7.1 修改点

| 文件 | 位置 | 修改内容 |
|------|------|---------|
| `claude_service.py` | 第 598 行 | `timeout=60000` → `timeout=120000`（或更高） |
| `claude_service.py` | 第 601 行 | `timeout=30000` → `timeout=60000` |
| `claude_service.py` | 关键操作 | 增加 try/except 捕获超时异常并记录日志 |
| `luchuApi.js` | 第 67 行 | `maxTime = 180000` → `maxTime = 360000` |

**说明**：已在 v13.0 审核通过，按上述修改即可。

---

## 八、P2：代理日志 + SVG 缓存

### 8.1 修改点

| 文件 | 修改内容 |
|------|---------|
| `luchu_images.py` | 代理请求失败时增加 `logger.warning` 日志 |
| `luchu_images.py` | SVG 请求增加 `Cache-Control: no-store` 避免缓存旧图 |

**说明**：已在 v12.0 审核通过，按上述修改即可。

---

## 九、修改范围汇总（v5.4）

### 9.1 代码修改

| 文件 | 修改内容 | 问题编号 |
|------|---------|---------|
| `google_ads_service_account_sync.py` | 移除 ÷7.2（第 1175-1177 行） | D1 |
| `api_analysis_service.py` | KeywordBid 查询 + convert_to_usd（第 792-799 行） | D6 |
| `api_analysis_service.py` | `include_empty` 参数（第 633、785-787 行） | D3 |
| `analysis.py` | `/l7d` 端点增加 `include_empty` 查询参数并传入 service | D3 |
| `platform_data.py` | 差值法追加"未归类拒付"行（第 538 行后） | D2 |
| `claude_service.py` | Playwright 超时（第 598、601 行） | P1 |
| `luchu_images.py` | warning 日志 + no-store | P2 |
| `luchuApi.js` | maxTime 360000（第 67 行） | P1 |
| `Analysis.jsx` | "显示无数据的广告系列"复选框 | D3 |
| `DataCenter.jsx` | IS Budget/Rank 使用 formatIsLost（第 263、269 行） | D5 |
| `GoogleAdsData.jsx` | IS Budget/Rank 使用 formatIsLost（第 461、469 行 render，可选） | D5 |
| `网站字段定义参考手册.md` | Max CPC 字段定义 | D6 |
| `scripts/clean_cny_google_ads_data.py` | **新增** D1 清理脚本（E2 修正：完整模型查询；N3：sys.path） | D1 |
| ~~`analysis.py`~~ | ~~C1 补丁~~ **已撤销** | - |
| ~~`analysis.py`~~ | ~~D6 补丁~~ **已推迟** | - |

**总计**：9 个代码文件 + 1 个新增脚本 + 1 个文档，约 90 行修改

### 9.2 提交策略

```bash
git add .
git commit -m "fix: 综合问题修复 v5.4

修复问题：
- D1: CNY 账号费用双重转换（仅存储端 + Python 清理脚本，E2/N3 修正）
- D2: 拒付佣金汇总与明细不一致（差值法）
- D3: L7D 广告系列数量不一致（include_empty 开关）
- D5: IS Budget/Rank >90% 格式（DataCenter、GoogleAdsData）
- D6: 当前 Max CPC 来源错误（仅 api_analysis_service.py）
- P1: Playwright 超时
- P2: 代理日志 + SVG 缓存

响应审核报告 v17.0：E2+N3"

git push origin main
```

### 9.3 回滚方案

```bash
git revert HEAD
git push origin main

# 服务器
cd ~/Google-Data-Analysis && git pull origin main
pkill -9 -f "uvicorn.*app.main" || true
sleep 2
cd backend && source venv/bin/activate
nohup /home/admin/Google-Data-Analysis/backend/venv/bin/uvicorn app.main:app --host 0.0.0.0 --port 8000 >> run.log 2>&1 &
```

---

## 十、审核清单

| 序号 | 检查项 | 状态 |
|------|--------|------|
| 1 | E2：D1 清理脚本查询已改为完整模型 `query(GoogleMccAccount).all()` | ⬜ 待确认 |
| 2 | N3：D1 清理脚本已添加 sys.path 保障 | ⬜ 待确认 |
| 3 | E1：D1 清理脚本已改为 Python + SQLAlchemy，兼容 SQLite/PostgreSQL | ⬜ 待确认 |
| 4 | N1：D5 formatIsLost 修改范围已明确（DataCenter、GoogleAdsData 第 461/469 行 render） | ⬜ 待确认 |
| 5 | N2：D3 include_empty 参数传递链路已细化 | ⬜ 待确认 |
| 6 | 修改范围明确（9 文件 + 1 脚本 + 1 文档） | ⬜ 待确认 |
| 7 | 回滚方案完整 | ⬜ 待确认 |

---

*本设计方案 v5.4 响应审核报告 v17.0，修正 E2（清理脚本 SQLAlchemy 查询改为完整模型，避免 Row 无 .id 属性）、采纳 N3（添加 sys.path 保障）。修正 E2 后方案可执行。*
