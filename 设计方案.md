# 全系统功能核查与设计方案

> **设计人员**: AI 开发助手  
> **验收人员**: 07  
> **版本**: v6.1（用户体系修正版）  
> **日期**: 2026-02-25  
> **审核状态**: 待 07 验收  
> **变更说明**: v6.0 全面核查 → v6.1 根据 07 反馈修正用户体系认知，发现致命级 bug

---

## 〇、沟通记录

| 日期 | 沟通内容 | 结论 | 备注 |
|------|---------|------|------|
| 2026-02-25 | 07 要求全面核查系统功能 | 建立核查清单 + 一键测试脚本 | 对不合理/赘余/无法实现的功能全部列出 |
| 2026-02-25 | 07 指出经理账号已改为 `manager`，且有组长角色 `wjzu` | 深入重新探查用户体系，发现致命 bug | 设计人员初次探查不够深入，已修正 |
| | | | |

---

## 一、系统概况

| 项目 | 说明 |
|------|------|
| 项目名称 | Google Ads 数据分析平台 |
| 前端技术 | React 18 + Vite + Ant Design 5 |
| 后端技术 | FastAPI + SQLAlchemy + SQLite/PostgreSQL |
| 前端部署 | Cloudflare Pages |
| 后端部署 | 云服务器 (uvicorn) |
| GitHub | https://github.com/starrats111/Google-Data-Analysis |
| API 域名 | https://api.google-data-analysis.top |
| 前端域名 | https://google-data-analysis.top |
| 后端 API 路由文件 | 34 个 |
| 后端 API 端点 | 约 150+ 个 |
| 前端页面组件 | 36 个（3 个未注册路由） |
| 后端脚本 | 121+ 个（大部分为一次性修复脚本） |
| 数据模型 | 20+ 个 SQLAlchemy 模型 |
| 定时任务 | 4 个定时 + 1 个一次性 |

### 用户角色体系（v6.1 修正）

| 角色 | 英文 | 用户名 | 数量 | 权限范围 |
|------|------|--------|------|---------|
| 经理 | MANAGER | `manager` | 1 个 | 查看/编辑/删除所有数据 |
| 组长 | LEADER | `wjzu`, `jyzu`, `yzzu` | 3 个 | 查看/编辑/删除本组数据 |
| 组员 | MEMBER | `wj01`-`wj10`, `jy01`-`jy10`, `yz01`-`yz10` | 30 个 | 仅查看/编辑自己的数据 |
| 员工 | EMPLOYEE | （兼容旧数据） | - | 等同 MEMBER |

**小组结构**:

| 小组 | 组长 | 组员 |
|------|------|------|
| wj 组（文俊组） | `wjzu` | `wj01` - `wj10` |
| jy 组 | `jyzu` | `jy01` - `jy10` |
| yz 组 | `yzzu` | `yz01` - `yz10` |

> **重要**: 经理账号已从 `wenjun123` 迁移为 `manager`（通过 `migrate_teams.py`），但代码中多处仍硬编码 `wenjun123`，详见下方致命 bug SEC-4。

---

## 二、全系统功能核查清单

### A. 基础设施（4 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| A1 | 健康检查 | `GET /health` | ⬜ 待测 | - | - | 保留 |
| A2 | CORS 跨域配置 | `main.py` | 🔴 有问题 | 三重 CORS 处理层叠加（CORSMiddleware + cors_logging_middleware + options_handler），过度工程化，日志中间件在生产环境有性能开销 | 中等 | 精简为仅 CORSMiddleware |
| A3 | CORS 配置重复 | `config.py:86-104` | 🔴 有问题 | 第 88 行和第 101 行完全重复 `"https://google-data-analysis.top"`，第 92 行和第 103 行完全重复 `"https://google-data-analysis.pages.dev"` | 轻微 | 删除重复项 |
| A4 | SPA 回退路由 | `main.py:377-396` | 🟡 待验证 | 仅当 `frontend/dist` 存在时生效，若后端不托管前端则无用 | 轻微 | 确认部署模式后决定 |

### B. 认证与用户（6 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| B1 | 用户登录 | `POST /api/auth/login` | ⬜ 待测 | - | - | 保留 |
| B2 | 获取当前用户 | `GET /api/auth/me` | ⬜ 待测 | - | - | 保留 |
| B3 | Token 刷新 | `POST /api/auth/refresh` | ⬜ 待测 | - | - | 保留 |
| B4 | 登出 | `POST /api/auth/logout` | ⬜ 待测 | - | - | 保留 |
| B5 | 用户列表（经理） | `GET /api/users/` | ⬜ 待测 | - | - | 保留 |
| B6 | 重置密码硬编码 | `team_management.py:428-437` | 🔴 安全问题 | 默认密码硬编码在源码中（wj123456, jy123456 等），任何能看到代码的人都知道默认密码 | 严重 | 改为从环境变量读取或由经理自行指定 |

### C. MCC 账号管理（8 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| C1 | 创建 MCC 账号 | `POST /api/mcc/accounts` | ⬜ 待测 | - | - | 保留 |
| C2 | 列出 MCC 账号 | `GET /api/mcc/accounts` | ⬜ 待测 | - | - | 保留 |
| C3 | 更新 MCC 账号 | `PUT /api/mcc/accounts/{id}` | ⬜ 待测 | - | - | 保留 |
| C4 | 删除 MCC 账号 | `DELETE /api/mcc/accounts/{id}` | ⬜ 待测 | - | - | 保留 |
| C5 | 手动同步 MCC | `POST /api/mcc/accounts/{id}/sync` | ⬜ 待测 | - | - | 保留 |
| C6 | 测试 MCC 连接 | `POST /api/mcc/accounts/{id}/test-connection` | ⬜ 待测 | - | - | 保留 |
| C7 | 同步历史数据 | `POST /api/mcc/accounts/{id}/sync-history` | ⬜ 待测 | - | - | 保留 |
| C8 | 服务账号配置 | `POST /api/mcc/service-account` | ⬜ 待测 | - | - | 保留 |

### D. 联盟平台管理（7 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| D1 | 列出平台 | `GET /api/affiliate/platforms` | ⬜ 待测 | - | - | 保留 |
| D2 | 列出账号 | `GET /api/affiliate/accounts` | ⬜ 待测 | - | - | 保留 |
| D3 | 创建/更新/删除账号 | `POST/PUT/DELETE` | ⬜ 待测 | - | - | 保留 |
| D4 | 测试 API 连接 | `POST /api/affiliate/accounts/{id}/test-api` | ⬜ 待测 | - | - | 保留 |
| D5 | 同步账号数据 | `POST /api/affiliate/accounts/{id}/sync` | ⬜ 待测 | - | - | 保留 |
| D6 | CollabGlow 专用 API | `collabglow.py` | 🟡 赘余 | 已有通用同步接口 `affiliate.py`，CollabGlow 专用端点功能重叠 | 轻微 | 考虑合并到通用接口 |
| D7 | LinkHaitao 专用 API | `linkhaitao.py` | 🟡 赘余 | 同上，功能与通用接口重叠 | 轻微 | 考虑合并到通用接口 |

### E. Google Ads 数据（4 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| E1 | 原始数据查询 | `GET /api/google-ads-data/` | ⬜ 待测 | - | - | 保留 |
| E2 | 数据汇总 | `GET /api/google-ads-data/summary` | ⬜ 待测 | - | - | 保留 |
| E3 | 按系列聚合 | `GET /api/google-ads-aggregate/by-campaign` | ⬜ 待测 | - | - | 保留 |
| E4 | 实时同步 | `POST /api/google-ads-aggregate/sync-realtime` | ⬜ 待测 | - | - | 保留 |

### F. 平台数据（4 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| F1 | 数据汇总 | `GET /api/platform-data/summary` | ⬜ 待测 | - | - | 保留 |
| F2 | 数据明细 | `GET /api/platform-data/detail` | ⬜ 待测 | - | - | 保留 |
| F3 | 交易记录 | `GET /api/platform-data/transactions` | ⬜ 待测 | - | - | 保留 |
| F4 | 实时同步 | `POST /api/platform-data/sync-realtime` | ⬜ 待测 | - | - | 保留 |

### G. 数据分析（7 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| G1 | 废弃端点 | `POST /api/analysis/process` | 🔴 赘余 | 返回 410 Gone，已废弃但仍注册在路由中 | 轻微 | 删除 |
| G2 | 生成分析 | `POST /api/analysis/generate` | ⬜ 待测 | - | - | 保留 |
| G3 | 分析结果列表 | `GET /api/analysis/results` | ⬜ 待测 | - | - | 保留 |
| G4 | 生成 L7D 分析 | `POST /api/analysis/l7d` | ⬜ 待测 | - | - | 保留 |
| G5 | 每日分析 | `POST /api/analysis/daily` | ⬜ 待测 | - | - | 保留 |
| G6 | 从 Excel 生成 | `POST /api/analysis/from-daily` | ⬜ 待测 | - | - | 保留 |
| G7 | 从 Excel+Google 生成 | `POST /api/analysis/from-daily-with-google` | ⬜ 待测 | - | - | 保留 |

### H. 出价管理（12 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| H1 | 出价策略列表 | `GET /api/bids/strategies` | ⬜ 待测 | - | - | 保留 |
| H2 | 关键词列表 | `GET /api/bids/keywords` | ⬜ 待测 | - | - | 保留 |
| H3 | 同步出价数据 | `POST /api/bids/sync` | ⬜ 待测 | - | - | 保留 |
| H4 | 切换手动 CPC | `POST /api/bids/change-to-manual` | ⬜ 待测 | - | - | 保留 |
| H5 | 设置关键词 CPC | `POST /api/bids/set-keyword-cpc` | ⬜ 待测 | - | - | 保留 |
| H6 | 批量设置 CPC | `POST /api/bids/batch-set-cpc` | ⬜ 待测 | - | - | 保留 |
| H7 | 获取系列最大 CPC | `GET /api/bids/campaign-max-cpc/{id}` | ⬜ 待测 | - | - | 保留 |
| H8 | 设置预算 | `POST /api/bids/set-budget` | ⬜ 待测 | - | - | 保留 |
| H9 | 一键部署 | `POST /api/bids/one-click-deploy` | ⬜ 待测 | - | - | 保留 |
| H10 | 关键词建议 | `POST /api/bids/get-keyword-suggestions` | ⬜ 待测 | - | - | 保留 |
| H11 | 添加关键词 | `POST /api/bids/add-keyword` | ⬜ 待测 | - | - | 保留 |
| H12 | 广告组列表 | `GET /api/bids/ad-groups` | ⬜ 待测 | - | - | 保留 |

### I. 仪表板（6 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| I1 | 总览（经理） | `GET /api/dashboard/overview` | ⬜ 待测 | - | - | 保留 |
| I2 | 趋势数据 | `GET /api/dashboard/trend` | ⬜ 待测 | - | - | 保留 |
| I3 | 员工列表 | `GET /api/dashboard/employees` | ⬜ 待测 | - | - | 保留 |
| I4 | 员工洞察 | `GET /api/dashboard/employee-insights` | ⬜ 待测 | - | - | 保留 |
| I5 | 平台汇总（旧） | `GET /api/dashboard/platform-summary` | 🟡 过时 | 使用旧 AnalysisResult 数据格式，可能数据不准 | 中等 | 迁移到新数据源或删除 |
| I6 | 账号详情（旧） | `GET /api/dashboard/account-details` | 🟡 过时 | 同上 | 中等 | 迁移到新数据源或删除 |

### J. 费用管理（5 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| J1 | 费用汇总 | `GET /api/expenses/summary` | ⬜ 待测 | - | - | 保留 |
| J2 | 费用明细 | `GET /api/expenses/cost-detail` | ⬜ 待测 | - | - | 保留 |
| J3 | MCC 费用明细 | `GET /api/expenses/mcc-cost-detail` | ⬜ 待测 | - | - | 保留 |
| J4 | 每日费用 | `GET /api/expenses/daily` | ⬜ 待测 | - | - | 保留 |
| J5 | 清理重复费用 | `POST /api/expenses/clean-duplicate-costs` | ⬜ 待测 | - | - | 保留 |

### K. 报告模块（7 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| K1 | 财务报告 | `GET /api/reports/financial` | ⬜ 待测 | - | - | 保留 |
| K2 | 月度报告 | `GET /api/reports/monthly` | ⬜ 待测 | - | - | 保留 |
| K3 | 季度报告 | `GET /api/reports/quarterly` | ⬜ 待测 | - | - | 保留 |
| K4 | 年度报告 | `GET /api/reports/yearly` | ⬜ 待测 | - | - | 保留 |
| K5 | 月度导出 | `GET /api/reports/monthly/export` | ⬜ 待测 | - | - | 保留 |
| K6 | 季度导出 | `GET /api/reports/quarterly/export` | ⬜ 待测 | - | - | 保留 |
| K7 | 年度导出 | `GET /api/reports/yearly/export` | ⬜ 待测 | - | - | 保留 |

### L. AI / Gemini（9 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| L1 | AI 报告列表 | `GET /api/gemini/reports` | ⬜ 待测 | - | - | 保留 |
| L2 | 生成 AI 报告 | `POST /api/gemini/generate-report` | ⬜ 待测 | - | - | 保留 |
| L3 | 分析广告系列 | `POST /api/gemini/analyze-campaign` | ⬜ 待测 | - | - | 保留 |
| L4 | 生成操作指令 | `POST /api/gemini/generate-instructions` | ⬜ 待测 | - | - | 保留 |
| L5 | 推荐关键词 | `POST /api/gemini/recommend-keywords` | ⬜ 待测 | - | - | 保留 |
| L6 | 营销日历 | `GET /api/gemini/marketing-calendar/{country}` | ⬜ 待测 | - | - | 保留 |
| L7 | 图片分析 | `POST /api/gemini/analyze-image` | ⬜ 待测 | - | - | 保留 |
| L8 | L7D 审计分析 | `POST /api/gemini/analyze-l7d` | ⬜ 待测 | - | - | 保留 |
| L9 | 自定义提示词 | `GET/POST /api/gemini/user-prompt` | ⬜ 待测 | - | - | 保留 |

### M. 文件上传（3 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| M1 | 上传 Google Ads 文件 | `POST /api/upload/google-ads` | ⬜ 待测 | - | - | 保留 |
| M2 | 上传联盟数据文件 | `POST /api/upload/affiliate` | ⬜ 待测 | - | - | 保留 |
| M3 | 上传历史 | `GET /api/upload/history` | ⬜ 待测 | - | - | 保留 |

### N. 团队管理（7 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| N1 | 团队列表 | `GET /api/team/teams` | ⬜ 待测 | - | - | 保留 |
| N2 | 创建/更新/删除团队 | `POST/PUT/DELETE` | ⬜ 待测 | - | - | 保留 |
| N3 | 用户列表 | `GET /api/team/users` | ⬜ 待测 | - | - | 保留 |
| N4 | 团队统计 | `GET /api/team/stats/teams` | ⬜ 待测 | - | - | 保留 |
| N5 | 成员排名 | `GET /api/team/stats/ranking` | ⬜ 待测 | - | - | 保留 |
| N6 | 同步团队数据 | `POST /api/team/sync-team-data` | ⬜ 待测 | - | - | 保留 |
| N7 | 我的信息 | `GET /api/team/me/info` | ⬜ 待测 | - | - | 保留 |

### O. 数据导出（2 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| O1 | 导出分析结果 | `GET /api/export/analysis` | ⬜ 待测 | - | - | 保留 |
| O2 | 导出仪表板（经理） | `GET /api/export/dashboard` | ⬜ 待测 | - | - | 保留 |

### P. 系统管理（3 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| P1 | 系统健康 | `GET /api/system/health` | ⬜ 待测 | - | - | 保留 |
| P2 | 系统日志 | `GET /api/system/logs` | ⬜ 待测 | - | - | 保留 |
| P3 | 系统统计 | `GET /api/system/stats` | ⬜ 待测 | - | - | 保留 |

### Q. 露出功能 Luchu（18 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| Q1 | 文章列表 | `GET /api/luchu/articles` | ⬜ 待测 | - | - | 保留 |
| Q2 | 创建文章 | `POST /api/luchu/articles` | ⬜ 待测 | - | - | 保留 |
| Q3 | 提交审核 | `POST /api/luchu/articles/{id}/submit` | ⬜ 待测 | - | - | 保留 |
| Q4 | AI 分析商家 | `POST /api/luchu/ai/analyze` | ⬜ 待测 | - | - | 保留 |
| Q5 | AI 生成文章 | `POST /api/luchu/ai/generate` | ⬜ 待测 | - | - | 保留 |
| Q6 | 审核管理 | `GET /api/luchu/reviews` | ⬜ 待测 | - | - | 保留 |
| Q7 | 发布文章 | `POST /api/luchu/publish/{id}` | ⬜ 待测 | - | - | 保留 |
| Q8 | 网站配置 | `GET /api/luchu/websites` | ⬜ 待测 | - | - | 保留 |
| Q9 | 仪表板统计 | `GET /api/luchu/stats/dashboard` | ⬜ 待测 | - | - | 保留 |
| Q10 | 通知系统 | `GET /api/luchu/notifications` | ⬜ 待测 | - | - | 保留 |
| Q11 | 提示词模板 | `GET /api/luchu/prompts` | ⬜ 待测 | - | - | 保留 |
| Q12 | 操作日志 | `GET /api/luchu/logs` | ⬜ 待测 | - | - | 保留 |
| Q13 | 图片代理 | `GET /api/luchu/images/proxy` | ⬜ 待测 | - | - | 保留 |
| Q14 | 图片上传 | `POST /api/luchu/images/upload` | ⬜ 待测 | - | - | 保留 |
| Q15 | 版本历史 | `GET /api/luchu/articles/{id}/versions` | ⬜ 待测 | - | - | 保留 |
| Q16 | 发布趋势 | `GET /api/luchu/stats/publish-trend` | ⬜ 待测 | - | - | 保留 |
| Q17 | 分类统计 | `GET /api/luchu/stats/category-stats` | ⬜ 待测 | - | - | 保留 |
| Q18 | 审核效率 | `GET /api/luchu/stats/review-efficiency` | ⬜ 待测 | - | - | 保留 |

### R. Google OAuth（2 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| R1 | OAuth 授权 URL | `GET /api/google-oauth/authorize` | 🟡 赘余 | 已改用服务账号模式，OAuth 流程可能不再需要 | 中等 | 确认是否还需要，不需要则删除 |
| R2 | OAuth 回调 | `GET /api/google-oauth/callback` | 🟡 赘余 | 同上 | 中等 | 同上 |

### S. 阶段标签（1 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| S1 | 阶段标签详情 | `GET /api/stage-label/{label}` | ⬜ 待测 | - | - | 保留 |

### T. 广告系列管理（5 项）

| 编号 | 功能 | 端点/位置 | 核查结果 | 问题描述 | 严重程度 | 处置建议 |
|------|------|----------|---------|---------|---------|---------|
| T1 | 列出广告系列 | `GET /api/ad-campaigns` | ⬜ 待测 | - | - | 保留 |
| T2 | 创建广告系列 | `POST /api/ad-campaigns` | ⬜ 待测 | - | - | 保留 |
| T3 | 更新广告系列 | `PUT /api/ad-campaigns/{id}` | ⬜ 待测 | - | - | 保留 |
| T4 | 批量更新 | `POST /api/ad-campaigns/batch-update` | ⬜ 待测 | - | - | 保留 |
| T5 | Excel 导入 | `POST /api/ad-campaigns/import` | ⬜ 待测 | - | - | 保留 |

---

## 三、已发现的严重问题汇总

### 3.1 安全问题（4 项，含 1 项致命）

| 编号 | 问题 | 位置 | 严重程度 | 详情 |
|------|------|------|---------|------|
| **SEC-4** | **经理账号名不匹配导致功能失效** | `mcc.py:1327`、`config.py:82` | **💀 致命** | **经理已迁移为 `manager`，但 `mcc.py:1327` 仍检查 `username != "wenjun123"`，导致经理用 `manager` 账号无法上传全局服务账号！`config.py:82` 的 `MANAGER_USERNAME` 也仍是 `wenjun123`。** |
| SEC-1 | 默认密码硬编码 | `team_management.py:428-437` | 🔴 严重 | `wj123456`, `jy123456`, `yz123456`, `m123456`, `123456` 明文写在源码 |
| SEC-2 | Developer Token 泄露 | `scripts/update_token_07.sh` 等 4 个文件 | 🔴 严重 | Google Ads Developer Token `hWBTxgYlOiWB4XfXQl_UfA` 硬编码在多个脚本中 |
| SEC-3 | 平台 API Token 泄露 | `scripts/test_collabglow_api.py` 等 | 🟠 中等 | CollabGlow Token `916a0dbb...` 和 Rewardoo Token `41df7906...` 硬编码 |

#### SEC-4 详细说明（致命）

**影响链路**：

```
migrate_teams.py 将 wenjun123 → manager（已执行）
         ↓
mcc.py:1327 仍检查 username != "wenjun123"
         ↓
经理用 manager 登录 → username == "manager" != "wenjun123"
         ↓
条件成立 → 抛出 403 "只有管理员可以上传全局服务账号"
         ↓
💀 经理无法上传服务账号配置！
```

**受影响代码**：

| 文件 | 行号 | 当前代码 | 应改为 |
|------|------|---------|--------|
| `app/api/mcc.py` | 1327 | `current_user.username != "wenjun123"` | `current_user.role != UserRole.MANAGER` |
| `app/config.py` | 82 | `MANAGER_USERNAME: str = "wenjun123"` | `MANAGER_USERNAME: str = "manager"` |
| `scripts/init_users.py` | 21,29 | 创建 `wenjun123` | 改为创建 `manager` |
| `scripts/update_users.py` | 34,40 | 查询 `wenjun123` | 改为查询 `manager` |
| `scripts/migrate_users.py` | 24,27 | 创建 `wenjun123` | 已过时，建议删除 |
| `scripts/test_wj08.py` | 15 | `MANAGER_USERNAME = "wenjun123"` | 已过时，建议删除 |

### 3.2 设计问题（5 项）

| 编号 | 问题 | 位置 | 严重程度 | 详情 |
|------|------|------|---------|------|
| DES-1 | CORS 三重冗余 | `main.py:105-294` | 🟠 中等 | CORSMiddleware + cors_logging_middleware + 手动 options_handler 三层叠加，逻辑复杂且有性能开销 |
| DES-2 | 仪表板两个端点用旧数据 | `dashboard.py` platform-summary/account-details | 🟠 中等 | 依赖旧的 AnalysisResult，数据可能不准确 |
| DES-3 | 废弃端点未清理 | `POST /api/analysis/process` | 🟢 轻微 | 返回 410 Gone 但仍注册在路由中，增加代码噪音 |
| DES-4 | OpenAI 配置残留 | `config.py:133-134,158` | 🟢 轻微 | `OPENAI_API_KEY`, `OPENAI_MODEL`, `OPENAI_BASE_URL` 在配置中但系统只用 Gemini/Claude |
| DES-5 | 月度总结只写日志 | `scheduler.py:739-892` | 🟡 待确认 | `monthly_summary_job` 计算完数据只写入日志，无存储无展示，功能形同虚设 |

### 3.3 代码质量问题（4 项）

| 编号 | 问题 | 位置 | 严重程度 | 详情 |
|------|------|------|---------|------|
| CODE-1 | 脚本重复代码 | `scripts/sync_all_mcc_07.py` | 🟠 中等 | 第 1-104 行和第 106-208 行代码完全重复 |
| CODE-2 | CORS 配置重复 | `config.py:86-104` | 🟢 轻微 | 两个域名在列表中各出现两次 |
| CODE-3 | 定时任务逻辑重复 | `scheduler.py` | 🟠 中等 | `sync_approved_commission_job` 和 `sync_platform_data_90days_job` 功能几乎完全相同，都是同步 90 天平台数据 |
| CODE-4 | 一次性调度任务残留 | `scheduler.py:939-955` | 🟢 轻微 | `sync_mcc_missing_data_job` 是一次性 CNY 补同步任务，每天启动时仍会尝试注册 |

---

## 四、前端页面核查

### 4.1 已注册路由的页面（33 个）

| 路由 | 页面 | 状态 | 说明 |
|------|------|------|------|
| `/` | Dashboard.jsx | ⬜ 待测 | 数据总览 |
| `/analysis-l7d` | Analysis.jsx | ⬜ 待测 | L7D 分析 |
| `/bid-management` | BidManagement.jsx | ⬜ 待测 | 出价管理 |
| `/accounts` | AffiliateAccounts.jsx | ⬜ 待测 | 联盟账号 |
| `/mcc-accounts` | MccAccounts.jsx | ⬜ 待测 | MCC 账号 |
| `/mcc-aggregate` | MccDataAggregate.jsx | ⬜ 待测 | MCC 数据聚合 |
| `/platform-data` | PlatformData.jsx | ⬜ 待测 | 平台每日数据 |
| `/google-ads-data` | GoogleAdsData.jsx | ⬜ 待测 | Google Ads 数据 |
| `/data-center` | DataCenter.jsx | ⬜ 待测 | 数据中心 |
| `/employees` | EmployeeList.jsx | ⬜ 待测 | 员工列表 |
| `/employees/:id` | EmployeeDetail.jsx | ⬜ 待测 | 员工详情 |
| `/expense-cost-detail` | ExpenseCostDetail.jsx | ⬜ 待测 | 费用详情 |
| `/rejections` | RejectionDetails.jsx | ⬜ 待测 | 拒付详情 |
| `/stage-label/:label` | StageLabelDetail.jsx | ⬜ 待测 | 阶段标签 |
| `/ad-copy` | AdCopyGenerator.jsx | ⬜ 待测 | AI 广告词生成 |
| `/my-reports` | MyReports.jsx | ⬜ 待测 | 我的报告 |
| `/financial-report` | FinancialReport.jsx | ⬜ 待测 | 财务报表 |
| `/report-monthly` | ReportMonthly.jsx | ⬜ 待测 | 月度报表 |
| `/report-quarterly` | ReportQuarterly.jsx | ⬜ 待测 | 季度报表 |
| `/report-yearly` | ReportYearly.jsx | ⬜ 待测 | 年度报表 |
| `/system-logs` | SystemLogs.jsx | ⬜ 待测 | 系统日志 |
| `/team-management` | TeamManagement.jsx | ⬜ 待测 | 团队管理 |
| `/team-overview` | TeamOverview.jsx | ⬜ 待测 | 小组总览 |
| `/luchu` | LuchuDashboard.jsx | ⬜ 待测 | 露出总览 |
| `/luchu/create` | LuchuCreate.jsx | ⬜ 待测 | 创建内容 |
| `/luchu/articles` | LuchuArticles.jsx | ⬜ 待测 | 文章列表 |
| `/luchu/articles/:id` | LuchuArticleDetail.jsx | ⬜ 待测 | 文章详情 |
| `/luchu/reviews` | LuchuReviews.jsx | ⬜ 待测 | 审核管理 |
| `/luchu/publish` | LuchuPublish.jsx | ⬜ 待测 | 发布管理 |
| `/luchu/notifications` | LuchuNotifications.jsx | ⬜ 待测 | 通知中心 |
| `/login` | Login.jsx | ⬜ 待测 | 登录 |
| `/google-oauth-callback` | GoogleOAuthCallback.jsx | 🟡 赘余 | OAuth 已改服务账号模式 |

### 4.2 未注册路由的页面文件（3 个，建议删除）

| 文件 | 状态 | 说明 |
|------|------|------|
| `Upload.jsx` | 🔴 废弃 | 文件存在但路由未注册，上传功能已在其他页面实现 |
| `Expenses.jsx` | 🔴 废弃 | 文件存在但路由未注册，费用功能已在 ExpenseCostDetail.jsx 实现 |
| `MyAnalysis.jsx` | 🔴 废弃 | 路由已重定向到 `/analysis-l7d`，仅为跳转页面 |

---

## 五、赘余文件清理清单

### 5.1 根目录赘余文件（全部建议删除/归档）

| 文件 | 类型 | 说明 | 处置建议 |
|------|------|------|---------|
| `一键修复CORS.sh` | 运维脚本 | 一次性 CORS 修复 | 🗑 删除 |
| `修复mcc缩进.py` | 修复脚本 | 一次性代码修复 | 🗑 删除 |
| `完整修复mcc缩进.sh` | 修复脚本 | 同上 | 🗑 删除 |
| `检查并启动后端服务.sh` | 运维脚本 | 一次性使用 | 🗑 删除 |
| `解决分支分歧.sh` | Git 脚本 | 一次性使用 | 🗑 删除 |
| `解决服务器git冲突.sh` | Git 脚本 | 一次性使用 | 🗑 删除 |
| `解决服务器git冲突-手动解决.sh` | Git 脚本 | 一次性使用 | 🗑 删除 |
| `服务器重启和验证CORS.sh` | 运维脚本 | 一次性使用 | 🗑 删除 |
| `快速修复CORS-一键执行.sh` | 运维脚本 | 一次性使用 | 🗑 删除 |
| `服务器启动失败诊断.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `服务器部署问题排查.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `查看启动错误日志命令.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `检查同步错误日志.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `在服务器上直接修复.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `精确修复mcc缩进.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `诊断服务启动失败.txt` | 指令文档 | 临时排查记录 | 🗑 删除 |
| `完整CORS问题诊断和修复.md` | 文档 | 历史排查文档 | 🗑 删除 |
| `服务器部署指令.txt` | 指令文档 | 应移入 docs/ | 📁 归档到 docs/ |
| `compare_lh_data.py` | 脚本 | 不属于根目录 | 🗑 删除 |
| `check_linkhaitao_status.py` | 脚本 | 应在 scripts/ 下 | 🗑 删除 |

**合计**: 20 个赘余文件

### 5.2 `backend/scripts/` 赘余脚本（建议清理）

| 分类 | 数量 | 示例 | 处置建议 |
|------|------|------|---------|
| CORS 修复脚本 | 8 个 | `fix_cors_on_server.sh`, `fix_cors_error.sh`, `check_cors_headers.sh`... | 🗑 全部删除 |
| Developer Token 脚本 | 6 个 | `update_token_07.sh`, `quick_fix_dev_token.py`... | 🗑 全部删除（含敏感信息） |
| MCC 修复脚本 | 6 个 | `fix_mcc_sync_error.sh`, `quick_fix_mcc.sh`... | 🗑 全部删除 |
| 诊断脚本 | 8 个 | `diagnose_*.py`, `diagnose_*.sh` | 🗑 全部删除 |
| 重复部署脚本 | 5 个 | `restart_backend_fixed.sh`, `restart_backend.ps1`... | 保留 1 个，删除其余 |
| 测试脚本（含硬编码密码） | 6 个 | `test_wj07_*.sh`, `test_wj08.py`, `test_all_features.py`... | 🗑 全部删除（含敏感信息） |
| 一次性数据修复 | 10+ 个 | `fix_missing_mid.py`, `fix_zero_commission.py`... | 🗑 全部删除 |
| 数据库迁移（已执行） | 15+ 个 | `add_*_column.py`, `create_*_table.py`... | 📁 归档（已执行则可删） |

**预计可清理**: 60+ 个脚本

### 5.3 建议保留的脚本

| 脚本 | 用途 |
|------|------|
| `init_db.py` | 数据库初始化 |
| `init_users.py` | 用户初始化 |
| `init_platforms.py` | 平台初始化 |
| `deploy_backend.sh` | 标准部署脚本 |
| `full_system_test.py` | 全系统测试脚本（本次新增） |
| `clean_cny_google_ads_data.py` | D1 清理脚本（待执行） |

---

## 六、定时任务核查

| 编号 | 任务名 | 执行时间 | 核查结果 | 问题 |
|------|--------|---------|---------|------|
| CRON-1 | 每日自动同步与分析 | 每天 04:00 | ✅ 正常 | 核心任务，包含 5 个子步骤 |
| CRON-2 | 平台数据补充同步 | 每天 16:00 | ✅ 正常 | 下午再同步一次确保完整 |
| CRON-3 | 月度总结 | 每月 1 号 08:20 | 🟡 形同虚设 | 只写日志无存储无展示（DES-5） |
| CRON-4 | 已付佣金同步 | 每月 1/15 号 00:00 | 🟡 功能重复 | 和 CRON-1 中的周一 90 天同步逻辑几乎完全相同（CODE-3） |
| CRON-5 | 一次性 MCC 补同步 | 今天 16:00（一次性） | 🟡 应移除 | 每天启动时仍尝试注册，应改为手动触发（CODE-4） |

---

## 七、v5.4 遗留问题状态

| 编号 | 问题 | v5.4 方案 | 是否已实施到代码 | 备注 |
|------|------|----------|----------------|------|
| D1 | CNY 双重转换 | 移除 ÷7.2 + 清理脚本 | ⬜ 待确认 | 需检查 `google_ads_service_account_sync.py:1175` |
| D2 | 拒付佣金不一致 | 差值法 | ⬜ 待确认 | 需检查 `platform_data.py:538` |
| D3 | L7D 系列数量不一致 | include_empty 开关 | ⬜ 待确认 | 需检查 `api_analysis_service.py:633,785` |
| D5 | IS >90% 格式 | formatIsLost | ⬜ 待确认 | 需检查 `DataCenter.jsx:263,269` |
| D6 | Max CPC 来源错误 | KeywordBid 查询 | ⬜ 待确认 | 需检查 `api_analysis_service.py:792` |
| P1 | Playwright 超时 | 增加 timeout | ⬜ 待确认 | 需检查 `claude_service.py:598,601` |
| P2 | 代理日志+SVG 缓存 | warning 日志 + no-store | ⬜ 待确认 | 需检查 `luchu_images.py` |

---

## 八、一键测试脚本使用方式（v6.1 修正）

**脚本路径**: `backend/scripts/full_system_test.py`

**使用方法**（三种角色全部测试）:

```bash
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
python -m scripts.full_system_test \
  --username wj07 --password "wj123456" \
  --manager-username manager --manager-password "m123456" \
  --leader-username wjzu --leader-password "wj123456"
```

**测试覆盖范围**: 24 个模块，约 80+ 个端点，覆盖经理/组长/组员三种角色

**测试项目**:
1. 基础连通性（/health, /, /api/system/health）
2. 认证模块（三种角色登录、获取用户、用户统计）
3. MCC 管理（列表、状态、经理查看用户 MCC）
4. 联盟平台（平台、账号、经理按员工分组）
5. Google Ads 数据（原始、汇总、聚合）
6. 平台数据（汇总、明细、交易）
7. 联盟交易（汇总、拒付）
8. 数据分析（结果、废弃端点验证、L7D 数据）
9. 出价管理（策略、关键词）
10. 仪表板（经理总览、组长洞察、组员洞察）
11. 费用管理（汇总、明细、MCC、每日）
12. 报告模块（财务、月/季/年度，经理/组长都测）
13. AI/Gemini（报告、提示词、营销日历）
14. 广告系列（列表）
15. 数据导出（分析结果）
16. 文件上传（历史）
17. 用户管理（列表）
18. 团队管理（经理团队列表、组长统计排名、组员我的信息）
19. 系统管理（日志、统计）
20. 露出功能（文章、网站、通知等 15 个端点，含经理/组长专用）
21. 阶段标签（K1-T1 五个标签）
22. Google OAuth（授权 URL）
23. 平台专用 API（CollabGlow、LinkHaitao）
24. **权限边界测试**（组员禁访经理接口、未认证禁访）

---

## 九、整改优先级建议

### P0 - 立即处理（致命 + 安全）

| 编号 | 内容 | 工作量 |
|------|------|--------|
| **SEC-4** | **修复 mcc.py:1327 的 wenjun123 硬编码，改为角色检查；修复 config.py MANAGER_USERNAME** | **0.5h** |
| SEC-1 | 默认密码从源码移至环境变量或经理指定 | 0.5h |
| SEC-2 | 删除含 Developer Token 的脚本 | 0.5h |
| SEC-3 | 删除含平台 API Token 的测试脚本 | 0.5h |

### P1 - 尽快处理（功能修复）

| 编号 | 内容 | 工作量 |
|------|------|--------|
| v5.4 D1-D6 | 确认并实施 v5.4 修复方案 | 4h |
| v5.4 P1-P2 | 确认并实施 P1/P2 修复 | 1h |

### P2 - 近期处理（代码清理）

| 编号 | 内容 | 工作量 |
|------|------|--------|
| 5.1 | 清理根目录 20 个赘余文件 | 0.5h |
| 5.2 | 清理 scripts/ 下 60+ 个赘余脚本 | 1h |
| 4.2 | 删除 3 个废弃前端页面 | 0.5h |
| DES-1 | 精简 CORS 为单层 | 2h |
| CODE-2 | 修复 CORS 配置重复 | 0.1h |
| CODE-3 | 合并重复定时任务 | 1h |

### P3 - 后续迭代

| 编号 | 内容 | 工作量 |
|------|------|--------|
| DES-2 | 仪表板旧端点迁移 | 3h |
| DES-4 | 清理 OpenAI 配置残留 | 0.1h |
| DES-5 | 月度总结实现存储或删除 | 1h |
| R1-R2 | 确认 OAuth 是否保留 | 0.5h |
| D6-D7 | 评估专用平台 API 合并 | 2h |

---

## 十、审核清单

| 序号 | 检查项 | 状态 |
|------|--------|------|
| 1 | 核查清单覆盖全部 API 端点（150+） | ⬜ 待 07 确认 |
| 2 | 核查清单覆盖全部前端页面（36 个） | ⬜ 待 07 确认 |
| 3 | 一键测试脚本可运行 | ⬜ 待 07 测试 |
| 4 | 安全问题（3 项）已全部列出 | ⬜ 待 07 确认 |
| 5 | 设计问题（5 项）已全部列出 | ⬜ 待 07 确认 |
| 6 | 赘余文件清理清单完整（80+ 个） | ⬜ 待 07 确认 |
| 7 | 整改优先级合理 | ⬜ 待 07 确认 |

---

*本设计方案 v6.0 为全系统功能核查版，由 AI 设计人员对整个项目进行了全面的代码审查、端点梳理和问题排查，共发现 3 项安全问题、5 项设计问题、4 项代码质量问题、80+ 个赘余文件。待 07 验收通过后，按优先级逐步整改。*
