# 后端服务器部署命令（一键复制粘贴）

## 📋 方式一：SSH连接后执行（推荐）

### 1. 连接到服务器
```bash
ssh root@your-server-ip
# 或者
ssh username@your-server-ip
```

### 2. 进入项目目录并拉取最新代码
```bash
cd ~/Google-Data-Analysis && git pull origin main
```

### 3. 重启后端服务（一键命令）
```bash
cd ~/Google-Data-Analysis/backend && pkill -9 -f "uvicorn app.main:app" && sleep 3 && find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true && find . -name "*.pyc" -delete 2>/dev/null || true && source venv/bin/activate && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 & sleep 5 && curl -s http://127.0.0.1:8000/health && echo "✓ 后端部署成功" || tail -n 50 run.log
```

---

## 📋 方式二：分步执行（更安全）

### 步骤1：连接到服务器
```bash
ssh root@your-server-ip
```

### 步骤2：进入项目目录
```bash
cd ~/Google-Data-Analysis
```

### 步骤3：拉取最新代码
```bash
git pull origin main
```

### 步骤4：停止旧服务
```bash
pkill -9 -f "uvicorn app.main:app"
```

### 步骤5：等待进程完全退出
```bash
sleep 3
```

### 步骤6：清理Python缓存
```bash
cd backend
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -name "*.pyc" -delete 2>/dev/null || true
```

### 步骤7：激活虚拟环境并启动服务
```bash
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &
```

### 步骤8：等待服务启动并验证
```bash
sleep 5
curl -s http://127.0.0.1:8000/health
```

---

## 📋 方式三：使用部署脚本

### 创建部署脚本（首次使用）
```bash
cat > ~/deploy_backend.sh << 'EOF'
#!/bin/bash
cd ~/Google-Data-Analysis
echo "=== 拉取最新代码 ==="
git pull origin main

cd backend
echo "=== 停止旧服务 ==="
pkill -9 -f "uvicorn app.main:app" || echo "没有运行中的服务"
sleep 3

echo "=== 清理缓存 ==="
find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true
find . -name "*.pyc" -delete 2>/dev/null || true

echo "=== 启动服务 ==="
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &

sleep 5

echo "=== 验证服务 ==="
if curl -s http://127.0.0.1:8000/health > /dev/null; then
    echo "✓ 后端部署成功"
    echo "进程ID: $(pgrep -f 'uvicorn app.main:app')"
else
    echo "✗ 后端部署失败，查看日志："
    tail -n 50 run.log
fi
EOF

chmod +x ~/deploy_backend.sh
```

### 以后每次部署只需执行
```bash
~/deploy_backend.sh
```

---

## 📋 验证部署是否成功

### 检查服务进程
```bash
ps aux | grep uvicorn | grep -v grep
```

### 检查服务健康状态
```bash
curl -s http://127.0.0.1:8000/health
```

### 查看服务日志
```bash
tail -n 50 ~/Google-Data-Analysis/backend/run.log
```

### 检查端口占用
```bash
netstat -tlnp | grep 8000 || ss -tlnp | grep 8000
```

---

## 📋 如果遇到问题

### 问题1：端口被占用
```bash
# 查找占用8000端口的进程
lsof -i:8000 || netstat -tulpn | grep 8000

# 强制杀死占用端口的进程
kill -9 $(lsof -t -i:8000) 2>/dev/null || true
```

### 问题2：Git拉取失败
```bash
# 检查Git状态
cd ~/Google-Data-Analysis
git status

# 如果有冲突，先暂存本地修改
git stash

# 再拉取
git pull origin main

# 恢复本地修改（如果需要）
git stash pop
```

### 问题3：虚拟环境问题
```bash
cd ~/Google-Data-Analysis/backend

# 重新创建虚拟环境（如果需要）
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

---

## 📋 完整一键部署命令（复制粘贴即可）

```bash
ssh root@your-server-ip "cd ~/Google-Data-Analysis && git pull origin main && cd backend && pkill -9 -f 'uvicorn app.main:app' && sleep 3 && find . -type d -name __pycache__ -exec rm -rf {} + 2>/dev/null || true && find . -name '*.pyc' -delete 2>/dev/null || true && source venv/bin/activate && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 & sleep 5 && curl -s http://127.0.0.1:8000/health && echo '✓ 后端部署成功' || tail -n 50 run.log"
```

**注意**：将 `root@your-server-ip` 替换为你的实际服务器地址。

---

## 📋 定时任务相关说明

部署后，定时任务会自动启动（在`app/main.py`中配置）：
- ✅ 平台数据同步：每天4点和16点（逐天同步过去1周）
- ✅ Google Ads数据同步：每天8点（逐天同步前7天）
- ✅ 每日分析：每天8点05分
- ✅ 每周L7D分析：周一/三/五8点10分

查看定时任务日志：
```bash
tail -f ~/Google-Data-Analysis/backend/logs/app.log
```

