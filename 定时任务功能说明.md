# 定时任务功能说明

## 功能概述

已成功实现以下定时任务功能，满足您的需求：

### 1. 平台数据同步（4点和16点）
- **执行时间**: 每天北京时间4点和16点
- **功能**: 逐天同步平台过去1周数据，确保数据完整
- **提取字段**:
  - MID（商家ID，从交易数据中提取）
  - 商家（从交易数据中提取）
  - 订单数（orders）
  - 佣金（commission）
  - 拒付佣金（rejected_commission）
- **数据范围**: 过去7天（从7天前到昨天）
- **同步方式**: 逐天同步，每天的数据单独同步，确保数据完整性和准确性

### 2. Google Ads数据同步（早上8点）
- **执行时间**: 每天北京时间早上8点
- **功能**: 自动提取前7天Google Ads数据
- **数据范围**: 前7天（从7天前到昨天，逐天同步）
- **同步内容**: 广告系列数据、费用、点击、展示等

### 3. 每日分析（早上8点05分）
- **执行时间**: 每天北京时间早上8点05分
- **功能**: 取前一天的平台数据和对应商家的Google Ads数据进行每日分析
- **分析内容**: 
  - 合并平台数据和Google Ads数据
  - 计算ROI、EPC等指标
  - 生成操作指令

### 4. 每周L7D分析（周一/三/五早上8点10分）
- **执行时间**: 每周一、三、五北京时间早上8点10分
- **功能**: 自动生成L7D数据
- **数据范围**: 过去7天（从7天前到昨天）

## 技术实现

### 修改的文件
1. `backend/app/services/scheduler.py` - 定时任务调度器
   - 修改了Google Ads数据同步任务，改为同步前7天数据
   - 优化了所有任务的日志记录和错误处理
   - 更新了月度总结任务，使用真实的拒付佣金数据

### 新增的文件
1. `backend/scripts/test_scheduler_tasks.py` - 测试脚本
   - 用于手动测试定时任务功能
   - 可以单独测试每个任务或全部测试

## 使用方法

### 1. 启动定时任务
定时任务会在后端服务启动时自动启动（在`main.py`中配置）。

### 2. 手动测试定时任务
```bash
cd backend
python scripts/test_scheduler_tasks.py
```

然后根据提示选择要测试的任务：
- 输入 `1` - 测试平台数据同步
- 输入 `2` - 测试Google Ads数据同步
- 输入 `3` - 测试每日分析
- 输入 `4` - 测试L7D分析
- 输入 `all` - 测试全部任务

### 3. 查看日志
定时任务的执行日志会记录在：
- `backend/logs/app.log` - 应用日志
- `backend/logs/error.log` - 错误日志

## 日志格式

所有定时任务都使用统一的日志格式，包含：
- 任务开始/结束标记（`=`分隔线）
- 执行时间范围
- 成功/失败统计
- 详细的错误信息（如有）

示例日志：
```
============================================================
开始执行平台数据同步任务（过去1周，逐天同步）...
找到 3 个活跃账号
时间范围: 2026-01-20 至 2026-01-26 (共7天)
------------------------------------------------------------
正在同步日期: 2026-01-20
  同步账号: 账号1 (平台: CollabGlow)
  ✓ 账号 账号1 同步成功: 保存 1 条记录
日期 2026-01-20 同步完成: 成功 3 个账号, 失败 0 个账号, 保存 3 条记录
------------------------------------------------------------
正在同步日期: 2026-01-21
  ...
============================================================
平台数据同步任务完成（逐天同步）:
  - 同步日期数: 7 天
  - 总成功次数: 21 次
  - 总失败次数: 0 次
  - 共保存: 21 条记录
  - 提取字段: MID、商家、订单数、佣金、拒付佣金
============================================================
```

## 注意事项

1. **时区设置**: 所有定时任务使用北京时间（UTC+8）
2. **数据范围**: 
   - 平台数据同步：过去7天（逐天同步，确保数据完整）
   - Google Ads数据同步：前7天（逐天同步）
   - 每日分析：前一天的数据
   - L7D分析：过去7天
3. **同步方式**: 
   - 平台数据同步和Google Ads数据同步都采用逐天同步方式
   - 每天的数据单独同步，确保数据完整性和准确性
   - 即使某一天同步失败，也不会影响其他天的同步
4. **错误处理**: 所有任务都有完善的错误处理，单个账号失败不会影响其他账号
5. **数据去重**: 平台数据同步使用transaction_id进行去重，避免重复计算

## 验证功能

运行测试脚本后，检查：
1. 日志中是否有成功/失败记录
2. 数据库中是否有新数据（PlatformData、GoogleAdsApiData表）
3. 分析结果是否正确生成

## 后续优化建议

1. 可以添加任务执行状态监控（成功/失败统计）
2. 可以添加邮件/通知功能，在任务失败时发送告警
3. 可以添加任务执行历史记录表，方便追踪任务执行情况

