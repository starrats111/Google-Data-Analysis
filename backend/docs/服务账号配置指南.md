# Google Ads API 服务账号配置指南

## 一、创建服务账号（在 Google Cloud Console 操作）

### 1.1 登录 Google Cloud Console

1. 访问 [Google Cloud Console](https://console.cloud.google.com)
2. 使用您的 Google 账号登录

### 1.2 选择或创建项目

> ⚠️ **重要**：建议使用与开发者令牌关联的同一个 GCP 项目

1. 点击顶部导航栏的项目选择器
2. 如果已有项目，选择该项目
3. 如果需要创建新项目：
   - 点击 "新建项目"
   - 输入项目名称（如：`google-ads-sync`）
   - 点击 "创建"

### 1.3 启用 Google Ads API

1. 在左侧菜单中，导航到 **API 和服务** → **库**
2. 搜索 "Google Ads API"
3. 点击 **Google Ads API**
4. 点击 **启用**

### 1.4 创建服务账号

1. 在左侧菜单中，导航到 **IAM 和管理** → **服务账号**
2. 点击 **+ 创建服务账号**
3. 填写服务账号详情：
   - **服务账号名称**：`google-ads-sync`（或其他易识别的名称）
   - **服务账号 ID**：自动生成（如：`google-ads-sync@project-id.iam.gserviceaccount.com`）
   - **服务账号说明**：`用于自动同步 Google Ads 数据`
4. 点击 **创建并继续**
5. 跳过"向此服务账号授予对项目的访问权限"步骤，点击 **继续**
6. 跳过"向用户授予访问此服务账号的权限"步骤，点击 **完成**

### 1.5 创建并下载 JSON 密钥

1. 在服务账号列表中，找到刚创建的服务账号
2. 点击服务账号的 **邮箱地址** 进入详情页
3. 点击 **密钥** 标签页
4. 点击 **添加密钥** → **创建新密钥**
5. 选择 **JSON** 格式
6. 点击 **创建**
7. JSON 密钥文件将自动下载，**请妥善保存**

> ⚠️ **安全提示**：
> - JSON 密钥文件包含敏感信息，请勿泄露
> - 建议将密钥文件存放在安全位置
> - 不要将密钥文件提交到代码仓库

---

## 二、为 MCC 账号授权服务账号

### 2.1 获取服务账号邮箱

从 JSON 密钥文件中找到 `client_email` 字段，格式如：
```
google-ads-sync@your-project-id.iam.gserviceaccount.com
```

### 2.2 在 Google Ads 中添加服务账号

> ⚠️ **需要对每个 MCC 账号执行以下操作**

1. 登录 [Google Ads](https://ads.google.com)
2. 在顶部选择您要配置的 **MCC 账号**
3. 点击右上角的 **工具与设置** ⚙️
4. 在 "设置" 区域，点击 **访问权限与安全**
5. 点击 **用户** 标签
6. 点击 **+** 按钮添加用户
7. 在 "邮箱地址" 中粘贴服务账号邮箱
8. 选择访问权限级别：
   - **只读**：如果只需要读取数据（推荐）
   - **标准**：如果需要管理账号
9. 点击 **发送邀请**

> ℹ️ **说明**：服务账号会自动接受邀请，无需手动确认

### 2.3 批量添加服务账号（可选）

如果您有 100 个 MCC 账号，可以：

**方法一：手动逐个添加**
- 预计耗时：每个 MCC 约 1-2 分钟
- 100 个 MCC 约需 2-3 小时

**方法二：使用 Google Ads API 批量添加**（需要超级管理员权限）
- 可通过脚本自动化
- 需要先有一个 MCC 的访问权限

---

## 三、配置系统

### 3.1 上传 JSON 密钥文件

**方式一：通过文件路径配置**

1. 将下载的 JSON 密钥文件复制到服务器
2. 推荐路径：`backend/config/service_account.json`
3. 在 `.env` 文件中配置：

```env
GOOGLE_ADS_SERVICE_ACCOUNT_FILE=./config/service_account.json
```

**方式二：通过环境变量配置（推荐用于云部署）**

1. 将 JSON 文件内容进行 Base64 编码：
   ```bash
   # Linux/Mac
   base64 -i service_account.json
   
   # Windows PowerShell
   [Convert]::ToBase64String([IO.File]::ReadAllBytes("service_account.json"))
   ```

2. 在 `.env` 文件中配置：
   ```env
   GOOGLE_ADS_SERVICE_ACCOUNT_JSON_BASE64=eyJ0eXBlIjoi...（Base64编码内容）
   ```

**方式三：通过前端界面上传**

1. 登录系统后台
2. 进入 "系统配置" → "Google Ads 设置"
3. 上传 JSON 密钥文件

### 3.2 配置开发者令牌

在 `.env` 文件中确保已配置：

```env
GOOGLE_ADS_SHARED_DEVELOPER_TOKEN=<DEVELOPER_TOKEN_FROM_ENV>
```

### 3.3 配置同步参数（可选）

```env
# 每批同步的 MCC 数量（默认 10）
GOOGLE_ADS_SYNC_BATCH_SIZE=10

# 批次间延迟秒数（默认 2）
GOOGLE_ADS_SYNC_DELAY_SECONDS=2

# 每个请求间延迟秒数（默认 1）
GOOGLE_ADS_REQUEST_DELAY_SECONDS=1
```

---

## 四、验证配置

### 4.1 检查服务账号权限

运行测试脚本验证配置是否正确：

```bash
cd backend
python -m scripts.test_service_account
```

预期输出：
```
✓ 服务账号配置加载成功
✓ 开发者令牌已配置
✓ 成功连接 MCC: 123-456-7890
✓ 找到 15 个客户账号
✓ 成功获取广告系列数据
```

### 4.2 手动触发同步测试

1. 登录系统后台
2. 进入 "MCC 管理" 页面
3. 选择一个 MCC 账号
4. 点击 "同步数据" 按钮
5. 查看同步日志

---

## 五、常见问题

### Q1: 服务账号邮箱无法添加到 Google Ads？

**可能原因**：
- 邮箱格式不正确
- MCC 账号权限不足

**解决方案**：
1. 确认邮箱格式为 `xxx@project-id.iam.gserviceaccount.com`
2. 确保您有 MCC 的管理员权限

### Q2: 同步时提示 "PERMISSION_DENIED"？

**可能原因**：
- 服务账号未添加到该 MCC
- 服务账号权限级别不足

**解决方案**：
1. 检查服务账号是否已添加到所有 MCC
2. 确保权限级别至少为 "只读"

### Q3: 同步时提示 "DEVELOPER_TOKEN_PROHIBITED"？

**可能原因**：
- 开发者令牌与 GCP 项目不匹配
- 开发者令牌未激活

**解决方案**：
1. 确保服务账号所在的 GCP 项目与开发者令牌关联的项目相同
2. 检查开发者令牌是否已通过 Google 审核

### Q4: 同步时提示 "QUOTA_EXHAUSTED"？

**可能原因**：
- API 配额已用完

**解决方案**：
1. 等待配额恢复（通常 24 小时后重置）
2. 减少 `GOOGLE_ADS_SYNC_BATCH_SIZE` 值
3. 增加 `GOOGLE_ADS_SYNC_DELAY_SECONDS` 值
4. 联系 Google 申请更高配额

### Q5: 如何查看当前 API 配额使用情况？

1. 访问 [Google Cloud Console](https://console.cloud.google.com)
2. 导航到 **API 和服务** → **已启用的 API 和服务**
3. 点击 **Google Ads API**
4. 查看 "配额" 标签页

---

## 六、安全最佳实践

1. **最小权限原则**：服务账号只授予"只读"权限
2. **密钥轮换**：定期更换 JSON 密钥（建议每 90 天）
3. **访问控制**：限制服务器上密钥文件的访问权限
4. **审计日志**：定期检查 Google Cloud 审计日志
5. **环境隔离**：生产和测试环境使用不同的服务账号

---

## 七、MCC 批量导入模板

如果需要批量添加 MCC 账号，可以准备 CSV 文件，格式如下：

```csv
mcc_id,mcc_name
123-456-7890,MCC账号1
234-567-8901,MCC账号2
345-678-9012,MCC账号3
```

然后通过系统后台的 "批量导入" 功能上传。

---

## 八、联系支持

如遇到问题，请联系系统管理员或查看日志文件：
- 后端日志：`backend/logs/app.log`
- 同步日志：`backend/logs/google_ads_sync.log`

