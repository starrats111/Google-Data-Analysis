"""
Gemini AI æœåŠ¡
æä¾›å¹¿å‘Šåˆ†æã€ä¼˜åŒ–å»ºè®®ã€èŠ‚æ—¥è¥é”€ç­‰AIåŠŸèƒ½
æ”¯æŒå®˜æ–¹APIå’Œå“ˆåŸºç±³ç­‰ä¸­è½¬APIï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰
"""
import logging
from typing import Optional, List, Dict
from datetime import date, datetime
import json
import requests

logger = logging.getLogger(__name__)

# Gemini API é…ç½®
GEMINI_API_KEY = None
GEMINI_BASE_URL = None
GEMINI_MODEL = "gemini-2.5-flash-lite"


class GeminiService:
    """Gemini AI æœåŠ¡ç±»
    
    æ”¯æŒå“ˆåŸºç±³ç­‰ä¸­è½¬APIï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰
    """
    
    def __init__(self, api_key: Optional[str] = None, base_url: Optional[str] = None, model: Optional[str] = None):
        self.api_key = api_key
        self.base_url = base_url or "https://api.gemai.cc"
        # å“ˆåŸºç±³æ¨¡å‹åç§°éœ€è¦å¸¦å‰ç¼€ï¼Œå¦‚ [ç¦åˆ©]gemini-2.5-flash-lite
        self.model = model or "[ç¦åˆ©]gemini-2.5-flash-lite"
        logger.info(f"Gemini API é…ç½®: base_url={self.base_url}, model={self.model}")
    
    def _call_api(self, prompt: str, image_data: bytes = None) -> str:
        """è°ƒç”¨å“ˆåŸºç±³ APIï¼ˆOpenAIå…¼å®¹æ ¼å¼ï¼‰"""
        headers = {
            "Authorization": f"Bearer {self.api_key}",
            "Content-Type": "application/json"
        }
        
        # æ„å»ºæ¶ˆæ¯
        if image_data:
            # å›¾ç‰‡åˆ†æè¯·æ±‚
            import base64
            image_base64 = base64.b64encode(image_data).decode('utf-8')
            messages = [{
                "role": "user",
                "content": [
                    {"type": "text", "text": prompt},
                    {"type": "image_url", "image_url": {"url": f"data:image/png;base64,{image_base64}"}}
                ]
            }]
        else:
            # çº¯æ–‡æœ¬è¯·æ±‚
            messages = [{"role": "user", "content": prompt}]
        
        payload = {
            "model": self.model,
            "messages": messages,
            "max_tokens": 8192
        }
        
        # è°ƒç”¨ APIï¼ˆå“ˆåŸºç±³ä½¿ç”¨ OpenAI å…¼å®¹æ ¼å¼ï¼‰
        # base_url åº”è¯¥æ˜¯ https://api.gemai.ccï¼ˆä¸å¸¦ /v1betaï¼‰
        base = self.base_url.rstrip('/')
        if base.endswith('/v1beta'):
            base = base[:-7]  # ç§»é™¤ /v1beta
        if base.endswith('/v1'):
            base = base[:-3]  # ç§»é™¤ /v1
        url = f"{base}/v1/chat/completions"
        response = requests.post(url, headers=headers, json=payload, timeout=120)
        
        if response.status_code != 200:
            error_msg = response.text
            logger.error(f"API è°ƒç”¨å¤±è´¥: {response.status_code} - {error_msg}")
            raise Exception(f"API è°ƒç”¨å¤±è´¥: {error_msg}")
        
        result = response.json()
        return result["choices"][0]["message"]["content"]
    
    def analyze_campaign_data(self, campaign_data: Dict) -> Dict:
        """
        A. åˆ†æå¹¿å‘Šæ•°æ®ï¼Œç”Ÿæˆä¼˜åŒ–å»ºè®®
        
        Args:
            campaign_data: å¹¿å‘Šç³»åˆ—æ•°æ®ï¼ŒåŒ…å«cost, clicks, impressions, cpc, roiç­‰
        
        Returns:
            åˆ†æç»“æœå’Œä¼˜åŒ–å»ºè®®
        """
        prompt = f"""ä½ æ˜¯ä¸€ä½èµ„æ·±çš„Google Adså¹¿å‘Šä¼˜åŒ–ä¸“å®¶ã€‚è¯·åˆ†æä»¥ä¸‹å¹¿å‘Šæ•°æ®å¹¶æä¾›è¯¦ç»†çš„ä¼˜åŒ–å»ºè®®ã€‚

å¹¿å‘Šæ•°æ®ï¼š
{json.dumps(campaign_data, ensure_ascii=False, indent=2)}

è¯·ä»ä»¥ä¸‹å‡ ä¸ªç»´åº¦è¿›è¡Œåˆ†æï¼š
1. **æ•°æ®æ¦‚è§ˆ**ï¼šæ€»ç»“å…³é”®æŒ‡æ ‡è¡¨ç°
2. **é—®é¢˜è¯Šæ–­**ï¼šè¯†åˆ«æ•°æ®ä¸­çš„é—®é¢˜ï¼ˆå¦‚ROIè¿‡ä½ã€CPCè¿‡é«˜ã€ISä¸¢å¤±ä¸¥é‡ç­‰ï¼‰
3. **ä¼˜åŒ–å»ºè®®**ï¼šé’ˆå¯¹æ¯ä¸ªé—®é¢˜ç»™å‡ºå…·ä½“çš„æ“ä½œå»ºè®®
4. **ä¼˜å…ˆçº§æ’åº**ï¼šå°†å»ºè®®æŒ‰é‡è¦æ€§å’Œç´§æ€¥ç¨‹åº¦æ’åº
5. **é¢„æœŸæ•ˆæœ**ï¼šé¢„ä¼°ä¼˜åŒ–åçš„æ•ˆæœæå‡

è¯·ç”¨ä¸­æ–‡å›ç­”ï¼Œæ ¼å¼æ¸…æ™°æ˜“è¯»ã€‚"""

        try:
            analysis = self._call_api(prompt)
            return {
                "success": True,
                "analysis": analysis,
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"åˆ†æå¹¿å‘Šæ•°æ®å¤±è´¥: {e}")
            return {"success": False, "message": str(e)}
    
    def generate_operation_instruction(self, campaign_data: Dict) -> Dict:
        """
        B. æ™ºèƒ½ç”Ÿæˆæ“ä½œæŒ‡ä»¤
        
        Args:
            campaign_data: å¹¿å‘Šç³»åˆ—æ•°æ®
        
        Returns:
            æ“ä½œæŒ‡ä»¤åˆ—è¡¨
        """
        prompt = f"""ä½ æ˜¯ä¸€ä½Google Adsæ“ä½œä¸“å®¶ã€‚æ ¹æ®ä»¥ä¸‹å¹¿å‘Šæ•°æ®ï¼Œç”Ÿæˆå…·ä½“çš„æ“ä½œæŒ‡ä»¤ã€‚

å¹¿å‘Šæ•°æ®ï¼š
{json.dumps(campaign_data, ensure_ascii=False, indent=2)}

è¯·ç”Ÿæˆæ¸…æ™°ã€å¯æ‰§è¡Œçš„æ“ä½œæŒ‡ä»¤ï¼Œæ ¼å¼å¦‚ä¸‹ï¼š
1. ã€æ“ä½œç±»å‹ã€‘å…·ä½“æ“ä½œå†…å®¹
   - åŸå› ï¼šä¸ºä»€ä¹ˆè¦è¿™æ ·åš
   - é¢„æœŸæ•ˆæœï¼šé¢„è®¡å¸¦æ¥çš„æ”¹å–„

æ“ä½œç±»å‹åŒ…æ‹¬ï¼šåŠ é¢„ç®—ã€é™é¢„ç®—ã€æCPCã€é™CPCã€æš‚åœã€å¼€å¯ã€è§‚å¯Ÿã€ä¼˜åŒ–ç­‰ã€‚

è¯·åªè¾“å‡ºæœ€é‡è¦çš„3-5æ¡æ“ä½œæŒ‡ä»¤ï¼ŒæŒ‰ä¼˜å…ˆçº§æ’åºã€‚ç”¨ä¸­æ–‡å›ç­”ã€‚"""

        try:
            instructions = self._call_api(prompt)
            return {
                "success": True,
                "instructions": instructions,
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"ç”Ÿæˆæ“ä½œæŒ‡ä»¤å¤±è´¥: {e}")
            return {"success": False, "message": str(e)}
    
    def analyze_keywords_and_recommend(
        self, 
        keywords: List[str], 
        product_url: Optional[str] = None,
        target_country: str = "US"
    ) -> Dict:
        """
        C. æ ¹æ®å…³é”®è¯ç”Ÿæˆæ¨èé¢„ç®—ã€CPCå’Œå¹¿å‘Šè¯
        
        Args:
            keywords: å…³é”®è¯åˆ—è¡¨
            product_url: äº§å“é“¾æ¥ï¼ˆå¿…é¡»æä¾›ï¼Œç”¨äºæŠ“å–çœŸå®æŠ˜æ‰£å’Œç‰©æµä¿¡æ¯ï¼‰
            target_country: ç›®æ ‡å›½å®¶
        
        Returns:
            æ¨èé…ç½®å’Œå¹¿å‘Šè¯
        """
        if not product_url:
            return {"success": False, "message": "è¯·æä¾›äº§å“é“¾æ¥URLï¼Œç”¨äºè·å–çœŸå®çš„æŠ˜æ‰£å’Œç‰©æµä¿¡æ¯"}
        
        # å›½å®¶é…ç½®ï¼šè¯­è¨€ã€è´§å¸
        country_config = {
            "US": {"lang": "è‹±è¯­", "lang_code": "English", "currency": "USD", "name": "ç¾å›½"},
            "UK": {"lang": "è‹±è¯­", "lang_code": "English", "currency": "GBP", "name": "è‹±å›½"},
            "DE": {"lang": "å¾·è¯­", "lang_code": "German", "currency": "EUR", "name": "å¾·å›½"},
            "FR": {"lang": "æ³•è¯­", "lang_code": "French", "currency": "EUR", "name": "æ³•å›½"},
            "ES": {"lang": "è¥¿ç­ç‰™è¯­", "lang_code": "Spanish", "currency": "EUR", "name": "è¥¿ç­ç‰™"},
            "IT": {"lang": "æ„å¤§åˆ©è¯­", "lang_code": "Italian", "currency": "EUR", "name": "æ„å¤§åˆ©"},
            "AU": {"lang": "è‹±è¯­", "lang_code": "English", "currency": "AUD", "name": "æ¾³å¤§åˆ©äºš"},
            "CA": {"lang": "è‹±è¯­", "lang_code": "English", "currency": "CAD", "name": "åŠ æ‹¿å¤§"},
            "JP": {"lang": "æ—¥è¯­", "lang_code": "Japanese", "currency": "JPY", "name": "æ—¥æœ¬"},
            "KR": {"lang": "éŸ©è¯­", "lang_code": "Korean", "currency": "KRW", "name": "éŸ©å›½"},
        }
        
        config = country_config.get(target_country, country_config["US"])
        
        prompt = f"""ä½ æ˜¯ä¸€ä½è°·æ­Œå¹¿å‘ŠæŠ•æ”¾ä¸“å®¶ï¼Œç‰¹åˆ«æ“…é•¿å…³é”®è¯ç­›é€‰å’Œå¹¿å‘Šæ–‡æ¡ˆæ’°å†™ã€‚

**æœ€é‡è¦è§„åˆ™**ï¼šçœŸå®ã€ä¸¥è°¨ï¼æ‰€æœ‰æŠ˜æ‰£å’Œç‰©æµä¿¡æ¯å¿…é¡»ä»URLä¸­æŸ¥æ‰¾çœŸå®è¯æ®ï¼Œä¸èƒ½ç¼–é€ ï¼

**äº§å“é“¾æ¥**ï¼š{product_url}
**è¾“å…¥å…³é”®è¯**ï¼š{', '.join(keywords)}
**ç›®æ ‡å›½å®¶**ï¼š{config['name']} ({target_country})
**å¹¿å‘Šè¯­è¨€**ï¼š{config['lang']} ({config['lang_code']})

---

## 1.1 ç½‘ç«™ä¸»è¥ä¸šåŠ¡

è¯·è®¿é—®é“¾æ¥ï¼Œåˆ†æå¹¶è¾“å‡ºï¼š
1. **è¯¥ç½‘ç«™ä¸»è¥ä¸šåŠ¡**ï¼šè¿™ä¸ªç½‘ç«™ä¸»è¦å–ä»€ä¹ˆäº§å“/æœåŠ¡ï¼Ÿ
2. **çœŸå®æŠ˜æ‰£ä¿¡æ¯**ï¼šç½‘ç«™ä¸Šå®é™…å­˜åœ¨çš„æŠ˜æ‰£ï¼ˆå¦‚æ— åˆ™æ ‡æ³¨"æœªæ‰¾åˆ°"ï¼‰
3. **çœŸå®ç‰©æµä¿¡æ¯**ï¼šè¯¥ç½‘ç«™å¯¹{config['name']}çš„é…é€æ”¿ç­–ï¼ˆå¦‚æ— åˆ™æ ‡æ³¨"æœªæ‰¾åˆ°"ï¼‰
4. **åˆè§„æ£€æŸ¥**ï¼šæ ¸æŸ¥å¹¿å‘Šè¯æ˜¯å¦ä¼šè§¦å‘è°·æ­Œå¹¿å‘Šæ”¿ç­–ä¸­å¿ƒæé†’ï¼ˆå¦‚æ¶‰åŠæ•æ„Ÿè¯ã€å¤¸å¤§å®£ä¼ ç­‰ï¼‰

---

## 1.2 å…³é”®è¯æ¨èï¼ˆå…±8ä¸ªï¼‰

æ ¹æ®ç½‘ç«™ä¸»è¥ä¸šåŠ¡ï¼Œæ¨è8ä¸ªé«˜æ„å‘å…³é”®è¯ã€‚

**æ¨èå…³é”®è¯æ ¼å¼**ï¼ˆå¯ç›´æ¥å¤åˆ¶åˆ° Google Adsï¼‰ï¼š
```
[å…³é”®è¯1]
[å…³é”®è¯2]
[å…³é”®è¯3]
"å…³é”®è¯4"
"å…³é”®è¯5"
å…³é”®è¯6
å…³é”®è¯7
å…³é”®è¯8
```

**åŒ¹é…ç±»å‹è¯´æ˜**ï¼š
- `[å®Œå…¨åŒ¹é…]`ï¼šé”å®šå“ç‰Œå¿ å®ç”¨æˆ·ï¼Œé˜²æ­¢é¢„ç®—è¢«å…¶ä»–å“ç‰Œè¯è¹­èµ°
- `"è¯ç»„åŒ¹é…"`ï¼šæ•æ‰ "buy xxx" "best xxx" ç­‰é«˜è´¨é‡é•¿å°¾æµé‡
- `å¹¿æ³›åŒ¹é…`ï¼šæ‰©å¤§è¦†ç›–èŒƒå›´

**å…³é”®è¯é€‰æ‹©ä¾æ®**ï¼š
| # | å…³é”®è¯ | æ¨èåŒ¹é…ç±»å‹ | é€‰æ‹©ç†ç”± |
|---|--------|-------------|---------|
| 1 | [å…³é”®è¯1] | å®Œå…¨åŒ¹é… | å“ç‰Œè¯/æ ¸å¿ƒè¯ |
| 2 | [å…³é”®è¯2] | å®Œå…¨åŒ¹é… | ... |
| 3 | [å…³é”®è¯3] | å®Œå…¨åŒ¹é… | ... |
| 4 | "å…³é”®è¯4" | è¯ç»„åŒ¹é… | é«˜è´­ä¹°æ„å‘ |
| 5 | "å…³é”®è¯5" | è¯ç»„åŒ¹é… | ... |
| 6 | å…³é”®è¯6 | å¹¿æ³›åŒ¹é… | æ‰©å¤§è¦†ç›– |
| 7 | å…³é”®è¯7 | å¹¿æ³›åŒ¹é… | ... |
| 8 | å…³é”®è¯8 | å¹¿æ³›åŒ¹é… | ... |

ğŸ’¡ æç¤ºï¼šå¯åœ¨ sem.3ue.co è¾“å…¥åŸŸåéªŒè¯è¿™äº›å…³é”®è¯çš„æœç´¢é‡å’Œç«äº‰åº¦

---

## 1.3 å¹¿å‘Šæ–‡æ¡ˆ (Ad Copy)

### Ad Headlines (å¹¿å‘Šæ ‡é¢˜ - æ¯è¡Œ â‰¤ 25 å­—ç¬¦)

å‰ä¸‰æ¡å·²æŒ‰æ‚¨çš„è¦æ±‚é”å®šï¼šå“ç‰Œå®šä½ã€æœ€é«˜æŠ˜æ‰£ã€ç‰©æµä¿¡æ¯ã€‚

| # | English Headline (Copy & Paste) | ä¸­æ–‡ç¿»è¯‘ | å­—ç¬¦æ•° |
|---|--------------------------------|---------|-------|
| 1 | [å“ç‰Œç›¸å…³æ ‡é¢˜] | [ç¿»è¯‘] | XX |
| 2 | [æŠ˜æ‰£æ ‡é¢˜-ä»ç½‘ç«™æ‰¾åˆ°çš„çœŸå®æŠ˜æ‰£] | [ç¿»è¯‘] | XX |
| 3 | [ç‰©æµæ ‡é¢˜-ä»ç½‘ç«™æ‰¾åˆ°çš„çœŸå®ç‰©æµ] | [ç¿»è¯‘] | XX |
| 4 | [æ ‡é¢˜4] | [ç¿»è¯‘] | XX |
| ... | ... | ... | ... |
| 17 | [æ ‡é¢˜17] | [ç¿»è¯‘] | XX |

### Ad Descriptions (å¹¿å‘Šæè¿° - 50 è‡³ 80 å­—ç¬¦)

ç¬¬ä¸€æ¡æè¿°åŒ…å«ä¸»åŠ›æŠ˜æ‰£ä¸{config['name']}å…é‚®ä¿¡æ¯ã€‚

| # | English Description (Copy & Paste) | ä¸­æ–‡ç¿»è¯‘ | å­—ç¬¦æ•° |
|---|-----------------------------------|---------|-------|
| 1 | [æè¿°1-å«æŠ˜æ‰£å’Œç‰©æµ] | [ç¿»è¯‘] | XX |
| 2 | [æè¿°2] | [ç¿»è¯‘] | XX |
| 3 | [æè¿°3] | [ç¿»è¯‘] | XX |
| 4 | [æè¿°4] | [ç¿»è¯‘] | XX |
| 5 | [æè¿°5] | [ç¿»è¯‘] | XX |
| 6 | [æè¿°6] | [ç¿»è¯‘] | XX |

---

## 1.4 é™„åŠ é“¾æ¥ (Sitelinks) - å¿…é¡»åŒ…å«çœŸå®é“¾æ¥ URLï¼

**é‡è¦**ï¼šé™„åŠ é“¾æ¥å¿…é¡»æ˜¯ç½‘ç«™ä¸ŠçœŸå®å­˜åœ¨çš„é¡µé¢ URLï¼è¯·ä»ç½‘ç«™å¯¼èˆªæ ã€èœå•ä¸­æ‰¾åˆ°çœŸå®çš„åˆ†ç±»é¡µé¢é“¾æ¥ã€‚

| é™„åŠ é“¾æ¥æ ‡é¢˜ (â‰¤25å­—ç¬¦) | çœŸå®é¡µé¢ URL (å®Œæ•´é“¾æ¥) | æè¿°1 (â‰¤28å­—ç¬¦) | æè¿°2 (â‰¤28å­—ç¬¦) |
|---------------------|----------------------|----------------|----------------|
| [åˆ†ç±»å1] | https://xxx.com/path1 | [æè¿°] | [æè¿°] |
| [åˆ†ç±»å2] | https://xxx.com/path2 | [æè¿°] | [æè¿°] |
| [åˆ†ç±»å3] | https://xxx.com/path3 | [æè¿°] | [æè¿°] |
| [åˆ†ç±»å4] | https://xxx.com/path4 | [æè¿°] | [æè¿°] |
| [åˆ†ç±»å5] | https://xxx.com/path5 | [æè¿°] | [æè¿°] |
| [åˆ†ç±»å6] | https://xxx.com/path6 | [æè¿°] | [æè¿°] |

âš ï¸ **URL å¿…é¡»çœŸå®å­˜åœ¨**ï¼šè¯·ä»ç½‘ç«™çš„å¯¼èˆªèœå•ã€åº•éƒ¨é“¾æ¥æ‰¾åˆ°çœŸå®URLï¼Œä¸è¦ç¼–é€ ï¼å¦‚æœæ‰¾ä¸åˆ°6ä¸ªï¼Œè¾“å‡ºæ‰¾åˆ°çš„å³å¯ã€‚

---

## 1.5 æŠ•æ”¾å»ºè®®

é¢„ç®—ï¼š4{config['currency']} / Max CPCï¼š0.3{config['currency']}
å»ºè®®ä½¿ç”¨ Manual CPC (æ‰‹åŠ¨å‡ºä»·) å¹¶ä»…é’ˆå¯¹ {config['name']} æŠ•æ”¾ã€‚

---

## 1.6 Google Ads æ”¿ç­–åˆè§„æ£€æŸ¥

è¯·æ ¸æŸ¥ä»¥ä¸Šæ‰€æœ‰å¹¿å‘Šæ–‡æ¡ˆï¼š
1. æ˜¯å¦ä¼šè§¦å‘è°·æ­Œå¹¿å‘Šæ”¿ç­–ä¸­å¿ƒæé†’ï¼Ÿ
2. æ˜¯å¦æ¶‰åŠæ•æ„Ÿè¯ã€å¤¸å¤§å®£ä¼ ã€è™šå‡æ‰¿è¯ºï¼Ÿ
3. æ˜¯å¦ç¬¦åˆ Google Ads å¹³å°è§„èŒƒï¼Ÿ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ ‡æ³¨å¹¶ç»™å‡ºä¿®æ”¹å»ºè®®ã€‚

âš ï¸ å¦‚æœç½‘ç«™æ²¡æœ‰æŠ˜æ‰£æˆ–å…è¿è´¹ä¿¡æ¯ï¼Œè¯·åœ¨å¯¹åº”ä½ç½®æ ‡æ³¨"æœªæ‰¾åˆ°"ï¼Œä¸è¦ç¼–é€ ï¼"""

        try:
            recommendations = self._call_api(prompt)
            return {
                "success": True,
                "recommendations": recommendations,
                "keywords": keywords,
                "product_url": product_url,
                "target_country": target_country,
                "country_name": config['name'],
                "language": config['lang'],
                "currency": config['currency'],
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"ç”Ÿæˆæ¨èé…ç½®å¤±è´¥: {e}")
            return {"success": False, "message": str(e)}
    
    def get_marketing_calendar(
        self, 
        country: str = "US",
        month: Optional[int] = None,
        year: Optional[int] = None
    ) -> Dict:
        """
        D. è·å–çƒ­é—¨èŠ‚æ—¥å’Œæ¨èå•†å®¶ï¼ˆè¿”å›ç»“æ„åŒ–JSONï¼‰
        
        Args:
            country: å›½å®¶ä»£ç ï¼ˆUS/UK/DE/FRç­‰ï¼‰
            month: æœˆä»½ï¼ˆé»˜è®¤å½“æœˆï¼‰
            year: å¹´ä»½ï¼ˆé»˜è®¤ä»Šå¹´ï¼‰
        
        Returns:
            èŠ‚æ—¥åˆ—è¡¨å’Œå•†å®¶æ¨èï¼ˆJSONç»“æ„ï¼‰
        """
        today = date.today()
        if not month:
            month = today.month
        if not year:
            year = today.year
        
        # ä¸‹ä¸ªæœˆ
        next_month = month + 1 if month < 12 else 1
        next_year = year if month < 12 else year + 1
        
        country_names = {
            "US": "ç¾å›½", "UK": "è‹±å›½", "DE": "å¾·å›½", "FR": "æ³•å›½",
            "ES": "è¥¿ç­ç‰™", "IT": "æ„å¤§åˆ©", "AU": "æ¾³å¤§åˆ©äºš", "CA": "åŠ æ‹¿å¤§",
            "JP": "æ—¥æœ¬", "KR": "éŸ©å›½"
        }
        country_name = country_names.get(country, country)
        
        prompt = f"""ä½ æ˜¯ä¸€ä½è·¨å¢ƒç”µå•†è¥é”€ä¸“å®¶ã€‚è¯·æä¾›{country_name}æœªæ¥2ä¸ªæœˆï¼ˆ{year}å¹´{month}æœˆå’Œ{next_year}å¹´{next_month}æœˆï¼‰çš„è¥é”€æ—¥å†ä¿¡æ¯ã€‚

ä»Šå¤©æ˜¯ {today.strftime('%Y-%m-%d')}ï¼Œåªè¿”å›ä»Šå¤©åŠä»¥åçš„èŠ‚æ—¥ï¼Œå·²è¿‡å»çš„èŠ‚æ—¥ä¸è¦è¿”å›ã€‚

è¯·ä¸¥æ ¼æŒ‰ä»¥ä¸‹JSONæ ¼å¼è¿”å›ï¼Œä¸è¦æ·»åŠ ä»»ä½•å…¶ä»–æ–‡å­—ï¼š
```json
{{
  "holidays": [
    {{
      "name_en": "Valentine's Day",
      "name_cn": "æƒ…äººèŠ‚",
      "date": "2026-02-14",
      "importance": "â­â­â­â­â­",
      "meaning": "æå…¶é‡è¦çš„ç”µå•†èŠ‚ç‚¹ï¼Œç¤¼å“é”€å”®é«˜å³°æœŸ",
      "categories": ["ç å®", "å·§å…‹åŠ›", "é²œèŠ±", "æœè£…", "é¦™æ°´", "å®¶å±…è£…é¥°"],
      "brands": ["Norma Kamali", "B&W/Polk"],
      "tips": "1æœˆä¸­ä¸‹æ—¬å¼€å§‹è¿›å…¥ç¤¼å“æœç´¢æœŸï¼Œæå‰é¢„çƒ­"
    }}
  ]
}}
```

å­—æ®µè¯´æ˜ï¼š
- name_en: è‹±æ–‡åç§°
- name_cn: ä¸­æ–‡åç§°  
- date: æ—¥æœŸæ ¼å¼ YYYY-MM-DD
- importance: é‡è¦æ€§ï¼ˆ1-5ä¸ªâ­ï¼‰
- meaning: å¯¹ç”µå•†çš„è¥é”€æ„ä¹‰ï¼ˆä¸€å¥è¯ï¼‰
- categories: é€‚ç”¨å“ç±»æ•°ç»„
- brands: é€‚ç”¨å“ç‰Œç¤ºä¾‹æ•°ç»„
- tips: ç®€çŸ­è¥é”€å»ºè®®

è¯·æŒ‰æ—¥æœŸå‡åºæ’åˆ—ï¼Œè¿”å›8-15ä¸ªèŠ‚æ—¥/è¥é”€èŠ‚ç‚¹ã€‚åªè¿”å›JSONï¼Œä¸è¦markdownä»£ç å—æ ‡è®°ã€‚"""

        try:
            response = self._call_api(prompt)
            
            # å°è¯•è§£æJSON
            try:
                # æ¸…ç†å“åº”ï¼šç§»é™¤å¯èƒ½çš„markdownä»£ç å—æ ‡è®°
                clean_response = response.strip()
                if clean_response.startswith('```json'):
                    clean_response = clean_response[7:]
                if clean_response.startswith('```'):
                    clean_response = clean_response[3:]
                if clean_response.endswith('```'):
                    clean_response = clean_response[:-3]
                clean_response = clean_response.strip()
                
                data = json.loads(clean_response)
                holidays = data.get('holidays', [])
                
                # è¿‡æ»¤å·²è¿‡å»çš„èŠ‚æ—¥
                today_str = today.strftime('%Y-%m-%d')
                future_holidays = [h for h in holidays if h.get('date', '') >= today_str]
                
                return {
                    "success": True,
                    "holidays": future_holidays,
                    "country": country,
                    "country_name": country_name,
                    "current_month": f"{year}å¹´{month}æœˆ",
                    "next_month": f"{next_year}å¹´{next_month}æœˆ",
                    "today": today_str,
                    "timestamp": datetime.now().isoformat()
                }
            except json.JSONDecodeError as je:
                logger.warning(f"JSONè§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬: {je}")
                # å¦‚æœè§£æå¤±è´¥ï¼Œè¿”å›åŸå§‹æ–‡æœ¬ä½œä¸ºå¤‡ç”¨
                return {
                    "success": True,
                    "calendar": response,
                    "holidays": [],
                    "country": country,
                    "country_name": country_name,
                    "current_month": f"{year}å¹´{month}æœˆ",
                    "next_month": f"{next_year}å¹´{next_month}æœˆ",
                    "timestamp": datetime.now().isoformat()
                }
        except Exception as e:
            logger.error(f"è·å–è¥é”€æ—¥å†å¤±è´¥: {e}")
            return {"success": False, "message": str(e)}
    
    def analyze_image(self, image_data: bytes, prompt: str = None) -> Dict:
        """
        åˆ†æå›¾ç‰‡ï¼ˆå¦‚å…³é”®è¯æˆªå›¾ï¼‰
        
        Args:
            image_data: å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®
            prompt: åˆ†ææç¤ºè¯
        
        Returns:
            å›¾ç‰‡åˆ†æç»“æœ
        """
        try:
            if not prompt:
                prompt = """è¯·åˆ†æè¿™å¼ æˆªå›¾ä¸­çš„å…³é”®è¯æ•°æ®ï¼Œæå–ä»¥ä¸‹ä¿¡æ¯ï¼š
1. å…³é”®è¯åˆ—è¡¨
2. æœç´¢é‡æ•°æ®
3. ç«äº‰ç¨‹åº¦
4. CPCå‚è€ƒå€¼

ç„¶ååŸºäºè¿™äº›æ•°æ®ï¼Œç»™å‡ºï¼š
- æ¨èæŠ•æ”¾çš„å…³é”®è¯
- å»ºè®®çš„Max CPCèŒƒå›´
- æ—¥é¢„ç®—å»ºè®®"""
            
            analysis = self._call_api(prompt, image_data)
            
            return {
                "success": True,
                "analysis": analysis,
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"åˆ†æå›¾ç‰‡å¤±è´¥: {e}")
            return {"success": False, "message": str(e)}
    
    def analyze_l7d_campaigns(self, campaigns_data: List[Dict]) -> Dict:
        """
        L7D å¹¿å‘Šç³»åˆ—å®¡è®¡åˆ†æ
        
        åŸºäºå“ç‰Œè¯å¥—åˆ©å®¡è®¡æç¤ºè¯ v5 ç‰ˆæœ¬
        å¯¹å¹¿å‘Šç³»åˆ—è¿›è¡Œå…¨é‡å®¡è®¡ä¸åˆ†çº§ï¼Œè¾“å‡ºå¯æ‰§è¡Œæ–¹æ¡ˆ
        
        Args:
            campaigns_data: å¹¿å‘Šç³»åˆ—æ•°æ®åˆ—è¡¨ï¼Œæ¯ä¸ªåŒ…å«ï¼š
                - campaign_name: ç³»åˆ—åç§°
                - cost: L7DèŠ±è´¹
                - clicks: L7Dç‚¹å‡»
                - impressions: L7Då±•ç¤º
                - cpc: å½“å‰CPC
                - budget: å½“å‰é¢„ç®—
                - conservative_epc: ä¿å®ˆEPCï¼ˆå·²å«0.72ç³»æ•°ï¼‰
                - is_budget_lost: Budgetä¸¢å¤±æ¯”ä¾‹
                - is_rank_lost: Rankä¸¢å¤±æ¯”ä¾‹
                - orders: L7Dè®¢å•æ•°
                - order_days: å‡ºå•å¤©æ•°
                - commission: ä½£é‡‘
        
        Returns:
            å®Œæ•´å®¡è®¡æŠ¥å‘Š
        """
        # è·å–ä»Šå¤©æ˜ŸæœŸå‡ 
        today = datetime.now()
        weekday_names = ["å‘¨ä¸€", "å‘¨äºŒ", "å‘¨ä¸‰", "å‘¨å››", "å‘¨äº”", "å‘¨å…­", "å‘¨æ—¥"]
        weekday = today.weekday()
        weekday_name = weekday_names[weekday]
        is_analysis_day = weekday in [0, 2, 4]  # å‘¨ä¸€ã€ä¸‰ã€äº”
        
        # è½¬æ¢æ•°æ®ä¸ºè¡¨æ ¼æ ¼å¼
        table_rows = []
        for c in campaigns_data:
            table_rows.append(f"| {c.get('campaign_name', '')} | {c.get('cost', 0)} | {c.get('clicks', 0)} | {c.get('impressions', 0)} | {c.get('cpc', 0)} | {c.get('budget', 0)} | {c.get('conservative_epc', 0)} | {c.get('is_budget_lost', 0)} | {c.get('is_rank_lost', 0)} | {c.get('orders', 0)} | {c.get('order_days', 0)} | {c.get('commission', 0)} |")
        
        table_header = "| ç³»åˆ—å | L7DèŠ±è´¹ | L7Dç‚¹å‡» | L7Då±•ç¤º | CPC | é¢„ç®— | ä¿å®ˆEPC | Budgetä¸¢å¤± | Rankä¸¢å¤± | è®¢å• | å‡ºå•å¤©æ•° | ä½£é‡‘ |"
        table_divider = "|--------|---------|---------|---------|-----|------|---------|-----------|----------|------|---------|------|"
        table_data = "\n".join([table_header, table_divider] + table_rows)
        
        prompt = f"""# Google Ads å“ç‰Œè¯å¥—åˆ©å®¡è®¡æç¤ºè¯ï¼ˆv5 å¼ºåˆ¶å®Œæ•´ç‰ˆï¼‰

ä½ æ˜¯èµ„æ·± Google Ads å“ç‰Œè¯ç›´è¿å¥—åˆ©æ“ç›˜æ‰‹ã€‚å¯¹è¡¨æ ¼ä¸­æ¯ä¸ªå¹¿å‘Šç³»åˆ—åšå…¨é‡å®¡è®¡ä¸åˆ†çº§ï¼Œè¾“å‡ºå¯æ‰§è¡Œæ–¹æ¡ˆã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€å›¢é˜ŸèŠ‚å¥ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
åˆ†ææ—¥ï¼šå‘¨ä¸€ã€ä¸‰ã€äº”ã€‚æ ¹æ®ä»Šæ—¥è‡ªåŠ¨åˆ¤æ–­æ˜¯å¦åˆ†ææ—¥ã€‚
ä»Šæ—¥ï¼š{today.strftime('%Y-%m-%d')} {weekday_name}ï¼ˆ{"âœ… åˆ†ææ—¥" if is_analysis_day else "âš ï¸ éåˆ†ææ—¥"}ï¼‰

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€å£å¾„ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- ä¿å®ˆEPC/ROI å·²å«0.72ç³»æ•°ï¼Œç¦æ­¢é‡å¤ä¹˜
- L7D = D-1è‡³D-8æ»šåŠ¨ç´¯è®¡
- æ—¥å‡ç‚¹å‡» = L7Dç‚¹å‡» Ã· 7
- çº¢çº¿CPC = ä¿å®ˆEPC Ã— 0.7

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€æ ·æœ¬é‡åˆ¤å®šã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
| æ—¥å‡ç‚¹å‡» | åˆ¤å®š | çº¦æŸ |
|---------|------|------|
| < 10 | ğŸ”´ | ç¦åˆ¤Dï¼ˆé™¤éEPC=0ï¼‰ |
| 10-25 | ğŸŸ¡ | ç¦åˆ¤S |
| > 25 | ğŸŸ¢ | æ­£å¸¸åˆ¤å®š |

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ç“¶é¢ˆåˆ¤å®šã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
- Budgetç“¶é¢ˆï¼šBudgetä¸¢å¤± â‰¥ 40% ä¸” > Rankä¸¢å¤±
- Rankç“¶é¢ˆï¼šRankä¸¢å¤± â‰¥ 40% ä¸” > Budgetä¸¢å¤±
- æ··åˆï¼šä¸¤è€…éƒ½ â‰¥ 40%
- æ­£å¸¸ï¼šä¸¤è€…éƒ½ < 40%

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€åˆ†çº§è§„åˆ™ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â–¶ Sçº§ï¼šå¿…é¡»åŒæ—¶æ»¡è¶³
  â‘  ROI â‰¥ 3.0  â‘¡ ä¸å€’æŒ‚  â‘¢ å‡ºå•å¤©æ•° â‰¥ 5  â‘£ æ ·æœ¬ğŸŸ¢
  ä»»ä¸€ä¸æ»¡è¶³ â†’ Bçº§

â–¶ Dçº§ï¼šæ»¡è¶³ä»»ä¸€
  â‘  ROI â‰¤ 0 ä¸” æ ·æœ¬ğŸŸ¢
  â‘¡ å€’æŒ‚å¹…åº¦ â‰¥ 0.05 ä¸” ROI < 1.0 ä¸” æ ·æœ¬ğŸŸ¢
  â‘¢ L7Dç‚¹å‡» â‰¥ 100 ä¸” å‡ºå• = 0
  â‘£ ä¿å®ˆEPC = 0

â–¶ Bçº§ï¼šä¸æ»¡è¶³Sä¹Ÿä¸è§¦å‘D

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€åŠ¨ä½œè§„åˆ™ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é¢„ç®—ä¸Šé™ï¼šé»˜è®¤+30%ï¼›Sçº§ä¸”Budgetä¸¢å¤±>60%æ—¶å…è®¸+100%

â–¶ Sçº§ï¼šBudgetä¸¢å¤±>60%é¢„ç®—Ã—2.0ï¼Œ40-60%é¢„ç®—Ã—1.3ï¼ŒRankä¸¢å¤±>60%åŠ CPCè‡³çº¢çº¿Ã—0.9
â–¶ Bçº§ï¼šå€’æŒ‚â†’é™CPCè‡³çº¢çº¿ï¼›æ ·æœ¬ğŸ”´ğŸŸ¡â†’é¢„ç®—Ã—1.3
â–¶ Dçº§ï¼šç«‹å³PAUSE
â–¶ å‘¨äº”ï¼šSçº§é¢å¤–+20%

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€æ•ˆæœé¢„æµ‹å…¬å¼ï¼ˆå¿…ç®—ï¼‰ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
é¢„æœŸæ—¥ç‚¹å‡» = æ–°é¢„ç®— Ã· æ–°CPC
é¢„æœŸROI = (ä¿å®ˆEPC - æ–°CPC) Ã· æ–°CPC

æ–¹æ¡ˆå¯è¡Œæ€§åˆ¤å®šï¼š
- é¢„æœŸæ—¥ç‚¹å‡» > 25 â†’ âœ…å¯è¾¾ğŸŸ¢
- é¢„æœŸæ—¥ç‚¹å‡» â‰¤ 25 â†’ âš ï¸æ— æ³•è¾¾ğŸŸ¢
- è‹¥æ— æ³•è¾¾ğŸŸ¢ï¼šæœ€ä½è¾¾æ ‡é¢„ç®— = 26 Ã— æ–°CPC

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€è¾“å‡ºæ ¼å¼ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

A) èŠ‚å¥é¢æ¿
ğŸ“… ä»Šæ—¥ï¼šYYYY-MM-DD å‘¨Xï¼ˆâœ…/âš ï¸ï¼‰| ä¸Šæ¬¡ï¼šå‘¨X | ä¸‹æ¬¡ï¼šå‘¨X

B) æ¦‚è§ˆ
æ€»ç³»åˆ—ï¼šX | Sçº§ï¼šX | Bçº§ï¼šX | Dçº§ï¼šX

C) å®¡è®¡æ€»è¡¨
| # | ç³»åˆ—å | çº§åˆ« | æ—¥å‡ç‚¹å‡» | æ ·æœ¬ | çº¢çº¿ | MaxCPC | å€’æŒ‚ | ROI | ç“¶é¢ˆ | é¢„æœŸæ—¥ç‚¹å‡» | å¯è¡Œæ€§ |

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
D) é€ç³»åˆ—å®Œæ•´åˆ†æ
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€å¼ºåˆ¶è¦æ±‚ã€‘ï¼š
1. å¿…é¡»å¯¹è¾“å…¥è¡¨æ ¼ä¸­çš„ã€æ¯ä¸€ä¸ªç³»åˆ—ã€‘å•ç‹¬è¾“å‡º
2. å¿…é¡»æŒ‰ä¸‹æ–¹æ¨¡æ¿è¾“å‡ºã€å…¨éƒ¨å­—æ®µã€‘ï¼Œç¼ºä¸€ä¸å¯
3. S/B/D ä¸‰ç§çº§åˆ«ä½¿ç”¨ã€åŒä¸€æ¨¡æ¿ã€‘ï¼Œå­—æ®µå®Œå…¨ç›¸åŒ
4. ç¦æ­¢ä½¿ç”¨"æ ¸å¿ƒç¤ºä¾‹""å…¸å‹""å…¶ä½™ç±»ä¼¼"ç­‰çœç•¥è¡¨è¿°
5. ç¦æ­¢åˆå¹¶å¤šä¸ªç³»åˆ—
6. Dçº§ç³»åˆ—ä¹Ÿå¿…é¡»è¾“å‡ºå®Œæ•´å­—æ®µï¼ˆåŠ¨ä½œå›ºå®šä¸ºPAUSEï¼‰

ã€ç»Ÿä¸€æ¨¡æ¿ - æ¯ä¸ªç³»åˆ—å¿…é¡»åŒ…å«ä»¥ä¸‹å…¨éƒ¨10è¡Œã€‘ï¼š
---
ã€ç³»åˆ—åç§°ã€‘
çº§åˆ«ï¼šS / B / D
æ£€éªŒï¼šROI=X.XX[âœ“/âœ—] | ä¸å€’æŒ‚[âœ“/âœ—] | å‡ºå•â‰¥5[âœ“/âœ—] | æ ·æœ¬ğŸŸ¢[âœ“/âœ—] â†’ [4âœ“=S / å¦åˆ™B / è§¦å‘Dè§„åˆ™=D]
Dçº§æ£€æŸ¥ï¼šâ‘ ROIâ‰¤0ä¸”ğŸŸ¢[æ˜¯/å¦] â‘¡å€’æŒ‚â‰¥0.05ä¸”ROI<1ä¸”ğŸŸ¢[æ˜¯/å¦] â‘¢ç‚¹å‡»â‰¥100ä¸”å‡ºå•=0[æ˜¯/å¦] â‘£EPC=0[æ˜¯/å¦] â†’ è§¦å‘ï¼š[æ— /è§„åˆ™X]
è¯Šæ–­ï¼šæ—¥å‡X.X(ğŸ”´/ğŸŸ¡/ğŸŸ¢) | çº¢çº¿$X.XX | å€’æŒ‚å¹…åº¦$X.XX | Budgetä¸¢å¤±X%/Rankä¸¢å¤±X% â†’ [ç“¶é¢ˆç±»å‹]
åŠ¨ä½œï¼šCPC $X.XXâ†’$X.XX | é¢„ç®— $X.XXâ†’$X.XX(+X%) | [S/B/Dç‰¹å®šåŠ¨ä½œè¯´æ˜]
æ•ˆæœï¼šé¢„æœŸæ—¥ç‚¹å‡»=$X.XXÃ·$X.XX=X.X | å¯è¡Œæ€§[âœ…å¯è¾¾ğŸŸ¢/âš ï¸ä»…ğŸŸ¡/âŒä»ğŸ”´] | è‹¥âš ï¸âŒ:è¾¾ğŸŸ¢éœ€$X.XX,ç¼ºå£$X.XX | é¢„æœŸROI:X.XXâ†’X.XX
éªŒè¯ï¼šMM-DDå‘¨X | å±Šæ—¶é¢„æœŸçŠ¶æ€ | æ£€æŸ¥é¡¹ | æœªè¾¾æ ‡å¤„ç½®
å‡é™ï¼šå‡çº§æ¡ä»¶ | é™çº§è§¦å‘ | ç»´æŒè§‚å¯Ÿç‚¹
---

E) æ‰§è¡Œæ¸…å•
| ä¼˜å…ˆçº§ | ç³»åˆ— | åŠ¨ä½œ | æ“ä½œ | é¢„æœŸæ•ˆæœ | å¯è¡Œæ€§ | éªŒè¯æ—¥ |
| ğŸ”´ | xxx | æš‚åœ | PAUSE | æ­¢æŸ | - | - |
| ğŸŸ¡ | xxx | è°ƒä»· | CPC Xâ†’X | ROI Xâ†’X | âœ… | MM-DD |
| ğŸŸ¢ | xxx | åŠ é¢„ç®— | $Xâ†’$X | æ—¥ç‚¹å‡»Xâ†’X | âš ï¸ | MM-DD |

F) ä¸“é¡¹åå•
1. æ½œåŠ›è‚¡ï¼š[ç³»åˆ—] - åŸå› 
2. å¸è¡€é¬¼ï¼š[ç³»åˆ—] - è§¦å‘è§„åˆ™X
3. æ ·æœ¬ä¸è¶³ï¼š[ç³»åˆ—] - å¯è¡Œæ€§[âœ…/âš ï¸]ï¼Œè‹¥âš ï¸è¾¾ğŸŸ¢éœ€$X.XX
4. å—é™ç³»åˆ—ï¼š[ç³»åˆ—] - éœ€Xæ¬¡+30%è°ƒæ•´è¾¾ğŸŸ¢

G) ç»¼è¿°
å…³é”®å‘ç° | ä¸‹æ¬¡é‡ç‚¹ | [å‘¨äº”]å‘¨æœ«ç­–ç•¥

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€è‡ªæ£€æ¸…å•ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¾“å‡ºå‰å¿…é¡»é€æ¡ç¡®è®¤ï¼š
â–¡ 1. è¾“å‡ºç³»åˆ—æ•° = è¾“å…¥ç³»åˆ—æ•°ï¼ˆå†™å‡ºï¼šX = Xï¼‰
â–¡ 2. æ¯ä¸ªç³»åˆ—éƒ½æœ‰å®Œæ•´10è¡Œï¼ˆé€ä¸ªç¡®è®¤ï¼‰
â–¡ 3. Sçº§å…¨æ»¡è¶³4æ¡ä»¶
â–¡ 4. æ‰€æœ‰MaxCPC â‰¤ çº¢çº¿
â–¡ 5. é¢„ç®—è°ƒæ•´ â‰¤ ä¸Šé™
â–¡ 6. Dçº§éƒ½æ ‡æ˜è§¦å‘è§„åˆ™
â–¡ 7. Bçº§éƒ½æœ‰å‡é™æ¡ä»¶
â–¡ 8. å€’æŒ‚â‰¥0.05ä¸”ROI<1ä¸”ğŸŸ¢éƒ½åˆ¤D
â–¡ 9. æ¯ä¸ªç³»åˆ—éƒ½æœ‰æ•ˆæœé¢„æµ‹
â–¡ 10. âš ï¸âŒç³»åˆ—éƒ½æ ‡æ³¨è¾¾ğŸŸ¢æ‰€éœ€é¢„ç®—

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ç¦æ­¢äº‹é¡¹ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
âŒ çœç•¥ä»»ä½•ç³»åˆ—
âŒ ä½¿ç”¨"æ ¸å¿ƒç¤ºä¾‹""å…¸å‹åˆ†æ""å…¶ä½™ç±»ä¼¼""ç»Ÿä¸€å¤„ç†"ç­‰è¡¨è¿°
âŒ Dçº§ç³»åˆ—ç®€åŒ–è¾“å‡ºï¼ˆå¿…é¡»è¾“å‡ºå®Œæ•´å­—æ®µï¼‰
âŒ åˆå¹¶å¤šä¸ªç³»åˆ—åˆ°ä¸€ä¸ªåˆ†æå—
âŒ MaxCPC > çº¢çº¿
âŒ æ ·æœ¬ğŸ”´åˆ¤Dï¼ˆé™¤éEPC=0ï¼‰
âŒ æ ·æœ¬ğŸŸ¡åˆ¤S
âŒ é¢„ç®—è¶…é™
âŒ æ•ˆæœé¢„æµ‹ç¼ºå¤±
âŒ âš ï¸âŒç³»åˆ—ä¸æ ‡æ³¨è¾¾ğŸŸ¢æ‰€éœ€é¢„ç®—
âŒ éªŒè¯çª—å£æ— ä¾æ®

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€å®Œæ•´æ€§æœ€ç»ˆç¡®è®¤ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
è¾“å‡ºç»“æŸå‰ï¼Œå¿…é¡»å†™ï¼š
"âœ… å®Œæ•´æ€§ç¡®è®¤ï¼šå…±è¾“å…¥Xä¸ªç³»åˆ—ï¼Œå·²å…¨éƒ¨è¾“å‡ºXä¸ªç³»åˆ—ï¼Œæ— çœç•¥ã€‚"

è‹¥è¾“å‡ºæ•° â‰  è¾“å…¥æ•°ï¼Œå¿…é¡»è¡¥å…¨åå†è¾“å‡ºç¡®è®¤ã€‚

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
å¾…å®¡è®¡çš„å¹¿å‘Šç³»åˆ—æ•°æ®ï¼š
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
{table_data}

è¯·å¼€å§‹å®¡è®¡ã€‚"""

        try:
            analysis = self._call_api(prompt)
            return {
                "success": True,
                "analysis": analysis,
                "campaign_count": len(campaigns_data),
                "analysis_date": today.strftime('%Y-%m-%d'),
                "weekday": weekday_name,
                "is_analysis_day": is_analysis_day,
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"L7D åˆ†æå¤±è´¥: {e}")
            return {"success": False, "message": str(e)}
    
    def generate_operation_report(self, campaigns_data: List[Dict], custom_prompt: str = None) -> Dict:
        """
        ç”Ÿæˆå¯æ‰§è¡Œçš„æ“ä½œæŠ¥å‘Š
        
        è¾“å‡ºæ ¼å¼å¦‚ï¼š
        - CPC 0.10â†’0.08
        - é¢„ç®— $10.00â†’$15.00(+50%)
        
        Args:
            campaigns_data: å¹¿å‘Šç³»åˆ—æ•°æ®
            custom_prompt: ç”¨æˆ·è‡ªå®šä¹‰æç¤ºè¯ï¼ˆå¯é€‰ï¼‰
        
        Returns:
            æ“ä½œæŠ¥å‘Š
        """
        today = datetime.now()
        
        # è½¬æ¢æ•°æ®ä¸ºè¡¨æ ¼æ ¼å¼
        table_rows = []
        for c in campaigns_data:
            roi = 0
            if c.get('cost', 0) > 0:
                roi = (c.get('commission', 0) * 0.72 - c.get('cost', 0)) / c.get('cost', 0)
            table_rows.append(
                f"| {c.get('campaign_name', '')} | ${c.get('cost', 0):.2f} | "
                f"${c.get('budget', 0):.2f} | ${c.get('cpc', 0):.2f} | "
                f"{c.get('orders', 0)} | {c.get('order_days', 0)} | "
                f"{c.get('is_budget_lost', 0)*100:.0f}% | {c.get('is_rank_lost', 0)*100:.0f}% | "
                f"{roi:.2f} |"
            )
        
        table_header = "| ç³»åˆ—å | L7DèŠ±è´¹ | é¢„ç®— | CPC | è®¢å• | å‡ºå•å¤©æ•° | Budgetä¸¢å¤± | Rankä¸¢å¤± | ROI |"
        table_divider = "|--------|---------|------|-----|------|---------|-----------|----------|-----|"
        table_data = "\n".join([table_header, table_divider] + table_rows)
        
        # é»˜è®¤æç¤ºè¯
        default_prompt = """ä½ æ˜¯ä¸€ä½èµ„æ·±çš„ Google Ads å“ç‰Œè¯å¥—åˆ©ä¸“å®¶ã€‚è¯·æ ¹æ®ä»¥ä¸‹å¹¿å‘Šç³»åˆ—æ•°æ®ç”Ÿæˆæ“ä½œæŠ¥å‘Šã€‚

## è¾“å‡ºæ ¼å¼è¦æ±‚

å¯¹äºæ¯ä¸ªå¹¿å‘Šç³»åˆ—ï¼Œè¾“å‡ºä»¥ä¸‹æ ¼å¼çš„æ‰§è¡ŒæŒ‡ä»¤ï¼š

**[å¹¿å‘Šç³»åˆ—å]**
- CPC å½“å‰å€¼â†’å»ºè®®å€¼
- é¢„ç®— $å½“å‰å€¼â†’$å»ºè®®å€¼(å˜åŒ–%)
- çŠ¶æ€: ç»´æŒ/æš‚åœ/åŠ é¢„ç®—
- åŸå› : ç®€è¦è¯´æ˜

## åˆ†æè§„åˆ™

1. ROI < 0.8 â†’ è€ƒè™‘é™ä½CPCæˆ–æš‚åœ
2. ROI > 1.5 ä¸” Budgetä¸¢å¤± > 30% â†’ åŠ é¢„ç®—
3. Rankä¸¢å¤± > 20% â†’ è€ƒè™‘æé«˜CPC
4. è¿ç»­7å¤©æ— è®¢å• â†’ æš‚åœ
5. å‡ºå•å¤©æ•° â‰¥ 5 ä¸” ROI > 2 â†’ è¡¨ç°ä¼˜ç§€ï¼Œå¯åŠ é¢„ç®—

## æ³¨æ„äº‹é¡¹

- æ‰€æœ‰æ•°å€¼å˜åŒ–ç”¨ç®­å¤´ â†’ è¡¨ç¤º
- é¢„ç®—å˜åŒ–éœ€æ˜¾ç¤ºç™¾åˆ†æ¯”ï¼Œå¦‚ $10â†’$15(+50%)
- CPCå˜åŒ–éœ€ç²¾ç¡®åˆ°å°æ•°ç‚¹å2ä½
- ä¿æŒç®€æ´ï¼Œæ¯ä¸ªç³»åˆ—æœ€å¤š4è¡Œ

è¯·åŸºäºæ•°æ®ç”Ÿæˆç®€æ´ã€å¯æ‰§è¡Œçš„æ“ä½œæŒ‡ä»¤ã€‚"""

        prompt_text = custom_prompt if custom_prompt and custom_prompt.strip() else default_prompt
        
        full_prompt = f"""{prompt_text}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€ä»Šæ—¥æ—¥æœŸã€‘{today.strftime('%Y-%m-%d')}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ã€å¹¿å‘Šç³»åˆ—æ•°æ®ã€‘
{table_data}

è¯·å¼€å§‹ç”Ÿæˆæ“ä½œæŠ¥å‘Šã€‚"""

        try:
            analysis = self._call_api(full_prompt)
            return {
                "success": True,
                "analysis": analysis,
                "campaign_count": len(campaigns_data),
                "analysis_date": today.strftime('%Y-%m-%d'),
                "timestamp": datetime.now().isoformat()
            }
        except Exception as e:
            logger.error(f"ç”Ÿæˆæ“ä½œæŠ¥å‘Šå¤±è´¥: {e}")
            return {"success": False, "message": str(e)}

