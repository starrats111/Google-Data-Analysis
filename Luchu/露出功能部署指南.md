# 露出功能部署指南

## 一、服务器端部署步骤

### 1. 拉取最新代码
```bash
cd ~/Google-Data-Analysis
git pull origin main
```

### 2. 安装新依赖
```bash
cd backend
source venv/bin/activate
pip install anthropic httpx
```

### 3. 执行数据库迁移
```bash
# 执行迁移脚本，在 google_analysis.db 中创建 luchu_ 开头的表
sqlite3 google_analysis.db < scripts/migrate_luchu.sql
```

### 4. 配置环境变量

编辑 `backend/.env` 文件，添加以下配置：

```bash
# Claude API Key (露出功能) - 从管理员获取
CLAUDE_API_KEY=your_claude_api_key_here

# GitHub Token (发布功能) - 从管理员获取
GITHUB_TOKEN=your_github_token_here
GITHUB_OWNER=starrats111
```

> **注意**：API Key 请联系 07 获取，不要提交到代码仓库

### 5. 重启后端服务
```bash
pkill -f uvicorn
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 &
```

### 6. 验证部署
```bash
# 检查服务是否启动
curl http://localhost:8000/api/luchu/websites

# 检查数据库表是否创建
sqlite3 google_analysis.db ".tables" | grep luchu
```

## 二、前端自动部署

前端代码已推送到 GitHub，Cloudflare Pages 会自动部署。

部署完成后，访问 https://google-data-analysis.top/luchu 即可使用露出功能。

## 三、功能入口

### 普通员工 (wj组)
- 侧边栏 → 露出管理
  - 露出总览：统计数据和通知
  - 创建内容：AI自动分析商家URL、生成文章
  - 我的文章：查看和管理自己的文章
  - 待发布：发布审核通过的文章
  - 通知中心：查看审核结果通知

### 管理员/组长
- 额外功能：
  - 审核管理：审核员工提交的文章

### 特殊权限 (wj02, wj07)
- 自检功能：可跳过审核流程直接发布

## 四、数据库表说明

| 表名 | 说明 |
|------|------|
| luchu_websites | 网站配置（已预置9个网站） |
| luchu_articles | 文章数据 |
| luchu_article_versions | 文章版本历史 |
| luchu_reviews | 审核记录 |
| luchu_publish_logs | 发布日志 |
| luchu_image_checks | 图片检测记录 |
| luchu_image_alerts | 图片告警 |
| luchu_prompt_templates | 提示词模板（已预置2个） |
| luchu_notifications | 平台通知 |
| luchu_crawl_cache | 爬取缓存 |
| luchu_operation_logs | 操作日志 |

## 五、一键部署命令

复制以下命令到服务器执行：

```bash
cd ~/Google-Data-Analysis
git pull origin main
cd backend
source venv/bin/activate
pip install anthropic httpx

# 执行数据库迁移
sqlite3 google_analysis.db < scripts/migrate_luchu.sql

# 添加环境变量（手动编辑 .env 文件，添加以下内容）
# CLAUDE_API_KEY=<从管理员获取>
# GITHUB_TOKEN=<从管理员获取>
# GITHUB_OWNER=starrats111
# 
# 或使用以下命令（替换 YOUR_KEY 为实际值）：
# echo "CLAUDE_API_KEY=YOUR_CLAUDE_KEY" >> .env
# echo "GITHUB_TOKEN=YOUR_GITHUB_TOKEN" >> .env
# echo "GITHUB_OWNER=starrats111" >> .env

# 重启服务
pkill -f uvicorn
sleep 2
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 &

echo "部署完成！"
```

