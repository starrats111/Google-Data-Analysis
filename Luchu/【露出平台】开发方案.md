# 🚀 露出功能开发方案 v3.0

> **版本**: v3.0  
> **更新日期**: 2026-02-13  
> **负责人**: wj07  
> **项目性质**: **分析平台子功能模块**（非独立项目）

---

## 一、项目概述

### 1.1 项目背景

团队10人（wj01-wj10），每人负责一个博客网站的"露出"内容编辑。当前流程：
1. 手动分析商家URL
2. 手动撰写推广博客
3. 手动上传图片
4. 手动推送到GitHub
5. Cloudflare自动部署

**痛点**：每篇博客耗时1-2小时，重复劳动多，质量不稳定。

### 1.2 架构定位

> ⚠️ **重要：露出功能是分析平台的子模块，不是独立项目**

| 对比项 | 分析平台（现有） | 露出功能（新增） |
|--------|------------------|------------------|
| **前端** | React + Ant Design + Vite | 相同技术栈，新增页面 |
| **后端** | FastAPI + Python | 相同框架，新增路由 |
| **数据库** | SQLite (google_analysis.db) | 相同数据库，新增表 |
| **部署** | 阿里云服务器 | 相同服务器 |
| **用户系统** | 现有 users 表 | 复用，扩展角色 |
| **API Key** | 哈基米环境变量 | 相同方式 |

### 1.3 项目目标

开发一个**AI驱动的露出管理功能**，作为分析平台的新模块：

| 目标 | 描述 | 预期效果 |
|------|------|----------|
| **自动化** | AI自动爬取网页+生成博客内容 | 单篇耗时降至10分钟 |
| **标准化** | 统一内容格式和质量 | 符合露出指南100% |
| **协作化** | 支持审核和分发 | 零沟通成本 |
| **一站式** | 从创建到发布全流程 | 无需切换工具 |

### 1.4 核心用户与权限

复用现有分析平台的角色体系，扩展露出相关权限：

| 现有角色 | 露出权限 |
|----------|----------|
| **manager** | 全部权限（管理员） |
| **leader** | 审核+编辑+发布+自检模式 |
| **member** | 创建+编辑自己的内容 |

**特殊权限**：
- 自检模式：wj02, wj07 可跳过审核
- 操作日志查看：仅 wj02, wj07

---

## 二、功能设计

### 2.1 功能架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                    分析平台 - 露出功能模块                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   内容创建   │  │   审核管理   │  │   发布推送   │          │
│  │              │  │              │  │              │          │
│  │ • 商家URL输入│  │ • 待审列表   │  │ • 选择网站   │          │
│  │ • 自动爬取   │  │ • 审核/驳回  │  │ • 真实预览   │          │
│  │ • 智能选图   │  │ • 修改历史   │  │ • GitHub推送 │          │
│  │ • AI内容生成 │  │ • 版本对比   │  │ • 批量发布   │          │
│  │ • 预览编辑   │  │              │  │ • 发布状态   │          │
│  │ • 自检模式   │  │              │  │              │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │
│  │   内容管理   │  │   图片管理   │  │   系统设置   │          │
│  │              │  │              │  │              │          │
│  │ • 文章列表   │  │ • 外链检测   │  │ • 网站配置   │          │
│  │ • 搜索筛选   │  │ • 失效告警   │  │ • 提示词模板 │          │
│  │ • 版本历史   │  │ • 一键本地化 │  │ • 操作日志   │          │
│  └──────────────┘  └──────────────┘  └──────────────┘          │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### 2.2 前端页面规划

在现有 `App.jsx` 路由中新增露出相关页面：

```jsx
// 新增路由（在现有路由基础上添加）
<Route path="luchu" element={<LuchuDashboard />} />           {/* 露出仪表盘 */}
<Route path="luchu/create" element={<LuchuCreate />} />       {/* 创建内容 */}
<Route path="luchu/articles" element={<LuchuArticles />} />   {/* 文章列表 */}
<Route path="luchu/articles/:id" element={<LuchuEdit />} />   {/* 编辑文章 */}
<Route path="luchu/articles/:id/preview" element={<LuchuPreview />} /> {/* 预览 */}
<Route path="luchu/reviews" element={<LuchuReviews />} />     {/* 审核管理 */}
<Route path="luchu/publish" element={<LuchuPublish />} />     {/* 发布管理 */}
<Route path="luchu/images" element={<LuchuImages />} />       {/* 图片管理 */}
<Route path="luchu/websites" element={<LuchuWebsites />} />   {/* 网站配置 */}
<Route path="luchu/prompts" element={<LuchuPrompts />} />     {/* 提示词管理 */}
<Route path="luchu/logs" element={<LuchuLogs />} />           {/* 操作日志 */}
```

### 2.3 侧边栏菜单扩展

在现有 `Layout/index.jsx` 的菜单中添加：

```jsx
// 露出功能菜单组
{
  key: 'luchu',
  icon: <EditOutlined />,
  label: '露出管理',
  children: [
    { key: '/luchu', label: '露出概览' },
    { key: '/luchu/create', label: '创建内容' },
    { key: '/luchu/articles', label: '我的文章' },
    { key: '/luchu/reviews', label: '待审核', badge: pendingReviewCount },
    { key: '/luchu/publish', label: '发布管理' },
    { key: '/luchu/images', label: '图片管理' },
    { key: '/luchu/websites', label: '网站配置' },
    { key: '/luchu/prompts', label: '提示词模板' },
    { key: '/luchu/logs', label: '操作日志' },  // 仅 wj02/wj07 可见
  ],
}
```

### 2.4 核心功能详解

#### 2.4.1 内容创建（核心模块）

**输入**：
- 商家URL（必填）
- 追踪链接（必填）
- 目标网站（下拉选择）
- 品牌关键词出现次数（默认10次，可调整）
- 发布时间（默认：创建日期-7天，可修改）
- 提示词模板（下拉选择）

**AI处理流程（Claude Tool Use）**：

```
商家URL
    │
    ▼
┌─────────────────────────────────────────────────────────────────┐
│                    Claude API (Tool Use 模式)                    │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  Step 1: Claude 请求调用 fetch_webpage 工具                     │
│          │                                                       │
│          ▼                                                       │
│  ┌─────────────────┐                                            │
│  │ 后端执行        │ ─── 实际 fetch 请求获取网页 HTML           │
│  │ fetch_webpage() │                                            │
│  └─────────────────┘                                            │
│          │                                                       │
│          ▼                                                       │
│  Step 2: 将 HTML 返回给 Claude                                  │
│          │                                                       │
│          ▼                                                       │
│  ┌─────────────────┐                                            │
│  │ Claude 分析     │ ─── 提取品牌信息、产品、图片URL            │
│  │ 网页内容        │ ─── 智能筛选最佳5张图片                    │
│  └─────────────────┘ ─── 生成图片 alt 描述                      │
│          │                                                       │
│          ▼                                                       │
│  Step 3: 返回结构化商家数据                                     │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────┐
│  用户确认界面   │ ─── 展示提取的信息和图片
│  • 编辑品牌信息 │ ─── 可调整图片顺序
│  • 调整图片选择 │ ─── 可替换单张图片
└─────────────────┘
    │
    ▼ 确认后
┌─────────────────────────────────────────────────────────────────┐
│                    Claude API (内容生成)                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  输入:                                                          │
│  • 商家信息 (品牌名、产品、描述)                                │
│  • 5张图片 URL + alt 描述                                       │
│  • 追踪链接                                                     │
│  • 提示词模板                                                   │
│  • 关键词次数要求                                               │
│                                                                  │
│  输出:                                                          │
│  • 文章标题                                                     │
│  • 文章摘要                                                     │
│  • HTML 正文 (含图片位置标记)                                   │
│  • 产品模块数据 (如有)                                          │
│  • SEO 元数据                                                   │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────┐
│  预览 & 编辑    │
│  提交审核/发布  │
└─────────────────┘
```

**图片智能筛选规则**：
1. 过滤小图标（宽或高 < 200px）
2. 过滤 logo、banner 等非产品图
3. 优先选择产品图、场景图
4. 按图片质量评分排序
5. 自动选取 Top 5

**输出**：
- 文章标题
- 文章正文（HTML格式）
- 摘要/描述
- 文章图片（5张：1张头图 + 4张内容图）
- 产品列表（如有）
- SEO元数据

#### 2.4.2 审核管理

**工作流**：
```
创建 ──> 待审核 ──> 审核通过 ──> 待发布 ──> 已发布
              │
              └──> 审核驳回 ──> 修改 ──> 待审核
```

**审核功能**：
- 查看完整预览
- 通过/驳回按钮
- 驳回时填写修改意见
- 批量审核操作
- 版本历史对比

**自检模式**：
- wj02 和 wj07 的内容可跳过审核
- 点击"自检发布"后直接进入"待发布"状态
- 仍需手动执行发布操作

**版本历史**：
- 每次保存自动创建新版本
- 支持查看任意历史版本
- 支持版本对比（Diff 视图）
- 支持恢复到任意历史版本

#### 2.4.3 发布推送

**推送流程**：
```
选择文章
    │
    ▼
确认目标网站
    │
    ▼
预览发布效果 (可选)
    │
    ▼
生成 JSON 文件
    │
    ▼
GitHub API 推送
    │
    ▼
Cloudflare 自动部署
    │
    ▼
验证发布结果
```

**推送内容**：
- `js/articles/{id}.json` - 文章完整内容
- `js/articles-index.js` - 更新索引

**真实预览功能**：
- 从目标网站 GitHub 仓库获取 `article.html` 模板
- 将文章 JSON 数据注入模板
- 在 iframe 中渲染，展示真实效果
- 支持在新窗口打开预览

#### 2.4.4 图片外链检测

**检测机制**：
- 每日定时任务 (04:00 UTC+8)
- HEAD 请求检测图片URL有效性
- 失效时创建告警，仪表盘通知

**告警通知机制**：仅使用**仪表盘通知**，不使用邮件

| 触发条件 | 通知方式 |
|----------|----------|
| 图片外链失效告警 | 仪表盘通知 🔴 |
| 审核结果（通过/驳回） | 仪表盘通知 |
| 发布成功 | 仪表盘通知 |
| 系统通知 | 仪表盘通知 |

**失效处理选项**：
1. **更换图片** - 重新选择或上传
2. **下载本地** - 如果图片还能访问，下载到 GitHub
3. **使用 Unsplash** - 使用图库替换
4. **忽略告警** - 标记为已处理

#### 2.4.5 错误处理机制

**网页爬取失败**：
| 错误类型 | 处理方式 |
|----------|----------|
| 超时 (15秒) | 自动重试 1 次 |
| HTTP 4xx | 提示"网站拒绝访问，请检查URL" |
| HTTP 5xx | 提示"商家网站暂时不可用，请稍后重试" |
| 其他错误 | 提供手动输入信息的降级选项 |

**Claude API 失败**：
| 错误类型 | 处理方式 |
|----------|----------|
| 限流 (429) | 队列等待，自动重试 |
| 超时 | 自动重试 1 次 |
| 其他错误 | 显示错误信息，允许重试 |

**GitHub 推送失败**：
| 错误类型 | 处理方式 |
|----------|----------|
| 认证失败 | 提示管理员检查 Token |
| 冲突 | 自动 fetch 最新后重试 |
| 其他错误 | 记录日志，允许手动重试 |

#### 2.4.6 操作日志审计

**记录的操作**：
- 文章：创建、编辑、删除、提交审核、发布
- 审核：通过、驳回
- 图片告警：处理
- 系统设置：修改

**权限**：仅 wj02 和 wj07 可查看操作日志

#### 2.4.7 数据统计

**仪表盘统计**：
- 发布趋势（本月）
- 网站浏览趋势（本月）
- 按分类统计
- 审核效率（平均审核时长、通过率）

#### 2.4.8 网站管理

**预配置的9个网站**：

| ID | 网站 | 域名 | 负责人 | GitHub 仓库 |
|----|------|------|--------|-------------|
| 1 | EverydayHaven | everydayhaven.top | wj01 | starrats111/EverydayHaven |
| 2 | Quiblo | quiblo.top | wj02 | starrats111/Quiblo |
| 3 | Kivanta | kivanta.top | wj03 | starrats111/Kivanta |
| 4 | NovaNest | novanest.one | wj04 | starrats111/NovaNest |
| 5 | Zontri | zontri.top | wj05 | starrats111/Zontri |
| 6 | AlluraHub | allurahub.top | wj06 | starrats111/AlluraHub |
| 7 | VitaHaven | vitahaven.click | wj07 | starrats111/VitaHaven |
| 8 | — | — | wj08 | 已离职，无对应仓库 |
| 9 | BloomRoots | bloomroots.top | wj09 | starrats111/BloomRoots |
| 10 | VitaSphere | vitasphere.top | wj10 | starrats111/VitaSphere |

---

## 三、技术架构

### 3.1 整体架构（集成到分析平台）

```
┌─────────────────────────────────────────────────────────────────┐
│                    Cloudflare Pages (前端)                       │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │            React + Ant Design + Vite (现有前端)            │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │            现有功能模块                               │  │  │
│  │  │  • 仪表盘    • L7D分析    • 出价管理                 │  │  │
│  │  │  • MCC聚合   • 平台数据   • 员工管理   ...           │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │            露出功能模块（新增）                        │  │  │
│  │  │  • 露出概览   • 创建内容   • 我的文章                │  │  │
│  │  │  • 审核管理   • 发布管理   • 图片管理   ...          │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ API请求
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                    阿里云服务器 (后端)                           │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │            FastAPI + Python (现有后端)                     │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │            现有 API 路由                               │  │  │
│  │  │  /api/auth/*     /api/analysis/*   /api/mcc/*         │  │  │
│  │  │  /api/affiliate/* /api/dashboard/* /api/gemini/*      │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                            │  │
│  │  ┌─────────────────────────────────────────────────────┐  │  │
│  │  │            露出 API 路由（新增）                        │  │  │
│  │  │  /api/luchu/articles/*     /api/luchu/ai/*            │  │  │
│  │  │  /api/luchu/reviews/*      /api/luchu/publish/*       │  │  │
│  │  │  /api/luchu/images/*       /api/luchu/websites/*      │  │  │
│  │  │  /api/luchu/prompts/*      /api/luchu/notifications/* │  │  │
│  │  │  /api/luchu/logs/*         /api/luchu/stats/*         │  │  │
│  │  └─────────────────────────────────────────────────────┘  │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
│                              │                                   │
│                              ▼                                   │
│  ┌───────────────────────────────────────────────────────────┐  │
│  │     SQLite 数据库 (google_analysis.db) - 统一数据库        │  │
│  │                                                            │  │
│  │  ┌─────────────────┐  ┌─────────────────┐                 │  │
│  │  │   现有表        │  │   露出新增表     │                 │  │
│  │  │   users         │  │   luchu_articles │                 │  │
│  │  │   teams         │  │   luchu_versions │                 │  │
│  │  │   ...           │  │   luchu_websites │                 │  │
│  │  │                 │  │   luchu_prompts  │                 │  │
│  │  │                 │  │   ...            │                 │  │
│  │  └─────────────────┘  └─────────────────┘                 │  │
│  │                                                            │  │
│  └───────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
              ┌───────────────┼───────────────┐
              │               │               │
              ▼               ▼               ▼
    ┌──────────────┐ ┌──────────────┐ ┌──────────────┐
    │   Claude     │ │   GitHub     │ │  博客网站    │
    │   API        │ │   API        │ │  (9个)       │
    └──────────────┘ └──────────────┘ └──────────────┘
```

### 3.2 技术选型（复用现有技术栈）

| 层级 | 技术 | 说明 |
|------|------|------|
| **前端框架** | React 18 + JSX | 复用现有，无需 TypeScript |
| **UI组件** | Ant Design 5 | 复用现有，统一风格 |
| **构建工具** | Vite 5 | 复用现有 |
| **状态管理** | Zustand | 复用现有 |
| **HTTP客户端** | Axios | 复用现有 api.js |
| **后端框架** | FastAPI | 复用现有 |
| **数据库** | SQLite | 复用现有 google_analysis.db |
| **ORM** | SQLAlchemy | 复用现有 |
| **认证** | JWT (python-jose) | 复用现有 |
| **密码** | passlib[bcrypt] | 复用现有 |
| **AI** | Claude API | 新增，Sonnet 3.5 |
| **定时任务** | APScheduler | 复用现有 |

### 3.3 环境变量配置

在现有 `.env` 或环境变量中新增：

| 变量名 | 说明 | 位置 |
|--------|------|------|
| `CLAUDE_API_KEY` | Claude API 密钥 | 哈基米（与 Gemini 相同方式） |
| `GITHUB_TOKEN` | GitHub PAT | 哈基米或服务器环境变量 |

### 3.4 Claude Tool Use 实现

```python
# backend/app/services/claude_service.py

import httpx
from anthropic import Anthropic
from typing import Dict, List, Any
import logging

logger = logging.getLogger(__name__)

class ClaudeService:
    """Claude API 服务，支持 Tool Use"""
    
    def __init__(self, api_key: str):
        self.client = Anthropic(api_key=api_key)
        self.tools = self._define_tools()
    
    def _define_tools(self) -> List[Dict]:
        return [
            {
                "name": "fetch_webpage",
                "description": "获取指定URL的网页HTML内容，用于分析商家网站",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "url": {
                            "type": "string",
                            "description": "要获取的网页URL"
                        }
                    },
                    "required": ["url"]
                }
            },
            {
                "name": "fetch_image_info",
                "description": "获取图片的元信息（尺寸、格式等）",
                "input_schema": {
                    "type": "object",
                    "properties": {
                        "url": {
                            "type": "string",
                            "description": "图片URL"
                        }
                    },
                    "required": ["url"]
                }
            }
        ]
    
    async def analyze_merchant_url(self, url: str) -> Dict[str, Any]:
        """分析商家URL，提取品牌信息和图片"""
        
        messages = [{
            "role": "user",
            "content": f"""请分析以下商家网站，提取：
1. 品牌名称
2. 品牌描述（简短）
3. 主营产品类型
4. 当前促销活动或热门产品
5. 从网页中选取5张最适合做博客配图的高质量图片URL（1张主图+4张内容图）
   - 优先选择产品图、场景图
   - 过滤掉logo、小图标、banner广告
   - 图片尺寸应大于400x400
6. 为每张图片生成简短的alt描述

商家网址: {url}

请以JSON格式返回结果。"""
        }]
        
        response = self.client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=4096,
            tools=self.tools,
            messages=messages
        )
        
        # 处理工具调用循环
        while response.stop_reason == "tool_use":
            tool_results = []
            
            for content in response.content:
                if content.type == "tool_use":
                    result = await self._execute_tool(content.name, content.input)
                    tool_results.append({
                        "type": "tool_result",
                        "tool_use_id": content.id,
                        "content": result
                    })
            
            # 继续对话
            messages.append({"role": "assistant", "content": response.content})
            messages.append({"role": "user", "content": tool_results})
            
            response = self.client.messages.create(
                model="claude-sonnet-4-20250514",
                max_tokens=4096,
                tools=self.tools,
                messages=messages
            )
        
        # 解析最终结果
        for content in response.content:
            if hasattr(content, 'text'):
                return self._parse_json_response(content.text)
        
        raise Exception("分析失败：无法获取结果")
    
    async def _execute_tool(self, tool_name: str, tool_input: Dict) -> str:
        """执行工具调用"""
        
        if tool_name == "fetch_webpage":
            return await self._fetch_webpage(tool_input["url"])
        elif tool_name == "fetch_image_info":
            return await self._fetch_image_info(tool_input["url"])
        else:
            return f"未知工具: {tool_name}"
    
    async def _fetch_webpage(self, url: str) -> str:
        """获取网页内容"""
        try:
            async with httpx.AsyncClient(timeout=15.0) as client:
                response = await client.get(
                    url,
                    headers={"User-Agent": "Mozilla/5.0 (compatible; LuchuBot/1.0)"},
                    follow_redirects=True
                )
                response.raise_for_status()
                html = response.text
                # 限制长度，避免 token 超限
                return html[:50000]
        except httpx.TimeoutException:
            return "Error: 请求超时"
        except httpx.HTTPStatusError as e:
            return f"Error: HTTP {e.response.status_code}"
        except Exception as e:
            return f"Error: {str(e)}"
    
    async def _fetch_image_info(self, url: str) -> str:
        """获取图片信息"""
        try:
            async with httpx.AsyncClient(timeout=10.0) as client:
                response = await client.head(url)
                return {
                    "url": url,
                    "status": "valid" if response.is_success else "invalid",
                    "content_type": response.headers.get("content-type", ""),
                    "content_length": response.headers.get("content-length", "0")
                }
        except Exception as e:
            return {"url": url, "status": "error", "error": str(e)}
    
    async def generate_article(
        self,
        merchant_data: Dict,
        tracking_link: str,
        keyword_count: int,
        prompt_template: str
    ) -> Dict[str, Any]:
        """生成文章内容"""
        
        prompt = prompt_template.replace(
            "[品牌名称]", merchant_data.get("brand_name", "")
        ).replace(
            "[追踪链接]", tracking_link
        ).replace(
            "[关键词次数]", str(keyword_count)
        ).replace(
            "[商家信息]", str(merchant_data)
        )
        
        response = self.client.messages.create(
            model="claude-sonnet-4-20250514",
            max_tokens=8192,
            messages=[{"role": "user", "content": prompt}]
        )
        
        for content in response.content:
            if hasattr(content, 'text'):
                return self._parse_json_response(content.text)
        
        raise Exception("生成失败")
    
    def _parse_json_response(self, text: str) -> Dict:
        """解析 JSON 响应"""
        import json
        import re
        
        # 尝试从 markdown 代码块中提取
        json_match = re.search(r'```json\s*([\s\S]*?)\s*```', text)
        if json_match:
            return json.loads(json_match.group(1))
        
        # 尝试直接解析
        json_match = re.search(r'\{[\s\S]*\}', text)
        if json_match:
            return json.loads(json_match.group(0))
        
        raise Exception("无法解析 JSON 响应")
```

### 3.5 数据库设计

#### 3.5.1 新增表（使用 luchu_ 前缀避免冲突）

```sql
-- ============================================================
-- 露出功能数据库 Schema（在现有 google_analysis.db 中新增）
-- 表名统一使用 luchu_ 前缀
-- ============================================================

-- 1. 露出网站配置表
CREATE TABLE luchu_websites (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  domain TEXT NOT NULL,
  owner_id INTEGER REFERENCES users(id),
  github_repo TEXT NOT NULL,
  data_path TEXT DEFAULT 'js/articles',
  has_products BOOLEAN DEFAULT TRUE,
  site_url TEXT,
  is_active BOOLEAN DEFAULT TRUE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 2. 露出文章表
CREATE TABLE luchu_articles (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  website_id INTEGER REFERENCES luchu_websites(id),
  author_id INTEGER REFERENCES users(id),
  
  title TEXT NOT NULL,
  slug TEXT,
  category TEXT,
  category_name TEXT,
  excerpt TEXT,
  content TEXT,
  
  images TEXT,      -- JSON: {"hero":{...}, "content":[...]}
  products TEXT,    -- JSON数组
  
  merchant_url TEXT,
  tracking_link TEXT,
  brand_name TEXT,
  brand_keyword TEXT,
  keyword_count INTEGER DEFAULT 10,
  
  status TEXT DEFAULT 'draft',  -- draft/pending/approved/rejected/ready/published
  
  publish_date DATE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  published_at DATETIME,
  
  version INTEGER DEFAULT 1
);

-- 3. 文章版本历史表
CREATE TABLE luchu_article_versions (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER REFERENCES luchu_articles(id),
  version_number INTEGER NOT NULL,
  title TEXT,
  content TEXT,
  images TEXT,
  products TEXT,
  changed_by INTEGER REFERENCES users(id),
  change_type TEXT,      -- create/edit/review_reject
  change_reason TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 4. 审核记录表
CREATE TABLE luchu_reviews (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER REFERENCES luchu_articles(id),
  reviewer_id INTEGER REFERENCES users(id),
  status TEXT NOT NULL,  -- approved/rejected
  comment TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 5. 发布日志表
CREATE TABLE luchu_publish_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER REFERENCES luchu_articles(id),
  website_id INTEGER REFERENCES luchu_websites(id),
  operator_id INTEGER REFERENCES users(id),
  commit_sha TEXT,
  file_path TEXT,
  status TEXT,           -- success/failed
  error_message TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 6. 图片检测记录表
CREATE TABLE luchu_image_checks (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER REFERENCES luchu_articles(id),
  image_type TEXT NOT NULL,  -- hero/content_1/content_2/content_3/content_4
  url TEXT NOT NULL,
  local_path TEXT,
  status TEXT DEFAULT 'unchecked',  -- valid/invalid/local/unchecked
  http_status INTEGER,
  last_check DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 7. 图片告警表
CREATE TABLE luchu_image_alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id INTEGER REFERENCES luchu_articles(id),
  website_id INTEGER REFERENCES luchu_websites(id),
  user_id INTEGER REFERENCES users(id),
  image_type TEXT NOT NULL,
  url TEXT NOT NULL,
  alert_type TEXT NOT NULL,
  is_resolved BOOLEAN DEFAULT FALSE,
  resolved_at DATETIME,
  resolved_by INTEGER REFERENCES users(id),
  resolve_method TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 8. 提示词模板表
CREATE TABLE luchu_prompt_templates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  description TEXT,
  website_id INTEGER,
  category TEXT,
  has_products BOOLEAN DEFAULT TRUE,
  template_content TEXT NOT NULL,
  is_default BOOLEAN DEFAULT FALSE,
  created_by INTEGER REFERENCES users(id),
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 9. 平台通知表
CREATE TABLE luchu_notifications (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER REFERENCES users(id),
  type TEXT NOT NULL,
  title TEXT NOT NULL,
  content TEXT,
  related_type TEXT,
  related_id INTEGER,
  is_read BOOLEAN DEFAULT FALSE,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 10. 爬取缓存表
CREATE TABLE luchu_crawl_cache (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  url TEXT NOT NULL UNIQUE,
  url_hash TEXT NOT NULL,
  crawl_data TEXT,
  images TEXT,
  expires_at DATETIME,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 11. 操作日志表
CREATE TABLE luchu_operation_logs (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  user_id INTEGER REFERENCES users(id),
  action TEXT NOT NULL,
  resource_type TEXT NOT NULL,
  resource_id INTEGER,
  details TEXT,
  ip_address TEXT,
  created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 索引
CREATE INDEX idx_luchu_articles_status ON luchu_articles(status);
CREATE INDEX idx_luchu_articles_website ON luchu_articles(website_id);
CREATE INDEX idx_luchu_articles_author ON luchu_articles(author_id);
CREATE INDEX idx_luchu_image_alerts_resolved ON luchu_image_alerts(is_resolved);
CREATE INDEX idx_luchu_notifications_user ON luchu_notifications(user_id, is_read);
CREATE INDEX idx_luchu_crawl_cache_hash ON luchu_crawl_cache(url_hash);
```

---

## 四、API设计

### 4.1 API概览（使用 /api/luchu/ 前缀）

| 模块 | 端点 | 方法 | 描述 |
|------|------|------|------|
| **AI** | `/api/luchu/ai/analyze` | POST | 分析商家URL（Tool Use） |
| | `/api/luchu/ai/generate` | POST | 生成文章内容 |
| | `/api/luchu/ai/regenerate` | POST | 重新生成部分内容 |
| **文章** | `/api/luchu/articles` | GET | 文章列表 |
| | `/api/luchu/articles` | POST | 创建文章 |
| | `/api/luchu/articles/:id` | GET | 文章详情 |
| | `/api/luchu/articles/:id` | PUT | 更新文章 |
| | `/api/luchu/articles/:id` | DELETE | 删除文章 |
| | `/api/luchu/articles/:id/versions` | GET | 版本历史 |
| | `/api/luchu/articles/:id/versions/:v/restore` | POST | 恢复到某版本 |
| | `/api/luchu/articles/:id/preview` | GET | 生成预览HTML |
| **审核** | `/api/luchu/reviews` | GET | 待审核列表 |
| | `/api/luchu/reviews/:id/approve` | POST | 通过 |
| | `/api/luchu/reviews/:id/reject` | POST | 驳回 |
| | `/api/luchu/reviews/:id/self-check` | POST | 自检通过 |
| **发布** | `/api/luchu/publish/:id` | POST | 发布单篇 |
| | `/api/luchu/publish/batch` | POST | 批量发布 |
| | `/api/luchu/publish/logs` | GET | 发布日志 |
| **图片** | `/api/luchu/images/check` | POST | 手动检测 |
| | `/api/luchu/images/alerts` | GET | 告警列表 |
| | `/api/luchu/images/alerts/:id/resolve` | POST | 处理告警 |
| | `/api/luchu/images/download` | POST | 下载到本地 |
| **通知** | `/api/luchu/notifications` | GET | 通知列表 |
| | `/api/luchu/notifications/:id/read` | POST | 标记已读 |
| | `/api/luchu/notifications/read-all` | POST | 全部已读 |
| **提示词** | `/api/luchu/prompts` | GET | 模板列表 |
| | `/api/luchu/prompts` | POST | 创建模板 |
| | `/api/luchu/prompts/:id` | PUT | 更新模板 |
| | `/api/luchu/prompts/:id` | DELETE | 删除模板 |
| **网站** | `/api/luchu/websites` | GET | 网站列表 |
| | `/api/luchu/websites/:id` | PUT | 更新配置 |
| **日志** | `/api/luchu/logs` | GET | 操作日志（仅 wj02/wj07） |
| **统计** | `/api/luchu/stats/dashboard` | GET | 仪表盘数据 |

### 4.2 后端路由注册

在 `backend/app/main.py` 中添加：

```python
# 露出功能路由（新增）
from app.api import (
    luchu_articles,
    luchu_ai,
    luchu_reviews,
    luchu_publish,
    luchu_images,
    luchu_notifications,
    luchu_prompts,
    luchu_websites,
    luchu_logs,
    luchu_stats,
)

# ... 现有路由 ...

# 露出功能 API 路由
app.include_router(luchu_articles.router)
app.include_router(luchu_ai.router)
app.include_router(luchu_reviews.router)
app.include_router(luchu_publish.router)
app.include_router(luchu_images.router)
app.include_router(luchu_notifications.router)
app.include_router(luchu_prompts.router)
app.include_router(luchu_websites.router)
app.include_router(luchu_logs.router)
app.include_router(luchu_stats.router)
```

---

## 五、文件结构

### 5.1 后端新增文件

```
backend/
├── app/
│   ├── api/
│   │   ├── luchu_articles.py      # 文章 CRUD
│   │   ├── luchu_ai.py            # AI 分析和生成
│   │   ├── luchu_reviews.py       # 审核管理
│   │   ├── luchu_publish.py       # 发布推送
│   │   ├── luchu_images.py        # 图片检测
│   │   ├── luchu_notifications.py # 通知管理
│   │   ├── luchu_prompts.py       # 提示词模板
│   │   ├── luchu_websites.py      # 网站配置
│   │   ├── luchu_logs.py          # 操作日志
│   │   └── luchu_stats.py         # 统计数据
│   │
│   ├── models/
│   │   └── luchu.py               # 所有露出相关模型
│   │
│   ├── schemas/
│   │   └── luchu.py               # Pydantic 验证模型
│   │
│   └── services/
│       ├── claude_service.py      # Claude API 服务
│       ├── github_service.py      # GitHub API 服务
│       └── luchu_image_checker.py # 图片检测服务
```

### 5.2 前端新增文件

```
frontend/
├── src/
│   ├── pages/
│   │   ├── LuchuDashboard.jsx     # 露出概览
│   │   ├── LuchuCreate.jsx        # 创建内容（核心页面）
│   │   ├── LuchuArticles.jsx      # 我的文章
│   │   ├── LuchuEdit.jsx          # 编辑文章
│   │   ├── LuchuPreview.jsx       # 真实预览
│   │   ├── LuchuReviews.jsx       # 审核管理
│   │   ├── LuchuPublish.jsx       # 发布管理
│   │   ├── LuchuImages.jsx        # 图片管理
│   │   ├── LuchuWebsites.jsx      # 网站配置
│   │   ├── LuchuPrompts.jsx       # 提示词管理
│   │   └── LuchuLogs.jsx          # 操作日志
│   │
│   ├── services/
│   │   └── luchuApi.js            # 露出功能 API 封装
│   │
│   └── store/
│       └── luchuStore.js          # 露出功能状态管理
```

---

## 六、开发计划

### 6.1 里程碑（7周）

| 阶段 | 内容 | 时间 | 交付物 |
|------|------|------|--------|
| **M0** | 网站迁移 | 第1周 | 9个网站迁移完成 |
| **M1** | 基础框架 | 第2周 | 数据库表 + API骨架 + 前端页面框架 |
| **M2** | AI核心功能 | 第3周 | Claude Tool Use + 自动爬取 + 内容生成 |
| **M3** | 内容管理 | 第4周 | 文章CRUD + 版本历史 + 预览 |
| **M4** | 审核发布 | 第5周 | 审核流程 + 自检模式 + GitHub推送 |
| **M5** | 图片+通知 | 第6周 | 图片检测 + 告警 + 仪表盘通知 |
| **M6** | 优化测试 | 第7周 | Bug修复 + 性能优化 + 用户测试 |

### 6.2 详细排期

#### M1 基础框架（第2周）
| 任务 | 天数 |
|------|------|
| 数据库迁移脚本（新增露出表） | 0.5 |
| 后端 API 骨架（10个路由模块） | 1 |
| 前端页面框架（11个页面） | 1 |
| 侧边栏菜单集成 | 0.5 |
| 网站配置管理 | 1 |
| 提示词模板管理 | 1 |

#### M2 AI核心功能（第3周）
| 任务 | 天数 |
|------|------|
| Claude API 集成 + Tool Use | 1.5 |
| 网页爬取逻辑 (fetch_webpage) | 1 |
| 图片智能筛选算法 | 1 |
| 内容生成逻辑 | 1 |
| 创建内容页面（步骤1-2） | 0.5 |

#### M3 内容管理（第4周）
| 任务 | 天数 |
|------|------|
| 创建内容页面（步骤3-4） | 1 |
| 文章列表页面 | 1 |
| 文章编辑页面 | 1 |
| 版本历史 + 版本恢复功能 | 1 |
| 真实预览功能（使用目标网站样式） | 1 |

#### M4 审核发布（第5周）
| 任务 | 天数 |
|------|------|
| 审核列表页面 | 1 |
| 审核操作（通过/驳回/自检） | 1 |
| GitHub API 集成 | 1 |
| 发布功能实现 | 1 |
| 发布日志 | 1 |

#### M5 图片+通知+日志（第6周）
| 任务 | 天数 |
|------|------|
| 图片检测定时任务 | 1 |
| 图片告警系统 | 1 |
| 平台通知系统（仪表盘） | 1 |
| 操作日志审计系统 | 1 |
| 图片管理页面 + 仪表盘统计 | 1 |

#### M6 优化测试（第7周）
| 任务 | 天数 |
|------|------|
| Bug修复 | 2 |
| 性能优化 | 1 |
| 用户测试 | 1 |
| 文档完善 + 部署 | 1 |

---

## 七、成本估算

### 7.1 月度成本

| 服务 | 单价 | 预估用量 | 月成本 |
|------|------|----------|--------|
| 阿里云服务器（现有） | 已有 | - | $0 |
| Claude API | $3-15/1M token | 无限制调用约100篇 | ~$30 |
| GitHub API | 免费 | - | $0 |
| **总计** | | | **~$30/月** |

---

## 八、待办事项

开发前需要确认：

| 事项 | 负责人 | 状态 | 说明 |
|------|--------|------|------|
| Claude API Key | 07 | ✅ 已提供 | 从哈基米读取 |
| GitHub PAT | 07 | ✅ 已提供 | 有所有仓库写权限 |
| 9个网站 GitHub 仓库地址 | 07 | ✅ 已提供 | 全部使用 starrats111 账号 |

---

## 九、风险与注意事项

### 9.1 与现有系统的兼容性

| 风险点 | 缓解措施 |
|--------|----------|
| 数据库表名冲突 | 所有新表使用 `luchu_` 前缀 |
| API 路由冲突 | 所有新路由使用 `/api/luchu/` 前缀 |
| 前端组件冲突 | 新页面使用 `Luchu` 前缀命名 |
| 定时任务冲突 | 复用现有 APScheduler，新增任务不影响现有任务 |

### 9.2 部署注意事项

1. **数据库迁移**：需要在服务器上执行 SQL 脚本创建新表
2. **依赖安装**：需要安装 `anthropic` Python 包
3. **环境变量**：需要在服务器上配置 `CLAUDE_API_KEY` 和 `GITHUB_TOKEN`
4. **重启服务**：代码部署后需要重启 uvicorn

---

**文档版本**: v3.0  
**更新日期**: 2026-02-13  
**维护人**: wj07

> 💡 如有问题或建议，请联系wj07。
