# 部署指令文档

## 本地推送代码到GitHub

### Windows PowerShell
```powershell
# 方法1: 使用脚本（推荐）
.\scripts\push_to_github.ps1 "修复CollabGlow API问题"

# 方法2: 自定义提交信息
.\scripts\push_to_github.ps1 "你的提交信息"

# 方法3: 使用默认提交信息（当前时间）
.\scripts\push_to_github.ps1
```

### Windows 批处理
```cmd
REM 方法1: 使用脚本
scripts\push_to_github.bat "修复CollabGlow API问题"

REM 方法2: 自定义提交信息
scripts\push_to_github.bat 你的提交信息
```

### 手动推送
```bash
git add .
git commit -m "你的提交信息"
git push origin main
```

## 阿里云服务器部署指令

### 完整部署指令（一次性复制粘贴）

```bash
cd ~/Google-Data-Analysis && git pull origin main && cd backend && source venv/bin/activate && pip install -q --upgrade pip && pip install -q -r requirements.txt && pkill -f 'uvicorn.*app.main' && sleep 2 && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 & sleep 3 && curl -s http://127.0.0.1:8000/health && echo "" && echo "✓ 部署完成" && tail -n 5 run.log
```

### 使用部署脚本（推荐）

```bash
# 方法1: 直接执行部署脚本
cd ~/Google-Data-Analysis/backend && bash scripts/deploy_backend.sh

# 方法2: 如果脚本没有执行权限
chmod +x ~/Google-Data-Analysis/backend/scripts/deploy_backend.sh
cd ~/Google-Data-Analysis/backend && bash scripts/deploy_backend.sh
```

### 分步执行（便于调试）

```bash
# 1. 进入项目目录
cd ~/Google-Data-Analysis

# 2. 拉取最新代码
git pull origin main

# 3. 进入后端目录
cd backend

# 4. 激活虚拟环境
source venv/bin/activate

# 5. 更新依赖（可选，如果需要）
pip install --upgrade pip
pip install -r requirements.txt

# 6. 停止现有服务器
pkill -f 'uvicorn.*app.main'
sleep 2

# 7. 启动服务器
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &

# 8. 等待启动
sleep 3

# 9. 检查状态
curl http://127.0.0.1:8000/health
```

## 常用操作指令

### 查看服务器状态
```bash
# 检查进程
ps aux | grep uvicorn

# 检查端口
netstat -tlnp | grep 8000
# 或
lsof -i:8000

# 检查健康状态
curl http://127.0.0.1:8000/health
```

### 查看日志
```bash
# 实时查看日志
tail -f ~/Google-Data-Analysis/backend/run.log

# 查看最近50行
tail -n 50 ~/Google-Data-Analysis/backend/run.log

# 查看错误日志
tail -n 100 ~/Google-Data-Analysis/backend/logs/error.log
```

### 重启服务器
```bash
# 快速重启
cd ~/Google-Data-Analysis/backend && bash scripts/restart_backend.sh

# 或手动重启
pkill -f 'uvicorn.*app.main'
sleep 2
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &
```

### 停止服务器
```bash
# 停止服务器
pkill -f 'uvicorn.*app.main'

# 或强制停止
pkill -9 -f 'uvicorn.*app.main'
```

## 首次部署（如果项目不存在）

```bash
# 1. 克隆项目
cd ~
git clone https://github.com/starrats111/Google-Data-Analysis.git

# 2. 进入后端目录
cd Google-Data-Analysis/backend

# 3. 创建虚拟环境
python3 -m venv venv

# 4. 激活虚拟环境
source venv/bin/activate

# 5. 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 6. 初始化数据库（如果需要）
python scripts/init_db.py
python scripts/init_users.py

# 7. 启动服务器
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &
```

## 故障排查

### 如果部署失败

1. **检查Git拉取是否成功**
   ```bash
   cd ~/Google-Data-Analysis
   git status
   git pull origin main
   ```

2. **检查虚拟环境**
   ```bash
   cd ~/Google-Data-Analysis/backend
   source venv/bin/activate
   python --version
   which python
   ```

3. **检查依赖安装**
   ```bash
   pip list | grep fastapi
   pip list | grep uvicorn
   ```

4. **检查端口占用**
   ```bash
   lsof -i:8000
   # 如果被占用，停止进程
   lsof -ti:8000 | xargs kill -9
   ```

5. **查看详细错误日志**
   ```bash
   tail -n 100 ~/Google-Data-Analysis/backend/run.log
   tail -n 100 ~/Google-Data-Analysis/backend/logs/error.log
   ```

## 自动化部署（可选）

可以设置GitHub Actions或使用cron定时拉取代码，但建议手动部署以确保稳定性。

