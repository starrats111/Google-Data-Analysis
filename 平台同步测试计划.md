# 平台同步测试计划

## 测试目标
确保所有平台的同步功能正常工作，数据能正确保存和查询。

## 支持的平台列表

根据代码分析，系统支持以下平台：

1. **CollabGlow (CG)** - ✅ 已修复
2. **Rewardoo (RW)** - ✅ 已修复
3. **LinkHaitao (LH)** - ✅ 已修复
4. **通用平台**：
   - **LB** - ✅ 已修复
   - **PM** - ✅ 已修复
   - **BSH** - ✅ 已修复
   - **CF** - ✅ 已修复

## 测试步骤

### 1. 前置准备

#### 1.1 检查服务器状态
```bash
# 检查服务器是否运行
ps aux | grep uvicorn | grep -v grep

# 如果未运行，启动服务器
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &
sleep 3
curl http://127.0.0.1:8000/health
```

#### 1.2 检查数据库连接
```bash
# 检查数据库文件是否存在
ls -lh ~/Google-Data-Analysis/backend/google_analysis.db
```

### 2. 测试每个平台

对每个平台执行以下测试：

#### 2.1 前端测试步骤

1. **登录系统**
   - 打开前端页面
   - 使用账号登录

2. **进入平台账号页面**
   - 点击左侧菜单"平台账号"
   - 查看所有已配置的平台账号

3. **测试同步功能**
   - 选择一个平台账号
   - 点击"同步数据"按钮
   - 在弹窗中：
     - 选择日期范围（建议：最近30天，例如：2026-01-02 ~ 2026-02-01）
     - 输入或确认API Token
     - 点击"开始同步"
   - 等待同步完成
   - 查看同步结果：
     - 同步记录数应该大于0
     - 状态应该显示"成功"

4. **验证数据查询**
   - 点击左侧菜单"平台每日数据"
   - 选择相同的日期范围
   - 选择对应的平台
   - 点击"查询"
   - 验证：
     - 应该能看到数据表格
     - 数据应该包含：订单数、GMV、佣金等信息
     - 统计数据应该正确显示

#### 2.2 后端日志验证

同步完成后，查看日志确认：

```bash
# 查看最近的同步日志
tail -n 200 ~/Google-Data-Analysis/backend/run.log | grep -i "同步\|已保存\|成功同步\|明细交易"

# 查看特定平台的日志（替换PLATFORM为平台代码，如cg、rw、lh等）
tail -n 200 ~/Google-Data-Analysis/backend/run.log | grep -i "PLATFORM同步\|PLATFORM.*已保存"
```

**预期日志内容：**
- `[XX同步] API返回 X 条数据`
- `[XX同步] 已保存 X/Y 条明细交易到AffiliateTransaction表`（X应该大于0）
- `[XX同步] 按日期聚合后共有 N 天的数据`（N应该大于0）
- `成功同步 N 条记录`（N应该大于0）
- 不应该出现错误信息

#### 2.3 数据库验证

```bash
cd ~/Google-Data-Analysis/backend
sqlite3 google_analysis.db

# 检查明细交易表
SELECT COUNT(*) as count, platform FROM affiliate_transactions GROUP BY platform;

# 检查平台数据表
SELECT COUNT(*) as count, platform FROM platform_data GROUP BY platform;

# 查看最近同步的数据（替换PLATFORM为平台代码）
SELECT date, orders, total_commission, approved_orders, rejected_orders 
FROM platform_data 
WHERE affiliate_account_id = (SELECT id FROM affiliate_accounts WHERE platform_code LIKE '%PLATFORM%' LIMIT 1)
ORDER BY date DESC 
LIMIT 10;

.exit
```

### 3. 平台特定测试

#### 3.1 CollabGlow (CG)
- ✅ 使用 `/transaction` API端点
- ✅ 正确解析camelCase字段
- ✅ 时间戳转换（秒/毫秒）
- ✅ 保存明细交易和聚合数据

**测试要点：**
- 确认使用 `/transaction` 而不是 `/transaction/v3`
- 确认能正确提取订单和佣金数据

#### 3.2 Rewardoo (RW)
- ✅ 从 `data.transactions` 提取数据
- ✅ 日期解析支持多种格式
- ✅ 唯一约束错误处理
- ✅ 保存明细交易和聚合数据

**测试要点：**
- 确认能正确提取交易数据
- 确认不会出现唯一约束错误

#### 3.3 LinkHaitao (LH)
- ✅ 使用 Order Report API (`cashback2`)
- ✅ 从 `data.list` 提取数据
- ✅ 时间戳转换为日期
- ✅ 使用UnifiedPlatformService统一处理
- ✅ 保存明细交易和聚合数据

**测试要点：**
- 确认使用正确的API端点
- 确认能正确提取订单和佣金数据
- 确认数据能正确保存到PlatformData表

#### 3.4 通用平台 (LB/PM/BSH/CF)
- ✅ 日期解析支持多种格式
- ✅ 保存明细交易和聚合数据
- ✅ 使用UnifiedPlatformService统一处理

**测试要点：**
- 确认API配置正确（base_url和token）
- 确认能正确提取和保存数据

### 4. 常见问题排查

#### 4.1 同步返回0条记录

**可能原因：**
1. Token不正确或过期
2. 日期范围内没有数据
3. API端点配置错误
4. API响应格式不匹配

**排查步骤：**
```bash
# 查看详细日志
tail -n 300 ~/Google-Data-Analysis/backend/run.log | grep -A 10 -B 10 "XX同步"

# 检查API响应
tail -n 300 ~/Google-Data-Analysis/backend/run.log | grep -i "API.*响应\|API.*返回"
```

#### 4.2 数据保存失败

**可能原因：**
1. 数据库字段不匹配
2. 日期格式解析失败
3. 唯一约束冲突

**排查步骤：**
```bash
# 查看错误日志
tail -n 300 ~/Google-Data-Analysis/backend/run.log | grep -i "错误\|失败\|Exception\|Error"

# 检查数据库结构
sqlite3 google_analysis.db ".schema platform_data"
sqlite3 google_analysis.db ".schema affiliate_transactions"
```

#### 4.3 查询不到数据

**可能原因：**
1. 数据未正确保存到PlatformData表
2. 日期范围不匹配
3. 平台代码不匹配

**排查步骤：**
```bash
# 检查数据是否保存
sqlite3 google_analysis.db "SELECT COUNT(*) FROM platform_data WHERE date >= '2026-01-02' AND date <= '2026-02-01';"

# 检查明细交易
sqlite3 google_analysis.db "SELECT COUNT(*) FROM affiliate_transactions WHERE transaction_time >= '2026-01-02' AND transaction_time <= '2026-02-01';"
```

### 5. 测试检查清单

- [ ] CollabGlow (CG) 同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

- [ ] Rewardoo (RW) 同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

- [ ] LinkHaitao (LH) 同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

- [ ] LB 平台同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

- [ ] PM 平台同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

- [ ] BSH 平台同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

- [ ] CF 平台同步测试
  - [ ] 同步成功，记录数 > 0
  - [ ] 明细交易已保存
  - [ ] 平台数据已保存
  - [ ] 前端能查询到数据

### 6. 测试报告模板

```
## 平台同步测试报告

**测试日期：** YYYY-MM-DD
**测试人员：** XXX

### 测试结果汇总

| 平台 | 同步状态 | 记录数 | 明细交易 | 平台数据 | 前端查询 | 备注 |
|------|---------|--------|----------|----------|----------|------|
| CG   | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |
| RW   | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |
| LH   | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |
| LB   | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |
| PM   | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |
| BSH  | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |
| CF   | ✅/❌   | X      | ✅/❌    | ✅/❌    | ✅/❌    |      |

### 问题记录

1. [问题描述]
   - 平台：XXX
   - 现象：XXX
   - 日志：XXX
   - 状态：已解决/待解决

### 总结

[测试总结]
```

## 注意事项

1. **测试环境**
   - 确保在测试环境或非生产环境进行测试
   - 测试数据不会影响生产数据

2. **日期范围**
   - 建议使用最近30天的数据范围
   - 确保该日期范围内有实际数据

3. **Token安全**
   - 不要在日志中暴露完整的Token
   - 测试完成后及时清理敏感信息

4. **性能考虑**
   - 大量数据同步可能需要较长时间
   - 注意观察服务器资源使用情况

## 联系支持

如果测试过程中遇到问题，请提供：
1. 平台名称和代码
2. 完整的错误日志
3. 同步时的日期范围
4. 前端截图（如果有）

