# 后端部署指令

## 快速部署（推荐）

在服务器上执行以下命令，一键完成部署：

```bash
cd ~/Google-Data-Analysis && git pull origin main && cd backend && source venv/bin/activate && pip install -q --upgrade pip && pip install -q -r requirements.txt && pkill -f 'uvicorn.*app.main' && sleep 2 && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 & sleep 3 && curl -s http://127.0.0.1:8000/health && echo "" && echo "✓ 后端部署完成" && tail -n 5 run.log
```

## 分步部署

如果需要分步执行，可以按以下步骤：

### 1. 进入项目目录
```bash
cd ~/Google-Data-Analysis
```

### 2. 拉取最新代码
```bash
git pull origin main
```

### 3. 进入后端目录
```bash
cd backend
```

### 4. 激活虚拟环境
```bash
source venv/bin/activate
```

### 5. 更新依赖（可选，如果有新依赖）
```bash
pip install -q --upgrade pip
pip install -q -r requirements.txt
```

### 6. 停止现有服务器
```bash
pkill -f 'uvicorn.*app.main'
sleep 2
```

### 7. 启动服务器
```bash
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &
sleep 3
```

### 8. 验证服务器状态
```bash
curl http://127.0.0.1:8000/health
```

### 9. 查看启动日志
```bash
tail -n 20 run.log
```

## 使用部署脚本（推荐）

如果服务器上有部署脚本，可以使用：

```bash
cd ~/Google-Data-Analysis/backend
bash scripts/deploy_backend.sh
```

## 检查服务器状态

### 检查进程
```bash
ps aux | grep uvicorn | grep -v grep
```

### 检查端口
```bash
netstat -tlnp | grep 8000
# 或
lsof -i :8000
```

### 检查健康状态
```bash
curl http://127.0.0.1:8000/health
```

### 查看日志
```bash
# 查看最新日志
tail -n 100 ~/Google-Data-Analysis/backend/run.log

# 实时查看日志
tail -f ~/Google-Data-Analysis/backend/run.log

# 查看错误日志
tail -n 200 ~/Google-Data-Analysis/backend/run.log | grep -i "error\|exception\|失败"
```

## 常见问题

### 1. 端口被占用

如果8000端口被占用，可以：

```bash
# 查找占用端口的进程
lsof -i :8000

# 或使用netstat
netstat -tlnp | grep 8000

# 停止占用端口的进程
pkill -f 'uvicorn.*app.main'
```

### 2. 服务器启动失败

检查日志：
```bash
tail -n 50 ~/Google-Data-Analysis/backend/run.log
```

常见原因：
- 依赖未安装：运行 `pip install -r requirements.txt`
- 数据库文件权限问题：检查 `google_analysis.db` 文件权限
- 端口被占用：参考上面的解决方案

### 3. 代码更新后未生效

确保：
1. 已执行 `git pull origin main`
2. 已重启服务器（`pkill` + `nohup uvicorn`）
3. 检查进程ID是否变化：`ps aux | grep uvicorn`

### 4. 虚拟环境问题

如果虚拟环境不存在或有问题：

```bash
cd ~/Google-Data-Analysis/backend
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt
```

## 完整部署流程示例

```bash
# 1. 进入项目目录
cd ~/Google-Data-Analysis

# 2. 拉取最新代码
git pull origin main

# 3. 进入后端目录并激活虚拟环境
cd backend
source venv/bin/activate

# 4. 更新依赖（如果有新依赖）
pip install -q --upgrade pip
pip install -q -r requirements.txt

# 5. 停止现有服务器
pkill -f 'uvicorn.*app.main' || echo "没有运行中的服务器"
sleep 2

# 6. 启动服务器
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &

# 7. 等待启动
sleep 3

# 8. 检查服务器状态
if curl -s http://127.0.0.1:8000/health > /dev/null; then
    echo "✓ 后端服务器启动成功"
    echo "进程ID: $(pgrep -f 'uvicorn app.main:app')"
    echo "最近5行日志:"
    tail -n 5 run.log
else
    echo "✗ 后端服务器启动失败，查看日志："
    tail -n 20 run.log
fi
```

## 注意事项

1. **备份数据**：部署前建议备份数据库文件
   ```bash
   cp ~/Google-Data-Analysis/backend/google_analysis.db ~/Google-Data-Analysis/backend/google_analysis.db.backup
   ```

2. **检查磁盘空间**：确保有足够的磁盘空间
   ```bash
   df -h
   ```

3. **检查内存**：确保有足够的内存
   ```bash
   free -h
   ```

4. **日志文件**：定期清理日志文件，避免占用过多空间
   ```bash
   # 查看日志文件大小
   ls -lh ~/Google-Data-Analysis/backend/run.log
   
   # 如果日志文件过大，可以清空或归档
   # > ~/Google-Data-Analysis/backend/run.log  # 清空日志（谨慎使用）
   ```

## 快速参考

```bash
# 一键部署
cd ~/Google-Data-Analysis && git pull origin main && cd backend && source venv/bin/activate && pkill -f 'uvicorn.*app.main' && sleep 2 && nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 & sleep 3 && curl -s http://127.0.0.1:8000/health && echo "" && echo "✓ 后端部署完成"

# 查看日志
tail -n 100 ~/Google-Data-Analysis/backend/run.log

# 检查状态
ps aux | grep uvicorn | grep -v grep
curl http://127.0.0.1:8000/health
```

