# 设计方案 v7.2+ 增量审核报告（IS Budget/Rank 丢失修复）

> **审核人员**: AI 审核专员  
> **验收人员**: 07  
> **审核对象**: 设计方案新增章节"IS Budget丢失 / IS Rank丢失 数据不一致修复"（第 1311-1421 行，+113 行）  
> **审核日期**: 2026-02-26  
> **审核结论**: ✅ **通过——方案准确、代码引用正确、影响范围可控，可直接动手改**

---

## 一、交叉验证结果

### 1.1 代码引用准确性

| 方案描述 | 实际代码 | 验证 |
|---------|---------|------|
| "第 117-123 行使用 `max()` 取最大值" | 第 117-124 行确认 `is_budget_lost` 和 `is_rank_lost` 均使用 `max()` | ✅ 准确 |
| "campaigns_data 初始化中 `is_budget_lost: 0`" | 第 103-104 行确认初始值为 0 | ✅ 准确 |
| "仅修改 `api_only_analysis_service.py` 一个文件" | 全局搜索确认 IS 聚合逻辑仅在此文件 | ✅ 准确 |
| "前端无需改动（字段名不变）" | 第 251-252 行输出字段名为 `"IS Budget丢失"` / `"IS Rank丢失"`，方案不改字段名 | ✅ 准确 |

### 1.2 根因分析验证

方案说"当前用 `max()` 取 7 天最大值"——代码确认无误。`max()` 会放大极端值，而 Google Ads 后台用展示次数加权平均，两者在展示次数波动大时差异显著。方案举例（bofrost 50.6% vs 21.5%）逻辑自洽。

### 1.3 方案 A 技术可行性

已验证循环体（第 86-124 行）中 `data.impressions` 字段可用（第 111 行已在累加 `total_impressions`），因此新增加权累加器可以直接复用 `data.impressions`，无需额外查询。

---

## 二、发现的问题（2 项轻微）

### 问题 1：加权累加器可复用已有的 `total_impressions`，无需新增 `is_impressions_total`

| 项目 | 详情 |
|------|------|
| **位置** | 方案第 1387 行：`"is_impressions_total": 0` |
| **现状** | 第 100 行已有 `"total_impressions": 0`，第 111 行已在累加 `data.impressions or 0` |
| **问题** | 方案新增了一个独立的 `is_impressions_total` 累加器，与已有的 `total_impressions` 功能完全重复 |
| **影响** | 不影响正确性，但增加了不必要的冗余字段 |
| **建议** | 直接复用 `total_impressions` 作为加权分母，不新增 `is_impressions_total`。最终计算改为 `campaign_data["is_budget_lost_weighted_sum"] / campaign_data["total_impressions"]` |

**但有一个例外需要考虑**：如果某天 `is_budget_lost` 为 `None`（API 未返回）而 `impressions` 有值，那么 `total_impressions` 包含了这天的展示次数，但加权分子中没有这天的贡献，会导致加权平均偏低。方案中用 `data.is_budget_lost or 0` 处理了 None→0 的情况，此时 `is_budget_lost * impressions = 0`，分子不受影响，但分母包含了这天的展示次数。

**结论**：如果 Google Ads API 对于有展示的天一定会返回 IS 值（不会是 None），则复用 `total_impressions` 没问题。如果可能返回 None，则保留独立的 `is_impressions_total` 更安全——**仅在 `is_budget_lost` 非 None 时才累加展示次数**。建议保留方案原设计，但将累加条件改为：

```python
if data.is_budget_lost is not None:
    campaigns_data[campaign_id]["is_budget_lost_weighted_sum"] += data.is_budget_lost * day_impressions
    campaigns_data[campaign_id]["is_impressions_total"] += day_impressions
```

这样 IS 为 None 的天完全不参与计算，更严谨。

### 问题 2：操作指令阈值判断的输入值语义变化

| 项目 | 详情 |
|------|------|
| **位置** | 方案第 1411 行："同步修改 `_generate_operation_instruction` 调用处" |
| **现状** | `_generate_operation_instruction` 中的阈值判断（第 388-411 行）使用 `is_budget_lost > 0.2`、`is_rank_lost > 0.15`、`is_budget_lost > 0.3` |
| **问题** | 修改前传入的是 7 天最大值，修改后传入的是 7 天加权平均值。加权平均值通常**小于**最大值，这意味着修改后触发"加预算"/"提CPC"操作指令的概率会**降低** |
| **影响** | 不是 bug，但会改变操作指令的触发行为。之前某些被建议"加预算"的广告系列，修改后可能不再触发该建议 |
| **建议** | 方案中已提到"操作指令的判断逻辑不变（阈值判断仍然有效，只是输入值更准确）"，这个描述是正确的。但 07 需要知道：**修改后操作指令会变得更保守**（因为加权平均 < 最大值）。如果这符合预期（更准确的数据 → 更准确的建议），则无需调整阈值。如果希望保持原有的触发灵敏度，可能需要适当降低阈值（如 0.2→0.15） |

---

## 三、审核结论

| 项目 | 结论 |
|------|------|
| 根因分析 | ✅ 准确，`max()` vs 加权平均的差异解释清晰 |
| 方案选择 | ✅ 方案 A（展示次数加权平均）是正确选择，与 Google 官方一致 |
| 代码引用 | ✅ 文件路径、行号、变量名全部验证正确 |
| 影响范围 | ✅ 仅改一个文件，前端无需动 |
| 伪代码质量 | ✅ 三步修改（初始化→累加→输出）逻辑清晰，可直接实施 |
| 问题 1 | ⚠️ 轻微：建议保留独立 `is_impressions_total`，但加条件判断 `is_budget_lost is not None` |
| 问题 2 | ⚠️ 轻微：操作指令会变更保守，07 确认是否符合预期即可 |
| **综合** | **✅ 通过，可以动手改** |

---

*方案准确，影响可控。两个轻微问题不阻塞实施——问题 1 是严谨性优化，问题 2 是行为变化提醒。确认后直接改。*
