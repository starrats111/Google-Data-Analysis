# 07专属部署指南 🎯

> 这是为07专门准备的超简单部署指南，直接复制粘贴命令就行！

---

## 📋 部署分3步

| 步骤 | 做什么 | 在哪里做 |
|------|--------|----------|
| **第1步** | 推送前端代码到GitHub | 本地电脑 |
| **第2步** | 更新后端代码 | 阿里云服务器 |
| **第3步** | 创建服务账号 | Google网站 |

---

## 🔹 第1步：推送前端到GitHub（本地电脑）

打开 PowerShell，复制粘贴以下命令：

```powershell
cd "D:\Google Analysis"
git add .
git commit -m "添加服务账号同步功能"
git push origin main
```

**如果报错说分支问题，试试这个：**
```powershell
git push origin master
```

✅ 推送成功后，Cloudflare会自动部署前端，等2-3分钟就好。

---

## 🔹 第2步：更新后端（阿里云服务器）

用远程连接工具连接到阿里云服务器，然后复制粘贴以下命令：

### 2.1 拉取最新代码
```bash
cd /www/wwwroot/google-data-analysis/backend
git pull origin main
```

**如果报错说分支问题，试试：**
```bash
git pull origin master
```

### 2.2 安装依赖（如果有新依赖）
```bash
source venv/bin/activate
pip install google-ads -q
```

### 2.3 运行数据库迁移
```bash
python -m scripts.migrate_mcc_service_account
```

### 2.4 重启后端服务
```bash
# 方式1：如果用 systemd
sudo systemctl restart google-analysis

# 方式2：如果用 supervisor
sudo supervisorctl restart google-analysis

# 方式3：如果用 pm2
pm2 restart google-analysis

# 方式4：如果都不是，手动重启
pkill -f "uvicorn app.main"
nohup python -m uvicorn app.main:app --host 0.0.0.0 --port 8000 > /dev/null 2>&1 &
```

---

## 🔹 第3步：创建服务账号（在Google网站操作）

### 3.1 创建服务账号

1. 打开 https://console.cloud.google.com
2. 左上角选择你的项目（如果没有就创建一个）
3. 搜索栏输入 **"Service Accounts"** 并点击
4. 点击 **"+ CREATE SERVICE ACCOUNT"**
5. 填写名称：`google-ads-sync`
6. 点击 **"CREATE AND CONTINUE"**
7. 跳过权限设置，直接点 **"DONE"**

### 3.2 下载密钥文件

1. 在服务账号列表中，点击刚创建的服务账号
2. 点击 **"KEYS"** 标签
3. 点击 **"ADD KEY"** → **"Create new key"**
4. 选择 **"JSON"**
5. 点击 **"CREATE"**
6. 文件会自动下载，记住这个文件！

### 3.3 在系统中上传密钥

1. 打开你的网站后台
2. 进入 **"MCC账号管理"** 页面
3. 点击右上角 **"配置服务账号"** 按钮
4. 用记事本打开刚下载的JSON文件
5. 全选复制（Ctrl+A, Ctrl+C）
6. 粘贴到网页的输入框里
7. 点击 **"保存"**

### 3.4 给MCC添加服务账号权限

**对每个MCC账号执行以下操作：**

1. 打开 https://ads.google.com
2. 切换到你要添加的MCC账号
3. 点击右上角 **⚙️ 工具与设置**
4. 点击 **"访问权限与安全"**
5. 点击 **"用户"**
6. 点击 **"+"** 添加用户
7. 邮箱填写你的服务账号邮箱（在JSON文件里的 `client_email` 字段）
   - 格式类似：`google-ads-sync@你的项目.iam.gserviceaccount.com`
8. 权限选择 **"只读"**
9. 点击 **"发送邀请"**

---

## 🔹 第4步：添加MCC账号并同步数据

### 4.1 批量添加MCC

1. 在网站后台，进入 **"MCC账号管理"**
2. 点击 **"批量导入"**
3. 按格式填写你的100个MCC：
   ```
   123-456-7890,MCC名称1
   234-567-8901,MCC名称2
   345-678-9012,MCC名称3
   ```
4. 点击确定

### 4.2 同步历史数据

1. 在MCC列表中，找到一个MCC
2. 点击 **🕐（历史数据）** 图标
3. 选择日期范围：2026-01-01 到 今天
4. 点击 **"开始同步"**

---

## ❓ 常见问题

### Q: 同步报错 "DEVELOPER_TOKEN_PROHIBITED"
**A:** 开发者令牌和GCP项目不匹配。确保：
- 服务账号在同一个GCP项目里
- 该项目和开发者令牌关联

### Q: 同步报错 "PERMISSION_DENIED"  
**A:** 服务账号没有权限。检查：
- 是否已在Google Ads中添加了服务账号为用户
- 权限是否正确

### Q: 数据没有同步
**A:** 检查：
- 服务账号JSON是否正确上传
- MCC账号是否是"激活"状态
- 查看后端日志：`tail -f /www/wwwroot/google-data-analysis/backend/logs/app.log`

---

## 🆘 如果还是不行

把以下信息发给我：
1. 报错截图
2. 后端日志（运行 `tail -100 /www/wwwroot/google-data-analysis/backend/logs/app.log`）

---

**祝07顺利！** 🎉

