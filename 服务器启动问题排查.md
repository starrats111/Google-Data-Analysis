# 服务器启动问题排查指南

## 问题现象

执行部署命令后，服务器启动失败（Exit 1），但日志信息不完整。

## 排查步骤

### 1. 查看详细错误日志

```bash
tail -n 100 ~/Google-Data-Analysis/backend/run.log
```

或者查看完整的日志：

```bash
cat ~/Google-Data-Analysis/backend/run.log
```

### 2. 使用诊断脚本

已创建诊断脚本，运行：

```bash
cd ~/Google-Data-Analysis
bash backend/scripts/diagnose_startup.sh
```

### 3. 手动检查常见问题

#### 检查端口占用

```bash
lsof -i :8000
# 如果端口被占用，强制释放：
lsof -ti:8000 | xargs kill -9
```

#### 检查Python环境

```bash
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
python --version
```

#### 检查依赖安装

```bash
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
pip install -r requirements.txt
```

#### 检查代码语法

```bash
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
python -m py_compile app/main.py
python -m py_compile app/api/affiliate.py
```

#### 尝试导入应用

```bash
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
python -c "from app.main import app; print('OK')"
```

### 4. 手动启动并查看实时输出

```bash
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
```

这样可以实时看到错误信息。

### 5. 检查常见错误

#### 导入错误
- 检查所有导入的模块是否已安装
- 检查导入路径是否正确

#### 语法错误
- 检查Python语法是否正确
- 检查缩进是否正确

#### 配置错误
- 检查 `.env` 文件是否存在
- 检查必要的环境变量是否配置

#### 数据库连接错误
- 检查数据库文件权限
- 检查数据库URL配置

## 快速修复命令

如果诊断出问题，可以尝试：

```bash
# 1. 停止所有相关进程
pkill -f 'uvicorn.*app.main'
sleep 2

# 2. 检查并释放端口
lsof -ti:8000 | xargs kill -9 2>/dev/null || true
sleep 1

# 3. 重新安装依赖
cd ~/Google-Data-Analysis/backend
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements.txt

# 4. 测试导入
python -c "from app.main import app; print('OK')"

# 5. 启动服务器
nohup uvicorn app.main:app --host 0.0.0.0 --port 8000 > run.log 2>&1 &
sleep 3

# 6. 检查状态
curl http://127.0.0.1:8000/health
tail -n 20 run.log
```

## 如果问题仍然存在

请提供以下信息：

1. **完整的错误日志**：
   ```bash
   cat ~/Google-Data-Analysis/backend/run.log
   ```

2. **诊断脚本输出**：
   ```bash
   bash backend/scripts/diagnose_startup.sh
   ```

3. **手动启动的输出**：
   ```bash
   cd ~/Google-Data-Analysis/backend
   source venv/bin/activate
   python -m uvicorn app.main:app --host 0.0.0.0 --port 8000
   ```

4. **Python版本**：
   ```bash
   python --version
   ```

5. **已安装的包**：
   ```bash
   pip list | grep -E "fastapi|uvicorn|sqlalchemy"
   ```

---

**下一步：** 请运行诊断脚本或查看日志文件，然后提供错误信息以便进一步排查。

