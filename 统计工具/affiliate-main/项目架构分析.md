# 联盟营销数据采集系统 - 项目架构分析

## 📋 项目概述

**项目名称**: 联盟营销数据采集系统 - 多用户SaaS版  
**技术栈**: Node.js + Express + SQLite + 原生JavaScript  
**主要功能**: 多用户SaaS系统，自动登录联盟平台（LinkHaitao等），采集订单数据并持久化

---

## 🏗️ 整体架构

### 架构模式
- **前后端分离**: 前端静态文件 + RESTful API
- **单页应用(SPA)**: 原生JavaScript实现路由切换
- **数据库驱动**: SQLite本地数据库
- **JWT认证**: Token-based身份验证

```
┌─────────────────┐
│   前端 (Public)  │  ← HTML + CSS + JavaScript
│  index-v2.html  │
│  app-v2.js      │
│  style-v2.css   │
└────────┬────────┘
         │ HTTP/HTTPS
         │ RESTful API
┌────────▼────────┐
│  后端 (Express)  │  ← server-v2.js
│  - 路由处理      │
│  - 业务逻辑      │
│  - 数据验证      │
└────────┬────────┘
         │
┌────────▼────────┐
│   数据库层       │  ← SQLite (data.db)
│  - Users        │
│  - Orders       │
│  - Accounts     │
└─────────────────┘
         │
┌────────▼────────┐
│   外部服务       │
│  - LinkHaitao   │  ← 联盟平台API
│  - Google Sheets│
│  - OCR (Python) │  ← 验证码识别
└─────────────────┘
```

---

## 📁 项目文件结构

### 核心后端文件

```
根目录/
├── server-v2.js          # 多用户版主服务器（当前使用）
├── server.js             # 单用户版服务器（旧版本）
├── db.js                 # 数据库初始化和连接
├── utils.js              # 工具函数（加密、JWT、签名）
├── migrate.js            # 数据库迁移管理工具
├── init-admin.js         # 初始化超级管理员脚本
└── ocr_solver.py         # Python验证码识别脚本
```

### 前端文件

```
public/
├── index-v2.html         # 多用户版主页面（当前使用）
├── app-v2.js            # 多用户版前端逻辑（当前使用）
├── style-v2.css         # 多用户版样式（当前使用）
│
├── index.html           # 单用户版主页面（旧版本）
├── app.js               # 单用户版前端逻辑（旧版本）
├── style.css            # 单用户版样式（旧版本）
│
├── admin.html           # 超级管理员页面
├── admin.js             # 管理员前端逻辑
└── admin.css            # 管理员样式
```

### 数据库相关

```
根目录/
├── data.db              # SQLite数据库文件（生产环境）
├── database.db          # 备用数据库文件
├── database-schema.sql  # PostgreSQL版本Schema（参考）
└── migrations/          # 数据库迁移脚本
    ├── 0001_baseline_schema.js
    ├── 0002_add_api_token_field.js
    ├── 0003_make_password_nullable.js
    ├── 0005_add_affiliate_name_to_orders.js
    ├── 0006_add_merchant_slug_to_google_ads_data.js
    ├── 0007_add_user_role.js
    └── 0008_create_audit_logs.js
```

### 配置文件

```
根目录/
├── package.json         # Node.js依赖和脚本
├── config.ini           # 配置文件
├── .env                 # 环境变量（需创建）
├── Dockerfile           # Docker容器配置
├── ecosystem.config.js  # PM2进程管理配置
├── railway.json         # Railway部署配置
└── nixpacks.toml        # Nixpacks构建配置
```

### 工具脚本

```
根目录/
├── scripts/
│   └── create-super-admin.js  # 创建超级管理员
│
├── test-*.js            # 各种测试脚本
├── check-*.js           # 各种检查脚本
├── fix-*.js             # 修复脚本
└── migrate-*.js         # 数据迁移脚本
```

---

## 🔧 后端架构详解

### 1. 服务器入口 (`server-v2.js`)

**主要功能**:
- Express服务器初始化
- 中间件配置（CORS、JSON解析、静态文件服务）
- 路由注册
- 数据库初始化

**核心中间件**:
- `authenticateToken`: JWT认证中间件
- `requireSuperAdmin`: 超级管理员权限验证
- `auditLog`: 审计日志记录

**API路由分类**:

#### 用户认证API
- `POST /api/auth/register` - 用户注册
- `POST /api/auth/login` - 用户登录
- `GET /api/auth/profile` - 获取用户信息

#### 平台账号管理API
- `GET /api/platform-accounts` - 获取账号列表
- `POST /api/platform-accounts` - 添加平台账号
- `PUT /api/platform-accounts/:id` - 更新平台账号
- `DELETE /api/platform-accounts/:id` - 删除平台账号

#### 数据采集API
- `POST /api/collect` - 启动数据采集任务
- `GET /api/orders` - 查询订单数据
- `POST /api/export/orders` - 导出订单数据（Excel）

#### Google Sheets集成API
- `GET /api/google-sheets` - 获取Google表格列表
- `POST /api/google-sheets` - 添加Google表格配置
- `POST /api/google-sheets/:id/sync` - 同步数据到Google表格

#### 超级管理员API
- `GET /api/admin/users` - 获取所有用户
- `PUT /api/admin/users/:id` - 修改用户信息
- `DELETE /api/admin/users/:id` - 删除用户
- `GET /api/admin/audit-logs` - 查看审计日志

#### 外部平台API（代理）
- `GET /api/captcha` - 获取验证码图片（LinkHaitao）
- `POST /api/platform/login` - 登录外部平台
- `POST /api/platform/fetch-orders` - 获取订单数据

### 2. 数据库层 (`db.js`)

**数据库类型**: SQLite (better-sqlite3)

**特点**:
- 零配置，单文件数据库
- 支持外键约束
- 集成Migration系统
- 自动初始化Schema

**数据库表结构**:

1. **users** - SaaS用户表
   - id, email, password_hash, username
   - created_at, updated_at, is_active
   - role (普通用户/super_admin)

2. **platform_accounts** - 平台账号配置表
   - id, user_id, platform, account_name
   - account_password (加密), is_active
   - created_at, updated_at

3. **platform_tokens** - 平台Token缓存表
   - id, platform_account_id, token
   - expire_time, created_at, updated_at

4. **orders** - 订单数据表
   - id, user_id, platform_account_id
   - order_id, merchant_id, merchant_name
   - order_amount, commission, status
   - order_date, confirm_date
   - raw_data (JSON), collected_at

5. **collection_jobs** - 采集任务记录表
   - id, user_id, platform_account_id
   - start_date, end_date, status
   - total_orders, total_amount, total_commission
   - error_message, started_at, completed_at

6. **google_sheets** - Google表格配置表
   - id, user_id, name, sheet_id
   - api_token (加密), worksheet_name
   - is_active, created_at, updated_at

7. **audit_logs** - 审计日志表
   - id, admin_id, admin_username
   - action, target_user_id, target_username
   - request_path, request_method, ip_address
   - execution_time, created_at

8. **db_schema_versions** - Migration版本追踪表
   - id, version, name, applied_at, checksum

### 3. 工具函数层 (`utils.js`)

**加密相关**:
- `encryptPassword()` - AES-256-CBC加密平台密码
- `decryptPassword()` - 解密平台密码
- `hashPassword()` - bcrypt加密用户密码
- `verifyPassword()` - 验证用户密码

**JWT相关**:
- `generateToken()` - 生成JWT Token（7天有效期）
- `verifyToken()` - 验证JWT Token

**外部平台相关**:
- `generateSign()` - 生成LinkHaitao平台签名

### 4. 迁移系统 (`migrate.js`)

**功能**:
- 版本化数据库Schema管理
- 自动检测和执行待运行的迁移
- 支持回滚（手动）
- 校验迁移文件完整性

**迁移文件命名规则**: `NNNN_description.js`

---

## 🎨 前端架构详解

### 1. 页面结构 (`index-v2.html`)

**单页应用(SPA)**，通过显示/隐藏实现路由切换：

1. **认证页面** (`#authSection`)
   - 登录表单
   - 注册表单
   - Tab切换

2. **主应用页面** (`#appSection`)
   - 平台账号管理模块
   - Google表格管理模块
   - 数据采集模块
   - 数据展示模块

3. **模态框**
   - 添加平台账号模态框
   - 添加Google表格模态框

### 2. 前端逻辑 (`app-v2.js`)

**核心变量**:
```javascript
let authToken = null;              // JWT Token
let currentUser = null;            // 当前用户信息
let platformAccounts = [];         // 平台账号列表
let selectedAccountIds = [];       // 选中的账号ID数组
let googleSheets = [];             // Google表格列表
```

**主要功能模块**:

1. **用户认证**
   - `handleLogin()` - 处理登录
   - `handleRegister()` - 处理注册
   - `logout()` - 登出
   - `loadUserProfile()` - 加载用户信息

2. **平台账号管理**
   - `loadPlatformAccounts()` - 加载账号列表
   - `handleAddAccount()` - 添加账号
   - `handleDeleteAccount()` - 删除账号
   - `selectAccount()` - 选择账号（多选支持）

3. **数据采集**
   - `handleCollect()` - 启动采集任务
   - `checkCollectionStatus()` - 轮询采集状态
   - `displayCollectionResults()` - 显示采集结果

4. **数据展示**
   - `loadOrders()` - 加载订单数据
   - `renderOrdersTable()` - 渲染订单表格
   - `exportOrders()` - 导出订单数据

5. **Google Sheets**
   - `loadGoogleSheets()` - 加载表格列表
   - `handleAddGoogleSheet()` - 添加表格配置
   - `syncToGoogleSheet()` - 同步数据到Google表格

6. **工具函数**
   - `showMessage()` - 显示消息提示
   - `formatDate()` - 日期格式化
   - `formatCurrency()` - 金额格式化

### 3. 样式设计 (`style-v2.css`)

**设计风格**:
- 现代化扁平设计
- 响应式布局
- 丰富的交互效果（hover、transition）
- 配色方案：蓝色主色调 + 灰色辅助

**核心组件样式**:
- `.container` - 主容器
- `.card` - 卡片组件
- `.btn-primary` / `.btn-secondary` - 按钮
- `.form-group` - 表单组
- `.modal` - 模态框
- `.table` - 表格
- `.status-message` - 状态消息

---

## 🔐 安全机制

### 1. 用户密码安全
- **加密方式**: bcrypt (10轮salt)
- **存储**: `users.password_hash`
- **验证**: 登录时比对hash

### 2. 平台账号密码安全
- **加密方式**: AES-256-CBC
- **密钥来源**: 环境变量 `ENCRYPTION_KEY`
- **存储**: `platform_accounts.account_password`
- **使用**: 登录外部平台时临时解密

### 3. JWT Token安全
- **密钥**: 环境变量 `JWT_SECRET`
- **有效期**: 7天
- **存储**: 前端 localStorage
- **传输**: Authorization Header (Bearer Token)

### 4. API安全
- **认证**: 所有API（除登录/注册）需要JWT Token
- **授权**: 超级管理员API需要额外权限验证
- **审计**: 管理员操作记录审计日志
- **CORS**: 配置允许的域名白名单

---

## 🔄 数据流程

### 数据采集流程

```
1. 用户选择账号和日期范围
   ↓
2. 前端调用 POST /api/collect
   ↓
3. 后端检查Token是否过期
   ↓
4. 如果过期 → 自动登录外部平台
   ├─ 获取验证码图片
   ├─ Python OCR识别验证码
   ├─ 提交登录请求
   └─ 保存新Token
   ↓
5. 调用外部平台API获取订单数据
   ↓
6. 解析数据并保存到数据库
   ├─ 检查订单是否已存在（去重）
   ├─ 插入新订单
   └─ 更新采集任务状态
   ↓
7. 返回采集结果给前端
   ↓
8. 前端轮询采集状态直到完成
   ↓
9. 显示采集结果和统计数据
```

### 用户认证流程

```
1. 用户输入邮箱/密码
   ↓
2. 前端调用 POST /api/auth/login
   ↓
3. 后端验证邮箱和密码（bcrypt比对）
   ↓
4. 生成JWT Token
   ↓
5. 返回Token和用户信息
   ↓
6. 前端保存Token到localStorage
   ↓
7. 后续请求携带Token (Authorization Header)
```

---

## 📊 技术栈总结

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Node.js | >=20.0.0 | 运行环境 |
| Express | ^5.1.0 | Web框架 |
| better-sqlite3 | ^12.4.1 | SQLite数据库驱动 |
| bcryptjs | ^3.0.2 | 密码加密 |
| jsonwebtoken | ^9.0.2 | JWT认证 |
| axios | ^1.12.2 | HTTP客户端 |
| exceljs | ^4.4.0 | Excel导出 |
| cors | ^2.8.5 | 跨域处理 |
| dotenv | ^17.2.3 | 环境变量管理 |

### 前端技术栈

| 技术 | 说明 |
|------|------|
| HTML5 | 页面结构 |
| CSS3 | 样式设计 |
| 原生JavaScript | 业务逻辑（无框架） |
| Fetch API | HTTP请求 |

### 外部服务

| 服务 | 用途 |
|------|------|
| LinkHaitao API | 联盟平台数据源 |
| Google Sheets API | 数据同步 |
| ddddocr (Python) | 验证码识别 |

---

## 🚀 部署架构

### 开发环境
- 本地Node.js服务器
- SQLite本地数据库文件
- 端口: 3000

### 生产环境（Railway）
- Node.js运行时
- SQLite数据库（持久化Volume）
- 环境变量配置
- HTTPS自动配置

### Docker支持
- `Dockerfile` 已配置
- 支持容器化部署

### PM2支持
- `ecosystem.config.js` 已配置
- 支持进程管理和自动重启

---

## 📝 版本管理

### 当前版本: v2.0 (多用户SaaS版)

**v2.0 特性**:
- ✅ 多用户注册/登录系统
- ✅ 平台账号配置管理
- ✅ 自动登录外部平台（OCR验证码识别）
- ✅ 订单数据持久化
- ✅ Google Sheets集成
- ✅ 数据导出功能
- ✅ 超级管理员系统
- ✅ 审计日志

### 旧版本: v1.0 (单用户版)

**保留文件**:
- `server.js`
- `public/index.html`
- `public/app.js`
- `public/style.css`

可通过 `npm run start:v1` 启动旧版本

---

## 🔍 关键设计决策

1. **为什么使用SQLite而不是PostgreSQL？**
   - 零配置，适合快速开发
   - 单文件数据库，易于备份
   - 性能足够满足中小规模需求
   - 支持迁移到PostgreSQL（Schema已准备）

2. **为什么前端不使用框架？**
   - 项目规模适中，原生JS足够
   - 减少依赖，部署简单
   - 加载速度快
   - 便于维护

3. **为什么使用JWT而不是Session？**
   - 无状态，易于扩展
   - 支持跨域
   - 适合RESTful API
   - 前端存储简单

4. **为什么使用Python做OCR？**
   - ddddocr识别率高（70-80%）
   - Node.js OCR库较少
   - 通过子进程调用，解耦设计

---

## 🐛 已知限制

1. **验证码识别率**: 约70-80%，可能需要多次重试
2. **数据库并发**: SQLite在高并发场景下性能有限
3. **Token管理**: Token过期自动重登录，但无主动刷新机制
4. **数据量**: 大量数据查询可能需要优化索引

---

## 🎯 未来改进方向

- [ ] 前端框架迁移（Vue/React）
- [ ] 数据库迁移到PostgreSQL
- [ ] Redis缓存层
- [ ] WebSocket实时更新
- [ ] 数据可视化图表
- [ ] 定时任务系统（自动采集）
- [ ] 邮件通知系统
- [ ] API限流和防刷

---

## 📞 项目维护

**关键文件修改时需要同步更新**:
- `server-v2.js` - API路由
- `db.js` - 数据库配置
- `migrations/` - Schema变更
- `.env` - 环境变量

**数据库迁移步骤**:
1. 创建新的迁移文件 `migrations/NNNN_description.js`
2. 在迁移文件中定义 `up()` 和 `down()` 函数
3. 重启服务器，自动执行迁移

---

*文档生成时间: 2025-01-27*
*项目版本: v2.0*

