# Google表格数据采集问题诊断报告

## 📋 当前代码期望的表格结构

### 列顺序（从第0列开始）：
```
列索引 | 列名                    | 用途                    | 数据库字段
-------|------------------------|-------------------------|------------------
0      | 广告系列名              | 必填字段                | campaign_name
1      | 目标投放国家            | (未使用，仅占位)        | -
2      | 最终到达网址            | (未使用，仅占位)        | -
3      | 广告系列预算            | 预算金额                | campaign_budget
4      | 广告系列预算所属货币    | 货币类型 (USD/CNY等)    | currency
5      | 广告系列类型            | (未使用，仅占位)        | -
6      | 出价策略                | (未使用，仅占位)        | -
7      | 日期                    | 必填字段 (YYYY-MM-DD)   | date
8      | 展示次数                | 展示数                  | impressions
9      | 点击次数                | 点击数                  | clicks
10     | 花费                    | 广告费用                | cost
```

**关键要求：**
- **最少需要11列**（从0到10）
- **数据从第3行开始**（A3单元格，跳过前2行表头）
- **必填字段：** 列0（广告系列名）和列7（日期）不能为空

---

## 🔍 数据采集失败的可能原因

### 1. **列结构变化（最可能）** ⚠️

如果Google表格**新增了两列**，可能导致以下问题：

#### 场景A：新增列在**前面**（最严重）
- **问题：** 所有列的索引都会错位
- **影响：** 所有数据都会读取错误
- **示例：** 如果在前插入2列，原来的"广告系列名"（索引0）会变成索引2

#### 场景B：新增列在**中间**
- **问题：** 部分列索引错位
- **影响：** 从插入位置开始的所有列都会错位
- **示例：** 如果在列3和列4之间插入，那么预算、货币、类型等列都会错位

#### 场景C：新增列在**末尾**（影响最小）
- **问题：** 如果总数≥11列，理论上仍可工作
- **影响：** 但需要确认列数是否足够

### 2. **数据验证失败**

代码中的验证逻辑：
```javascript
// 第3596行：检查列数
if (fields.length < 11) continue; // 如果少于11列，跳过该行

// 第3609行：检查必填字段
if (!date || !campaignName || campaignName.trim() === '') continue; // 如果日期或广告系列名为空，跳过
```

**可能导致失败的情况：**
- 某行数据少于11列 → 整行被跳过
- 广告系列名为空 → 整行被跳过
- 日期为空 → 整行被跳过
- 如果所有行都被跳过 → 采集结果：新增0条，更新0条，跳过所有行

### 3. **CSV解析问题**

代码使用简单的CSV解析：
```javascript
const fields = line.split(',').map(f => f.trim().replace(/^"|"$/g, ''));
```

**可能的问题：**
- 如果字段中包含逗号（如："商品, 名称"），会被错误分割
- 如果字段中包含引号，可能解析不正确
- 如果CSV格式不规范，可能导致列数计算错误

### 4. **网络/权限问题**

```javascript
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheet.sheet_id}/export?format=csv&gid=0`;
const response = await axios.get(csvUrl);
```

**可能的问题：**
- 表格未设置为"公开"或"任何人可查看" → 无法访问CSV导出URL
- 网络超时或连接失败 → axios请求失败
- 表格ID不正确 → 404错误

### 5. **数据行被全部跳过**

如果采集结果显示：
```
采集完成：新增 0 条，更新 0 条，跳过 X 条
```

**可能原因：**
- 所有行的列数 < 11
- 所有行的广告系列名或日期为空
- 所有行的日期都不是今天，且历史数据已存在

---

## 📊 数据库表结构

### `google_ads_data` 表字段：
```sql
- id (主键)
- user_id (用户ID)
- sheet_id (表格ID)
- date (日期) - 来自CSV列7
- campaign_name (广告系列名) - 来自CSV列0
- affiliate_name (联盟名称) - 从campaign_name提取
- merchant_id (商家ID) - 从campaign_name提取
- merchant_slug (商家标识符) - 从campaign_name提取
- campaign_budget (广告系列预算) - 来自CSV列3
- currency (货币) - 来自CSV列4
- impressions (展示次数) - 来自CSV列8
- clicks (点击次数) - 来自CSV列9
- cost (花费) - 来自CSV列10
- created_at (创建时间)
- updated_at (更新时间)
```

---

## 🔧 诊断步骤建议

### 1. **检查表格结构**
- [ ] 确认当前表格的实际列数和列名
- [ ] 确认新增的两列在哪个位置
- [ ] 确认列顺序是否与代码期望一致

### 2. **检查CSV导出**
- [ ] 手动访问CSV导出URL：`https://docs.google.com/spreadsheets/d/{sheet_id}/export?format=csv&gid=0`
- [ ] 检查CSV格式是否正确
- [ ] 检查第一行数据的列数（用Excel或文本编辑器打开CSV，数一下逗号分隔的字段数）

### 3. **检查服务器日志**
查看服务器控制台输出：
- [ ] 是否有 `📥 开始采集Google表格: {表格名}` 日志
- [ ] 是否有 `✅ 采集完成：新增 X 条...` 日志
- [ ] 是否有错误信息：`❌ 采集Google表格错误: ...`

### 4. **检查前端错误提示**
在前端界面点击"采集数据"后：
- [ ] 查看是否有错误提示信息
- [ ] 查看采集结果统计（新增、更新、跳过数量）

### 5. **测试数据行**
- [ ] 检查表格中是否有空行
- [ ] 检查是否有行的广告系列名为空
- [ ] 检查是否有行的日期为空或格式不正确
- [ ] 检查是否有行的列数少于11列

---

## 📝 需要确认的信息

为了准确诊断问题，需要以下信息：

1. **新增的两列信息：**
   - 列名是什么？
   - 插入在哪个位置？（第几列）
   - 这两列的数据是什么？

2. **错误信息：**
   - 采集时显示的具体错误信息是什么？
   - 是"采集失败"还是"跳过所有行"？
   - 服务器控制台有什么错误日志？

3. **表格当前结构：**
   - 当前表格总共有多少列？
   - 列的顺序是什么？（从A列开始）
   - 数据从第几行开始？

4. **采集结果：**
   - 采集完成后显示什么统计信息？
   - "新增"、"更新"、"跳过"的数量分别是多少？

---

## 🎯 可能的解决方案（待确认问题后）

根据问题类型，可能的解决方案包括：

1. **如果列位置变化：** 调整代码中的列索引映射
2. **如果列数不够：** 修改列数检查逻辑
3. **如果CSV解析问题：** 使用更强大的CSV解析库
4. **如果权限问题：** 检查表格分享设置
5. **如果数据格式问题：** 添加数据验证和清理逻辑

---

**报告生成时间：** 2025-11-04
**代码位置：** `server-v2.js` 第3529-3725行（Google表格采集API）
**前端位置：** `public/app-v2.js` 第1398-1447行（采集按钮和错误处理）

