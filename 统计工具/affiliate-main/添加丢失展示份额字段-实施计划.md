# 添加丢失展示份额字段 - 实施计划

## 📋 需求
在普通用户前端界面显示两个新字段：
1. **因预算而减少的展示份额** (Lost IS by Budget)
2. **因评级减少的展示份额** (Lost IS by Rank)

显示位置：
- ✅ **商家汇总**表格
- ✅ **广告系列按天详细数据**表格

---

## 🔧 需要修改的文件和位置

### 阶段1：数据库修改（必须先完成）

#### 1.1 创建数据库迁移文件
**文件：** `migrations/0010_add_lost_impression_share.js` (新建)

**内容：**
```javascript
// 添加丢失展示份额字段到 google_ads_data 表
ALTER TABLE google_ads_data 
ADD COLUMN lost_impression_share_budget REAL DEFAULT 0,  -- 因预算而减少的展示份额（小数形式，0-1之间）
ADD COLUMN lost_impression_share_rank REAL DEFAULT 0;    -- 因评级减少的展示份额（小数形式，0-1之间）
```

---

### 阶段2：后端修改

#### 2.1 修改CSV解析逻辑（2处）

**位置1：** `server-v2.js` 第3590-3637行（单个表格采集）

**修改内容：**
- 在 `fields` 解析后，添加读取列13和14的逻辑
- 在 `uniqueDataMap.set()` 中添加这两个字段
- 在 `insertStmt.run()` 和 `updateStmt.run()` 中添加这两个参数

**位置2：** `server-v2.js` 第6527-6575行（批量采集）

**修改内容：**
- 同样的修改，添加读取列13和14的逻辑
- 在 `insertStmt.run()` 和 `updateStmt.run()` 中添加这两个参数

#### 2.2 修改数据库INSERT/UPDATE语句（2处）

**位置1：** `server-v2.js` 第3574-3584行（单个表格采集）

**修改：**
```javascript
// 当前：
const insertStmt = db.prepare(`
  INSERT INTO google_ads_data
  (user_id, sheet_id, date, campaign_name, affiliate_name, merchant_id, merchant_slug, campaign_budget, currency, impressions, clicks, cost)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`);

// 修改为：
const insertStmt = db.prepare(`
  INSERT INTO google_ads_data
  (user_id, sheet_id, date, campaign_name, affiliate_name, merchant_id, merchant_slug, campaign_budget, currency, impressions, clicks, cost, lost_impression_share_budget, lost_impression_share_rank)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`);
```

**UPDATE语句也需要添加这两个字段。**

**位置2：** `server-v2.js` 第6514-6523行（批量采集）

**同样的修改。**

#### 2.3 修改商家汇总API

**位置：** `server-v2.js` 第1986-1995行（`/api/merchant-summary`）

**修改：**
在 `adsQuery` 的 SELECT 语句中添加：
```sql
AVG(lost_impression_share_budget) as avg_lost_is_budget,
AVG(lost_impression_share_rank) as avg_lost_is_rank
```

**注意：** 使用 `AVG()` 聚合函数，因为一个商家可能有多天的数据，需要计算平均值。

#### 2.4 修改广告系列按天详细数据API

**位置：** `server-v2.js` 第2173-2281行（`/api/campaign-daily-details`）

**修改1：** 在 `adsQuery` 的 SELECT 语句中添加：
```sql
AVG(lost_impression_share_budget) as lost_is_budget,
AVG(lost_impression_share_rank) as lost_is_rank
```

**修改2：** 在 `dailyMap.set()` 中添加这两个字段（第2219-2229行）

**修改3：** 在返回的 `dailyStats` 对象中添加这两个字段（第2267-2280行）

---

### 阶段3：前端修改

#### 3.1 修改商家汇总表格显示

**位置：** `public/app-v2.js` 第854-985行（`displayMerchantSummary` 函数）

**修改1：** 在表格头部添加两列（第919行附近）

**当前表头：**
```javascript
排名 | 广告系列 | 商家ID | 预算 | 展示 | 点击 | 广告费 | 订单数 | 佣金 | CR | EPC | CPC | ROI
```

**修改为：**
```javascript
排名 | 广告系列 | 商家ID | 预算 | 展示 | 点击 | 广告费 | 预算丢失展示份额 | 评级丢失展示份额 | 订单数 | 佣金 | CR | EPC | CPC | ROI
```

**修改2：** 在表格行数据中添加两列（第919-936行）

**修改3：** 更新 `colspan`（第864行和第958行）
- 从 `colspan="13"` 改为 `colspan="15"`

#### 3.2 修改广告系列按天详细数据表格显示

**位置：** `public/app-v2.js` 第1130-1203行（`renderDailyDetailsTable` 函数）

**修改1：** 在表格头部添加两列（第1156-1169行）

**当前表头：**
```javascript
日期 | 展示 | 点击 | 预算 | 广告费 | 订单数 | 佣金 | CR | EPC | CPC | ROI
```

**修改为：**
```javascript
日期 | 展示 | 点击 | 预算 | 广告费 | 预算丢失展示份额 | 评级丢失展示份额 | 订单数 | 佣金 | CR | EPC | CPC | ROI
```

**修改2：** 在表格行数据中添加两列（第1182-1194行）

---

## 📝 具体修改示例

### 示例1：商家汇总表格 - 添加列

**在 `displayMerchantSummary` 函数中：**

```javascript
// 在 row.innerHTML 中添加（第919行附近）：
// 在 "广告费" 列之后添加：
<td style="background: rgba(59, 130, 246, 0.1);">
  <span style="color: #fbbf24; font-size: 11px;">${((merchant.avg_lost_is_budget || 0) * 100).toFixed(2)}%</span>
</td>
<td style="background: rgba(59, 130, 246, 0.1);">
  <span style="color: #fbbf24; font-size: 11px;">${((merchant.avg_lost_is_rank || 0) * 100).toFixed(2)}%</span>
</td>
```

**说明：**
- `merchant.avg_lost_is_budget` 和 `merchant.avg_lost_is_rank` 是后端API返回的字段
- 乘以100转换为百分比显示
- 保留2位小数

### 示例2：按天详细数据表格 - 添加列

**在 `renderDailyDetailsTable` 函数中：**

```javascript
// 在表头添加（第1156-1169行）：
<th style="...">预算丢失展示份额</th>
<th style="...">评级丢失展示份额</th>

// 在表格行数据中添加（第1182-1194行）：
<td style="padding: 14px; text-align: right; color: #fbbf24; font-weight: 600; font-size: 12.5px; background: rgba(251, 191, 36, 0.1); font-family: 'Courier New', monospace; border-right: 1px solid rgba(59, 130, 246, 0.1);">
  ${((day.lost_is_budget || 0) * 100).toFixed(2)}%
</td>
<td style="padding: 14px; text-align: right; color: #fbbf24; font-weight: 600; font-size: 12.5px; background: rgba(251, 191, 36, 0.1); font-family: 'Courier New', monospace; border-right: 1px solid rgba(59, 130, 246, 0.1);">
  ${((day.lost_is_rank || 0) * 100).toFixed(2)}%
</td>
```

---

## 🎨 显示格式建议

### 显示格式
- **格式：** 百分比（如 `29.27%`）
- **小数位数：** 2位小数
- **颜色：** 建议使用黄色/橙色（`#fbbf24` 或 `#f59e0b`）突出显示
- **背景：** 浅色背景（`rgba(251, 191, 36, 0.1)`）

### 列位置
- **商家汇总：** 放在"广告费"列之后，"订单数"列之前
- **按天详细数据：** 放在"广告费"列之后，"订单数"列之前

---

## ⚠️ 注意事项

1. **向后兼容：**
   - 如果数据中没有这两个字段，使用默认值 `0`
   - 使用 `|| 0` 确保有默认值

2. **数据格式：**
   - 数据库存储：小数形式（0-1之间）
   - 前端显示：百分比形式（乘以100，保留2位小数）

3. **聚合方式：**
   - 商家汇总：使用 `AVG()` 计算平均值（因为一个商家可能有多天的数据）
   - 按天详细数据：使用 `AVG()` 计算平均值（如果同一天有多条记录）

4. **列数更新：**
   - 商家汇总表格：从13列改为15列
   - 按天详细数据表格：从11列改为13列

5. **表格宽度：**
   - 可能需要调整表格的 `min-width` 或使用横向滚动
   - 确保在移动设备上也能正常显示

---

## 📋 实施顺序

1. ✅ **阶段1：数据库迁移** - 添加字段到数据库
2. ✅ **阶段2：后端修改**
   - 修改CSV解析逻辑（2处）
   - 修改数据库INSERT/UPDATE语句（2处）
   - 修改商家汇总API
   - 修改广告系列按天详细数据API
3. ✅ **阶段3：前端修改**
   - 修改商家汇总表格显示
   - 修改广告系列按天详细数据表格显示
4. ✅ **测试**
   - 测试CSV采集是否正确读取新字段
   - 测试API是否返回新字段
   - 测试前端是否正确显示

---

**文档生成时间：** 2025-11-04  
**相关分析文档：** `添加丢失展示份额字段分析.md`

