# 添加"丢失展示份额"字段分析文档

## 📋 需求说明

需要在系统中显示Google表格中的两列新数据：
1. **因预算而减少的展示份额** (Lost IS by Budget)
2. **因评级减少的展示份额** (Lost IS by Rank)

这两列数据通常以百分比形式存储（例如：15.5% 或 0.155）。

---

## 🔍 当前系统分析

### 1. 当前Google表格列结构（代码期望）

**位置：** `server-v2.js` 第3598-3600行

```
列索引 | 列名                    | 用途                    | 数据库字段
-------|------------------------|-------------------------|------------------
0      | 广告系列名              | 必填                    | campaign_name
1      | 目标投放国家            | (未使用)                | -
2      | 最终到达网址            | (未使用)                | -
3      | 广告系列预算            | 预算金额                | campaign_budget
4      | 广告系列预算所属货币    | 货币类型                | currency
5      | 广告系列类型            | (未使用)                | -
6      | 出价策略                | (未使用)                | -
7      | 日期                    | 必填                    | date
8      | 展示次数                | 展示数                  | impressions
9      | 点击次数                | 点击数                  | clicks
10     | 花费                    | 广告费用                | cost
```

**当前要求：** 至少11列（索引0-10）

---

### 2. 新增列的实际位置（已确认）✅

**根据Google表格截图，实际列结构如下：**

```
列索引 | 列名（英文字母） | 列名（中文）              | 用途                    | 数据库字段
-------|----------------|-------------------------|-------------------------|------------------
0      | A             | 广告系列名              | 必填                    | campaign_name
1      | B             | 目标投放国家            | (未使用)                | -
2      | C             | 最终到达网址            | (未使用)                | -
3      | D             | 广告系列预算            | 预算金额                | campaign_budget
4      | E             | 广告系列预算所属货币    | 货币类型                | currency
5      | F             | 广告系列类型            | (未使用)                | -
6      | G             | 出价策略                | (未使用)                | -
7      | H             | 日期                    | 必填                    | date
8      | I             | 展示次数                | 展示数                  | impressions
9      | J             | 点击次数                | 点击数                  | clicks
10     | K             | 花费                    | 广告费用                | cost
11     | L             | 广告系列所属账          | (新增，未使用)          | - (跳过)
12     | M             | 广告系列所属账          | (新增，未使用)          | - (跳过)
13     | N             | 因预算而减少的展示份额  | **目标字段1**           | lost_impression_share_budget
14     | O             | 因评级减少的展示份额    | **目标字段2**           | lost_impression_share_rank
```

**重要发现：**
1. **实际新增了5列**（索引11-15），但我们需要关注的是最后2列（索引13、14）
2. **列11和12**（L列、M列）是"广告系列所属账"，**不需要存储**，解析时跳过即可
3. **目标字段位置：**
   - 列13 (N列) = 因预算而减少的展示份额
   - 列14 (O列) = 因评级减少的展示份额

**数据格式确认：**
- ✅ 已经是**小数形式**（0-1之间），例如：`0.2926829268` 表示 29.27%
- ✅ 不需要转换，直接使用 `parseFloat()` 即可
- ✅ 数据示例：
  - 因预算而减少的展示份额：`0`, `0.2926829268`, `0.60111023`, `0.000545107658`
  - 因评级减少的展示份额：`0`, `0.681988743`, `0.3735130849`, `0.9001`, `0.8023442518`

---

### 3. 数据库Schema修改

**当前表结构：** `google_ads_data` 表（`migrations/0001_baseline_schema.js`）

**需要添加的字段：**
```sql
ALTER TABLE google_ads_data 
ADD COLUMN lost_impression_share_budget REAL,  -- 因预算而减少的展示份额（小数形式，如0.155表示15.5%）
ADD COLUMN lost_impression_share_rank REAL;    -- 因评级减少的展示份额（小数形式，如0.102表示10.2%）
```

**字段类型选择：**
- `REAL` - 存储小数（推荐，因为百分比可以转换为小数）
- `TEXT` - 存储原始字符串（如 "15.5%"）

**建议：** 使用 `REAL` 类型，存储为小数形式（0-1之间），便于计算和比较。

---

### 4. CSV解析逻辑修改

**位置1：** `server-v2.js` 第3590-3607行（单个表格采集）

**当前代码：**
```javascript
const campaignName = fields[0] || '';
const date = fields[7] || '';
const budget = parseFloat(fields[3]) || 0;
const currency = fields[4] || '';
const impressions = parseInt(fields[8]) || 0;
const clicks = parseInt(fields[9]) || 0;
const cost = parseFloat(fields[10]) || 0;
```

**需要添加：**
```javascript
// 实际新增列在索引13和14（跳过索引11、12的"广告系列所属账"）
// 数据格式已经是小数形式（0-1之间），直接parseFloat即可
const lostISBudget = fields.length > 13 ? parseFloat(fields[13]) || 0 : 0;  // 列13：因预算而减少的展示份额
const lostISRank = fields.length > 14 ? parseFloat(fields[14]) || 0 : 0;    // 列14：因评级减少的展示份额
```

**数据格式处理：**
- ✅ 已经是小数形式，直接使用 `parseFloat()` 即可
- ✅ 使用条件判断 `fields.length > 13` 和 `fields.length > 14` 来确保向后兼容
- ✅ 如果列数不足，默认为 0（表示没有丢失展示份额）

**位置2：** `server-v2.js` 第6532-6538行（批量采集）

同样的修改需要应用到批量采集逻辑中。

---

### 5. 数据库插入/更新语句修改

**位置：** `server-v2.js` 第3574-3584行

**当前INSERT语句：**
```javascript
const insertStmt = db.prepare(`
  INSERT INTO google_ads_data
  (user_id, sheet_id, date, campaign_name, affiliate_name, merchant_id, merchant_slug, campaign_budget, currency, impressions, clicks, cost)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`);
```

**需要修改为：**
```javascript
const insertStmt = db.prepare(`
  INSERT INTO google_ads_data
  (user_id, sheet_id, date, campaign_name, affiliate_name, merchant_id, merchant_slug, campaign_budget, currency, impressions, clicks, cost, lost_impression_share_budget, lost_impression_share_rank)
  VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
`);
```

**UPDATE语句也需要添加这两个字段。**

---

### 6. API响应修改

**需要修改的API端点：**

1. **GET /api/google-ads-data** (`server-v2.js` 第3731行)
   - 查询时包含新字段
   - 返回数据中包含 `lost_impression_share_budget` 和 `lost_impression_share_rank`

2. **GET /api/merchant-summary** (`server-v2.js` 第1932行)
   - 商家汇总可能需要显示这些数据
   - 或者作为统计指标使用

3. **GET /api/user/:id/ads** (`server-v2.js` 第4483行)
   - 用户详情页的广告数据需要显示新字段

---

### 7. 前端显示位置

#### 位置1：用户详情页 - 广告数据标签 (`public/admin.js` 第836-849行)

**当前显示：**
```
日期 | 广告系列 | 预算 | 展示 | 点击 | 费用
```

**可以添加：**
```
日期 | 广告系列 | 预算 | 展示 | 点击 | 费用 | 预算丢失展示份额 | 评级丢失展示份额
```

#### 位置2：商家汇总 (`public/admin.js` 第982-1007行)

**当前显示：**
```
商家ID | 广告系列 | 预算 | 展示 | 点击 | 广告费 | 订单数 | 佣金 | ROI
```

**可以添加：**
- 在统计卡片中显示平均丢失展示份额
- 或者在表格中添加列

#### 位置3：广告系列按天详细数据 (`public/admin.js`)

**当前显示：**
```
日期 | 展示 | 点击 | 广告费 | 订单数 | 佣金
```

**可以添加：**
```
日期 | 展示 | 点击 | 广告费 | 预算丢失展示份额 | 评级丢失展示份额 | 订单数 | 佣金
```

---

### 8. 数据验证和列数检查

**当前检查：** `server-v2.js` 第3596行
```javascript
if (fields.length < 11) continue; // 数据不完整，至少需要11列
```

**需要修改为（向后兼容）：**
```javascript
// 最小要求：11列（核心字段，索引0-10）
// 如果列数 >= 15，读取两个丢失展示份额字段（索引13、14）
// 向后兼容：如果列数不足，丢失展示份额默认为0
const minRequiredColumns = 11;
if (fields.length < minRequiredColumns) continue;

// 跳过索引11、12（广告系列所属账），读取索引13、14
const lostISBudget = fields.length > 13 ? parseFloat(fields[13]) || 0 : 0;  // 列13
const lostISRank = fields.length > 14 ? parseFloat(fields[14]) || 0 : 0;    // 列14
```

**说明：**
- ✅ 保持最小要求11列不变，确保向后兼容
- ✅ 使用条件判断，如果列数不足，丢失展示份额默认为0
- ✅ 跳过索引11、12（"广告系列所属账"列），不存储到数据库

---

### 9. 数据迁移考虑

**需要处理：**
1. **现有数据：** 历史数据中这两个字段为 `NULL`
2. **向后兼容：** 如果表格没有这两列，字段应该为 `NULL` 或 `0`
3. **迁移脚本：** 不需要，因为新字段允许为 `NULL`

---

## 📝 实施步骤建议

### 步骤1：确认列位置和格式
1. 确认Google表格中这两列的实际位置（列索引）
2. 确认数据格式（百分比字符串还是小数）
3. 确认列名

### 步骤2：创建数据库迁移
1. 创建新的迁移文件（如 `0010_add_lost_impression_share.js`）
2. 添加两个新字段到 `google_ads_data` 表

### 步骤3：修改CSV解析逻辑
1. 修改 `server-v2.js` 中的单个表格采集逻辑
2. 修改批量采集逻辑
3. 添加数据格式转换（百分比 → 小数）

### 步骤4：修改数据库操作
1. 更新 INSERT 语句
2. 更新 UPDATE 语句
3. 更新 SELECT 语句（如果需要）

### 步骤5：修改API响应
1. 确保所有返回广告数据的API包含新字段
2. 测试API响应格式

### 步骤6：修改前端显示
1. 在广告数据表格中添加新列
2. 在商家汇总中添加相关统计（可选）
3. 添加数据格式化（小数 → 百分比显示）

### 步骤7：测试
1. 测试CSV解析是否正确读取新列
2. 测试数据存储是否正确
3. 测试前端显示是否正确
4. 测试向后兼容性（没有新列的旧数据）

---

## ⚠️ 需要注意的问题

1. **列索引确认：** 必须确认新增列的实际位置，否则会导致列索引错位
2. **数据格式：** Google表格可能导出百分比为 "15.5%" 字符串，需要转换为小数
3. **向后兼容：** 需要处理没有这两列的历史数据
4. **性能影响：** 添加字段对性能影响很小，但需要确保索引正确
5. **前端显示：** 需要考虑表格宽度，可能需要调整布局

---

## ✅ 已确认的信息

1. **列位置：** ✅ 已确认
   - 因预算而减少的展示份额：**列13 (N列)**
   - 因评级减少的展示份额：**列14 (O列)**
   - 列11、12（L列、M列）是"广告系列所属账"，不需要存储

2. **数据格式：** ✅ 已确认
   - 格式：**小数形式**（0-1之间）
   - 示例：`0.2926829268` 表示 29.27%
   - 处理方式：直接使用 `parseFloat()`，无需转换

3. **列名：** ✅ 已确认
   - 列13：**"因预算而减少的展示份额"**
   - 列14：**"因评级减少的展示份额"**

4. **数据范围：** ✅ 已确认
   - 值范围：0 到 1 之间（小数形式）
   - 0 表示没有丢失展示份额
   - 1 表示完全丢失展示份额（100%）

## 🔧 需要确认的信息

1. **显示位置：**
   - 希望在哪些页面显示这些数据？
     - 用户详情页的广告数据表格？
     - 商家汇总？
     - 广告系列按天详细数据？
   - 是否需要计算总丢失展示份额（预算 + 评级）？

2. **显示格式：**
   - 显示为小数（如 0.2927）还是百分比（如 29.27%）？
   - 是否需要格式化显示（保留2位小数）？

3. **数据验证：**
   - 是否需要验证数据范围（0-1）？
   - 是否需要处理异常值（如负数或大于1）？

---

**报告生成时间：** 2025-11-04  
**相关代码位置：**
- CSV解析：`server-v2.js` 第3590-3607行、第6532-6538行
- 数据库操作：`server-v2.js` 第3574-3584行、第6514-6523行
- 前端显示：`public/admin.js` 第836-849行、第982-1007行
- 数据库Schema：`migrations/0001_baseline_schema.js` 第117-136行

