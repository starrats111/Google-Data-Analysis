# Railway 部署 - 快速修复指南

## 🚨 问题：可提现金额显示 $0.00 且只显示部分账号

### 原因
1. 生产环境的订单数据缺少 `settlement_date` 和 `paid_date` 字段的值
2. API 只显示有提现记录或有可提现金额的账号（已修复）

### ✅ 解决方案（3步搞定）

#### 步骤 1：部署最新代码 ⭐
**重要**：必须先部署最新代码，包含以下修复：
- 修复了账号显示逻辑：现在会显示所有 PM 账号
- 添加了同步 API 和前端按钮
- 即使 API 失败也会显示账号

```bash
git add .
git commit -m "fix: 修复提现管理账号显示和同步功能"
git push
```

等待 Railway 自动部署完成（通常 1-2 分钟）。

#### 步骤 2：同步数据
部署完成后，登录超级管理员后台，点击 **"🔄 同步数据"** 按钮：

1. 访问：`https://your-domain/admin.html`
2. 登录超级管理员账号
3. 点击左侧"提现管理"
4. 点击顶部的 **"🔄 同步数据"** 按钮
5. 等待同步完成（可能需要 2-5 分钟）

**同步过程**：
- 系统会自动获取所有 PM 账号
- 调用 Transaction V3 API 获取每个账号的订单数据
- 更新数据库中的 settlement_date 和 paid_date
- 显示同步结果统计

#### 步骤 3：刷新页面
同步完成后：
- 点击浏览器刷新按钮（或按 F5）
- 或者点击"全部"按钮重新加载数据
- 应该能看到所有 PM 账号
- 可提现金额应该显示正确的数值

---

## 📊 预期结果

同步完成后，你应该看到：

### 顶部汇总卡片
- 💰 可提现金额：显示所有账号的可提现总额（不再是 $0.00）
- ⏳ 提现中金额：$0.00（如果没有正在处理的提现）
- 💵 已提现佣金：显示已支付的佣金总额（受日期筛选影响）

### 账号列表
**所有** PartnerMatic 账号都会显示，包括：
- 有可提现金额的账号
- 没有可提现金额但有提现记录的账号
- 新账号（还没有任何数据）

每个账号显示：
- 账号名称和用户信息
- 💰 可提现金额（基于数据库计算）
- ⏳ 提现中金额
- ✅ 已提现金额（基于 Payment Summary API，受日期筛选影响）

### 重要说明
- **可提现金额**：不受日期筛选影响，始终显示当前可提现的总额
- **已提现金额**：受日期筛选影响，只显示选定日期范围内的提现记录
- 如果某个账号的可提现金额是 $0.00，可能是：
  1. 该账号确实没有可提现的订单
  2. 所有 Approved 订单都已经支付
  3. 订单还未结算（没有 settlement_date）

---

## 🔍 如何验证同步是否成功

### 方法 1：查看同步结果
同步完成后会显示：
```
同步成功！
处理 X 条订单
更新 Y 条订单
```

### 方法 2：检查可提现金额
- 如果之前显示 $0.00，现在应该显示正确的金额
- 每个有 Approved 订单的账号都应该有可提现金额

### 方法 3：查看账号详情
点击任意账号卡片，展开查看：
- 应该能看到提现记录列表
- 记录包含：请求日期、支付日期、金额等信息

---

## ⚠️ 常见问题

### Q1：同步按钮点击后没反应？
**A**：检查浏览器控制台是否有错误信息，可能是：
- 网络问题
- API Token 过期
- 权限不足

### Q2：同步很慢？
**A**：这是正常的，因为需要：
- 调用每个账号的 Transaction V3 API
- 处理大量订单数据
- 更新数据库
- 通常需要 2-5 分钟，取决于账号数量和订单数量

### Q3：同步后还是显示 $0.00？
**A**：可能的原因：
1. 该账号确实没有可提现的订单
2. 所有 Approved 订单都已经支付（有 paid_date）
3. 订单没有 settlement_date（还未结算）

**解决**：点击"全部"按钮查看历史数据，或检查该账号的订单状态

### Q4：某些账号没有显示？
**A**：检查：
1. 该账号是否是 PartnerMatic 平台
2. 该账号是否有 API Token
3. 该账号是否有订单数据

---

## 🛠️ 备用方案：使用 Railway CLI

如果网页同步失败，可以使用 Railway CLI：

```bash
# 1. 安装 Railway CLI
npm install -g @railway/cli

# 2. 登录
railway login

# 3. 链接项目
railway link

# 4. 运行同步脚本
railway run node sync-all-pm-orders.js
```

---

## 📞 需要帮助？

如果以上步骤都无法解决问题，请提供：
1. 同步按钮点击后的提示信息
2. 浏览器控制台的错误信息（F12 打开）
3. 账号数量和订单数量
4. Railway 日志信息

---

**最后更新**：2026-01-26
**适用版本**：v1.3.0+
