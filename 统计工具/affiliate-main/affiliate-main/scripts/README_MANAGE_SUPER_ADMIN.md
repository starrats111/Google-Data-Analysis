# 超级管理员管理脚本使用指南

## 📋 功能说明

`manage-super-admin.js` 是一个交互式命令行工具，用于安全地管理超级管理员用户。

### 主要功能

1. **查看所有超级管理员** - 列出系统中所有超级管理员及其详细信息
2. **检查数据依赖** - 查看指定用户的所有相关数据（平台账号、订单、广告数据等）
3. **降级超级管理员** - 将超级管理员降级为普通用户（保留数据）
4. **删除用户** - 删除指定用户及其所有相关数据（级联删除）

## 🚀 使用方法

### 本地环境

```bash
# 在项目根目录执行
node scripts/manage-super-admin.js
```

### Railway 部署环境

```bash
# 1. 安装 Railway CLI（如果还没有）
npm i -g @railway/cli

# 2. 登录 Railway
railway login

# 3. 在项目目录下链接项目
railway link

# 4. 执行脚本
railway run node scripts/manage-super-admin.js
```

## 📖 操作流程

### 1. 查看所有超级管理员

选择菜单选项 `1`，系统会显示：
- 所有超级管理员的 ID、用户名、邮箱
- 账户状态（激活/禁用）
- 创建时间

### 2. 检查数据依赖

选择菜单选项 `2`，输入用户 ID，系统会显示：
- 平台账号数量
- 订单记录数量
- 广告数据数量
- 审计日志数量
- 邀请码数量

**重要提示**: 删除用户会级联删除以上所有相关数据！

### 3. 降级超级管理员

选择菜单选项 `3`，输入要降级的用户 ID：

**安全保护**:
- 如果这是最后一个超级管理员，系统会阻止降级
- 需要输入 `yes` 确认操作
- 降级后用户将失去超级管理员权限，但数据会保留

**适用场景**:
- 需要移除某个用户的超级管理员权限
- 但希望保留该用户的数据和普通用户权限

### 4. 删除用户

选择菜单选项 `4`，输入要删除的用户 ID：

**安全保护**:
- 如果这是最后一个超级管理员，系统会阻止删除
- 需要输入 `yes` 进行第一次确认
- 需要输入 `DELETE` 进行第二次确认（防止误操作）
- 显示所有将被删除的数据统计

**适用场景**:
- 完全移除某个用户及其所有数据
- 用户已降级为普通用户，现在要彻底删除

## ⚠️ 重要注意事项

### 1. 至少保留一个超级管理员

- 系统会检查是否还有其他超级管理员
- 如果是最后一个，会阻止降级/删除操作
- 必须先创建另一个超级管理员

### 2. 级联删除

删除用户会级联删除：
- ✅ 所有平台账号 (`platform_accounts`)
- ✅ 所有订单记录 (`orders`)
- ✅ 所有广告数据 (`google_ads_data`)
- ⚠️ 审计日志 (`audit_logs`) - 可能保留（取决于外键设置）

### 3. 数据备份

**强烈建议在操作前备份数据库**:

```bash
# Railway 环境
railway run cat /app/data/data.db > backup-$(date +%Y%m%d).db

# 本地环境
cp data.db backup-$(date +%Y%m%d).db
```

### 4. 日志记录

所有操作都会记录到日志文件：
- 日志文件位置: `scripts/super-admin-management.log`
- 包含时间戳、操作类型、详细信息
- 可用于审计和问题排查

## 📝 操作示例

### 示例 1: 降级超级管理员

```
🔐 超级管理员管理工具
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1. 查看所有超级管理员
2. 检查用户数据依赖
3. 降级超级管理员（降级为普通用户）
4. 删除用户（先降级再删除，或直接删除）
5. 退出
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

请选择操作 (1-5): 1

📋 查询所有超级管理员...

✅ 找到 2 个超级管理员:

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
ID      | 用户名          | 邮箱                    | 状态    | 创建时间
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
1       | admin           | admin@example.com       | ✅ 激活 | 2025-01-01 10:00:00
2       | superuser       | super@example.com       | ✅ 激活 | 2025-01-02 11:00:00
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

按回车键继续...

请选择操作 (1-5): 3
请输入要降级的用户 ID: 2

⬇️  准备降级用户 ID 2...

📋 用户信息:
   ID: 2
   用户名: superuser
   邮箱: super@example.com
   当前角色: super_admin
   状态: 激活

ℹ️  系统中还有 1 个其他超级管理员

⚠️  警告: 降级后该用户将失去超级管理员权限！
❓ 确认降级此用户? (输入 yes 确认): yes
✅ 用户 ID 2 已成功降级为普通用户
📝 操作记录: superuser (super@example.com) 从 super_admin 降级为 user
```

### 示例 2: 删除用户

```
请选择操作 (1-5): 4
请输入要删除的用户 ID: 2

🗑️  准备删除用户 ID 2...

📋 用户信息:
   ID: 2
   用户名: superuser
   邮箱: super@example.com
   角色: user
   状态: 激活

🔍 检查用户 ID 2 的数据依赖...

📊 数据依赖统计:
   平台账号: 3 个
   订单记录: 150 条
   广告数据: 500 条
   审计日志: 20 条
   邀请码: 5 个
   总计: 678 条相关数据

⚠️  警告: 删除此用户将级联删除以上所有相关数据！

⚠️  严重警告: 删除用户将永久删除该用户及其所有相关数据！
   包括: 平台账号、订单、广告数据等（级联删除）

❓ 确认删除此用户? (输入 yes 继续): yes
❓ 最后确认: 输入 DELETE 确认删除: DELETE
✅ 用户 ID 2 已成功删除
📝 删除记录: superuser (super@example.com)
   级联删除: 3 个平台账号, 150 条订单, 500 条广告数据
```

## 🔒 安全建议

1. **定期审查超级管理员列表** - 确保只有授权人员拥有超级管理员权限
2. **操作前备份数据库** - 防止误操作导致数据丢失
3. **使用日志审计** - 定期检查 `super-admin-management.log` 文件
4. **最小权限原则** - 只给必要的人员超级管理员权限
5. **及时清理** - 删除不再需要的用户账号

## 🐛 故障排查

### 问题 1: 数据库连接失败

**错误信息**: `数据库连接失败: ...`

**解决方案**:
- 检查数据库文件路径是否正确
- 确认数据库文件存在且有读取权限
- Railway 环境: 确认 Volume 已正确挂载到 `/app/data`

### 问题 2: 无法删除最后一个超级管理员

**错误信息**: `这是最后一个超级管理员，不能删除！`

**解决方案**:
- 先创建另一个超级管理员: `node scripts/create-super-admin.js`
- 然后再删除目标用户

### 问题 3: 外键约束错误

**错误信息**: `FOREIGN KEY constraint failed`

**解决方案**:
- 检查数据库外键约束设置
- 确认相关表的外键关系
- 可能需要手动清理某些关联数据

## 📞 获取帮助

如果遇到问题，请：
1. 查看日志文件: `scripts/super-admin-management.log`
2. 检查数据库结构是否正确
3. 确认所有依赖表都已创建

---

**最后更新**: 2025-11-07

