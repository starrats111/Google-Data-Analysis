<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æç°ç®¡ç† - è”ç›Ÿè¥é”€ç»Ÿè®¡ç³»ç»Ÿ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
      background: #0a0e27;
      color: #e0e0e0;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid #1e2139;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 600;
      color: #fff;
    }

    .header-actions {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #1e2139;
      color: #e0e0e0;
      border: 1px solid #2d3250;
    }

    .btn-secondary:hover {
      background: #2d3250;
    }

    /* æ¦‚è§ˆå¡ç‰‡ */
    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card {
      background: linear-gradient(135deg, #1e2139 0%, #252a48 100%);
      border-radius: 12px;
      padding: 24px;
      border: 1px solid #2d3250;
      transition: all 0.3s;
    }

    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.3);
    }

    .card-title {
      font-size: 14px;
      color: #8b92b0;
      margin-bottom: 12px;
      font-weight: 500;
    }

    .card-value {
      font-size: 32px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .card-value.green {
      color: #10b981;
    }

    .card-value.blue {
      color: #3b82f6;
    }

    .card-value.yellow {
      color: #f59e0b;
    }

    .card-subtitle {
      font-size: 12px;
      color: #6b7280;
    }

    /* ç­›é€‰æ  */
    .filters {
      background: #1e2139;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .filter-group label {
      font-size: 12px;
      color: #8b92b0;
      font-weight: 500;
    }

    .filter-group select,
    .filter-group input {
      padding: 8px 12px;
      background: #0a0e27;
      border: 1px solid #2d3250;
      border-radius: 6px;
      color: #e0e0e0;
      font-size: 14px;
      min-width: 150px;
    }

    .filter-group select:focus,
    .filter-group input:focus {
      outline: none;
      border-color: #667eea;
    }

    /* è¡¨æ ¼ */
    .table-container {
      background: #1e2139;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid #2d3250;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #252a48;
    }

    th {
      padding: 16px;
      text-align: left;
      font-size: 12px;
      font-weight: 600;
      color: #8b92b0;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      padding: 16px;
      border-top: 1px solid #2d3250;
      font-size: 14px;
      color: #e0e0e0;
    }

    tr:hover {
      background: #252a48;
    }

    /* çŠ¶æ€æ ‡ç­¾ */
    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-pending {
      background: rgba(245, 158, 11, 0.1);
      color: #f59e0b;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .status-processing {
      background: rgba(59, 130, 246, 0.1);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.2);
    }

    .status-completed {
      background: rgba(16, 185, 129, 0.1);
      color: #10b981;
      border: 1px solid rgba(16, 185, 129, 0.2);
    }

    .status-failed {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-cancelled {
      background: rgba(107, 114, 128, 0.1);
      color: #6b7280;
      border: 1px solid rgba(107, 114, 128, 0.2);
    }

    /* åˆ†é¡µ */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 20px;
      padding: 20px;
    }

    .pagination button {
      padding: 8px 12px;
      background: #1e2139;
      border: 1px solid #2d3250;
      border-radius: 6px;
      color: #e0e0e0;
      cursor: pointer;
      transition: all 0.3s;
    }

    .pagination button:hover:not(:disabled) {
      background: #2d3250;
    }

    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination button.active {
      background: #667eea;
      border-color: #667eea;
      color: white;
    }

    .pagination-info {
      color: #8b92b0;
      font-size: 14px;
    }

    /* æ¨¡æ€æ¡† */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: #1e2139;
      border-radius: 12px;
      padding: 32px;
      max-width: 500px;
      width: 90%;
      border: 1px solid #2d3250;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .modal-header h2 {
      font-size: 20px;
      color: #fff;
    }

    .modal-close {
      background: none;
      border: none;
      color: #8b92b0;
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: all 0.3s;
    }

    .modal-close:hover {
      background: #2d3250;
      color: #fff;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 14px;
      color: #8b92b0;
      font-weight: 500;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 12px;
      background: #0a0e27;
      border: 1px solid #2d3250;
      border-radius: 8px;
      color: #e0e0e0;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }

    .form-hint {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
    }

    /* åŠ è½½çŠ¶æ€ */
    .loading {
      text-align: center;
      padding: 40px;
      color: #8b92b0;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #8b92b0;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* å“åº”å¼ */
    @media (max-width: 768px) {
      .summary-cards {
        grid-template-columns: 1fr;
      }

      .filters {
        flex-direction: column;
        align-items: stretch;
      }

      .filter-group select,
      .filter-group input {
        min-width: 100%;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 12px 8px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- å¤´éƒ¨ -->
    <div class="header">
      <h1>ğŸ’° æç°ç®¡ç†</h1>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="refreshData()">
          ğŸ”„ åˆ·æ–°
        </button>
        <button class="btn btn-primary" onclick="openWithdrawalModal()">
          â• ç”³è¯·æç°
        </button>
      </div>
    </div>

    <!-- æ¦‚è§ˆå¡ç‰‡ -->
    <div class="summary-cards">
      <div class="card">
        <div class="card-title">å¯æç°é‡‘é¢</div>
        <div class="card-value green" id="availableAmount">$0.00</div>
        <div class="card-subtitle">Available to Withdraw</div>
      </div>

      <div class="card">
        <div class="card-title">å·²æç°é‡‘é¢</div>
        <div class="card-value blue" id="withdrawnAmount">$0.00</div>
        <div class="card-subtitle">Total Withdrawn</div>
      </div>

      <div class="card">
        <div class="card-title">æç°ä¸­é‡‘é¢</div>
        <div class="card-value yellow" id="processingAmount">$0.00</div>
        <div class="card-subtitle">Processing</div>
      </div>

      <div class="card">
        <div class="card-title">å·²æ‰¹å‡†ä½£é‡‘</div>
        <div class="card-value" id="approvedAmount">$0.00</div>
        <div class="card-subtitle">Approved Commission</div>
      </div>
    </div>

    <!-- ç­›é€‰æ  -->
    <div class="filters">
      <div class="filter-group">
        <label>å¹³å°è´¦å·</label>
        <select id="filterPlatformAccount" onchange="loadWithdrawalHistory()">
          <option value="">å…¨éƒ¨è´¦å·</option>
        </select>
      </div>

      <div class="filter-group">
        <label>çŠ¶æ€</label>
        <select id="filterStatus" onchange="loadWithdrawalHistory()">
          <option value="all">å…¨éƒ¨çŠ¶æ€</option>
          <option value="pending">å¾…å¤„ç†</option>
          <option value="processing">å¤„ç†ä¸­</option>
          <option value="completed">å·²å®Œæˆ</option>
          <option value="failed">å¤±è´¥</option>
          <option value="cancelled">å·²å–æ¶ˆ</option>
        </select>
      </div>

      <div class="filter-group">
        <label>æ—¥æœŸèŒƒå›´</label>
        <input type="date" id="filterStartDate" onchange="loadWithdrawalHistory()">
      </div>

      <div class="filter-group">
        <label>&nbsp;</label>
        <input type="date" id="filterEndDate" onchange="loadWithdrawalHistory()">
      </div>
    </div>

    <!-- æç°å†å²è¡¨æ ¼ -->
    <div class="table-container">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>å¹³å°è´¦å·</th>
            <th>é‡‘é¢</th>
            <th>æ”¯ä»˜æ–¹å¼</th>
            <th>çŠ¶æ€</th>
            <th>ç”³è¯·æ—¶é—´</th>
            <th>å®Œæˆæ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="withdrawalTableBody">
          <tr>
            <td colspan="8" class="loading">åŠ è½½ä¸­...</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- åˆ†é¡µ -->
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- ç”³è¯·æç°æ¨¡æ€æ¡† -->
  <div class="modal" id="withdrawalModal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ç”³è¯·æç°</h2>
        <button class="modal-close" onclick="closeWithdrawalModal()">Ã—</button>
      </div>

      <form id="withdrawalForm" onsubmit="submitWithdrawal(event)">
        <div class="form-group">
          <label>é€‰æ‹©å¹³å°è´¦å· *</label>
          <select id="platformAccountId" required>
            <option value="">è¯·é€‰æ‹©å¹³å°è´¦å·</option>
          </select>
        </div>

        <div class="form-group">
          <label>æç°é‡‘é¢ (USD) *</label>
          <input 
            type="number" 
            id="withdrawalAmount" 
            step="0.01" 
            min="0.01" 
            required
            placeholder="è¯·è¾“å…¥æç°é‡‘é¢"
          >
          <div class="form-hint">å¯æç°é‡‘é¢: $<span id="maxAmount">0.00</span></div>
        </div>

        <div class="form-group">
          <label>æ”¯ä»˜æ–¹å¼ *</label>
          <select id="paymentMethod" required>
            <option value="">è¯·é€‰æ‹©æ”¯ä»˜æ–¹å¼</option>
            <option value="paypal">PayPal</option>
            <option value="bank_transfer">é“¶è¡Œè½¬è´¦</option>
            <option value="wise">Wise</option>
            <option value="other">å…¶ä»–</option>
          </select>
        </div>

        <div class="form-group">
          <label>æ”¯ä»˜è´¦å· *</label>
          <input 
            type="text" 
            id="paymentAccount" 
            required
            placeholder="è¯·è¾“å…¥æ”¯ä»˜è´¦å·ï¼ˆå¦‚PayPalé‚®ç®±ï¼‰"
          >
        </div>

        <div class="form-group">
          <label>å¤‡æ³¨</label>
          <textarea 
            id="withdrawalNote" 
            placeholder="é€‰å¡«ï¼šæ·»åŠ å¤‡æ³¨ä¿¡æ¯"
          ></textarea>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeWithdrawalModal()">
            å–æ¶ˆ
          </button>
          <button type="submit" class="btn btn-primary">
            æäº¤ç”³è¯·
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // å…¨å±€å˜é‡
    let currentPage = 1;
    let pageSize = 20;
    let totalPages = 0;

    // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
      loadSummary();
      loadPlatformAccounts();
      loadWithdrawalHistory();
    });

    // åŠ è½½æç°æ¦‚è§ˆ
    async function loadSummary() {
      try {
        // TODO: æ›¿æ¢ä¸ºå®é™…çš„ API è°ƒç”¨
        // const response = await fetch('/api/withdrawal/summary');
        // const data = await response.json();

        // æ¨¡æ‹Ÿæ•°æ®
        const data = {
          availableToWithdraw: 2500.50,
          withdrawnAmount: 15000.00,
          processingAmount: 500.00,
          approvedCommission: 18000.50
        };

        document.getElementById('availableAmount').textContent = `$${data.availableToWithdraw.toFixed(2)}`;
        document.getElementById('withdrawnAmount').textContent = `$${data.withdrawnAmount.toFixed(2)}`;
        document.getElementById('processingAmount').textContent = `$${data.processingAmount.toFixed(2)}`;
        document.getElementById('approvedAmount').textContent = `$${data.approvedCommission.toFixed(2)}`;
        document.getElementById('maxAmount').textContent = data.availableToWithdraw.toFixed(2);
      } catch (error) {
        console.error('åŠ è½½æ¦‚è§ˆå¤±è´¥:', error);
      }
    }

    // åŠ è½½å¹³å°è´¦å·åˆ—è¡¨
    async function loadPlatformAccounts() {
      try {
        // TODO: æ›¿æ¢ä¸ºå®é™…çš„ API è°ƒç”¨
        // const response = await fetch('/api/platform-accounts');
        // const accounts = await response.json();

        // æ¨¡æ‹Ÿæ•°æ®
        const accounts = [
          { id: 1, platform: 'partnermatic', account_name: 'living001', affiliate_name: 'PM1' },
          { id: 2, platform: 'linkhaitao', account_name: 'dhdir', affiliate_name: 'LH1' }
        ];

        const filterSelect = document.getElementById('filterPlatformAccount');
        const modalSelect = document.getElementById('platformAccountId');

        accounts.forEach(account => {
          const option = document.createElement('option');
          option.value = account.id;
          option.textContent = `${account.platform} - ${account.account_name} (${account.affiliate_name})`;
          
          filterSelect.appendChild(option.cloneNode(true));
          modalSelect.appendChild(option);
        });
      } catch (error) {
        console.error('åŠ è½½å¹³å°è´¦å·å¤±è´¥:', error);
      }
    }

    // åŠ è½½æç°å†å²
    async function loadWithdrawalHistory() {
      try {
        const tbody = document.getElementById('withdrawalTableBody');
        tbody.innerHTML = '<tr><td colspan="8" class="loading">åŠ è½½ä¸­...</td></tr>';

        // TODO: æ›¿æ¢ä¸ºå®é™…çš„ API è°ƒç”¨
        // const params = new URLSearchParams({
        //   page: currentPage,
        //   pageSize: pageSize,
        //   status: document.getElementById('filterStatus').value,
        //   platformAccountId: document.getElementById('filterPlatformAccount').value
        // });
        // const response = await fetch(`/api/withdrawal/history?${params}`);
        // const data = await response.json();

        // æ¨¡æ‹Ÿæ•°æ®
        const data = {
          total: 0,
          page: 1,
          totalPages: 0,
          list: []
        };

        if (data.list.length === 0) {
          tbody.innerHTML = `
            <tr>
              <td colspan="8" class="empty-state">
                <div class="empty-state-icon">ğŸ“­</div>
                <div>æš‚æ— æç°è®°å½•</div>
              </td>
            </tr>
          `;
          document.getElementById('pagination').innerHTML = '';
          return;
        }

        tbody.innerHTML = data.list.map(item => `
          <tr>
            <td>#${item.id}</td>
            <td>${item.platform} - ${item.platform_account_name}</td>
            <td>$${item.amount.toFixed(2)}</td>
            <td>${getPaymentMethodText(item.payment_method)}</td>
            <td><span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></td>
            <td>${formatDate(item.requested_at)}</td>
            <td>${item.completed_at ? formatDate(item.completed_at) : '-'}</td>
            <td>
              <button class="btn btn-secondary" onclick="viewWithdrawal(${item.id})" style="padding: 6px 12px; font-size: 12px;">
                æŸ¥çœ‹
              </button>
              ${item.status === 'pending' ? `
                <button class="btn btn-secondary" onclick="cancelWithdrawal(${item.id})" style="padding: 6px 12px; font-size: 12px; margin-left: 4px;">
                  å–æ¶ˆ
                </button>
              ` : ''}
            </td>
          </tr>
        `).join('');

        renderPagination(data.total, data.page, data.totalPages);
      } catch (error) {
        console.error('åŠ è½½æç°å†å²å¤±è´¥:', error);
        document.getElementById('withdrawalTableBody').innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <div>åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>
            </td>
          </tr>
        `;
      }
    }

    // æ¸²æŸ“åˆ†é¡µ
    function renderPagination(total, page, totalPages) {
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }

      let html = `
        <button onclick="changePage(${page - 1})" ${page === 1 ? 'disabled' : ''}>ä¸Šä¸€é¡µ</button>
        <span class="pagination-info">ç¬¬ ${page} / ${totalPages} é¡µï¼Œå…± ${total} æ¡</span>
        <button onclick="changePage(${page + 1})" ${page === totalPages ? 'disabled' : ''}>ä¸‹ä¸€é¡µ</button>
      `;

      pagination.innerHTML = html;
    }

    // åˆ‡æ¢é¡µç 
    function changePage(page) {
      currentPage = page;
      loadWithdrawalHistory();
    }

    // æ‰“å¼€æç°æ¨¡æ€æ¡†
    function openWithdrawalModal() {
      document.getElementById('withdrawalModal').classList.add('active');
      document.getElementById('withdrawalForm').reset();
    }

    // å…³é—­æç°æ¨¡æ€æ¡†
    function closeWithdrawalModal() {
      document.getElementById('withdrawalModal').classList.remove('active');
    }

    // æäº¤æç°ç”³è¯·
    async function submitWithdrawal(event) {
      event.preventDefault();

      const formData = {
        platformAccountId: parseInt(document.getElementById('platformAccountId').value),
        amount: parseFloat(document.getElementById('withdrawalAmount').value),
        paymentMethod: document.getElementById('paymentMethod').value,
        paymentAccount: document.getElementById('paymentAccount').value,
        note: document.getElementById('withdrawalNote').value
      };

      try {
        // TODO: æ›¿æ¢ä¸ºå®é™…çš„ API è°ƒç”¨
        // const response = await fetch('/api/withdrawal/request', {
        //   method: 'POST',
        //   headers: { 'Content-Type': 'application/json' },
        //   body: JSON.stringify(formData)
        // });
        // const result = await response.json();

        alert('æç°ç”³è¯·å·²æäº¤ï¼');
        closeWithdrawalModal();
        refreshData();
      } catch (error) {
        console.error('æäº¤å¤±è´¥:', error);
        alert('æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // æŸ¥çœ‹æç°è¯¦æƒ…
    function viewWithdrawal(id) {
      // TODO: å®ç°æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½
      alert(`æŸ¥çœ‹æç°è¯¦æƒ… #${id}`);
    }

    // å–æ¶ˆæç°
    async function cancelWithdrawal(id) {
      if (!confirm('ç¡®å®šè¦å–æ¶ˆè¿™ä¸ªæç°ç”³è¯·å—ï¼Ÿ')) {
        return;
      }

      try {
        // TODO: æ›¿æ¢ä¸ºå®é™…çš„ API è°ƒç”¨
        // const response = await fetch(`/api/withdrawal/${id}/cancel`, {
        //   method: 'POST'
        // });
        // const result = await response.json();

        alert('æç°ç”³è¯·å·²å–æ¶ˆ');
        refreshData();
      } catch (error) {
        console.error('å–æ¶ˆå¤±è´¥:', error);
        alert('å–æ¶ˆå¤±è´¥ï¼Œè¯·é‡è¯•');
      }
    }

    // åˆ·æ–°æ•°æ®
    function refreshData() {
      loadSummary();
      loadWithdrawalHistory();
    }

    // è¾…åŠ©å‡½æ•°
    function getStatusText(status) {
      const statusMap = {
        'pending': 'å¾…å¤„ç†',
        'processing': 'å¤„ç†ä¸­',
        'completed': 'å·²å®Œæˆ',
        'failed': 'å¤±è´¥',
        'cancelled': 'å·²å–æ¶ˆ'
      };
      return statusMap[status] || status;
    }

    function getPaymentMethodText(method) {
      const methodMap = {
        'paypal': 'PayPal',
        'bank_transfer': 'é“¶è¡Œè½¬è´¦',
        'wise': 'Wise',
        'other': 'å…¶ä»–'
      };
      return methodMap[method] || method;
    }

    function formatDate(dateString) {
      if (!dateString) return '-';
      const date = new Date(dateString);
      return date.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }
  </script>
</body>
</html>
