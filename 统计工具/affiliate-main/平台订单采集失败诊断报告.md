# 平台订单数据采集失败诊断报告

## 🔴 错误提示
**❌ 所有账号采集均失败，请检查账号配置或网络连接**

这个错误出现在 `public/app-v2.js` 第666行，当所有账号的采集都失败时（`successCount === 0`）会显示此提示。

---

## 📋 采集流程分析

### 1. 前端采集流程（app-v2.js 第526-675行）

```javascript
1. 用户选择账号 → selectedAccountIds
2. 循环每个账号：
   - 发送 POST /api/collect-orders 请求
   - 检查响应状态
   - 如果 result.success === true 且 result.data.orders 存在 → successCount++
   - 否则 → failCount++
3. 如果 successCount === 0 → 显示"所有账号采集均失败"
```

### 2. 后端API流程（server-v2.js 第691-724行）

```javascript
POST /api/collect-orders
1. 验证参数：platformAccountId, startDate, endDate
2. 验证账号归属：查询 platform_accounts 表
3. 根据平台类型调用对应采集函数：
   - linkhaitao → collectLHOrders()
   - partnermatic → collectPMOrders()
   - linkbux → collectLBOrders()
   - rewardoo → collectRWOrders()
```

---

## 🔍 可能导致失败的原因

### 原因1：API Token未配置或为空 ⚠️ **最可能**

**所有平台（LH、PM、LB、RW）都需要API Token：**

#### LinkHaitao (LH)
- **检查位置：** `server-v2.js` 第735行
- **代码逻辑：** 如果 `account.api_token` 存在，使用API Token方式；否则使用模拟登录（旧方式）
- **失败情况：** 
  - API Token无效或过期 → API返回错误
  - 如果没有API Token且模拟登录失败 → 采集失败

#### PartnerMatic (PM)
- **检查位置：** `server-v2.js` 第1029-1036行
- **代码逻辑：** 必须提供 `account.api_token`
- **失败情况：** 如果 `!pmToken` → 返回错误：`"PartnerMatic账号未配置API Token，请在账号设置中添加"`

#### LinkBux (LB)
- **检查位置：** `server-v2.js` 第1309-1316行
- **代码逻辑：** 必须提供 `account.api_token`
- **失败情况：** 如果 `!lbToken` → 返回错误：`"LinkBux账号未配置API Token，请在账号设置中添加"`

#### Rewardoo (RW)
- **检查位置：** `server-v2.js` 第1553-1560行
- **代码逻辑：** 必须提供 `account.api_token`
- **失败情况：** 如果 `!rwToken` → 返回错误：`"Rewardoo账号未配置API Token，请在账号设置中添加"`

**诊断步骤：**
1. 检查数据库 `platform_accounts` 表中的 `api_token` 字段
2. 确认每个账号的API Token是否已正确配置
3. 查看前端账号列表，确认API Token是否显示

---

### 原因2：API Token无效或过期

**各平台的API响应验证：**

#### LinkHaitao API
- **API URL：** `https://www.linkhaitao.com/api.php?mod=medium&op=cashback2`
- **成功响应格式：** `{ status: { code: 0, msg: "success" }, data: { list: [...] } }`
- **失败响应：** `status.code !== 0` 或 `status.msg` 包含错误信息
- **日志位置：** `server-v2.js` 第760-784行
- **错误示例：** `"LH API错误: {错误信息}"`

#### PartnerMatic API
- **API URL：** `https://api.partnermatic.com/api/transaction`
- **成功响应格式：** `{ code: "0", message: "success", data: { list: [...] } }`
- **失败响应：** `code !== "0"` 或 `data` 不存在
- **日志位置：** `server-v2.js` 第1060行

#### LinkBux API
- **API URL：** `https://www.linkbux.com/api.php?mod=medium&op=transaction_v2`
- **成功响应格式：** `{ status: { code: 0, msg: "Success" }, data: { list: [...] } }`
- **失败响应：** `status.code !== 0` 或 `status.code === 1000`
- **日志位置：** `server-v2.js` 第1337行

#### Rewardoo API
- **API URL：** `https://admin.rewardoo.com/api.php?mod=medium&op=transaction_details`
- **成功响应格式：** 类似LB格式
- **失败响应：** `status.code !== 0`

**诊断步骤：**
1. 查看服务器控制台日志，查找具体的API错误信息
2. 手动测试API Token是否有效（可以在浏览器中测试API URL）
3. 检查API Token是否已过期或被平台撤销

---

### 原因3：网络请求失败

**可能的网络问题：**

1. **超时错误**
   - LH API超时设置：30秒（`server-v2.js` 第753行）
   - 如果网络慢或API响应慢，可能超时

2. **HTTP错误**
   - 404：API URL不正确
   - 403：权限不足或Token无效
   - 500：服务器内部错误
   - 502/503：网关错误或服务不可用

3. **网络连接问题**
   - 服务器无法访问外部API
   - 防火墙阻止请求
   - DNS解析失败

**诊断步骤：**
1. 查看服务器控制台，查找 `axiosError` 或网络错误信息
2. 检查服务器网络连接
3. 测试是否能访问各平台的API域名

---

### 原因4：账号归属验证失败

**验证逻辑：** `server-v2.js` 第700-706行
```javascript
const account = db.prepare(
  'SELECT * FROM platform_accounts WHERE id = ? AND user_id = ?'
).get(platformAccountId, req.user.id);

if (!account) {
  return res.json({ success: false, message: '平台账号不存在或无权访问' });
}
```

**失败情况：**
- 账号ID不存在
- 账号不属于当前用户
- 数据库查询错误

**诊断步骤：**
1. 检查前端发送的 `platformAccountId` 是否正确
2. 检查数据库中的账号 `user_id` 是否匹配
3. 查看是否有权限错误

---

### 原因5：日期参数问题

**验证逻辑：** `server-v2.js` 第695-697行
```javascript
if (!platformAccountId || !startDate || !endDate) {
  return res.json({ success: false, message: '缺少必要参数' });
}
```

**失败情况：**
- `startDate` 或 `endDate` 为空
- 日期格式不正确
- 日期范围无效（开始日期 > 结束日期）

**诊断步骤：**
1. 检查前端日期选择器的值
2. 确认日期格式为 `YYYY-MM-DD`
3. 查看是否有"缺少必要参数"的错误

---

### 原因6：平台不支持

**验证逻辑：** `server-v2.js` 第709-719行
```javascript
if (account.platform === 'linkhaitao') {
  return await collectLHOrders(...);
} else if (account.platform === 'partnermatic') {
  return await collectPMOrders(...);
} else if (account.platform === 'linkbux') {
  return await collectLBOrders(...);
} else if (account.platform === 'rewardoo') {
  return await collectRWOrders(...);
} else {
  return res.json({ success: false, message: `不支持的平台: ${account.platform}` });
}
```

**失败情况：**
- 平台类型不在支持列表中
- 平台字段值错误

---

### 原因7：前端错误处理

**前端可能的问题：**

1. **HTTP响应状态检查**（app-v2.js 第584-586行）
   ```javascript
   if (!response.ok) {
     throw new Error(`HTTP ${response.status}: ${response.statusText}`);
   }
   ```
   - 如果HTTP状态码不是200-299，会被捕获为网络错误

2. **响应数据格式检查**（app-v2.js 第593行）
   ```javascript
   if (result.success && result.data && result.data.orders) {
     // 成功
   } else {
     // 失败
   }
   ```
   - 如果后端返回的 `result.success !== true`
   - 或者 `result.data.orders` 不存在
   - 会被视为失败

3. **异常捕获**（app-v2.js 第633-640行）
   ```javascript
   catch (error) {
     failCount++;
     showMessage('collectStatus', `网络请求失败: ${error.message}`, 'error');
   }
   ```
   - 任何异常都会被捕获并计入失败

---

## 🔧 诊断步骤

### 步骤1：检查服务器日志

查看服务器控制台输出，查找以下关键词：
- `📥 开始采集...` - 表示采集已开始
- `✅ LH API Token方式：获取到 X 条订单` - 表示成功
- `❌ LH API 返回错误:` - 表示API返回错误
- `❌ LH API 请求异常:` - 表示网络错误
- `采集订单错误:` - 表示后端异常

### 步骤2：检查前端控制台

打开浏览器开发者工具（F12），查看Console标签：
- 查找 `[采集] {账号名} 响应:` - 查看API响应内容
- 查找 `[采集失败]` - 查看失败详情
- 查找网络请求错误（红色）

### 步骤3：检查账号配置

1. **查看账号列表**
   - 登录系统
   - 进入"平台账号"页面
   - 确认账号是否已配置API Token

2. **检查数据库**
   ```sql
   SELECT id, platform, account_name, api_token, is_active 
   FROM platform_accounts 
   WHERE user_id = ?;
   ```
   - 检查 `api_token` 字段是否有值
   - 检查 `is_active` 是否为 1（启用）

### 步骤4：测试单个账号

1. 只选择一个账号进行采集
2. 查看具体的错误信息
3. 根据错误信息定位问题

### 步骤5：检查网络连接

1. 确认服务器可以访问外网
2. 测试各平台的API域名：
   - `www.linkhaitao.com`
   - `api.partnermatic.com`
   - `www.linkbux.com`
   - `admin.rewardoo.com`

---

## 📝 需要确认的信息

为了准确诊断问题，请提供以下信息：

1. **错误信息详情：**
   - 前端显示的具体错误信息是什么？
   - 服务器控制台有什么日志？
   - 浏览器控制台有什么错误？

2. **账号配置：**
   - 有哪些账号？平台类型分别是什么？
   - 每个账号是否已配置API Token？
   - API Token是否正确（可以在平台后台验证）？

3. **采集设置：**
   - 选择的日期范围是什么？
   - 选择了哪些账号？

4. **网络环境：**
   - 服务器是否可以访问外网？
   - 是否有防火墙或代理限制？

---

## 🎯 可能的解决方案（待确认问题后）

根据不同的失败原因，可能的解决方案：

1. **API Token未配置：** 在账号设置中添加API Token
2. **API Token无效：** 从平台后台重新获取API Token并更新
3. **网络问题：** 检查服务器网络配置，确保可以访问外部API
4. **日期参数错误：** 检查前端日期选择器的值
5. **账号权限问题：** 检查账号是否属于当前用户

---

**报告生成时间：** 2025-11-04  
**相关代码位置：**
- 前端：`public/app-v2.js` 第526-675行（采集逻辑）
- 后端：`server-v2.js` 第691-724行（采集API）
- LH采集：`server-v2.js` 第729-1021行
- PM采集：`server-v2.js` 第1026-1299行
- LB采集：`server-v2.js` 第1303-1543行
- RW采集：`server-v2.js` 第1548-1785行

